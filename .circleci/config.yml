version: 2.1

executors:
  vm-docker:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false

commands:
  common-setup:
    steps:
      - checkout

  prepare-test-image:
    steps:
      - run:
          name: Pull TI-Toolbox test image
          command: |
            set -eo pipefail
            TEST_IMAGE="idossha/ti-toolbox-test:latest"
            echo "Pulling TI-Toolbox test image: ${TEST_IMAGE}"
            docker pull ${TEST_IMAGE}
            docker tag ${TEST_IMAGE} ti-test:latest
            echo "✓ Test image ready (SimNIBS + testing tools)"

jobs:

  build-and-run-tests:
    executor: vm-docker
    steps:
      - common-setup
      - prepare-test-image
      - run:
          name: Run complete test suite with coverage
          command: |
            set -euo pipefail

            # Create directories for test results, coverage, and test project
            mkdir -p /tmp/test-results /tmp/test_projectdir /tmp/coverage
            chmod 777 /tmp/test-results /tmp/test_projectdir /tmp/coverage

            # Get current working directory (checked out PR code)
            WORKSPACE=$(pwd)

            echo "=========================================="
            echo "TI-Toolbox CI Testing Pipeline"
            echo "=========================================="
            echo "Testing PR code from: ${WORKSPACE}"
            echo "Test image: ti-test:latest"
            echo ""

            # Run all tests with coverage
            # - Mounts PR code at /ti-toolbox (matches production environment)
            # - Script copies ElectrodeCaps and tes_flex to SimNIBS
            docker run --rm \
              -v "${WORKSPACE}:/ti-toolbox" \
              -v /tmp/test_projectdir:/mnt/test_projectdir \
              -v /tmp/test-results:/tmp/test-results \
              -v /tmp/coverage:/tmp/coverage \
              -w /ti-toolbox \
              ti-test:latest \
              bash -c './tests/run_tests.sh --verbose --coverage'

            EXIT_CODE=$?

            # Cleanup test project directory from host side (after container exits)
            # Note: Keep /tmp/test-results and /tmp/coverage for artifact storage
            echo "Cleaning up test project directory from host..."
            rm -rf /tmp/test_projectdir 2>/dev/null || true

            if [ $EXIT_CODE -eq 0 ]; then
              echo ""
              echo "✓ All tests passed!"
            else
              echo ""
              echo "✗ Some tests failed!"
              exit $EXIT_CODE
            fi

      - run:
          name: Upload coverage to Codecov
          command: |
            # Install codecov uploader (official uploader)
            curl -Os https://uploader.codecov.io/latest/linux/codecov
            chmod +x codecov

            # Verify uploader integrity (recommended security practice)
            curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM.sig

            # Verify SHA256 (will exit with error if mismatch)
            sha256sum -c codecov.SHA256SUM 2>&1 | grep OK

            echo "Uploading coverage report to Codecov..."

            # Upload coverage report with proper configuration
            # -t: Codecov token (set in CircleCI environment)
            # -f: Coverage file location
            # -F: Flags to categorize coverage (matches .codecov.yml flags)
            # -n: Custom name for the upload
            # -B: Branch name
            # -C: Commit SHA
            # -Z: Exit with non-zero code on upload failure
            ./codecov \
              -t ${CODECOV_TOKEN} \
              -f /tmp/coverage/coverage.xml \
              -F unittests,core,simulator,analyzer,optimizer \
              -n "CircleCI-${CIRCLE_BUILD_NUM}" \
              -B "${CIRCLE_BRANCH}" \
              -C "${CIRCLE_SHA1}" \
              -Z

            echo "Coverage uploaded successfully"
          when: always

      - store_artifacts:
          path: /tmp/test-results
          destination: test-results

      - store_artifacts:
          path: /tmp/coverage
          destination: coverage
            


workflows:
  version: 2
  # Only run on pull requests to main branch
  # This workflow will NOT run on direct commits to main
  pull_request_workflow:
    jobs:
      - build-and-run-tests:
          filters:
            branches:
              # Run on all branches EXCEPT main/master (where PRs come FROM)
              # Combined with GitHub branch protection, this ensures:
              # 1. Tests run when opening PR from feature branch -> main
              # 2. Tests do NOT run on direct commits to main
              # 3. Tests do NOT run when PR is merged to main
              ignore:
                - main
                - master
