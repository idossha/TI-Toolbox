version: 2.1

executors:
  vm-docker:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false

commands:
  common-setup:
    steps:
      - checkout

  prepare-test-image:
    steps:
      - run:
          name: Pull TI-Toolbox test image
          command: |
            set -eo pipefail
            TEST_IMAGE="idossha/ti-toolbox-test:latest"
            echo "Pulling TI-Toolbox test image: ${TEST_IMAGE}"
            docker pull ${TEST_IMAGE}
            docker tag ${TEST_IMAGE} ti-test:latest
            echo "âœ“ Test image ready (SimNIBS + testing tools)"

jobs:

  build-and-run-tests:
    executor: vm-docker
    steps:
      - common-setup
      - prepare-test-image
      - run:
          name: Run complete test suite with coverage
          no_output_timeout: 30m
          command: |
            set -euo pipefail

            echo "=========================================="
            echo "TI-Toolbox CI Testing Pipeline"
            echo "=========================================="
            echo "Testing PR code from: $(pwd)"
            echo "Test image: ti-test:latest"
            echo ""

            # Always run via the Docker wrapper to guarantee a consistent environment.
            # Use the already-pulled image tag to avoid re-pulling.
            TEST_IMAGE=ti-test:latest bash ./tests/test.sh --verbose --coverage

      - run:
          name: Upload coverage to Codecov
          command: |
            # Install codecov uploader (official uploader)
            curl -Os https://uploader.codecov.io/latest/linux/codecov
            chmod +x codecov

            # Verify uploader integrity (recommended security practice)
            curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM.sig

            # Verify SHA256 (will exit with error if mismatch)
            sha256sum -c codecov.SHA256SUM 2>&1 | grep OK

            echo "Uploading coverage report to Codecov..."

            # Upload coverage report with proper configuration
            # -t: Codecov token (set in CircleCI environment)
            # -f: Coverage file location
            # -F: Flags to categorize coverage (matches codecov.yml flags)
            # -n: Custom name for the upload
            # -B: Branch name
            # -C: Commit SHA
            # -Z: Exit with non-zero code on upload failure
            ./codecov \
              -t ${CODECOV_TOKEN} \
              -f /tmp/coverage/coverage.xml \
              -F unittests,core,simulator,analyzer,optimizer,stats,plotting,preprocessing \
              -n "CircleCI-${CIRCLE_BUILD_NUM}" \
              -B "${CIRCLE_BRANCH}" \
              -C "${CIRCLE_SHA1}" \
              -Z

            echo "Coverage uploaded successfully"
          when: always

      - store_artifacts:
          path: /tmp/test-results
          destination: test-results

      - store_artifacts:
          path: /tmp/coverage
          destination: coverage
            


workflows:
  version: 2

  # Run on all branches including main
  # This ensures:
  # 1. Tests run on PRs (feature branches)
  # 2. Tests run on main branch for coverage tracking
  # 3. Codecov can track coverage trends over time
  test_workflow:
    jobs:
      - build-and-run-tests:
          filters:
            branches:
              # Run on all branches
              only: /.*/
