version: 2.1

executors:
  vm-docker:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false

commands:
  common-setup:
    steps:
      - checkout

  prepare-simnibs-image:
    steps:
      - run:
          name: Pull SimNIBS image for testing
          command: |
            set -eo pipefail
            SIMNIBS_IMAGE="idossha/simnibs:v2.1.3"
            echo "Pulling SimNIBS image: ${SIMNIBS_IMAGE}"
            docker pull ${SIMNIBS_IMAGE}
            docker tag ${SIMNIBS_IMAGE} simnibs-test:latest
            echo "✓ SimNIBS image ready for testing"

jobs:

  build-and-run-tests:
    executor: vm-docker
    steps:
      - common-setup
      - prepare-simnibs-image
      - run:
          name: Run complete test suite with SimNIBS
          command: |
            set -euo pipefail
            
            # Create directories for test results and test project
            mkdir -p /tmp/test-results /tmp/test_projectdir
            chmod 777 /tmp/test-results /tmp/test_projectdir
            
            # Get current working directory (checked out PR code)
            WORKSPACE=$(pwd)
            
            echo "=========================================="
            echo "Running TI-Toolbox Test Suite"
            echo "=========================================="
            echo "Using PR code from: ${WORKSPACE}"
            echo "SimNIBS image: simnibs-test:latest"
            echo ""
            
            # Run all tests using the script (mounts PR code into container)
            docker run --rm \
              -v "${WORKSPACE}:/workspace" \
              -v /tmp/test_projectdir:/mnt/test_projectdir \
              -v /tmp/test-results:/tmp/test-results \
              -w /workspace \
              simnibs-test:latest \
              bash -c './tests/run_tests.sh --verbose'
            
            EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo ""
              echo "✓ All tests passed!"
            else
              echo ""
              echo "✗ Some tests failed!"
              exit $EXIT_CODE
            fi
      - store_artifacts:
          path: /tmp/test-results
          destination: test-results
            


workflows:
  version: 2
  pull_request_workflow:
    jobs:
      - build-and-run-tests:
          filters:
            branches:
              ignore: 
                - main
                - master
