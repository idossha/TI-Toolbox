
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Python API reference for the Temporal Interference Toolbox">
      
      
      
        <link rel="canonical" href="https://idossha.github.io/TI-Toolbox/api/reference/analyzer/">
      
      
        <link rel="prev" href="../sim/">
      
      
        <link rel="next" href="../opt/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Analyzer - TI-Toolbox API</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#analyzer-titanalyzer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="TI-Toolbox API" class="md-header__button md-logo" aria-label="TI-Toolbox API" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TI-Toolbox API
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Analyzer
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="TI-Toolbox API" class="md-nav__button md-logo" aria-label="TI-Toolbox API" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    TI-Toolbox API
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simulation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Analyzer
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Analyzer
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      analyzer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mesh-analyzer-titanalyzermesh_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      Mesh analyzer (tit.analyzer.mesh_analyzer)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      mesh_analyzer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      MeshAnalyzer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MeshAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.__del__" class="md-nav__link">
    <span class="md-ellipsis">
      __del__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_cortex" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_cortex
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_sphere" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_sphere
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_whole_head" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_whole_head
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.get_grey_matter_statistics" class="md-nav__link">
    <span class="md-ellipsis">
      get_grey_matter_statistics
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#voxel-analyzer-titanalyzervoxel_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      Voxel analyzer (tit.analyzer.voxel_analyzer)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      voxel_analyzer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      VoxelAnalyzer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VoxelAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_cortex" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_cortex
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_sphere" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_sphere
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_whole_head" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_whole_head
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.find_region" class="md-nav__link">
    <span class="md-ellipsis">
      find_region
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_atlas_regions" class="md-nav__link">
    <span class="md-ellipsis">
      get_atlas_regions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_grey_matter_statistics" class="md-nav__link">
    <span class="md-ellipsis">
      get_grey_matter_statistics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.load_brain_image" class="md-nav__link">
    <span class="md-ellipsis">
      load_brain_image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.resample_to_match" class="md-nav__link">
    <span class="md-ellipsis">
      resample_to_match
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#group-analyzer-titanalyzergroup_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      Group analyzer (tit.analyzer.group_analyzer)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      group_analyzer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.build_main_analyzer_command" class="md-nav__link">
    <span class="md-ellipsis">
      build_main_analyzer_command
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.collect_analysis_paths" class="md-nav__link">
    <span class="md-ellipsis">
      collect_analysis_paths
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.compute_subject_output_dir" class="md-nav__link">
    <span class="md-ellipsis">
      compute_subject_output_dir
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.create_group_output_directory" class="md-nav__link">
    <span class="md-ellipsis">
      create_group_output_directory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.determine_group_subfolder_name" class="md-nav__link">
    <span class="md-ellipsis">
      determine_group_subfolder_name
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.format_duration" class="md-nav__link">
    <span class="md-ellipsis">
      format_duration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.log_group_analysis_complete" class="md-nav__link">
    <span class="md-ellipsis">
      log_group_analysis_complete
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.log_group_analysis_start" class="md-nav__link">
    <span class="md-ellipsis">
      log_group_analysis_start
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.log_group_subject_status" class="md-nav__link">
    <span class="md-ellipsis">
      log_group_subject_status
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.run_comprehensive_group_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      run_comprehensive_group_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.run_subject_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      run_subject_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.setup_parser" class="md-nav__link">
    <span class="md-ellipsis">
      setup_parser
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.validate_args" class="md-nav__link">
    <span class="md-ellipsis">
      validate_args
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../opt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Statistics
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      analyzer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mesh-analyzer-titanalyzermesh_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      Mesh analyzer (tit.analyzer.mesh_analyzer)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      mesh_analyzer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      MeshAnalyzer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MeshAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.__del__" class="md-nav__link">
    <span class="md-ellipsis">
      __del__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_cortex" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_cortex
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_sphere" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_sphere
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_whole_head" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_whole_head
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.get_grey_matter_statistics" class="md-nav__link">
    <span class="md-ellipsis">
      get_grey_matter_statistics
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#voxel-analyzer-titanalyzervoxel_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      Voxel analyzer (tit.analyzer.voxel_analyzer)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      voxel_analyzer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      VoxelAnalyzer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VoxelAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_cortex" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_cortex
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_sphere" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_sphere
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_whole_head" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_whole_head
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.find_region" class="md-nav__link">
    <span class="md-ellipsis">
      find_region
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_atlas_regions" class="md-nav__link">
    <span class="md-ellipsis">
      get_atlas_regions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_grey_matter_statistics" class="md-nav__link">
    <span class="md-ellipsis">
      get_grey_matter_statistics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.load_brain_image" class="md-nav__link">
    <span class="md-ellipsis">
      load_brain_image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.resample_to_match" class="md-nav__link">
    <span class="md-ellipsis">
      resample_to_match
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#group-analyzer-titanalyzergroup_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      Group analyzer (tit.analyzer.group_analyzer)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      group_analyzer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.build_main_analyzer_command" class="md-nav__link">
    <span class="md-ellipsis">
      build_main_analyzer_command
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.collect_analysis_paths" class="md-nav__link">
    <span class="md-ellipsis">
      collect_analysis_paths
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.compute_subject_output_dir" class="md-nav__link">
    <span class="md-ellipsis">
      compute_subject_output_dir
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.create_group_output_directory" class="md-nav__link">
    <span class="md-ellipsis">
      create_group_output_directory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.determine_group_subfolder_name" class="md-nav__link">
    <span class="md-ellipsis">
      determine_group_subfolder_name
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.format_duration" class="md-nav__link">
    <span class="md-ellipsis">
      format_duration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.log_group_analysis_complete" class="md-nav__link">
    <span class="md-ellipsis">
      log_group_analysis_complete
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.log_group_analysis_start" class="md-nav__link">
    <span class="md-ellipsis">
      log_group_analysis_start
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.log_group_subject_status" class="md-nav__link">
    <span class="md-ellipsis">
      log_group_subject_status
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.run_comprehensive_group_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      run_comprehensive_group_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.run_subject_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      run_subject_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.setup_parser" class="md-nav__link">
    <span class="md-ellipsis">
      setup_parser
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.analyzer.group_analyzer.validate_args" class="md-nav__link">
    <span class="md-ellipsis">
      validate_args
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="analyzer-titanalyzer">Analyzer (<code>tit.analyzer</code>)<a class="headerlink" href="#analyzer-titanalyzer" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<a id="tit.analyzer"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">











  </div>

    </div>

</div><h2 id="mesh-analyzer-titanalyzermesh_analyzer">Mesh analyzer (<code>tit.analyzer.mesh_analyzer</code>)<a class="headerlink" href="#mesh-analyzer-titanalyzermesh_analyzer" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="tit.analyzer.mesh_analyzer"></a>
    <div class="doc doc-contents first">

        <p>MeshAnalyzer: A tool for analyzing mesh-based neuroimaging data</p>
<p>This module provides functionality for analyzing field data in specific regions of interest,
including spherical ROIs and cortical regions defined by an atlas. It works with
SimNIBS mesh files and uses the cortical middle-layer surface mesh (via msh2cortex)
for cortical/surface analyses.</p>
<p>Inputs:
    - SimNIBS mesh files (.msh) containing field data
    - Subject directory containing m2m files for atlas mapping
    - ROI specifications (coordinates, regions)</p>
<p>Outputs:
    - Statistical measures (mean, min, max)
    - ROI masks
    - Surface meshes for visualization
    - Visualization files (optional)</p>
<p>Example Usage:
    ```python
    # Initialize analyzer
    analyzer = MeshAnalyzer(
        field_mesh_path="/path/to/field.msh",
        field_name="normE",
        subject_dir="/path/to/m2m_subject",
        output_dir="/path/to/output"
    )</p>
<pre><code># Analyze a spherical ROI
sphere_results = analyzer.analyze_sphere(
    center_coordinates=[0, 0, 0],
    radius=10
)

# Analyze a cortical region
cortex_results = analyzer.analyze_cortex(
    atlas_type="DK40",
    target_region="superiorfrontal",
    visualize=True
)

# Analyze whole head
whole_head_results = analyzer.analyze_whole_head(
    atlas_type="DK40",
    visualize=True
)
```
</code></pre>
<p>Dependencies:
    - numpy
    - simnibs
    - subprocess (for msh2cortex operations)</p>








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="tit.analyzer.mesh_analyzer.MeshAnalyzer" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">MeshAnalyzer</span>


<a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">MeshAnalyzer</span><span class="p">(</span><span class="n">field_mesh_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


        <p>A class for analyzing mesh-based data from 3D models.</p>
<p>This class provides methods for analyzing field data in specific regions of interest,
 including spherical ROIs and cortical regions defined by an atlas. It works with
 SimNIBS mesh files and uses cortical middle-layer surface meshes for analysis.</p>
<p>Attributes:
     field_mesh_path (str): Path to the mesh file containing field data
     field_name (str): Name of the field to analyze in the mesh
     subject_dir (str): Directory containing subject data (m2m folder)
     output_dir (str): Directory where analysis results will be saved
     visualizer (MeshVisualizer): Instance of visualizer for generating plots
     _temp_dir (tempfile.TemporaryDirectory): Temporary directory for surface mesh
     _surface_mesh_path (str): Path to the generated surface mesh</p>

        <p>Initialize the MeshAnalyzer class.</p>
<p>Args:
    field_mesh_path (str): Path to the mesh file containing the field data
    field_name (str): Name of the field to analyze
    subject_dir (str): Directory containing subject data (m2m folder)
    output_dir (str): Directory where analysis results will be saved
    logger: Optional logger instance to use. If None, creates its own.</p>






                  <details class="quote">
                    <summary>Source code in <code>tit/analyzer/mesh_analyzer.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_mesh_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the MeshAnalyzer class.</span>

<span class="sd">    Args:</span>
<span class="sd">        field_mesh_path (str): Path to the mesh file containing the field data</span>
<span class="sd">        field_name (str): Name of the field to analyze</span>
<span class="sd">        subject_dir (str): Directory containing subject data (m2m folder)</span>
<span class="sd">        output_dir (str): Directory where analysis results will be saved</span>
<span class="sd">        logger: Optional logger instance to use. If None, creates its own.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">field_mesh_path</span> <span class="o">=</span> <span class="n">field_mesh_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="n">field_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span> <span class="o">=</span> <span class="n">subject_dir</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>

    <span class="c1"># Validate early (before logger/file handlers) so missing input paths fail</span>
    <span class="c1"># with the intended error rather than a secondary logging error.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">field_mesh_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field mesh file not found: </span><span class="si">{</span><span class="n">field_mesh_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Set up logger - use provided logger or create a new one</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Create a child logger to distinguish mesh analyzer logs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;mesh_analyzer&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create our own logger if none provided</span>
        <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>

        <span class="c1"># Extract subject ID from subject_dir (e.g., m2m_subject -&gt; subject)</span>
        <span class="n">subject_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span>

        <span class="c1"># Create derivatives/ti-toolbox/logs/sub-* directory structure</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">get_path_manager</span><span class="p">()</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;ti_logs&quot;</span><span class="p">,</span> <span class="n">subject_id</span><span class="o">=</span><span class="n">subject_id</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create log file in the new directory</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;mesh_analyzer_</span><span class="si">{</span><span class="n">time_stamp</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging_util</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;mesh_analyzer&#39;</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Initialize visualizer with logger</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="o">=</span> <span class="n">MeshVisualizer</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

    <span class="c1"># Initialize temporary directory and surface mesh path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_surface_mesh_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create output directory if it doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh analyzer initialized successfully&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field mesh path: </span><span class="si">{</span><span class="n">field_mesh_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field name: </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject directory: </span><span class="si">{</span><span class="n">subject_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.mesh_analyzer.MeshAnalyzer.__del__" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">__del__</span>


<a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.__del__" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="fm">__del__</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Cleanup temporary directory when the analyzer is destroyed.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/mesh_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cleanup temporary directory when the analyzer is destroyed.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up temporary directory...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">):</span>
            <span class="c1"># Best-effort cleanup - directory may already be deleted or inaccessible</span>
            <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_cortex" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">analyze_cortex</span>


<a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_cortex" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">analyze_cortex</span><span class="p">(</span><span class="n">atlas_type</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Analyze a cortical region defined by an atlas.</p>
<p>Args:
    atlas_type: Type of atlas to use (e.g., 'DK40', 'HCP_MMP1')
    target_region: Name of the region to analyze
    visualize: Whether to generate visualization files</p>
<p>Returns:
    Dictionary containing analysis results</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/mesh_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_cortex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_type</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze a cortical region defined by an atlas.</span>

<span class="sd">    Args:</span>
<span class="sd">        atlas_type: Type of atlas to use (e.g., &#39;DK40&#39;, &#39;HCP_MMP1&#39;)</span>
<span class="sd">        target_region: Name of the region to analyze</span>
<span class="sd">        visualize: Whether to generate visualization files</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing analysis results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting cortical analysis for region &#39;</span><span class="si">{</span><span class="n">target_region</span><span class="si">}</span><span class="s2">&#39; using </span><span class="si">{</span><span class="n">atlas_type</span><span class="si">}</span><span class="s2"> atlas&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">surface_mesh_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_surface_mesh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading surface mesh...&quot;</span><span class="p">)</span>
        <span class="n">gm_surf</span> <span class="o">=</span> <span class="n">simnibs</span><span class="o">.</span><span class="n">read_msh</span><span class="p">(</span><span class="n">surface_mesh_path</span><span class="p">)</span>

        <span class="c1"># Load the atlas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading atlas </span><span class="si">{</span><span class="n">atlas_type</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">atlas</span> <span class="o">=</span> <span class="n">simnibs</span><span class="o">.</span><span class="n">subject_atlas</span><span class="p">(</span><span class="n">atlas_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span>

        <span class="c1"># Verify region exists in atlas</span>
        <span class="k">if</span> <span class="n">target_region</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atlas</span><span class="p">:</span>
            <span class="n">available_regions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region &#39;</span><span class="si">{</span><span class="n">target_region</span><span class="si">}</span><span class="s2">&#39; not found in </span><span class="si">{</span><span class="n">atlas_type</span><span class="si">}</span><span class="s2"> atlas. Available regions: </span><span class="si">{</span><span class="n">available_regions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get ROI mask for this region</span>
        <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="n">target_region</span><span class="p">]</span>

        <span class="c1"># Check if we have any nodes in the ROI</span>
        <span class="n">roi_nodes_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roi_nodes_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No nodes found in the specified region &#39;</span><span class="si">{</span><span class="n">target_region</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;normal_mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;normal_max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;normal_min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;normal_focality&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>

            <span class="c1"># Save results to CSV even if empty</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">results</span>

        <span class="c1"># Get the field values within the ROI</span>
        <span class="n">field_values</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">field_values_in_roi</span> <span class="o">=</span> <span class="n">field_values</span><span class="p">[</span><span class="n">roi_mask</span><span class="p">]</span>

        <span class="c1"># Filter for positive values in ROI (matching voxel analyzer behavior)</span>
        <span class="n">positive_mask</span> <span class="o">=</span> <span class="n">field_values_in_roi</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">field_values_positive</span> <span class="o">=</span> <span class="n">field_values_in_roi</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>

        <span class="c1"># Check if we have any positive values in the ROI</span>
        <span class="n">positive_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">positive_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Region </span><span class="si">{</span><span class="n">target_region</span><span class="si">}</span><span class="s2"> has no positive values&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;normal_mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;normal_max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;normal_min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;normal_focality&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>

            <span class="c1"># Save results to CSV even if empty</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">results</span>

        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>
        <span class="n">node_areas</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">nodes_areas</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node_areas</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
            <span class="n">node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="o">.</span><span class="n">value</span>
        <span class="n">node_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">node_areas</span><span class="p">)</span>
        <span class="n">positive_node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="p">[</span><span class="n">roi_mask</span><span class="p">][</span><span class="n">positive_mask</span><span class="p">]</span>
        <span class="n">whole_brain_positive_mask</span> <span class="o">=</span> <span class="n">field_values</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">whole_brain_node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">]</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_roi_metrics</span><span class="p">(</span>
            <span class="n">field_values_positive</span><span class="p">,</span>
            <span class="n">positive_node_areas</span><span class="p">,</span>
            <span class="n">ti_field_gm</span><span class="o">=</span><span class="n">field_values</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">],</span>
            <span class="n">gm_volumes</span><span class="o">=</span><span class="n">whole_brain_node_areas</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mean_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImean_ROI&quot;</span><span class="p">]</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImax_ROI&quot;</span><span class="p">]</span>
        <span class="n">focality</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Focality&quot;</span><span class="p">)</span>
        <span class="n">whole_brain_average</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TImean_GM&quot;</span><span class="p">)</span>

        <span class="c1"># Log the whole brain average for debugging</span>
        <span class="k">if</span> <span class="n">whole_brain_average</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Whole brain average (denominator for focality): </span><span class="si">{</span><span class="n">whole_brain_average</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare the results with TI_max values</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="n">mean_value</span><span class="p">,</span>
            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="p">,</span>
            <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="p">,</span>
            <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="n">focality</span>
        <span class="p">}</span>

        <span class="c1"># Extract TI_normal values from normal mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting TI_normal values from normal mesh...&quot;</span><span class="p">)</span>
        <span class="n">normal_field_values_positive</span><span class="p">,</span> <span class="n">normal_statistics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_normal_field_values</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span>

        <span class="c1"># Add TI_normal statistics to results if available</span>
        <span class="k">if</span> <span class="n">normal_statistics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">normal_statistics</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TI_normal values successfully added to results&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;TI_normal values not available - results will only contain TI_max values&quot;</span><span class="p">)</span>

        <span class="c1"># Generate visualization if requested</span>
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating visualizations...&quot;</span><span class="p">)</span>
            <span class="c1"># Generate focality histogram</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating focality histogram for region: </span><span class="si">{</span><span class="n">target_region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Get node areas for volume weighting</span>
                <span class="n">node_areas</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">nodes_areas</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node_areas</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                    <span class="n">node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="o">.</span><span class="n">value</span>
                <span class="n">node_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">node_areas</span><span class="p">)</span>
                <span class="n">positive_node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="p">[</span><span class="n">roi_mask</span><span class="p">][</span><span class="n">positive_mask</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">generate_focality_histogram</span><span class="p">(</span>
                    <span class="n">whole_head_field_data</span><span class="o">=</span><span class="n">field_values</span><span class="p">,</span>
                    <span class="n">roi_field_data</span><span class="o">=</span><span class="n">field_values_positive</span><span class="p">,</span>
                    <span class="n">whole_head_element_sizes</span><span class="o">=</span><span class="n">node_areas</span><span class="p">,</span>
                    <span class="n">roi_element_sizes</span><span class="o">=</span><span class="n">positive_node_areas</span><span class="p">,</span>
                    <span class="n">region_name</span><span class="o">=</span><span class="n">target_region</span><span class="p">,</span>
                    <span class="n">roi_field_value</span><span class="o">=</span><span class="n">mean_value</span><span class="p">,</span>
                    <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;node&#39;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate focality histogram for </span><span class="si">{</span><span class="n">target_region</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Create region mesh visualization</span>
            <span class="c1"># This creates a mesh file with the ROI highlighted</span>
            <span class="n">region_mesh_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">visualize_cortex_roi</span><span class="p">(</span>
                <span class="n">gm_surf</span><span class="o">=</span><span class="n">gm_surf</span><span class="p">,</span>
                <span class="n">roi_mask</span><span class="o">=</span><span class="n">roi_mask</span><span class="p">,</span>
                <span class="n">target_region</span><span class="o">=</span><span class="n">target_region</span><span class="p">,</span>
                <span class="n">field_values</span><span class="o">=</span><span class="n">field_values</span><span class="p">,</span>
                <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
                <span class="n">surface_mesh_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_surface_mesh_path</span>
            <span class="p">)</span>

        <span class="c1"># Calculate and save extra focality information for entire grey matter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating focality metrics for entire grey matter...&quot;</span><span class="p">)</span>
        <span class="n">focality_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_focality_metrics</span><span class="p">(</span>
            <span class="n">field_values</span><span class="p">,</span>  <span class="c1"># Use entire surface data, not just ROI</span>
            <span class="n">node_areas</span><span class="p">,</span>    <span class="c1"># Use all node areas, not just ROI</span>
            <span class="n">target_region</span>
        <span class="p">)</span>

        <span class="c1"># Save results to CSV</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">)</span>

        <span class="c1"># Save extra info CSV with focality data</span>
        <span class="k">if</span> <span class="n">focality_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_extra_info_to_csv</span><span class="p">(</span><span class="n">focality_info</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in cortical analysis: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_sphere" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">analyze_sphere</span>


<a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_sphere" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">analyze_sphere</span><span class="p">(</span><span class="n">center_coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Analyze a spherical region of interest from a mesh.</p>
<p>Args:
    center_coordinates: List of [x, y, z] coordinates for the center of the sphere
    radius: Radius of the sphere in mm
    visualize: Whether to generate visualization files
    save_results: Whether to save individual CSV files (default: True, set False for batch processing)</p>
<p>Returns:
    Dictionary containing analysis results or None if no nodes found</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/mesh_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center_coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze a spherical region of interest from a mesh.</span>

<span class="sd">    Args:</span>
<span class="sd">        center_coordinates: List of [x, y, z] coordinates for the center of the sphere</span>
<span class="sd">        radius: Radius of the sphere in mm</span>
<span class="sd">        visualize: Whether to generate visualization files</span>
<span class="sd">        save_results: Whether to save individual CSV files (default: True, set False for batch processing)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing analysis results or None if no nodes found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting spherical ROI analysis (radius=</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">mm) at coordinates </span><span class="si">{</span><span class="n">center_coordinates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">surface_mesh_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_surface_mesh</span><span class="p">()</span>
        <span class="n">gm_surf</span> <span class="o">=</span> <span class="n">simnibs</span><span class="o">.</span><span class="n">read_msh</span><span class="p">(</span><span class="n">surface_mesh_path</span><span class="p">)</span>

        <span class="c1"># Check if field exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">field</span><span class="p">:</span>
            <span class="n">available_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gm_surf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; not found in surface mesh. Available fields: </span><span class="si">{</span><span class="n">available_fields</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get field values from surface mesh</span>
        <span class="n">field_values</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Create spherical ROI on surface mesh (use canonical helper)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating spherical ROI at </span><span class="si">{</span><span class="n">center_coordinates</span><span class="si">}</span><span class="s2"> with radius </span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">mm...&quot;</span><span class="p">)</span>
        <span class="n">node_coords</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">node_coord</span>
        <span class="n">roi_indices</span> <span class="o">=</span> <span class="n">ROICoordinateHelper</span><span class="o">.</span><span class="n">find_voxels_in_sphere</span><span class="p">(</span><span class="n">node_coords</span><span class="p">,</span> <span class="n">center_coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
        <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_coords</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">roi_mask</span><span class="p">[</span><span class="n">roi_indices</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check if we have any nodes in the ROI</span>
        <span class="n">roi_nodes_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roi_nodes_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis Failed: No nodes found in ROI at [</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">], r=</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">mm&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ROI is not capturing any grey matter surface nodes&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Suggestion: Adjust coordinates/radius or verify using freeview&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">roi_nodes_count</span><span class="si">}</span><span class="s2"> nodes in the ROI&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating statistics...&quot;</span><span class="p">)</span>

        <span class="c1"># Get the field values within the ROI</span>
        <span class="n">field_values_in_roi</span> <span class="o">=</span> <span class="n">field_values</span><span class="p">[</span><span class="n">roi_mask</span><span class="p">]</span>

        <span class="c1"># Filter for positive values in ROI (matching voxel analyzer behavior)</span>
        <span class="n">positive_mask</span> <span class="o">=</span> <span class="n">field_values_in_roi</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">field_values_positive</span> <span class="o">=</span> <span class="n">field_values_in_roi</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>

        <span class="c1"># Check if we have any positive values in the ROI</span>
        <span class="n">positive_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">positive_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No positive values found in spherical ROI&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">positive_count</span><span class="si">}</span><span class="s2"> nodes with positive values in the ROI&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating statistics...&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate statistics using canonical ROI metric helper</span>
        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>
        <span class="n">node_areas</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">nodes_areas</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node_areas</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
            <span class="n">node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="o">.</span><span class="n">value</span>
        <span class="n">node_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">node_areas</span><span class="p">)</span>
        <span class="n">positive_node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="p">[</span><span class="n">roi_mask</span><span class="p">][</span><span class="n">positive_mask</span><span class="p">]</span>

        <span class="n">whole_brain_positive_mask</span> <span class="o">=</span> <span class="n">field_values</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">whole_brain_node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">]</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_roi_metrics</span><span class="p">(</span>
            <span class="n">field_values_positive</span><span class="p">,</span>
            <span class="n">positive_node_areas</span><span class="p">,</span>
            <span class="n">ti_field_gm</span><span class="o">=</span><span class="n">field_values</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">],</span>
            <span class="n">gm_volumes</span><span class="o">=</span><span class="n">whole_brain_node_areas</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mean_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImean_ROI&quot;</span><span class="p">]</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImax_ROI&quot;</span><span class="p">]</span>
        <span class="n">focality</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Focality&quot;</span><span class="p">)</span>
        <span class="n">whole_brain_average</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TImean_GM&quot;</span><span class="p">)</span>

        <span class="c1"># Log the whole brain average for debugging</span>
        <span class="k">if</span> <span class="n">whole_brain_average</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Whole brain average (denominator for focality): </span><span class="si">{</span><span class="n">whole_brain_average</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create results dictionary with TI_max values</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="n">mean_value</span><span class="p">,</span>
            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="p">,</span>
            <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="p">,</span>
            <span class="s1">&#39;nodes_in_roi&#39;</span><span class="p">:</span> <span class="n">roi_nodes_count</span><span class="p">,</span>
            <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="n">focality</span>
        <span class="p">}</span>

        <span class="c1"># Extract TI_normal values from normal mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting TI_normal values from normal mesh...&quot;</span><span class="p">)</span>
        <span class="n">normal_field_values_positive</span><span class="p">,</span> <span class="n">normal_statistics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_normal_field_values</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span>

        <span class="c1"># Add TI_normal statistics to results if available</span>
        <span class="k">if</span> <span class="n">normal_statistics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">normal_statistics</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TI_normal values successfully added to results&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;TI_normal values not available - results will only contain TI_max values&quot;</span><span class="p">)</span>

        <span class="c1"># Generate visualizations if requested</span>
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating visualizations...&quot;</span><span class="p">)</span>

                <span class="c1"># Generate focality histogram</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating focality histogram for spherical ROI...&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">generate_focality_histogram</span><span class="p">(</span>
                        <span class="n">whole_head_field_data</span><span class="o">=</span><span class="n">field_values</span><span class="p">,</span>
                        <span class="n">roi_field_data</span><span class="o">=</span><span class="n">field_values_positive</span><span class="p">,</span>
                        <span class="n">whole_head_element_sizes</span><span class="o">=</span><span class="n">node_areas</span><span class="p">,</span>
                        <span class="n">roi_element_sizes</span><span class="o">=</span><span class="n">positive_node_areas</span><span class="p">,</span>
                        <span class="n">region_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;sphere_x</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_z</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_r</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">roi_field_value</span><span class="o">=</span><span class="n">mean_value</span><span class="p">,</span>
                        <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;node&#39;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate focality histogram for spherical ROI: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Create spherical ROI overlay visualization</span>
                <span class="c1"># This creates a mesh file with the ROI highlighted</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating spherical ROI overlay visualization...&quot;</span><span class="p">)</span>
                <span class="n">viz_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">visualize_spherical_roi</span><span class="p">(</span>
                    <span class="n">gm_surf</span><span class="o">=</span><span class="n">gm_surf</span><span class="p">,</span>
                    <span class="n">roi_mask</span><span class="o">=</span><span class="n">roi_mask</span><span class="p">,</span>
                    <span class="n">center_coords</span><span class="o">=</span><span class="n">center_coordinates</span><span class="p">,</span>
                    <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                    <span class="n">field_values</span><span class="o">=</span><span class="n">field_values</span><span class="p">,</span>
                    <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">,</span>
                    <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
                    <span class="n">surface_mesh_path</span><span class="o">=</span><span class="n">surface_mesh_path</span>
                <span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;visualization_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">viz_file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Visualization requested but MeshVisualizer not available&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate and save extra focality information for entire grey matter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating focality metrics for entire grey matter...&quot;</span><span class="p">)</span>
        <span class="n">focality_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_focality_metrics</span><span class="p">(</span>
            <span class="n">field_values</span><span class="p">,</span>  <span class="c1"># Use entire surface data, not just ROI</span>
            <span class="n">node_areas</span><span class="p">,</span>    <span class="c1"># Use all node areas, not just ROI</span>
            <span class="sa">f</span><span class="s2">&quot;sphere_x</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_z</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_r</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Save results to CSV (only if save_results=True)</span>
        <span class="k">if</span> <span class="n">save_results</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">region_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sphere_x</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_z</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_r</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;spherical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">)</span>

            <span class="c1"># Save extra info CSV with focality data</span>
            <span class="k">if</span> <span class="n">focality_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_extra_info_to_csv</span><span class="p">(</span><span class="n">focality_info</span><span class="p">,</span> <span class="s1">&#39;spherical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">save_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot save results to CSV - MeshVisualizer not available&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in spherical analysis: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_whole_head" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">analyze_whole_head</span>


<a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_whole_head" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">analyze_whole_head</span><span class="p">(</span><span class="n">atlas_type</span><span class="o">=</span><span class="s1">&#39;HCP_MMP1&#39;</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Analyze all regions in the specified atlas.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/mesh_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_whole_head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_type</span><span class="o">=</span><span class="s1">&#39;HCP_MMP1&#39;</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze all regions in the specified atlas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting whole head analysis using </span><span class="si">{</span><span class="n">atlas_type</span><span class="si">}</span><span class="s2"> atlas&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">surface_mesh_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_surface_mesh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading surface mesh...&quot;</span><span class="p">)</span>
        <span class="n">gm_surf</span> <span class="o">=</span> <span class="n">simnibs</span><span class="o">.</span><span class="n">read_msh</span><span class="p">(</span><span class="n">surface_mesh_path</span><span class="p">)</span>

        <span class="c1"># Load the atlas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading atlas </span><span class="si">{</span><span class="n">atlas_type</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">atlas</span> <span class="o">=</span> <span class="n">simnibs</span><span class="o">.</span><span class="n">subject_atlas</span><span class="p">(</span><span class="n">atlas_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span>

        <span class="c1"># Dictionary to store results for each region</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Analyze each region in the atlas</span>
        <span class="k">for</span> <span class="n">region_name</span> <span class="ow">in</span> <span class="n">atlas</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Create a directory for this region in the main output directory</span>
                <span class="n">region_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">region_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Get ROI mask for this region</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span>
                    <span class="c1"># Check if roi_mask is actually a mask array</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: atlas[region_name] returned a callable object, not a mask&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: Expected mask array, got callable object&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: atlas[region_name] returned non-array object: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: Expected mask array, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get ROI mask for region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>

                <span class="c1"># Check if we have any nodes in the ROI</span>
                <span class="n">roi_nodes_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">roi_nodes_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No nodes found in the specified region &#39;</span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="n">region_results</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;nodes_in_roi&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;normal_mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;normal_max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;normal_min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;normal_focality&#39;</span><span class="p">:</span> <span class="kc">None</span>
                    <span class="p">}</span>

                    <span class="c1"># Store in the overall results</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_results</span>

                    <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting field values within the ROI...&quot;</span><span class="p">)</span>
                <span class="c1"># Get the field values within the ROI</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">field_values</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field_values</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: field values returned a callable object&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: Expected field values array, got callable object&quot;</span><span class="p">)</span>
                    <span class="n">field_values_in_roi</span> <span class="o">=</span> <span class="n">field_values</span><span class="p">[</span><span class="n">roi_mask</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get field values for region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field values type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;field_values&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">locals</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROI mask type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>

                <span class="c1"># Filter for positive values in ROI (matching voxel analyzer behavior)</span>
                <span class="n">positive_mask</span> <span class="o">=</span> <span class="n">field_values_in_roi</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">field_values_positive</span> <span class="o">=</span> <span class="n">field_values_in_roi</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>

                <span class="c1"># Check if we have any positive values in the ROI</span>
                <span class="n">positive_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">positive_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> has no positive values&quot;</span><span class="p">)</span>
                    <span class="n">region_results</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;nodes_in_roi&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;normal_mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;normal_max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;normal_min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;normal_focality&#39;</span><span class="p">:</span> <span class="kc">None</span>
                    <span class="p">}</span>

                    <span class="c1"># Store in the overall results</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_results</span>

                    <span class="k">continue</span>

                <span class="c1"># Calculate statistics on positive values only</span>
                <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>
                <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>

                <span class="c1"># Calculate mean value using node areas for proper averaging (only positive values)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">node_areas</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">nodes_areas</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node_areas</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                        <span class="n">node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">node_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">node_areas</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">node_areas</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: nodes_areas() returned a callable object&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: Expected node areas array, got callable object&quot;</span><span class="p">)</span>
                    <span class="n">positive_node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="p">[</span><span class="n">roi_mask</span><span class="p">][</span><span class="n">positive_mask</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get node areas for region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node areas type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">node_areas</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;node_areas&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">locals</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="c1"># Calculate mean + focality using canonical ROI metric helper</span>
                <span class="n">whole_brain_positive_mask</span> <span class="o">=</span> <span class="n">field_values</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">whole_brain_node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">]</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_roi_metrics</span><span class="p">(</span>
                    <span class="n">field_values_positive</span><span class="p">,</span>
                    <span class="n">positive_node_areas</span><span class="p">,</span>
                    <span class="n">ti_field_gm</span><span class="o">=</span><span class="n">field_values</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">],</span>
                    <span class="n">gm_volumes</span><span class="o">=</span><span class="n">whole_brain_node_areas</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mean_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImean_ROI&quot;</span><span class="p">]</span>
                <span class="n">focality</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Focality&quot;</span><span class="p">)</span>
                <span class="n">whole_brain_average</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TImean_GM&quot;</span><span class="p">)</span>

                <span class="c1"># Log the whole brain average for debugging</span>
                <span class="k">if</span> <span class="n">whole_brain_average</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Whole brain average (denominator for focality): </span><span class="si">{</span><span class="n">whole_brain_average</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Create result dictionary for this region with TI_max values</span>
                <span class="n">region_results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="n">mean_value</span><span class="p">,</span>
                    <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="p">,</span>
                    <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="p">,</span>
                    <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="n">focality</span><span class="p">,</span>
                    <span class="s1">&#39;nodes_in_roi&#39;</span><span class="p">:</span> <span class="n">positive_count</span>
                <span class="p">}</span>

                <span class="c1"># Extract TI_normal values from normal mesh for this region</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting TI_normal values for region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">normal_field_values_positive</span><span class="p">,</span> <span class="n">normal_statistics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_normal_field_values</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span>

                <span class="c1"># Add TI_normal statistics to region results if available</span>
                <span class="k">if</span> <span class="n">normal_statistics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">region_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">normal_statistics</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TI_normal values successfully added for region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TI_normal values not available for region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Store in the overall results</span>
                <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_results</span>

                <span class="c1"># Generate visualizations if requested</span>
                <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating 3D visualization for region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Generate 3D visualization and save directly to the region directory</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">visualize_cortex_roi</span><span class="p">(</span>
                        <span class="n">gm_surf</span><span class="o">=</span><span class="n">gm_surf</span><span class="p">,</span>
                        <span class="n">roi_mask</span><span class="o">=</span><span class="n">roi_mask</span><span class="p">,</span>
                        <span class="n">target_region</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                        <span class="n">field_values</span><span class="o">=</span><span class="n">field_values</span><span class="p">,</span>
                        <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">,</span>
                        <span class="n">output_dir</span><span class="o">=</span><span class="n">region_dir</span><span class="p">,</span>
                        <span class="n">surface_mesh_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_surface_mesh_path</span>
                    <span class="p">)</span>

                    <span class="c1"># Generate focality histogram for this region</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating focality histogram for region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="c1"># Get node areas for volume weighting</span>
                            <span class="n">node_areas</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">nodes_areas</span><span class="p">()</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node_areas</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                                <span class="n">node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="o">.</span><span class="n">value</span>
                            <span class="n">node_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">node_areas</span><span class="p">)</span>
                            <span class="n">positive_node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="p">[</span><span class="n">roi_mask</span><span class="p">][</span><span class="n">positive_mask</span><span class="p">]</span>

                            <span class="c1"># Create a custom visualizer just for this region with the region directory as output</span>
                            <span class="c1"># Pass the main logger to avoid creating derivatives folder in region directory</span>
                            <span class="n">region_visualizer</span> <span class="o">=</span> <span class="n">MeshVisualizer</span><span class="p">(</span><span class="n">region_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

                            <span class="n">region_visualizer</span><span class="o">.</span><span class="n">generate_focality_histogram</span><span class="p">(</span>
                                <span class="n">whole_head_field_data</span><span class="o">=</span><span class="n">field_values</span><span class="p">,</span>
                                <span class="n">roi_field_data</span><span class="o">=</span><span class="n">field_values_positive</span><span class="p">,</span>
                                <span class="n">whole_head_element_sizes</span><span class="o">=</span><span class="n">node_areas</span><span class="p">,</span>
                                <span class="n">roi_element_sizes</span><span class="o">=</span><span class="n">positive_node_areas</span><span class="p">,</span>
                                <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                                <span class="n">roi_field_value</span><span class="o">=</span><span class="n">mean_value</span><span class="p">,</span>
                                <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;node&#39;</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate focality histogram for </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to analyze region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;nodes_in_roi&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;normal_mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;normal_max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;normal_min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;normal_focality&#39;</span><span class="p">:</span> <span class="kc">None</span>
                <span class="p">}</span>

        <span class="c1"># Generate global visualization plots are disabled - only histograms are generated per region</span>

        <span class="c1"># Always generate and save summary CSV after all regions are processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving whole-head analysis summary to CSV...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_whole_head_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">atlas_type</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">gm_surf</span>
            <span class="k">del</span> <span class="n">atlas</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="c1"># Variables may not be defined if cleanup failed earlier</span>
            <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.mesh_analyzer.MeshAnalyzer.get_grey_matter_statistics" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_grey_matter_statistics</span>


<a href="#tit.analyzer.mesh_analyzer.MeshAnalyzer.get_grey_matter_statistics" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_grey_matter_statistics</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Calculate grey matter field statistics from the GM surface (central layer).</p>
<p>For mesh analysis, tries to use the same GM surface as other analyses for consistency.
Falls back to original mesh if surface generation fails to ensure robustness.</p>
<p>Returns:
    dict: Dictionary containing grey matter statistics (mean, max, min)</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/mesh_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_grey_matter_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate grey matter field statistics from the GM surface (central layer).</span>

<span class="sd">    For mesh analysis, tries to use the same GM surface as other analyses for consistency.</span>
<span class="sd">    Falls back to original mesh if surface generation fails to ensure robustness.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing grey matter statistics (mean, max, min)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating grey matter field statistics from GM surface (central layer)...&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try to generate and load GM surface mesh (same as other mesh analyses)</span>
        <span class="n">surface_mesh_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_surface_mesh</span><span class="p">()</span>
        <span class="n">gm_surf</span> <span class="o">=</span> <span class="n">simnibs</span><span class="o">.</span><span class="n">read_msh</span><span class="p">(</span><span class="n">surface_mesh_path</span><span class="p">)</span>

        <span class="c1"># Check if field exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">field</span><span class="p">:</span>
            <span class="n">available_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gm_surf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; not found in GM surface. Available fields: </span><span class="si">{</span><span class="n">available_fields</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get field values from GM surface (same source as other mesh analyses)</span>
        <span class="n">field_values</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Filter for positive values only (matching ROI analysis behavior)</span>
        <span class="n">positive_mask</span> <span class="o">=</span> <span class="n">field_values</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">field_values_positive</span> <span class="o">=</span> <span class="n">field_values</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>

        <span class="c1"># Check if we have any positive values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No positive values found in GM surface&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

        <span class="c1"># Calculate statistics using area-weighted averaging (consistent with other mesh analyses)</span>
        <span class="n">node_areas</span> <span class="o">=</span> <span class="n">gm_surf</span><span class="o">.</span><span class="n">nodes_areas</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node_areas</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
            <span class="n">node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="o">.</span><span class="n">value</span>
        <span class="n">node_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">node_areas</span><span class="p">)</span>
        <span class="n">positive_node_areas</span> <span class="o">=</span> <span class="n">node_areas</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>
        <span class="n">grey_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">positive_node_areas</span><span class="p">)</span>
        <span class="n">grey_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>
        <span class="n">grey_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grey matter statistics from GM surface for field &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (positive values only): &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;mean=</span><span class="si">{</span><span class="n">grey_mean</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">grey_max</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">grey_min</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total nodes with positive values: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_mean</span><span class="p">),</span>
            <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_max</span><span class="p">),</span>
            <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_min</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GM surface generation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Falling back to original mesh for grey matter statistics...&quot;</span><span class="p">)</span>

        <span class="c1"># Fallback: Use original mesh if surface generation fails</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">field_mesh</span> <span class="o">=</span> <span class="n">simnibs</span><span class="o">.</span><span class="n">read_msh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_mesh_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_mesh</span><span class="o">.</span><span class="n">field</span><span class="p">:</span>
                <span class="n">available_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">field_mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; not found in original mesh. Available fields: </span><span class="si">{</span><span class="n">available_fields</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">field_values</span> <span class="o">=</span> <span class="n">field_mesh</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">positive_mask</span> <span class="o">=</span> <span class="n">field_values</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">field_values_positive</span> <span class="o">=</span> <span class="n">field_values</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No positive values found in original mesh&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

            <span class="c1"># Use simple averaging for volume mesh fallback</span>
            <span class="n">grey_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>
            <span class="n">grey_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>
            <span class="n">grey_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_values_positive</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grey matter statistics from original mesh (fallback) for field &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;mean=</span><span class="si">{</span><span class="n">grey_mean</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">grey_max</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">grey_min</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_mean</span><span class="p">),</span>
                <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_max</span><span class="p">),</span>
                <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_min</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fallback_error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fallback to original mesh also failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">fallback_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="voxel-analyzer-titanalyzervoxel_analyzer">Voxel analyzer (<code>tit.analyzer.voxel_analyzer</code>)<a class="headerlink" href="#voxel-analyzer-titanalyzervoxel_analyzer" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="tit.analyzer.voxel_analyzer"></a>
    <div class="doc doc-contents first">

        <p>VoxelAnalyzer: A tool for analyzing voxel-based neuroimaging data</p>
<p>This module provides functionality for analyzing voxel-based data from medical imaging,
particularly focusing on field analysis in specific regions of interest (ROIs).</p>
<p>Inputs:
    - NIfTI files containing field data
    - Atlas files (NIfTI/MGZ) for cortical parcellation
    - ROI specifications (coordinates, regions)</p>
<p>Outputs:
    - Statistical measures (mean, min, max)
    - ROI masks
    - Visualization files (optional)</p>
<p>Example Usage:
    ```python
    # Initialize analyzer
    analyzer = VoxelAnalyzer(
        field_nifti="/path/to/field.nii.gz",
        subject_dir="/path/to/subject",
        output_dir="/path/to/output"
    )</p>
<pre><code># Analyze a spherical ROI
sphere_results = analyzer.analyze_sphere(
    center_coordinates=[0, 0, 0],
    radius=10,
    visualize=True
)

# Analyze a cortical region
cortex_results = analyzer.analyze_cortex(
    atlas_file="/path/to/atlas.mgz",
    target_region="Left-Hippocampus"
)

# Analyze whole head
whole_head_results = analyzer.analyze_whole_head(
    atlas_file="/path/to/atlas.mgz",
    visualize=True
)
```
</code></pre>
<p>Dependencies:
    - numpy
    - nibabel
    - subprocess (for FreeSurfer operations)</p>








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="tit.analyzer.voxel_analyzer.VoxelAnalyzer" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">VoxelAnalyzer</span>


<a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">VoxelAnalyzer</span><span class="p">(</span><span class="n">field_nifti</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


        <p>A class for analyzing voxel-based data from medical imaging.</p>
<p>This class provides methods for analyzing field data in specific regions of interest,
including spherical ROIs and cortical regions defined by an atlas.</p>
<p>Attributes:
    field_nifti (str): Path to the NIfTI file containing field data
    subject_dir (str): Directory containing subject data
    output_dir (str): Directory where analysis results will be saved
    visualizer (VoxelVisualizer): Instance of visualizer for generating plots</p>

        <p>Initialize the VoxelAnalyzer with paths to required data.</p>
<p>Args:
    field_nifti (str): Path to the NIfTI file containing field data
    subject_dir (str): Directory containing subject data
    output_dir (str): Directory where analysis results will be saved
    logger: Optional logger instance to use. If None, creates its own.
    quiet (bool): If True, suppress verbose logging messages</p>
<p>Raises:
    FileNotFoundError: If field_nifti file does not exist</p>






                  <details class="quote">
                    <summary>Source code in <code>tit/analyzer/voxel_analyzer.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_nifti</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the VoxelAnalyzer with paths to required data.</span>

<span class="sd">    Args:</span>
<span class="sd">        field_nifti (str): Path to the NIfTI file containing field data</span>
<span class="sd">        subject_dir (str): Directory containing subject data</span>
<span class="sd">        output_dir (str): Directory where analysis results will be saved</span>
<span class="sd">        logger: Optional logger instance to use. If None, creates its own.</span>
<span class="sd">        quiet (bool): If True, suppress verbose logging messages</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If field_nifti file does not exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check for required dependencies</span>
    <span class="k">if</span> <span class="n">nib</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;nibabel is required for voxel analysis but is not installed&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span> <span class="o">=</span> <span class="n">field_nifti</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span> <span class="o">=</span> <span class="n">subject_dir</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>

    <span class="c1"># Validate early (before logger/file handlers) so missing input paths fail</span>
    <span class="c1"># with the intended error rather than a secondary logging error.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">field_nifti</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field file not found: </span><span class="si">{</span><span class="n">field_nifti</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Set up logger - use provided logger or create a new one</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Create a child logger to distinguish voxel analyzer logs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;voxel_analyzer&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create our own logger if none provided</span>
        <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>

        <span class="c1"># Extract subject ID from subject_dir (e.g., m2m_subject -&gt; subject)</span>
        <span class="n">subject_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span>

        <span class="c1"># Create derivatives/ti-toolbox/logs/sub-* directory structure</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">get_path_manager</span><span class="p">()</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;ti_logs&quot;</span><span class="p">,</span> <span class="n">subject_id</span><span class="o">=</span><span class="n">subject_id</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create log file in the new directory</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;voxel_analyzer_</span><span class="si">{</span><span class="n">time_stamp</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging_util</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;voxel_analyzer&#39;</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Initialize visualizer with logger</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="o">=</span> <span class="n">VoxelVisualizer</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

    <span class="c1"># Create output directory if it doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Voxel analyzer initialized successfully&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field NIfTI path: </span><span class="si">{</span><span class="n">field_nifti</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject directory: </span><span class="si">{</span><span class="n">subject_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_cortex" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">analyze_cortex</span>


<a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_cortex" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">analyze_cortex</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="n">region_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atlas_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Analyze a field scan within a specific cortical region defined in an atlas.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/voxel_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_cortex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="n">region_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atlas_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze a field scan within a specific cortical region defined in an atlas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract atlas type from filename</span>
    <span class="n">atlas_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_atlas_type</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>

    <span class="c1"># Load the atlas and field data if not provided</span>
    <span class="k">if</span> <span class="n">atlas_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading atlas from </span><span class="si">{</span><span class="n">atlas_file</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">atlas_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_brain_image</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
        <span class="n">atlas_img</span><span class="p">,</span> <span class="n">atlas_arr</span> <span class="o">=</span> <span class="n">atlas_tuple</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Unpack the tuple</span>
        <span class="n">atlas_img</span><span class="p">,</span> <span class="n">atlas_arr</span> <span class="o">=</span> <span class="n">atlas_data</span>

    <span class="k">if</span> <span class="n">field_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading field from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">field_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_brain_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span>
        <span class="n">field_img</span><span class="p">,</span> <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_tuple</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Unpack the tuple</span>
        <span class="n">field_img</span><span class="p">,</span> <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_data</span>

    <span class="c1"># Handle 4D field data (extract first volume if multiple volumes)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected 4D field data with shape </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">field_shape_3d</span> <span class="o">=</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># If time dimension is 1, we can simply reshape to 3D</span>
        <span class="k">if</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reshaping 4D field data to 3D&quot;</span><span class="p">)</span>
            <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;4D field has </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> volumes. Using only the first volume.&quot;</span><span class="p">)</span>
            <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field_shape_3d</span> <span class="o">=</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Compare spatial dimensions for atlas and field</span>
    <span class="k">if</span> <span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">field_shape_3d</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Atlas and field dimensions don&#39;t match, attempting to resample...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atlas shape: </span><span class="si">{</span><span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field shape: </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Resample the atlas to match the field data, passing atlas_file</span>
        <span class="n">atlas_img</span><span class="p">,</span> <span class="n">atlas_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample_to_match</span><span class="p">(</span>
            <span class="n">atlas_img</span><span class="p">,</span>
            <span class="n">field_shape_3d</span><span class="p">,</span>  <span class="c1"># Use only the spatial dimensions</span>
            <span class="n">field_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
            <span class="n">source_path</span><span class="o">=</span><span class="n">atlas_file</span>  <span class="c1"># Pass the atlas file path</span>
        <span class="p">)</span>

        <span class="c1"># Verify the resampling worked</span>
        <span class="k">if</span> <span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">field_shape_3d</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to resample atlas to match field dimensions: </span><span class="si">{</span><span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">field_shape_3d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Atlas and field dimensions already match - skipping resampling&quot;</span><span class="p">)</span>

    <span class="c1"># Load region information if not provided</span>
    <span class="k">if</span> <span class="n">region_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">region_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atlas_regions</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>

    <span class="c1"># Determine region ID based on target_region</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finding region information for </span><span class="si">{</span><span class="n">target_region</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">region_id</span><span class="p">,</span> <span class="n">region_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_region</span><span class="p">(</span><span class="n">target_region</span><span class="p">,</span> <span class="n">region_info</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Create mask for this region</span>
    <span class="n">region_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">atlas_arr</span> <span class="o">==</span> <span class="n">region_id</span><span class="p">)</span>

    <span class="c1"># Check if the mask contains any voxels</span>
    <span class="n">mask_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">region_mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">) contains 0 voxels in the atlas&quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="c1"># Save results to CSV even if empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="c1"># Filter for voxels with positive values</span>
    <span class="n">value_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">region_mask</span> <span class="o">&amp;</span> <span class="n">value_mask</span>

    <span class="c1"># Extract field values after filtering</span>
    <span class="n">field_values</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>

    <span class="c1"># Check if any voxels remain after filtering</span>
    <span class="n">filtered_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filtered_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">) has no voxels with positive values&quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="c1"># Save results to CSV even if empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating statistics...&quot;</span><span class="p">)</span>
    <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>
    <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>

    <span class="n">whole_brain_positive_mask</span> <span class="o">=</span> <span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">gm_values</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">]</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_roi_metrics</span><span class="p">(</span>
        <span class="n">field_values</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="n">ti_field_gm</span><span class="o">=</span><span class="n">gm_values</span><span class="p">,</span>
        <span class="n">gm_volumes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gm_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">mean_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImean_ROI&quot;</span><span class="p">]</span>
    <span class="n">focality</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Focality&quot;</span><span class="p">)</span>
    <span class="n">whole_brain_average</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TImean_GM&quot;</span><span class="p">)</span>

    <span class="c1"># Log the whole brain average for debugging</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Whole brain average (denominator for focality): </span><span class="si">{</span><span class="n">whole_brain_average</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Prepare results dictionary</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="n">mean_value</span><span class="p">,</span>
        <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="p">,</span>
        <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="p">,</span>
        <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="n">focality</span><span class="p">,</span>
        <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="n">filtered_count</span>
    <span class="p">}</span>

    <span class="c1"># Generate visualization if requested</span>
    <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating visualizations...&quot;</span><span class="p">)</span>

        <span class="c1"># Generate focality histogram</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating focality histogram for region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Get voxel dimensions from the field image</span>
            <span class="n">voxel_dims</span> <span class="o">=</span> <span class="n">field_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>

            <span class="c1"># Filter out zero values from whole head data for histogram</span>
            <span class="n">whole_head_positive_mask</span> <span class="o">=</span> <span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">whole_head_filtered</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">whole_head_positive_mask</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">generate_focality_histogram</span><span class="p">(</span>
                <span class="n">whole_head_field_data</span><span class="o">=</span><span class="n">whole_head_filtered</span><span class="p">,</span>
                <span class="n">roi_field_data</span><span class="o">=</span><span class="n">field_values</span><span class="p">,</span>
                <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                <span class="n">roi_field_value</span><span class="o">=</span><span class="n">mean_value</span><span class="p">,</span>
                <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;voxel&#39;</span><span class="p">,</span>
                <span class="n">voxel_dims</span><span class="o">=</span><span class="n">voxel_dims</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate focality histogram for </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create visualization NIfTI file</span>
        <span class="n">viz_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">create_cortex_nifti</span><span class="p">(</span>
            <span class="n">atlas_img</span><span class="o">=</span><span class="n">atlas_img</span><span class="p">,</span>
            <span class="n">atlas_arr</span><span class="o">=</span><span class="n">atlas_arr</span><span class="p">,</span>
            <span class="n">field_arr</span><span class="o">=</span><span class="n">field_arr</span><span class="p">,</span>
            <span class="n">region_id</span><span class="o">=</span><span class="n">region_id</span><span class="p">,</span>
            <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span>
        <span class="p">)</span>

    <span class="c1"># Calculate and save extra focality information for entire field</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating focality metrics for entire field...&quot;</span><span class="p">)</span>

    <span class="c1"># Get voxel dimensions for volume calculations</span>
    <span class="n">voxel_dims</span> <span class="o">=</span> <span class="n">field_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">voxel_volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">voxel_dims</span><span class="p">)</span>  <span class="c1"># Volume of one voxel in mm</span>

    <span class="c1"># Use entire field data (positive values only) for focality calculation</span>
    <span class="n">entire_field_positive</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">focality_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_focality_metrics</span><span class="p">(</span>
        <span class="n">entire_field_positive</span><span class="p">,</span>  <span class="c1"># Use entire field, not just ROI</span>
        <span class="n">voxel_volume</span><span class="p">,</span> 
        <span class="n">region_name</span>
    <span class="p">)</span>

    <span class="c1"># Save results to CSV</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>

    <span class="c1"># Save extra info CSV with focality data</span>
    <span class="k">if</span> <span class="n">focality_info</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_extra_info_to_csv</span><span class="p">(</span><span class="n">focality_info</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>

    <span class="c1"># Return analysis results</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_sphere" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">analyze_sphere</span>


<a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_sphere" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">analyze_sphere</span><span class="p">(</span><span class="n">center_coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Analyze a spherical region of interest from voxel data.</p>
<p>Returns:
    Dictionary containing analysis results or None if no valid voxels found</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/voxel_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span></pre></div></td><td class="code"><div><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center_coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze a spherical region of interest from voxel data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing analysis results or None if no valid voxels found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting spherical ROI analysis (radius=</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">mm) at coordinates </span><span class="si">{</span><span class="n">center_coordinates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Load the NIfTI data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading field data...&quot;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span>
        <span class="n">field_data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

        <span class="c1"># Handle 4D field data (extract first volume if multiple volumes)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get voxel dimensions (for proper distance calculation)</span>
        <span class="n">voxel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span>

        <span class="c1"># Get affine transformation matrix</span>
        <span class="n">affine</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span>

        <span class="c1"># Convert world coordinates to voxel coordinates if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting coordinates and creating ROI mask...&quot;</span><span class="p">)</span>
        <span class="n">inv_affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
        <span class="n">voxel_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">inv_affine</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_coordinates</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[:</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Create coordinate grids for the entire volume</span>
        <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">z_size</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">x_size</span><span class="p">,</span> <span class="p">:</span><span class="n">y_size</span><span class="p">,</span> <span class="p">:</span><span class="n">z_size</span><span class="p">]</span>

        <span class="c1"># Calculate distance from center voxel (using voxel dimensions to account for anisotropy)</span>
        <span class="n">dist_from_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">voxel_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">voxel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">voxel_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">voxel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">((</span><span class="n">z</span> <span class="o">-</span> <span class="n">voxel_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">voxel_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Create the spherical mask</span>
        <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">dist_from_center</span> <span class="o">&lt;=</span> <span class="n">radius</span>

        <span class="c1"># Create mask for non-zero values</span>
        <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">field_data</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Combine masks to get only non-zero values within ROI</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">roi_mask</span> <span class="o">&amp;</span> <span class="n">nonzero_mask</span>

        <span class="c1"># Count voxels in ROI</span>
        <span class="n">roi_voxels_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">)</span>
        <span class="n">total_roi_voxels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span>

        <span class="c1"># Check if we have any voxels in the ROI</span>
        <span class="k">if</span> <span class="n">roi_voxels_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Determine the tissue type from the field NIfTI name</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">tissue_type</span> <span class="o">=</span> <span class="s2">&quot;grey matter&quot;</span> <span class="k">if</span> <span class="s2">&quot;grey&quot;</span> <span class="ow">in</span> <span class="n">field_name</span> <span class="k">else</span> <span class="s2">&quot;white matter&quot;</span> <span class="k">if</span> <span class="s2">&quot;white&quot;</span> <span class="ow">in</span> <span class="n">field_name</span> <span class="k">else</span> <span class="s2">&quot;brain tissue&quot;</span>

            <span class="n">warning_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="se">\033</span><span class="s2">[93m  WARNING: Analysis Failed </span>
<span class="s2"> No valid voxels found in ROI at [</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">], r=</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">mm</span>
<span class="s2"> </span><span class="si">{</span><span class="s2">&quot;ROI not intersecting &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tissue_type</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">total_roi_voxels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;ROI contains only zero/invalid values&quot;</span><span class="si">}</span>
<span class="s2"> </span><span class="si">{</span><span class="s2">&quot;Adjust coordinates/radius&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">total_roi_voxels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;Check field data&quot;</span><span class="si">}</span><span class="s2"> or verify using freeview</span><span class="se">\033</span><span class="s2">[0m&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating statistics...&quot;</span><span class="p">)</span>
        <span class="c1"># Get the field values within the ROI</span>
        <span class="n">roi_values</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>

        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">roi_values</span><span class="p">)</span>
        <span class="n">whole_brain_positive_mask</span> <span class="o">=</span> <span class="n">field_data</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">gm_values</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">]</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_roi_metrics</span><span class="p">(</span>
            <span class="n">roi_values</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roi_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
            <span class="n">ti_field_gm</span><span class="o">=</span><span class="n">gm_values</span><span class="p">,</span>
            <span class="n">gm_volumes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gm_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">mean_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImean_ROI&quot;</span><span class="p">]</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImax_ROI&quot;</span><span class="p">]</span>
        <span class="n">focality</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Focality&quot;</span><span class="p">)</span>
        <span class="n">whole_brain_average</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TImean_GM&quot;</span><span class="p">)</span>

        <span class="c1"># Log the whole brain average for debugging</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Whole brain average (denominator for focality): </span><span class="si">{</span><span class="n">whole_brain_average</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create results dictionary</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="n">mean_value</span><span class="p">,</span>
            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="p">,</span>
            <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="p">,</span>
            <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="n">focality</span><span class="p">,</span>
            <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="n">roi_voxels_count</span>
        <span class="p">}</span>

        <span class="c1"># Generate visualization if requested</span>
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">region_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sphere_x</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_z</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_r</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Create visualization overlay (showing field values only within the sphere)</span>
            <span class="n">vis_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span>
            <span class="n">vis_arr</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>

            <span class="c1"># Save as NIfTI directly to the output directory</span>
            <span class="n">vis_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">affine</span><span class="p">)</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sphere_overlay_</span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">vis_img</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created visualization overlay: </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Visualization requested but only histogram generation is supported</span>

            <span class="c1"># Generate focality histogram if visualizer is available</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating focality histogram for spherical ROI...&quot;</span><span class="p">)</span>
                    <span class="c1"># Get voxel dimensions from the loaded image</span>
                    <span class="n">voxel_dims</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>

                    <span class="c1"># Filter out zero values from whole head data for histogram</span>
                    <span class="n">whole_head_positive_mask</span> <span class="o">=</span> <span class="n">field_data</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">whole_head_filtered</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">whole_head_positive_mask</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">generate_focality_histogram</span><span class="p">(</span>
                        <span class="n">whole_head_field_data</span><span class="o">=</span><span class="n">whole_head_filtered</span><span class="p">,</span>
                        <span class="n">roi_field_data</span><span class="o">=</span><span class="n">roi_values</span><span class="p">,</span>
                        <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                        <span class="n">roi_field_value</span><span class="o">=</span><span class="n">mean_value</span><span class="p">,</span>
                        <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;voxel&#39;</span><span class="p">,</span>
                        <span class="n">voxel_dims</span><span class="o">=</span><span class="n">voxel_dims</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate focality histogram for spherical ROI: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate and save extra focality information for entire volume</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating focality metrics for entire volume...&quot;</span><span class="p">)</span>
        <span class="n">focality_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_focality_metrics</span><span class="p">(</span>
            <span class="n">field_data</span><span class="p">,</span>  <span class="c1"># Use entire volume data</span>
            <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">voxel_size</span><span class="p">),</span>  <span class="c1"># Voxel volume</span>
            <span class="sa">f</span><span class="s2">&quot;sphere_x</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_z</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_r</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Save results to CSV if visualizer is available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">region_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sphere_x</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_z</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_r</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;spherical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>

            <span class="c1"># Save extra info CSV with focality data</span>
            <span class="k">if</span> <span class="n">focality_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_extra_info_to_csv</span><span class="p">(</span><span class="n">focality_info</span><span class="p">,</span> <span class="s1">&#39;spherical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot save results to CSV - VoxelVisualizer not available&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_whole_head" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">analyze_whole_head</span>


<a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_whole_head" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">analyze_whole_head</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Analyze all regions in the specified atlas.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/voxel_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_whole_head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze all regions in the specified atlas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting whole head analysis of atlas: </span><span class="si">{</span><span class="n">atlas_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extract atlas type from filename</span>
    <span class="n">atlas_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_atlas_type</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected atlas type: </span><span class="si">{</span><span class="n">atlas_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load region information once</span>
        <span class="n">region_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atlas_regions</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>

        <span class="c1"># Load atlas and field data once</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading atlas from </span><span class="si">{</span><span class="n">atlas_file</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">atlas_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_brain_image</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
        <span class="n">atlas_img</span><span class="p">,</span> <span class="n">atlas_arr</span> <span class="o">=</span> <span class="n">atlas_tuple</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading field from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">field_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_brain_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span>
        <span class="n">field_img</span><span class="p">,</span> <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_tuple</span>

        <span class="c1"># Handle 4D field data (extract first volume if multiple volumes)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected 4D field data with shape </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">field_shape_3d</span> <span class="o">=</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1"># If time dimension is 1, we can simply reshape to 3D</span>
            <span class="k">if</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reshaping 4D field data to 3D&quot;</span><span class="p">)</span>
                <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;4D field has </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> volumes. Using only the first volume.&quot;</span><span class="p">)</span>
                <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_shape_3d</span> <span class="o">=</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Check if resampling is needed and do it once if necessary</span>
        <span class="k">if</span> <span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">field_shape_3d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Atlas and field dimensions don&#39;t match, attempting to resample...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atlas shape: </span><span class="si">{</span><span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field shape: </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Resample the atlas to match the field data, passing atlas_file</span>
            <span class="n">atlas_img</span><span class="p">,</span> <span class="n">atlas_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample_to_match</span><span class="p">(</span>
                <span class="n">atlas_img</span><span class="p">,</span>
                <span class="n">field_shape_3d</span><span class="p">,</span>  <span class="c1"># Use only the spatial dimensions</span>
                <span class="n">field_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
                <span class="n">source_path</span><span class="o">=</span><span class="n">atlas_file</span>  <span class="c1"># Pass the atlas file path</span>
            <span class="p">)</span>

            <span class="c1"># Verify the resampling worked</span>
            <span class="k">if</span> <span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">field_shape_3d</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to resample atlas to match field dimensions: </span><span class="si">{</span><span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">field_shape_3d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Atlas and field dimensions already match - skipping resampling&quot;</span><span class="p">)</span>

        <span class="n">field_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_img</span><span class="p">,</span> <span class="n">field_arr</span><span class="p">)</span>

        <span class="c1"># Dictionary to store results for each region</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Analyze each region in the atlas</span>
        <span class="k">for</span> <span class="n">region_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">region_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">region_name</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Create a directory for this region in the main output directory</span>
                <span class="n">region_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">region_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Create mask for this region</span>
                <span class="n">region_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">atlas_arr</span> <span class="o">==</span> <span class="n">region_id</span><span class="p">)</span>

                <span class="c1"># Check if the mask contains any voxels</span>
                <span class="n">mask_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">region_mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mask_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">) contains 0 voxels in the atlas&quot;</span><span class="p">)</span>
                    <span class="n">region_results</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="mi">0</span>
                    <span class="p">}</span>

                    <span class="c1"># Store in the overall results</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_results</span>

                    <span class="k">continue</span>

                <span class="c1"># Filter for voxels with positive values</span>
                <span class="n">value_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">region_mask</span> <span class="o">&amp;</span> <span class="n">value_mask</span>

                <span class="c1"># Extract field values after filtering</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>

                <span class="c1"># Check if any voxels remain after filtering</span>
                <span class="n">filtered_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">filtered_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">) has no voxels with positive values&quot;</span><span class="p">)</span>
                    <span class="n">region_results</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="mi">0</span>
                    <span class="p">}</span>

                    <span class="c1"># Store in the overall results</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_results</span>

                    <span class="k">continue</span>

                <span class="c1"># Calculate statistics</span>
                <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>
                <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>

                <span class="n">whole_brain_positive_mask</span> <span class="o">=</span> <span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">gm_values</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">]</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_roi_metrics</span><span class="p">(</span>
                    <span class="n">field_values</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
                    <span class="n">ti_field_gm</span><span class="o">=</span><span class="n">gm_values</span><span class="p">,</span>
                    <span class="n">gm_volumes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gm_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">mean_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImean_ROI&quot;</span><span class="p">]</span>
                <span class="n">focality</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Focality&quot;</span><span class="p">)</span>
                <span class="n">whole_brain_average</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TImean_GM&quot;</span><span class="p">)</span>

                <span class="c1"># Log the whole brain average for debugging</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Whole brain average (denominator for focality): </span><span class="si">{</span><span class="n">whole_brain_average</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Create result dictionary for this region</span>
                <span class="n">region_results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="n">mean_value</span><span class="p">,</span>
                    <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="p">,</span>
                    <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="p">,</span>
                    <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="n">focality</span><span class="p">,</span>
                    <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="n">filtered_count</span>  <span class="c1"># Store the number of voxels</span>
                <span class="p">}</span>

                <span class="c1"># Store in the overall results</span>
                <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_results</span>

                <span class="c1"># Generate visualizations if requested</span>
                <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
                    <span class="c1"># Create visualization NIfTI file directly in the region directory</span>
                    <span class="n">viz_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">_generate_region_visualization</span><span class="p">(</span>
                        <span class="n">atlas_img</span><span class="o">=</span><span class="n">atlas_img</span><span class="p">,</span>
                        <span class="n">atlas_arr</span><span class="o">=</span><span class="n">atlas_arr</span><span class="p">,</span>
                        <span class="n">field_arr</span><span class="o">=</span><span class="n">field_arr</span><span class="p">,</span>
                        <span class="n">region_id</span><span class="o">=</span><span class="n">region_id</span><span class="p">,</span>
                        <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                        <span class="n">output_dir</span><span class="o">=</span><span class="n">region_dir</span>
                    <span class="p">)</span>

                    <span class="c1"># Generate focality histogram for this region</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating focality histogram for region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="c1"># Get voxel dimensions from the field image</span>
                            <span class="n">field_img_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_brain_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span>
                            <span class="n">voxel_dims</span> <span class="o">=</span> <span class="n">field_img_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>

                            <span class="c1"># Filter out zero values from whole head data for histogram</span>
                            <span class="n">whole_head_positive_mask</span> <span class="o">=</span> <span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span>
                            <span class="n">whole_head_filtered</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">whole_head_positive_mask</span><span class="p">]</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">generate_focality_histogram</span><span class="p">(</span>
                                <span class="n">whole_head_field_data</span><span class="o">=</span><span class="n">whole_head_filtered</span><span class="p">,</span>
                                <span class="n">roi_field_data</span><span class="o">=</span><span class="n">field_values</span><span class="p">,</span>
                                <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                                <span class="n">roi_field_value</span><span class="o">=</span><span class="n">mean_value</span><span class="p">,</span>
                                <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;voxel&#39;</span><span class="p">,</span>
                                <span class="n">voxel_dims</span><span class="o">=</span><span class="n">voxel_dims</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate focality histogram for </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to analyze region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="mi">0</span>
                <span class="p">}</span>

        <span class="c1"># Generate global visualization plots are disabled - only histograms are generated per region</span>

            <span class="c1"># Generate and save summary CSV</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_whole_head_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">atlas_type</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up all temporary data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">atlas_arr</span>
            <span class="k">del</span> <span class="n">field_arr</span>
            <span class="k">del</span> <span class="n">region_info</span>
            <span class="k">if</span> <span class="s1">&#39;atlas_tuple&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">atlas_tuple</span>
            <span class="k">if</span> <span class="s1">&#39;field_tuple&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">field_tuple</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="c1"># Variables may not be defined if cleanup failed earlier</span>
            <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.voxel_analyzer.VoxelAnalyzer.find_region" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">find_region</span>


<a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.find_region" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">find_region</span><span class="p">(</span><span class="n">target_region</span><span class="p">,</span> <span class="n">region_info</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Find region ID and name based on input.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>target_region</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target region name or ID</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>region_info</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with region information</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(region_id, region_name)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/voxel_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="n">region_info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find region ID and name based on input.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    target_region : str or int</span>
<span class="sd">        Target region name or ID</span>
<span class="sd">    region_info : dict</span>
<span class="sd">        Dictionary with region information</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (region_id, region_name)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if target_region is an ID (int) or can be converted to one</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">region_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_region</span><span class="p">)</span>
        <span class="c1"># If it&#39;s an ID, get the name from region_info if available</span>
        <span class="k">if</span> <span class="n">region_info</span> <span class="ow">and</span> <span class="n">region_id</span> <span class="ow">in</span> <span class="n">region_info</span><span class="p">:</span>
            <span class="n">region_name</span> <span class="o">=</span> <span class="n">region_info</span><span class="p">[</span><span class="n">region_id</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">region_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">region_id</span><span class="p">,</span> <span class="n">region_name</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># target_region is a string name, need to find the corresponding ID</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">region_info</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Region labels are required to look up regions by name&quot;</span><span class="p">)</span>

        <span class="c1"># Search for the region name (case-insensitive)</span>
        <span class="n">target_lower</span> <span class="o">=</span> <span class="n">target_region</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">region_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">region_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">target_lower</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">region_id</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

        <span class="c1"># If we get here, region name was not found</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region name &#39;</span><span class="si">{</span><span class="n">target_region</span><span class="si">}</span><span class="s2">&#39; not found in region labels&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_atlas_regions" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_atlas_regions</span>


<a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_atlas_regions" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_atlas_regions</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Extract region information from atlas file using FreeSurfer's mri_segstats.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>atlas_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the atlas file (.nii or .mgz)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping region IDs to region information</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/voxel_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_atlas_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract region information from atlas file using FreeSurfer&#39;s mri_segstats.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atlas_file : str</span>
<span class="sd">        Path to the atlas file (.nii or .mgz)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary mapping region IDs to region information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">region_info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Get the atlas name from the file path</span>
    <span class="n">atlas_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
    <span class="n">atlas_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">atlas_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Remove extension</span>
    <span class="k">if</span> <span class="n">atlas_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nii&#39;</span><span class="p">):</span>  <span class="c1"># Handle .nii.gz case</span>
        <span class="n">atlas_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">atlas_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get the FreeSurfer subject directory (parent of mri directory)</span>
    <span class="n">mri_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
    <span class="n">freesurfer_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">mri_dir</span><span class="p">)</span>

    <span class="c1"># Define the output file path in the mri directory</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mri_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atlas_name</span><span class="si">}</span><span class="s2">_labels.txt&quot;</span><span class="p">)</span>

    <span class="c1"># Create mri directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mri_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Function to generate the labels file</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_labels_file</span><span class="p">():</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;mri_segstats&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--seg&#39;</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">,</span>
            <span class="s1">&#39;--excludeid&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>  <span class="c1"># Exclude background</span>
            <span class="s1">&#39;--ctab-default&#39;</span><span class="p">,</span>    <span class="c1"># Use default color table</span>
            <span class="s1">&#39;--sum&#39;</span><span class="p">,</span> <span class="n">output_file</span>
        <span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not extract region information using mri_segstats: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command output: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">stdout</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command error: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Function to parse the labels file</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_labels_file</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># Skip header lines (all lines starting with #)</span>
                <span class="n">in_header</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># Check if we&#39;ve reached the end of the header</span>
                    <span class="k">if</span> <span class="n">in_header</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                        <span class="n">in_header</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># Process data lines (non-header)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_header</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                        <span class="c1"># The format is:</span>
                        <span class="c1"># Index SegId NVoxels Volume_mm3 StructName</span>
                        <span class="c1"># We need at least 5 columns</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">region_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># SegId is the second column</span>
                                <span class="n">n_voxels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>   <span class="c1"># NVoxels is the third column</span>

                                <span class="c1"># Structure name can contain spaces, so join the remaining parts</span>
                                <span class="n">region_name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>

                                <span class="c1"># Generate a random color based on region_id for visualization</span>
                                <span class="c1"># This creates a consistent color for each region</span>
                                <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
                                <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">region_id</span><span class="p">)</span>
                                <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
                                <span class="n">g</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
                                <span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>

                                <span class="n">region_info</span><span class="p">[</span><span class="n">region_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">region_name</span><span class="p">,</span>
                                    <span class="s1">&#39;voxel_count&#39;</span><span class="p">:</span> <span class="n">n_voxels</span><span class="p">,</span>
                                    <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                                <span class="p">}</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not parse line: </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">region_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading labels file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Try to use existing file first</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found existing labels file: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parse_labels_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully parsed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">region_info</span><span class="p">)</span><span class="si">}</span><span class="s2"> regions from existing file&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">region_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Existing file is invalid or empty, regenerating...&quot;</span><span class="p">)</span>

    <span class="c1"># Generate new file if needed</span>
    <span class="k">if</span> <span class="n">generate_labels_file</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">parse_labels_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully generated and parsed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">region_info</span><span class="p">)</span><span class="si">}</span><span class="s2"> regions&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">region_info</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning: Could not get region information from atlas file&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">region_info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_grey_matter_statistics" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_grey_matter_statistics</span>


<a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_grey_matter_statistics" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_grey_matter_statistics</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Calculate grey matter field statistics from the NIfTI data.</p>
<p>Returns:
    dict: Dictionary containing grey matter statistics (mean, max, min)</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/voxel_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_grey_matter_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate grey matter field statistics from the NIfTI data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing grey matter statistics (mean, max, min)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating grey matter field statistics...&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load the field data</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span>
        <span class="n">field_data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

        <span class="c1"># Handle 4D field data (extract first volume if multiple volumes)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># For voxel analysis, we assume the entire field is grey matter</span>
        <span class="c1"># (since we&#39;re typically working with grey matter NIfTI files)</span>
        <span class="c1"># Filter for positive values only (matching ROI analysis behavior)</span>
        <span class="n">positive_mask</span> <span class="o">=</span> <span class="n">field_data</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">field_data_positive</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>

        <span class="c1"># Check if we have any positive values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_data_positive</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No positive values found in grey matter data&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

        <span class="c1"># Calculate statistics on positive values only</span>
        <span class="n">grey_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">field_data_positive</span><span class="p">)</span>
        <span class="n">grey_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field_data_positive</span><span class="p">)</span>
        <span class="n">grey_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_data_positive</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grey matter statistics for field &#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; (positive values only): &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;mean=</span><span class="si">{</span><span class="n">grey_mean</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">grey_max</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">grey_min</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_mean</span><span class="p">),</span>
            <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_max</span><span class="p">),</span>
            <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_min</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating grey matter statistics: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.voxel_analyzer.VoxelAnalyzer.load_brain_image" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">load_brain_image</span>


<a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.load_brain_image" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_brain_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load brain image data from file, handling different formats.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the image file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(nibabel image object, numpy array of data)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/voxel_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_brain_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load brain image data from file, handling different formats.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_path : str</span>
<span class="sd">        Path to the image file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (nibabel image object, numpy array of data)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_ext</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">file_ext</span> <span class="o">==</span> <span class="s1">&#39;.mgz&#39;</span><span class="p">:</span>
        <span class="c1"># Try to use nibabel directly first</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load MGZ file directly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Try to convert MGZ to NIfTI using mri_convert</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create a temporary file for the converted image</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp</span><span class="p">:</span>
                    <span class="n">temp_path</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">name</span>

                <span class="c1"># Run mri_convert to convert MGZ to NIfTI</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mri_convert&#39;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">temp_path</span><span class="p">]</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Load the converted file</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

                <span class="c1"># Clean up</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">data</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to convert MGZ file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For NIfTI and other formats, use nibabel directly</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tit.analyzer.voxel_analyzer.VoxelAnalyzer.resample_to_match" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">resample_to_match</span>


<a href="#tit.analyzer.voxel_analyzer.VoxelAnalyzer.resample_to_match" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">resample_to_match</span><span class="p">(</span><span class="n">source_img</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">,</span> <span class="n">target_affine</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Resample source image to match target dimensions and affine using FreeSurfer's mri_convert.</p>
<p>If a resampled version already exists, it will be loaded instead of generating a new one.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source_img</code>
            </td>
            <td>
                  <code><span title="nibabel.Nifti1Image">Nifti1Image</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Source image to resample</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_shape</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target shape (x, y, z) or (x, y, z, t)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_affine</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target affine transformation matrix</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the source file. If provided, will be used to generate a resampled file name.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(resampled nibabel image, resampled data array)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/voxel_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">resample_to_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_img</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">,</span> <span class="n">target_affine</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resample source image to match target dimensions and affine using FreeSurfer&#39;s mri_convert.</span>

<span class="sd">    If a resampled version already exists, it will be loaded instead of generating a new one.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source_img : nibabel.Nifti1Image</span>
<span class="sd">        Source image to resample</span>
<span class="sd">    target_shape : tuple</span>
<span class="sd">        Target shape (x, y, z) or (x, y, z, t)</span>
<span class="sd">    target_affine : numpy.ndarray</span>
<span class="sd">        Target affine transformation matrix</span>
<span class="sd">    source_path : str, optional</span>
<span class="sd">        Path to the source file. If provided, will be used to generate a resampled file name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (resampled nibabel image, resampled data array)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resampling image from shape </span><span class="si">{</span><span class="n">source_img</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">target_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># If source_path is provided, try to find an existing resampled file</span>
    <span class="k">if</span> <span class="n">source_path</span><span class="p">:</span>
        <span class="n">resampled_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resampled_atlas_filename</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">resampled_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found existing resampled atlas: </span><span class="si">{</span><span class="n">resampled_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resampled_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resampled_path</span><span class="p">)</span>
                <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

                <span class="c1"># Check if the resampled image has the correct shape</span>
                <span class="k">if</span> <span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loaded previously resampled atlas&quot;</span><span class="p">)</span>

                    <span class="c1"># If target is 4D but resampled is 3D, reshape it to match</span>
                    <span class="n">is_target_4d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
                    <span class="k">if</span> <span class="n">is_target_4d</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reshaping 3D data </span><span class="si">{</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to match 4D target </span><span class="si">{</span><span class="n">target_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Add a dimension to match the 4D target shape</span>
                        <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

                        <span class="c1"># Create a new 4D NIfTI image</span>
                        <span class="n">new_header</span> <span class="o">=</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">new_header</span><span class="o">.</span><span class="n">set_data_shape</span><span class="p">(</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                        <span class="n">resampled_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">,</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">new_header</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">resampled_img</span><span class="p">,</span> <span class="n">resampled_data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Existing resampled atlas has wrong shape: </span><span class="si">{</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs expected </span><span class="si">{</span><span class="n">target_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading existing resampled atlas: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will generate a new one&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating new resampled atlas...&quot;</span><span class="p">)</span>

    <span class="c1"># If target shape is 4D but source is 3D, we need to handle this specially</span>
    <span class="n">is_target_4d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
    <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">target_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Extract just the spatial dimensions</span>

    <span class="c1"># Create a temporary file for the target template</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_template</span><span class="p">:</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="n">temp_template</span><span class="o">.</span><span class="n">name</span>

    <span class="c1"># Create a temporary file for the resampled output</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_output</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">temp_output</span><span class="o">.</span><span class="n">name</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Save the source image to a temporary file if not provided</span>
        <span class="k">if</span> <span class="n">source_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source_path</span><span class="p">):</span>
            <span class="c1"># Use the provided source path</span>
            <span class="n">temp_source_created</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Save the source image to a temporary file</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_source</span><span class="p">:</span>
                <span class="n">source_path</span> <span class="o">=</span> <span class="n">temp_source</span><span class="o">.</span><span class="n">name</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">source_img</span><span class="p">,</span> <span class="n">source_path</span><span class="p">)</span>
                <span class="n">temp_source_created</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Create a template image with target dimensions (3D only)</span>
        <span class="n">template_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">),</span> <span class="n">target_affine</span><span class="p">)</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">template_img</span><span class="p">,</span> <span class="n">template_path</span><span class="p">)</span>

        <span class="c1"># Run mri_convert to resample the image</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;mri_convert&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--reslice_like&#39;</span><span class="p">,</span> <span class="n">template_path</span><span class="p">,</span>  <span class="c1"># Use template for resampling</span>
            <span class="n">source_path</span><span class="p">,</span>                      <span class="c1"># Source image</span>
            <span class="n">output_path</span>                       <span class="c1"># Output image</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Load the resampled image</span>
        <span class="n">resampled_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

        <span class="c1"># If target is 4D but resampled is 3D, reshape it to match</span>
        <span class="k">if</span> <span class="n">is_target_4d</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reshaping 3D data </span><span class="si">{</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to match 4D target </span><span class="si">{</span><span class="n">target_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Add a dimension to match the 4D target shape</span>
            <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Create a new 4D NIfTI image</span>
            <span class="n">new_header</span> <span class="o">=</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_header</span><span class="o">.</span><span class="n">set_data_shape</span><span class="p">(</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">resampled_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">,</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">new_header</span><span class="p">)</span>

        <span class="c1"># Save the resampled atlas for future use if source_path was provided and not temporary</span>
        <span class="k">if</span> <span class="n">source_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">temp_source_created</span><span class="p">:</span>
            <span class="n">resampled_save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resampled_atlas_filename</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving resampled atlas for future use: </span><span class="si">{</span><span class="n">resampled_save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">resampled_img</span><span class="p">,</span> <span class="n">resampled_save_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resampling complete&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resampled_img</span><span class="p">,</span> <span class="n">resampled_data</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up temporary files</span>
        <span class="k">for</span> <span class="n">temp_file</span> <span class="ow">in</span> <span class="p">[</span><span class="n">template_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
                <span class="c1"># Best-effort cleanup - file may already be deleted</span>
                <span class="k">pass</span>

        <span class="c1"># Also remove temporary source file if we created it</span>
        <span class="k">if</span> <span class="s1">&#39;temp_source_created&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">temp_source_created</span> <span class="ow">and</span> <span class="s1">&#39;source_path&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
                <span class="c1"># Best-effort cleanup - file may already be deleted</span>
                <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="group-analyzer-titanalyzergroup_analyzer">Group analyzer (<code>tit.analyzer.group_analyzer</code>)<a class="headerlink" href="#group-analyzer-titanalyzergroup_analyzer" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="tit.analyzer.group_analyzer"></a>
    <div class="doc doc-contents first">

        <p>Group Analyzer Script</p>
<p>Each subject's analysis will be saved under:
    derivatives/SimNIBS/<subject_id>/Simulations/<montage_name>/Analyses/<Mesh-or-Voxel>/</p>
<p>Within each subject's Analyses folder, we also capture:
  - overlays &amp; plots (via --visualize)
  - CSV summary  (handled by main_analyzer.py)
  - centralized group analysis log file (all subjects logged together)</p>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.build_main_analyzer_command" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_main_analyzer_command</span>


<a href="#tit.analyzer.group_analyzer.build_main_analyzer_command" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">build_main_analyzer_command</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">subject_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">subject_output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build the command to run main_analyzer.py for a single subject,
matching the exact structure used in analyzer_tab.py.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_main_analyzer_command</span><span class="p">(</span>
    <span class="n">args</span><span class="p">,</span>
    <span class="n">subject_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">subject_output_dir</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build the command to run main_analyzer.py for a single subject,</span>
<span class="sd">    matching the exact structure used in analyzer_tab.py.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">group_logger</span>

    <span class="n">subject_id</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m2m_path</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">field_path</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Locate main_analyzer.py (assume it sits next to this script)</span>
    <span class="n">script_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
    <span class="n">main_analyzer_path</span> <span class="o">=</span> <span class="n">script_dir</span> <span class="o">/</span> <span class="s2">&quot;main_analyzer.py&quot;</span>

    <span class="c1"># Use `simnibs_python` as the interpreter (matching analyzer_tab.py)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;simnibs_python&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">main_analyzer_path</span><span class="p">)]</span>

    <span class="c1"># Add arguments in the same order as analyzer_tab.py</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--m2m_subject_path&quot;</span><span class="p">,</span> <span class="n">m2m_path</span><span class="p">]</span>

    <span class="c1"># For mesh analysis, field_path is the montage name directly</span>
    <span class="c1"># For voxel analysis, field_path is the actual file path</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">:</span>
        <span class="c1"># field_path is already the montage name</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--montage_name&quot;</span><span class="p">,</span> <span class="n">field_path</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--field_path&quot;</span><span class="p">,</span> <span class="n">field_path</span><span class="p">]</span>

    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--space&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">space</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--analysis_type&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span><span class="p">]</span>

    <span class="c1"># Analysis-type-specific flags</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span><span class="p">:</span>
        <span class="c1"># Pass coordinates and coordinate space - let main_analyzer.py handle transformation</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--coordinates&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">coordinates</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--coordinate-space&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">coordinate_space</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--radius&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">radius</span><span class="p">)]</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># cortical</span>
        <span class="c1"># For cortical, add atlas info first</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--atlas_name&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">atlas_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># voxel</span>
            <span class="n">atlas_path</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--atlas_path&quot;</span><span class="p">,</span> <span class="n">atlas_path</span><span class="p">]</span>

        <span class="c1"># Then add region or whole_head flag</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">whole_head</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--whole_head&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--region&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">region</span><span class="p">]</span>

    <span class="c1"># Field name is now hardcoded in main_analyzer.py, no need to pass it</span>

    <span class="c1"># Add output directory</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--output_dir&quot;</span><span class="p">,</span> <span class="n">subject_output_dir</span><span class="p">]</span>

    <span class="c1"># Always enable visualizations (matching the request)</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--visualize&quot;</span><span class="p">]</span>

    <span class="c1"># Add group analysis log file path if available</span>
    <span class="k">if</span> <span class="n">group_logger</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">group_logger</span><span class="p">,</span> <span class="s1">&#39;handlers&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">group_logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
        <span class="c1"># Get the log file path from the first handler</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">group_logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s1">&#39;baseFilename&#39;</span><span class="p">):</span>
                <span class="n">log_file_path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s1">&#39;baseFilename&#39;</span><span class="p">)</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--log_file&quot;</span><span class="p">,</span> <span class="n">log_file_path</span><span class="p">]</span>
                <span class="k">break</span>

    <span class="c1"># Add quiet flag if requested</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--quiet&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cmd</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.collect_analysis_paths" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">collect_analysis_paths</span>


<a href="#tit.analyzer.group_analyzer.collect_analysis_paths" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">collect_analysis_paths</span><span class="p">(</span><span class="n">successful_dirs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Each entry in successful_dirs is exactly the folder we passed to --output_dir
for main_analyzer.py. We check that it contains at least one .csv before returning it.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">collect_analysis_paths</span><span class="p">(</span><span class="n">successful_dirs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Each entry in successful_dirs is exactly the folder we passed to --output_dir</span>
<span class="sd">    for main_analyzer.py. We check that it contains at least one .csv before returning it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">group_logger</span>

    <span class="n">analysis_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">successful_dirs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">csv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">csv_list</span><span class="p">:</span>
                <span class="n">analysis_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group_logger</span><span class="p">:</span>
                    <span class="n">group_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No CSV found under </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group_logger</span><span class="p">:</span>
                <span class="n">group_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected analysis directory not found: </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">analysis_paths</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.compute_subject_output_dir" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">compute_subject_output_dir</span>


<a href="#tit.analyzer.group_analyzer.compute_subject_output_dir" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">compute_subject_output_dir</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">subject_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Create a consistent output directory structure for analysis results.
Structure: output_dir/sub-{subject_id}/Simulations/{montage_name}/Analyses/{Mesh|Voxel}/{analysis_name}</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_subject_output_dir</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">subject_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a consistent output directory structure for analysis results.</span>
<span class="sd">    Structure: output_dir/sub-{subject_id}/Simulations/{montage_name}/Analyses/{Mesh|Voxel}/{analysis_name}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subject_id</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># For mesh analysis, field_path is the montage name</span>
    <span class="c1"># For voxel analysis, we need to extract montage name from field path</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">:</span>
        <span class="n">montage_name</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># field_path is montage name for mesh</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For voxel analysis, extract montage name from path structure</span>
        <span class="n">field_path</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path_parts</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span>
            <span class="n">sim_idx</span> <span class="o">=</span> <span class="n">path_parts</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Simulations&#39;</span><span class="p">)</span>
            <span class="n">montage_name</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="n">sim_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="c1"># If we can&#39;t parse the path, use a default montage name</span>
            <span class="n">montage_name</span> <span class="o">=</span> <span class="s1">&#39;unknown_montage&#39;</span>

    <span class="c1"># Build consistent directory structure</span>
    <span class="n">space_dir</span> <span class="o">=</span> <span class="s1">&#39;Mesh&#39;</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span> <span class="k">else</span> <span class="s1">&#39;Voxel&#39;</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{</span><span class="n">subject_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Simulations&#39;</span><span class="p">,</span> <span class="n">montage_name</span><span class="p">,</span> <span class="s1">&#39;Analyses&#39;</span><span class="p">,</span> <span class="n">space_dir</span><span class="p">)</span>

    <span class="c1"># Create analysis-specific directory name</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span><span class="p">:</span>
        <span class="n">coord_space_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">coordinate_space</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">coordinates</span><span class="p">]</span>
        <span class="n">analysis_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sphere_x</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_z</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_r</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">radius</span><span class="si">}{</span><span class="n">coord_space_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># cortical</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">whole_head</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">:</span>
                <span class="n">analysis_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;whole_head_</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">atlas_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atlas_path</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">atlas_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">atlas_path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">analysis_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;whole_head_</span><span class="si">{</span><span class="n">atlas_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">analysis_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;region_</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">analysis_name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_dir</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.create_group_output_directory" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">create_group_output_directory</span>


<a href="#tit.analyzer.group_analyzer.create_group_output_directory" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">create_group_output_directory</span><span class="p">(</span><span class="n">first_subject_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Create centralized group analysis output directory.</p>
<p>Args:
    first_subject_path (str): Path from the first subject to extract project name</p>
<p>Returns:
    str: Path to the created group analysis directory</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_group_output_directory</span><span class="p">(</span><span class="n">first_subject_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create centralized group analysis output directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        first_subject_path (str): Path from the first subject to extract project name</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the created group analysis directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">group_logger</span>

    <span class="c1"># Extract project name from the first subject&#39;s path</span>
    <span class="n">project_name</span> <span class="o">=</span> <span class="n">_extract_project_name</span><span class="p">(</span><span class="n">first_subject_path</span><span class="p">)</span>

    <span class="c1"># No longer create centralized group analysis directory under SimNIBS</span>
    <span class="c1"># Individual subject analyses are stored in their respective subject directories</span>
    <span class="c1"># Group comparisons will be stored in the user-specified output directory</span>

    <span class="k">if</span> <span class="n">group_logger</span><span class="p">:</span>
        <span class="n">group_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using project: </span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Return a placeholder path - not actually used since we don&#39;t create central directories</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;/mnt/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">/derivatives/SimNIBS&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.determine_group_subfolder_name" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">determine_group_subfolder_name</span>


<a href="#tit.analyzer.group_analyzer.determine_group_subfolder_name" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">determine_group_subfolder_name</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">first_subject_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Determine the group subfolder name in format: {montage}_{roi}</p>
<p>Args:
    args: Command line arguments
    first_subject_args: First subject's arguments to extract montage info</p>
<p>Returns:
    str: Subfolder name like "montage_roi"</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">determine_group_subfolder_name</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">first_subject_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the group subfolder name in format: {montage}_{roi}</span>

<span class="sd">    Args:</span>
<span class="sd">        args: Command line arguments</span>
<span class="sd">        first_subject_args: First subject&#39;s arguments to extract montage info</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Subfolder name like &quot;montage_roi&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract montage name from field path</span>
    <span class="n">field_path</span> <span class="o">=</span> <span class="n">first_subject_args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">path_parts</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Locate &quot;Simulations&quot; in the file path</span>
        <span class="n">sim_idx</span> <span class="o">=</span> <span class="n">path_parts</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Simulations&#39;</span><span class="p">)</span>
        <span class="c1"># Montage name is the folder immediately after &quot;Simulations&quot;</span>
        <span class="n">montage_name</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="n">sim_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
        <span class="c1"># If &quot;Simulations&quot; not found in path, try to extract from filename</span>
        <span class="n">field_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
        <span class="k">if</span> <span class="n">field_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_TINormal&#39;</span><span class="p">):</span>
            <span class="n">montage_name</span> <span class="o">=</span> <span class="n">field_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_TINormal&#39;</span><span class="p">,</span> <span class="s1">&#39;Normal&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_TI_Normal&#39;</span><span class="p">):</span>
            <span class="n">montage_name</span> <span class="o">=</span> <span class="n">field_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_TI_Normal&#39;</span><span class="p">,</span> <span class="s1">&#39;_Normal&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_TI&#39;</span><span class="p">):</span>
            <span class="n">montage_name</span> <span class="o">=</span> <span class="n">field_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_TI&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">montage_name</span> <span class="o">=</span> <span class="n">field_filename</span>

    <span class="c1"># Determine ROI description</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span><span class="p">:</span>
        <span class="n">roi_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sphere_r</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># cortical</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">whole_head</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">:</span>
                <span class="n">roi_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;whole_head_</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">atlas_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># voxel</span>
                <span class="n">atlas_path</span> <span class="o">=</span> <span class="n">first_subject_args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_subject_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="s2">&quot;unknown_atlas&quot;</span>
                <span class="n">atlas_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">atlas_path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">atlas_path</span> <span class="o">!=</span> <span class="s2">&quot;unknown_atlas&quot;</span> <span class="k">else</span> <span class="s2">&quot;unknown_atlas&quot;</span>
                <span class="n">roi_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;whole_head_</span><span class="si">{</span><span class="n">atlas_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi_desc</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">region</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">montage_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">roi_desc</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.format_duration" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">format_duration</span>


<a href="#tit.analyzer.group_analyzer.format_duration" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">format_duration</span><span class="p">(</span><span class="n">total_seconds</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Format duration in human-readable format.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">format_duration</span><span class="p">(</span><span class="n">total_seconds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format duration in human-readable format.&quot;&quot;&quot;</span>
    <span class="n">total_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_seconds</span><span class="p">)</span>
    <span class="n">hours</span> <span class="o">=</span> <span class="n">total_seconds</span> <span class="o">//</span> <span class="mi">3600</span>
    <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_seconds</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span>
    <span class="n">seconds</span> <span class="o">=</span> <span class="n">total_seconds</span> <span class="o">%</span> <span class="mi">60</span>

    <span class="k">if</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">h </span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s2">m </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2">s&quot;</span>
    <span class="k">elif</span> <span class="n">minutes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s2">m </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2">s&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2">s&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.log_group_analysis_complete" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">log_group_analysis_complete</span>


<a href="#tit.analyzer.group_analyzer.log_group_analysis_complete" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">log_group_analysis_complete</span><span class="p">(</span><span class="n">num_successful</span><span class="p">,</span> <span class="n">num_total</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Log the completion of group analysis.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_group_analysis_complete</span><span class="p">(</span><span class="n">num_successful</span><span class="p">,</span> <span class="n">num_total</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log the completion of group analysis.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_group_start_time</span><span class="p">,</span> <span class="n">SUMMARY_MODE</span>

    <span class="k">if</span> <span class="n">_group_start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">total_duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">_group_start_time</span>
        <span class="n">duration_str</span> <span class="o">=</span> <span class="n">format_duration</span><span class="p">(</span><span class="n">total_duration</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">SUMMARY_MODE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_successful</span> <span class="o">==</span> <span class="n">num_total</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Group analysis completed (</span><span class="si">{</span><span class="n">num_successful</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_total</span><span class="si">}</span><span class="s2"> subjects successful, Total: </span><span class="si">{</span><span class="n">duration_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Group analysis completed with failures (</span><span class="si">{</span><span class="n">num_successful</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_total</span><span class="si">}</span><span class="s2"> subjects successful, Total: </span><span class="si">{</span><span class="n">duration_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
                <span class="c1"># Show relative path from /mnt/ for cleaner display</span>
                <span class="n">display_path</span> <span class="o">=</span> <span class="n">output_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/mnt/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">output_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/mnt/&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">output_path</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Group results saved to: </span><span class="si">{</span><span class="n">display_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.log_group_analysis_start" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">log_group_analysis_start</span>


<a href="#tit.analyzer.group_analyzer.log_group_analysis_start" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">log_group_analysis_start</span><span class="p">(</span><span class="n">num_subjects</span><span class="p">,</span> <span class="n">analysis_description</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Log the start of group analysis.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_group_analysis_start</span><span class="p">(</span><span class="n">num_subjects</span><span class="p">,</span> <span class="n">analysis_description</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log the start of group analysis.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_group_start_time</span><span class="p">,</span> <span class="n">SUMMARY_MODE</span>
    <span class="n">_group_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">SUMMARY_MODE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Beginning group analysis for </span><span class="si">{</span><span class="n">num_subjects</span><span class="si">}</span><span class="s2"> subjects (</span><span class="si">{</span><span class="n">analysis_description</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.log_group_subject_status" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">log_group_subject_status</span>


<a href="#tit.analyzer.group_analyzer.log_group_subject_status" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">log_group_subject_status</span><span class="p">(</span><span class="n">subject_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">duration_str</span><span class="p">,</span> <span class="n">error_msg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Log the status of a subject in group analysis.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_group_subject_status</span><span class="p">(</span><span class="n">subject_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">duration_str</span><span class="p">,</span> <span class="n">error_msg</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log the status of a subject in group analysis.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">SUMMARY_MODE</span>

    <span class="k">if</span> <span class="n">SUMMARY_MODE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;complete&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Subject </span><span class="si">{</span><span class="n">subject_id</span><span class="si">}</span><span class="s2">:  Complete (</span><span class="si">{</span><span class="n">duration_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Subject </span><span class="si">{</span><span class="n">subject_id</span><span class="si">}</span><span class="s2">:  Failed (</span><span class="si">{</span><span class="n">duration_str</span><span class="si">}</span><span class="s2">) - </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.run_comprehensive_group_analysis" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_comprehensive_group_analysis</span>


<a href="#tit.analyzer.group_analyzer.run_comprehensive_group_analysis" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_comprehensive_group_analysis</span><span class="p">(</span><span class="n">analysis_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">project_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run comprehensive group analysis using all available comparison methods.</p>
<p>Args:
    analysis_paths (List[str]): List of paths to individual subject analysis directories
    project_name (str, optional): Project name. If None, extracted from first path.</p>
<p>Returns:
    str: Path to the group analysis output directory</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_comprehensive_group_analysis</span><span class="p">(</span><span class="n">analysis_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">project_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run comprehensive group analysis using all available comparison methods.</span>

<span class="sd">    Args:</span>
<span class="sd">        analysis_paths (List[str]): List of paths to individual subject analysis directories</span>
<span class="sd">        project_name (str, optional): Project name. If None, extracted from first path.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the group analysis output directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">group_logger</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">analysis_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">group_logger</span><span class="p">:</span>
            <span class="n">group_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No analysis paths provided for group comparison.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">group_logger</span><span class="p">:</span>
        <span class="n">group_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Running comprehensive group analysis on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> analyses ===&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use the comprehensive comparison function from compare_analyses.py</span>
        <span class="n">group_output_dir</span> <span class="o">=</span> <span class="n">run_all_group_comparisons</span><span class="p">(</span><span class="n">analysis_paths</span><span class="p">,</span> <span class="n">project_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_logger</span><span class="p">:</span>
            <span class="n">group_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Comprehensive group analysis completed successfully.&quot;</span><span class="p">)</span>
            <span class="n">group_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  All results saved to: </span><span class="si">{</span><span class="n">group_output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">group_output_dir</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">group_logger</span><span class="p">:</span>
            <span class="n">group_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Group analysis failed with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.run_subject_analysis" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_subject_analysis</span>


<a href="#tit.analyzer.group_analyzer.run_subject_analysis" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_subject_analysis</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">subject_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run analysis for a single subject and return (success, output_dir).
All output is logged to the centralized group analysis log file.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_subject_analysis</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">subject_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run analysis for a single subject and return (success, output_dir).</span>
<span class="sd">    All output is logged to the centralized group analysis log file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">group_logger</span>

    <span class="n">subject_id</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m2m_path</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">field_path</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Compute the target output folder for this subject</span>
    <span class="n">subject_output_dir</span> <span class="o">=</span> <span class="n">compute_subject_output_dir</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">subject_args</span><span class="p">)</span>

    <span class="c1"># Build the command</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">build_main_analyzer_command</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">subject_args</span><span class="p">,</span> <span class="n">subject_output_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group_logger</span><span class="p">:</span>
        <span class="n">group_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting analysis for subject: </span><span class="si">{</span><span class="n">subject_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Track timing for subject analysis</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Run main_analyzer.py with real-time output streaming</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="c1"># In summary mode, stream output in real-time to show task steps as they happen</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> 
                               <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Stream output in real-time</span>
        <span class="n">output_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">output_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="c1"># Display task steps in real-time</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Beginning analysis for subject:&#39;</span><span class="p">):</span>
                        <span class="c1"># This is the subject start message, display it with proper indentation</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
                        <span class="c1"># This is a task step, display it with proper indentation</span>
                        <span class="n">clean_line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># Remove the tree symbols</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">clean_line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;Starting...&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;Subject&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># Skip the &quot;Subject X: Starting...&quot; line as it&#39;s already shown</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="s1">&#39; Complete&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39; Failed&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># Skip completion lines as they&#39;re handled separately</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="s1">&#39;Analysis completed successfully&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># Skip the final completion message as it&#39;s handled separately</span>
                        <span class="k">continue</span>

        <span class="c1"># Wait for process to complete</span>
        <span class="n">return_code</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">stdout_output</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_lines</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># In debug mode, capture output as before</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">return_code</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span>
        <span class="n">stdout_output</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
    <span class="n">duration_str</span> <span class="o">=</span> <span class="n">format_duration</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">group_logger</span><span class="p">:</span>
            <span class="n">group_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject </span><span class="si">{</span><span class="n">subject_id</span><span class="si">}</span><span class="s2"> analysis completed successfully&quot;</span><span class="p">)</span>

        <span class="c1"># Log subject status for summary</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_group_subject_status</span><span class="p">(</span><span class="n">subject_id</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="n">duration_str</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">subject_output_dir</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">group_logger</span><span class="p">:</span>
            <span class="n">group_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject </span><span class="si">{</span><span class="n">subject_id</span><span class="si">}</span><span class="s2"> analysis failed&quot;</span><span class="p">)</span>
            <span class="c1"># Log any additional error output that might not have been captured by main_analyzer.py</span>
            <span class="k">if</span> <span class="n">stdout_output</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">group_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;stdout: </span><span class="si">{</span><span class="n">stdout_output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># For streaming mode, stderr is redirected to stdout, so no separate stderr handling needed</span>

        <span class="c1"># Extract meaningful error message for summary</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stdout_output</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="c1"># Look for error patterns in stdout</span>
            <span class="n">stdout_lines</span> <span class="o">=</span> <span class="n">stdout_output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout_lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;error:&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;exception&#39;</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span><span class="p">]):</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">break</span>

        <span class="c1"># Log subject status for summary</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_group_subject_status</span><span class="p">(</span><span class="n">subject_id</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="n">duration_str</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.setup_parser" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">setup_parser</span>


<a href="#tit.analyzer.group_analyzer.setup_parser" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">setup_parser</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set up command line argument parser.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">setup_parser</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up command line argument parser.&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run analysis across multiple subjects and compare results&quot;</span><span class="p">)</span>

    <span class="c1"># Analysis parameters (same as main_analyzer.py)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--space&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Analysis space: mesh or voxel&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--analysis_type&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;spherical&#39;</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of analysis to perform&quot;</span><span class="p">)</span>

    <span class="c1"># Analysisspecific parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--atlas_name&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Atlas name for mesh-based cortical analysis (e.g., DK40)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--coordinates&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;x y z coordinates for spherical analysis&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--coordinate-space&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MNI&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Coordinate space of the input coordinates (MNI or subject) - required for spherical analysis&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--radius&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Radius for spherical analysis&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--region&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Region name for cortical analysis&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--whole_head&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Analyze the whole head instead of a specific region&quot;</span><span class="p">)</span>

    <span class="c1"># Subject specification; for voxelcortical we expect an extra atlas_path</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--subject&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;ARG&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Subject specification: subject_id m2m_path field_path [atlas_path] &quot;</span>
                             <span class="s2">&quot;(atlas_path required for voxel-based cortical analysis)&quot;</span><span class="p">)</span>

    <span class="c1"># Output and comparison options</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output_dir&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory for legacy group analysis outputs (comprehensive results go to centralized location)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable summary mode for clean output (non-debug mode)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no-compare&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Skip comparison analysis after all subjects are processed (comparison runs by default)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--visualize&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Generate visualization outputs for each analysis&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.analyzer.group_analyzer.validate_args" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">validate_args</span>


<a href="#tit.analyzer.group_analyzer.validate_args" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">validate_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Validate command line arguments.</p>

            <details class="quote">
              <summary>Source code in <code>tit/analyzer/group_analyzer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate command line arguments.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">subject</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one --subject must be specified&quot;</span><span class="p">)</span>

    <span class="c1"># Validate analysisspecific arguments</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;spherical&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinates are required for spherical analysis&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Radius is required for spherical analysis&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">coordinate_space</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate space (--coordinate-space) is required for spherical analysis&quot;</span><span class="p">)</span>

        <span class="c1"># Spherical: each subject must supply exactly (id, m2m_path, field_path)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subject_args</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">subject</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subject_args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Subject </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Spherical analysis requires exactly 3 arguments: &quot;</span>
                    <span class="s2">&quot;subject_id m2m_path field_path&quot;</span>
                <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># cortical</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">atlas_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Atlas name is required for mesh-based cortical analysis&quot;</span><span class="p">)</span>
            <span class="c1"># Meshcortical: each subject still has (id, m2m_path, field_path)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subject_args</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">subject</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subject_args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Subject </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Mesh cortical analysis requires exactly 3 arguments: &quot;</span>
                        <span class="s2">&quot;subject_id m2m_path field_path&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Voxelcortical: each subject must supply (id, m2m_path, field_path, atlas_path)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subject_args</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">subject</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subject_args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Subject </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Voxel cortical analysis requires exactly 4 arguments: &quot;</span>
                        <span class="s2">&quot;subject_id m2m_path field_path atlas_path&quot;</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">whole_head</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">region</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either --whole_head flag or --region must be specified for cortical analysis&quot;</span><span class="p">)</span>

    <span class="c1"># Validate spacespecific: mesh needs a field_name (now hardcoded)</span>
    <span class="c1"># Field name is now hardcoded to &quot;TI_max&quot;, no validation needed</span>

    <span class="c1"># Validate existence of provided paths</span>
    <span class="k">for</span> <span class="n">subject_args</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">subject</span><span class="p">:</span>
        <span class="n">subject_id</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">m2m_path</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">field_path</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">m2m_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject </span><span class="si">{</span><span class="n">subject_id</span><span class="si">}</span><span class="s2"> m2m directory not found: </span><span class="si">{</span><span class="n">m2m_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># For mesh analysis, field_path is actually a montage name, not a file path</span>
        <span class="c1"># Skip file existence check for mesh analysis</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">space</span> <span class="o">!=</span> <span class="s1">&#39;mesh&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">field_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject </span><span class="si">{</span><span class="n">subject_id</span><span class="si">}</span><span class="s2"> field file not found: </span><span class="si">{</span><span class="n">field_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;voxel&#39;</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;cortical&#39;</span><span class="p">:</span>
            <span class="n">atlas_path</span> <span class="o">=</span> <span class="n">subject_args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">atlas_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject </span><span class="si">{</span><span class="n">subject_id</span><span class="si">}</span><span class="s2"> atlas file not found: </span><span class="si">{</span><span class="n">atlas_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.sections", "navigation.expand", "toc.follow"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>