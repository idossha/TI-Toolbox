
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Python API reference for the Temporal Interference Toolbox">
      
      
      
        <link rel="canonical" href="https://idossha.github.io/TI-Toolbox/api/reference/stats/">
      
      
        <link rel="prev" href="../opt/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Statistics - TI-Toolbox API</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#statistics-titstats" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="TI-Toolbox API" class="md-header__button md-logo" aria-label="TI-Toolbox API" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TI-Toolbox API
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Statistics
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="TI-Toolbox API" class="md-nav__button md-logo" aria-label="TI-Toolbox API" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    TI-Toolbox API
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simulation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analyzer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Analyzer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../opt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Statistics
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Statistics
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tit.stats" class="md-nav__link">
    <span class="md-ellipsis">
      stats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.atlas_overlap_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      atlas_overlap_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.cluster_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      cluster_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.cluster_based_correction" class="md-nav__link">
    <span class="md-ellipsis">
      cluster_based_correction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.correlation_cluster_correction" class="md-nav__link">
    <span class="md-ellipsis">
      correlation_cluster_correction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.correlation_voxelwise" class="md-nav__link">
    <span class="md-ellipsis">
      correlation_voxelwise
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.generate_correlation_summary" class="md-nav__link">
    <span class="md-ellipsis">
      generate_correlation_summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.generate_summary" class="md-nav__link">
    <span class="md-ellipsis">
      generate_summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.get_path_manager" class="md-nav__link">
    <span class="md-ellipsis">
      get_path_manager
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.load_subject_data" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.load_subject_data_correlation" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data_correlation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.load_subject_data_group_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data_group_comparison
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.plot_cluster_size_mass_correlation" class="md-nav__link">
    <span class="md-ellipsis">
      plot_cluster_size_mass_correlation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.plot_permutation_null_distribution" class="md-nav__link">
    <span class="md-ellipsis">
      plot_permutation_null_distribution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.prepare_config_from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_config_from_csv
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.run_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      run_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.setup_logging" class="md-nav__link">
    <span class="md-ellipsis">
      setup_logging
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.ttest_voxelwise" class="md-nav__link">
    <span class="md-ellipsis">
      ttest_voxelwise
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#permutation-analysis-titstatspermutation_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Permutation analysis (tit.stats.permutation_analysis)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      permutation_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.load_subject_data" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.load_subject_data_correlation" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data_correlation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.load_subject_data_group_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data_group_comparison
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.prepare_config_from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_config_from_csv
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.run_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      run_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.setup_logging" class="md-nav__link">
    <span class="md-ellipsis">
      setup_logging
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tit.stats" class="md-nav__link">
    <span class="md-ellipsis">
      stats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.atlas_overlap_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      atlas_overlap_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.cluster_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      cluster_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.cluster_based_correction" class="md-nav__link">
    <span class="md-ellipsis">
      cluster_based_correction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.correlation_cluster_correction" class="md-nav__link">
    <span class="md-ellipsis">
      correlation_cluster_correction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.correlation_voxelwise" class="md-nav__link">
    <span class="md-ellipsis">
      correlation_voxelwise
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.generate_correlation_summary" class="md-nav__link">
    <span class="md-ellipsis">
      generate_correlation_summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.generate_summary" class="md-nav__link">
    <span class="md-ellipsis">
      generate_summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.get_path_manager" class="md-nav__link">
    <span class="md-ellipsis">
      get_path_manager
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.load_subject_data" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.load_subject_data_correlation" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data_correlation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.load_subject_data_group_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data_group_comparison
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.plot_cluster_size_mass_correlation" class="md-nav__link">
    <span class="md-ellipsis">
      plot_cluster_size_mass_correlation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.plot_permutation_null_distribution" class="md-nav__link">
    <span class="md-ellipsis">
      plot_permutation_null_distribution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.prepare_config_from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_config_from_csv
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.run_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      run_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.setup_logging" class="md-nav__link">
    <span class="md-ellipsis">
      setup_logging
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.ttest_voxelwise" class="md-nav__link">
    <span class="md-ellipsis">
      ttest_voxelwise
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#permutation-analysis-titstatspermutation_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Permutation analysis (tit.stats.permutation_analysis)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      permutation_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.load_subject_data" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.load_subject_data_correlation" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data_correlation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.load_subject_data_group_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      load_subject_data_group_comparison
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.prepare_config_from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_config_from_csv
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.run_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      run_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tit.stats.permutation_analysis.setup_logging" class="md-nav__link">
    <span class="md-ellipsis">
      setup_logging
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="statistics-titstats">Statistics (<code>tit.stats</code>)<a class="headerlink" href="#statistics-titstats" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<a id="tit.stats"></a>
    <div class="doc doc-contents first">

        <p>Statistical analysis utilities for TI-Toolbox.</p>
<p>This package includes permutation testing, atlas-based posthoc analyses,
and reporting/visualization helpers.</p>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="tit.stats.atlas_overlap_analysis" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">atlas_overlap_analysis</span>


<a href="#tit.stats.atlas_overlap_analysis" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">atlas_overlap_analysis</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">,</span> <span class="n">atlas_files</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">reference_img</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Analyze overlap between significant voxels and atlas regions</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>sig_mask : ndarray (x, y, z)
    Binary mask of significant voxels
atlas_files : list of str
    List of atlas file names
data_dir : str
    Directory containing atlas files
reference_img : nibabel image, optional
    Reference image for resampling
verbose : bool
    Print progress information</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>results : dict
    Dictionary mapping atlas names to DataFrames of region overlap statistics</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/atlas_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">atlas_overlap_analysis</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">,</span> <span class="n">atlas_files</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">reference_img</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze overlap between significant voxels and atlas regions</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    sig_mask : ndarray (x, y, z)</span>
<span class="sd">        Binary mask of significant voxels</span>
<span class="sd">    atlas_files : list of str</span>
<span class="sd">        List of atlas file names</span>
<span class="sd">    data_dir : str</span>
<span class="sd">        Directory containing atlas files</span>
<span class="sd">    reference_img : nibabel image, optional</span>
<span class="sd">        Reference image for resampling</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Print progress information</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    results : dict</span>
<span class="sd">        Dictionary mapping atlas names to DataFrames of region overlap statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ATLAS OVERLAP ANALYSIS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">atlas_file</span> <span class="ow">in</span> <span class="n">atlas_files</span><span class="p">:</span>
        <span class="n">atlas_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">atlas_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Atlas file not found - </span><span class="si">{</span><span class="n">atlas_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- </span><span class="si">{</span><span class="n">atlas_file</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
        <span class="n">atlas_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">atlas_path</span><span class="p">)</span>

        <span class="c1"># Check dimensions and resample if needed</span>
        <span class="k">if</span> <span class="n">reference_img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atlas_data</span> <span class="o">=</span> <span class="n">check_and_resample_atlas</span><span class="p">(</span><span class="n">atlas_img</span><span class="p">,</span> <span class="n">reference_img</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atlas_data</span> <span class="o">=</span> <span class="n">atlas_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Get unique regions (excluding 0 = background)</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">atlas_data</span><span class="p">[</span><span class="n">atlas_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">region_counts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">region_id</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
            <span class="n">region_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">atlas_data</span> <span class="o">==</span> <span class="n">region_id</span><span class="p">)</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_mask</span> <span class="o">&amp;</span> <span class="n">region_mask</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">region_counts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;region_id&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">region_id</span><span class="p">),</span>
                    <span class="s1">&#39;overlap_voxels&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">overlap</span><span class="p">),</span>
                    <span class="s1">&#39;region_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">region_mask</span><span class="p">))</span>
                <span class="p">})</span>

        <span class="c1"># Sort by overlap count</span>
        <span class="n">region_counts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">region_counts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;overlap_voxels&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top regions by significant voxel count:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">region_counts</span><span class="p">[:</span><span class="mi">15</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;overlap_voxels&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;region_size&#39;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">. Region </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;region_id&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;overlap_voxels&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> sig. voxels &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of region)&quot;</span><span class="p">)</span>

        <span class="n">results</span><span class="p">[</span><span class="n">atlas_file</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_counts</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.cluster_analysis" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">cluster_analysis</span>


<a href="#tit.stats.cluster_analysis" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">cluster_analysis</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Perform cluster analysis on significant voxels</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>sig_mask : ndarray (x, y, z)
    Binary mask of significant voxels
affine : ndarray
    Affine transformation matrix
verbose : bool
    Print progress information</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>clusters : list of dict
    Cluster information including size, center of mass in voxel and MNI coordinates</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/stats_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cluster_analysis</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform cluster analysis on significant voxels</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    sig_mask : ndarray (x, y, z)</span>
<span class="sd">        Binary mask of significant voxels</span>
<span class="sd">    affine : ndarray</span>
<span class="sd">        Affine transformation matrix</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Print progress information</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    clusters : list of dict</span>
<span class="sd">        Cluster information including size, center of mass in voxel and MNI coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing cluster analysis...&quot;</span><span class="p">)</span>

    <span class="c1"># Find connected clusters</span>
    <span class="n">labeled_array</span><span class="p">,</span> <span class="n">num_clusters</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_clusters</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No clusters found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_clusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cluster_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labeled_array</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">)</span>
        <span class="n">cluster_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cluster_mask</span><span class="p">)</span>

        <span class="c1"># Get center of mass in voxel coordinates</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">cluster_mask</span><span class="p">)</span>
        <span class="n">com_voxel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Convert to MNI coordinates</span>
        <span class="n">com_mni</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">affines</span><span class="o">.</span><span class="n">apply_affine</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">com_voxel</span><span class="p">)</span>

        <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;cluster_id&#39;</span><span class="p">:</span> <span class="n">cluster_id</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">cluster_size</span><span class="p">,</span>
            <span class="s1">&#39;center_voxel&#39;</span><span class="p">:</span> <span class="n">com_voxel</span><span class="p">,</span>
            <span class="s1">&#39;center_mni&#39;</span><span class="p">:</span> <span class="n">com_mni</span>
        <span class="p">})</span>

    <span class="c1"># Sort by size</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_clusters</span><span class="si">}</span><span class="s2"> clusters&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># Show top 10</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> voxels, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;MNI center: (</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clusters</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.cluster_based_correction" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">cluster_based_correction</span>


<a href="#tit.stats.cluster_based_correction" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">cluster_based_correction</span><span class="p">(</span><span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">,</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">valid_mask</span><span class="p">,</span> <span class="n">cluster_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">n_permutations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">test_type</span><span class="o">=</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span> <span class="n">cluster_stat</span><span class="o">=</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="n">t_statistics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_permutation_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">permutation_log_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subject_ids_resp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subject_ids_non_resp</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Apply cluster-based permutation correction for multiple comparisons</p>
<p>This implements the cluster-based approach commonly used in neuroimaging.
Tests all valid voxels in permutations and uses parallel processing for speed.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>responders : ndarray (x, y, z, n_subjects)
    Responder data
non_responders : ndarray (x, y, z, n_subjects)
    Non-responder data
p_values : ndarray (x, y, z)
    Uncorrected p-values from initial test
valid_mask : ndarray (x, y, z)
    Boolean mask of valid voxels
cluster_threshold : float
    Initial p-value threshold for cluster formation (uncorrected)
n_permutations : int
    Number of permutations for null distribution (500-1000 recommended)
alpha : float
    Significance level for cluster-level correction
test_type : str
    Either 'paired' or 'unpaired' t-test for permutations
alternative : {'two-sided', 'greater', 'less'}, optional
    Alternative hypothesis (default: 'two-sided')
cluster_stat : {'size', 'mass'}, optional
    Cluster statistic to use (default: 'size'):
    * 'size': count of contiguous significant voxels
    * 'mass': sum of t-statistics in contiguous significant voxels
t_statistics : ndarray (x, y, z), optional
    T-statistics from initial test (required if cluster_stat='mass')
n_jobs : int
    Number of parallel jobs. -1 uses all available CPU cores. 1 disables parallelization.
verbose : bool
    Print progress information
logger : logging.Logger, optional
    Logger instance for output (default: None)
save_permutation_log : bool, optional
    If True, save detailed permutation information to file (default: False)
permutation_log_file : str, optional
    Path to save permutation log. If None and save_permutation_log=True, 
    will use default name
subject_ids_resp : list, optional
    List of responder subject IDs (for logging)
subject_ids_non_resp : list, optional
    List of non-responder subject IDs (for logging)</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>sig_mask : ndarray (x, y, z)
    Binary mask of significant voxels
cluster_stat_threshold : float
    Cluster statistic threshold from permutation distribution
sig_clusters : list of dict
    Information about significant clusters
null_max_cluster_stats : ndarray
    Maximum cluster statistics from permutation null distribution
cluster_stats : list of dict
    All clusters from observed data (for plotting)
correlation_data : dict
    Dictionary with 'sizes' and 'masses' arrays for correlation analysis</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/stats_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cluster_based_correction</span><span class="p">(</span><span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">,</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">valid_mask</span><span class="p">,</span>
                            <span class="n">cluster_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">n_permutations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                            <span class="n">test_type</span><span class="o">=</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span> <span class="n">cluster_stat</span><span class="o">=</span><span class="s1">&#39;size&#39;</span><span class="p">,</span>
                            <span class="n">t_statistics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_permutation_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">permutation_log_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">subject_ids_resp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subject_ids_non_resp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply cluster-based permutation correction for multiple comparisons</span>

<span class="sd">    This implements the cluster-based approach commonly used in neuroimaging.</span>
<span class="sd">    Tests all valid voxels in permutations and uses parallel processing for speed.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    responders : ndarray (x, y, z, n_subjects)</span>
<span class="sd">        Responder data</span>
<span class="sd">    non_responders : ndarray (x, y, z, n_subjects)</span>
<span class="sd">        Non-responder data</span>
<span class="sd">    p_values : ndarray (x, y, z)</span>
<span class="sd">        Uncorrected p-values from initial test</span>
<span class="sd">    valid_mask : ndarray (x, y, z)</span>
<span class="sd">        Boolean mask of valid voxels</span>
<span class="sd">    cluster_threshold : float</span>
<span class="sd">        Initial p-value threshold for cluster formation (uncorrected)</span>
<span class="sd">    n_permutations : int</span>
<span class="sd">        Number of permutations for null distribution (500-1000 recommended)</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Significance level for cluster-level correction</span>
<span class="sd">    test_type : str</span>
<span class="sd">        Either &#39;paired&#39; or &#39;unpaired&#39; t-test for permutations</span>
<span class="sd">    alternative : {&#39;two-sided&#39;, &#39;greater&#39;, &#39;less&#39;}, optional</span>
<span class="sd">        Alternative hypothesis (default: &#39;two-sided&#39;)</span>
<span class="sd">    cluster_stat : {&#39;size&#39;, &#39;mass&#39;}, optional</span>
<span class="sd">        Cluster statistic to use (default: &#39;size&#39;):</span>
<span class="sd">        * &#39;size&#39;: count of contiguous significant voxels</span>
<span class="sd">        * &#39;mass&#39;: sum of t-statistics in contiguous significant voxels</span>
<span class="sd">    t_statistics : ndarray (x, y, z), optional</span>
<span class="sd">        T-statistics from initial test (required if cluster_stat=&#39;mass&#39;)</span>
<span class="sd">    n_jobs : int</span>
<span class="sd">        Number of parallel jobs. -1 uses all available CPU cores. 1 disables parallelization.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Print progress information</span>
<span class="sd">    logger : logging.Logger, optional</span>
<span class="sd">        Logger instance for output (default: None)</span>
<span class="sd">    save_permutation_log : bool, optional</span>
<span class="sd">        If True, save detailed permutation information to file (default: False)</span>
<span class="sd">    permutation_log_file : str, optional</span>
<span class="sd">        Path to save permutation log. If None and save_permutation_log=True, </span>
<span class="sd">        will use default name</span>
<span class="sd">    subject_ids_resp : list, optional</span>
<span class="sd">        List of responder subject IDs (for logging)</span>
<span class="sd">    subject_ids_non_resp : list, optional</span>
<span class="sd">        List of non-responder subject IDs (for logging)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    sig_mask : ndarray (x, y, z)</span>
<span class="sd">        Binary mask of significant voxels</span>
<span class="sd">    cluster_stat_threshold : float</span>
<span class="sd">        Cluster statistic threshold from permutation distribution</span>
<span class="sd">    sig_clusters : list of dict</span>
<span class="sd">        Information about significant clusters</span>
<span class="sd">    null_max_cluster_stats : ndarray</span>
<span class="sd">        Maximum cluster statistics from permutation null distribution</span>
<span class="sd">    cluster_stats : list of dict</span>
<span class="sd">        All clusters from observed data (for plotting)</span>
<span class="sd">    correlation_data : dict</span>
<span class="sd">        Dictionary with &#39;sizes&#39; and &#39;masses&#39; arrays for correlation analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.io_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_permutation_details</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">io_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_permutation_details</span>

    <span class="c1"># Validate cluster_stat parameter</span>
    <span class="k">if</span> <span class="n">cluster_stat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cluster_stat must be &#39;size&#39; or &#39;mass&#39;, got &#39;</span><span class="si">{</span><span class="n">cluster_stat</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Check that t_statistics is provided if using cluster mass</span>
    <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span> <span class="ow">and</span> <span class="n">t_statistics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;t_statistics must be provided when cluster_stat=&#39;mass&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="se">\n</span><span class="s2">CLUSTER-BASED PERMUTATION CORRECTION</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">cluster_stat_name</span> <span class="o">=</span> <span class="s2">&quot;Cluster Size&quot;</span> <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="k">else</span> <span class="s2">&quot;Cluster Mass&quot;</span>
        <span class="n">config_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cluster statistic: </span><span class="si">{</span><span class="n">cluster_stat_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">Cluster-forming threshold: p &lt; </span><span class="si">{</span><span class="n">cluster_threshold</span><span class="si">}</span><span class="se">\n</span><span class="s2">Number of permutations: </span><span class="si">{</span><span class="n">n_permutations</span><span class="si">}</span><span class="se">\n</span><span class="s2">Cluster-level alpha: </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">config_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">config_info</span><span class="p">)</span>

    <span class="c1"># Step 1: Form clusters based on initial threshold</span>
    <span class="n">initial_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_values</span> <span class="o">&lt;</span> <span class="n">cluster_threshold</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">valid_mask</span>
    <span class="n">labeled_array</span><span class="p">,</span> <span class="n">n_clusters</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">initial_mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found </span><span class="si">{</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2"> clusters at p &lt; </span><span class="si">{</span><span class="n">cluster_threshold</span><span class="si">}</span><span class="s2"> (uncorrected)&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_clusters</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No clusters found. Try increasing cluster_threshold (e.g., 0.05)&quot;</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># Return all 6 expected values with empty/default data</span>
        <span class="n">empty_correlation_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;sizes&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
            <span class="s1">&#39;masses&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">p_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="n">cluster_threshold</span><span class="p">,</span> <span class="p">[],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="p">[],</span> <span class="n">empty_correlation_data</span>

    <span class="c1"># Calculate cluster statistics efficiently without storing all clusters</span>
    <span class="k">if</span> <span class="n">n_clusters</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">warning_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WARNING: Found </span><span class="si">{</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2"> clusters! This is unusually high.</span><span class="se">\n</span><span class="s2">Consider:</span><span class="se">\n</span><span class="s2">  1. Using a stricter cluster_threshold (e.g., 0.01 instead of 0.05)</span><span class="se">\n</span><span class="s2">  2. Checking if your data is properly masked</span><span class="se">\n</span><span class="s2">  3. Verifying your p-values are computed correctly&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>

    <span class="c1"># Find top clusters for display without storing all in memory</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finding largest clusters for summary...&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">top_clusters</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Find top 10 clusters by their statistic</span>
        <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_clusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">cluster_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labeled_array</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cluster_mask</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Only multi-voxel clusters</span>
                <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
                    <span class="n">stat_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span>
                    <span class="n">stat_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t_statistics</span><span class="p">[</span><span class="n">cluster_mask</span><span class="p">]))</span>

                <span class="c1"># Keep only top 10</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_clusters</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">top_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cluster_id</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">stat_value</span><span class="p">))</span>
                    <span class="n">top_clusters</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">stat_value</span> <span class="o">&gt;</span> <span class="n">top_clusters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">top_clusters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">stat_value</span><span class="p">)</span>
                    <span class="n">top_clusters</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">top_clusters</span><span class="p">:</span>
            <span class="c1"># Show summary of top clusters</span>
            <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">top_clusters</span><span class="p">)</span><span class="si">}</span><span class="s2"> clusters (largest: </span><span class="si">{</span><span class="n">top_clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> voxels)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">top_clusters</span><span class="p">)</span><span class="si">}</span><span class="s2"> clusters (largest mass: </span><span class="si">{</span><span class="n">top_clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>

            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">stat_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_clusters</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Cluster </span><span class="si">{</span><span class="n">cid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> voxels&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Cluster </span><span class="si">{</span><span class="n">cid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> voxels, mass = </span><span class="si">{</span><span class="n">stat_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No multi-voxel clusters found&quot;</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Step 2: Test all valid voxels in permutations</span>
    <span class="n">test_mask</span> <span class="o">=</span> <span class="n">valid_mask</span>
    <span class="n">test_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">test_mask</span><span class="p">)</span>
    <span class="n">n_test_voxels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_coords</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Testing all </span><span class="si">{</span><span class="n">n_test_voxels</span><span class="si">}</span><span class="s2"> valid voxels in permutations&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Step 3: Permutation testing</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running </span><span class="si">{</span><span class="n">n_permutations</span><span class="si">}</span><span class="s2"> permutations...&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Combine all subjects</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n_resp</span> <span class="o">=</span> <span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n_non_resp</span> <span class="o">=</span> <span class="n">non_responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n_total</span> <span class="o">=</span> <span class="n">n_resp</span> <span class="o">+</span> <span class="n">n_non_resp</span>

    <span class="c1"># Pre-extract data for test voxels</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Pre-extracting voxel data for faster permutations...</span><span class="se">\n</span><span class="s2">  Test voxels: </span><span class="si">{</span><span class="n">n_test_voxels</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="se">\n</span><span class="s2">  Total subjects: </span><span class="si">{</span><span class="n">n_total</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Use float32 to save memory</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_test_voxels</span><span class="p">,</span> <span class="n">n_total</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_coords</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">test_data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Free the original combined data array</span>
    <span class="k">del</span> <span class="n">all_data</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Report memory usage</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">test_data_mb</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  Test data size: </span><span class="si">{</span><span class="n">test_data_mb</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Determine number of jobs</span>
    <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-detected </span><span class="si">{</span><span class="n">n_jobs</span><span class="si">}</span><span class="s2"> CPU cores&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running permutations sequentially (1 core)...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running permutations in parallel using </span><span class="si">{</span><span class="n">n_jobs</span><span class="si">}</span><span class="s2"> cores...&quot;</span><span class="p">)</span>

    <span class="c1"># Run permutations in parallel</span>
    <span class="c1"># Use seeds for reproducibility</span>
    <span class="n">seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_permutations</span><span class="p">)</span>

    <span class="c1"># Determine if we need to track permutation indices</span>
    <span class="n">track_indices</span> <span class="o">=</span> <span class="n">save_permutation_log</span> <span class="ow">and</span> <span class="n">subject_ids_resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">subject_ids_non_resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Sequential execution with progress bar</span>
        <span class="n">null_max_cluster_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">null_max_cluster_sizes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">null_max_cluster_masses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">permutation_indices</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">track_indices</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_permutations</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Permutations&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_permutations</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">_run_single_permutation</span><span class="p">(</span>
                <span class="n">test_data</span><span class="p">,</span> <span class="n">test_coords</span><span class="p">,</span> <span class="n">n_resp</span><span class="p">,</span> <span class="n">n_total</span><span class="p">,</span>
                <span class="n">cluster_threshold</span><span class="p">,</span> <span class="n">valid_mask</span><span class="p">,</span> <span class="n">p_values</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">test_type</span><span class="o">=</span><span class="n">test_type</span><span class="p">,</span>
                <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span>
                <span class="n">cluster_stat</span><span class="o">=</span><span class="n">cluster_stat</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="n">seeds</span><span class="p">[</span><span class="n">perm</span><span class="p">],</span>
                <span class="n">return_indices</span><span class="o">=</span><span class="n">track_indices</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">track_indices</span><span class="p">:</span>
                <span class="n">max_stat</span><span class="p">,</span> <span class="n">perm_idx</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">max_mass</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">null_max_cluster_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_stat</span><span class="p">)</span>
                <span class="n">null_max_cluster_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_size</span><span class="p">)</span>
                <span class="n">null_max_cluster_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_mass</span><span class="p">)</span>
                <span class="n">permutation_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perm_idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_stat</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">max_mass</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">null_max_cluster_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_stat</span><span class="p">)</span>
                <span class="n">null_max_cluster_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_size</span><span class="p">)</span>
                <span class="n">null_max_cluster_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_mass</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Parallel execution using joblib - same as local implementation</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using joblib with </span><span class="si">{</span><span class="n">n_jobs</span><span class="si">}</span><span class="s2"> processes...&quot;</span><span class="p">)</span>

        <span class="c1"># Run permutations with joblib</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">_run_single_permutation</span><span class="p">)(</span>
                <span class="n">test_data</span><span class="p">,</span> <span class="n">test_coords</span><span class="p">,</span> <span class="n">n_resp</span><span class="p">,</span> <span class="n">n_total</span><span class="p">,</span>
                <span class="n">cluster_threshold</span><span class="p">,</span> <span class="n">valid_mask</span><span class="p">,</span> <span class="n">p_values</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">test_type</span><span class="o">=</span><span class="n">test_type</span><span class="p">,</span>
                <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span>
                <span class="n">cluster_stat</span><span class="o">=</span><span class="n">cluster_stat</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="n">seeds</span><span class="p">[</span><span class="n">perm</span><span class="p">],</span>
                <span class="n">return_indices</span><span class="o">=</span><span class="n">track_indices</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_permutations</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Clean up parallel processing resources</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="n">n_permutations</span><span class="si">}</span><span class="s2"> permutations completed&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">track_indices</span><span class="p">:</span>
            <span class="n">null_max_cluster_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">permutation_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">null_max_cluster_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">null_max_cluster_masses</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">null_max_cluster_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">null_max_cluster_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">null_max_cluster_masses</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">permutation_indices</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Explicitly free memory from test_data and other large arrays</span>
    <span class="k">del</span> <span class="n">test_data</span>
    <span class="k">del</span> <span class="n">test_coords</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Step 4: Determine cluster statistic threshold using discrete approach</span>
    <span class="n">null_max_cluster_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">null_max_cluster_stats</span><span class="p">)</span>

    <span class="c1"># For p &lt; alpha, we need (count &gt;= observed) &lt; alpha * n_permutations</span>
    <span class="c1"># The threshold is the value where exactly alpha * n_permutations values exceed it</span>
    <span class="n">sorted_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">null_max_cluster_stats</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Sort descending</span>
    <span class="n">threshold_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">n_permutations</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">threshold_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">threshold_index</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Need at least 1 for edge case</span>
    <span class="k">if</span> <span class="n">threshold_index</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_null</span><span class="p">):</span>
        <span class="n">threshold_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_null</span><span class="p">)</span>

    <span class="c1"># Discrete threshold: the value where exactly alpha proportion exceeds it</span>
    <span class="n">cluster_stat_threshold</span> <span class="o">=</span> <span class="n">sorted_null</span><span class="p">[</span><span class="n">threshold_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># -1 for 0-indexing</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">stat_unit</span> <span class="o">=</span> <span class="s2">&quot;voxels&quot;</span> <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="k">else</span> <span class="s2">&quot;mass units&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Discrete threshold for significance (p &lt; </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">cluster_stat_threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">stat_unit</span><span class="si">}</span><span class="se">\n</span><span class="s2">  (This is the </span><span class="si">{</span><span class="n">threshold_index</span><span class="si">}</span><span class="s2">th largest value out of </span><span class="si">{</span><span class="n">n_permutations</span><span class="si">}</span><span class="s2"> permutations)</span><span class="se">\n</span><span class="s2">Null distribution stats: min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">null_max_cluster_stats</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">null_max_cluster_stats</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">null_max_cluster_stats</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Save permutation details if requested</span>
    <span class="k">if</span> <span class="n">save_permutation_log</span> <span class="ow">and</span> <span class="n">permutation_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">permutation_log_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">permutation_log_file</span> <span class="o">=</span> <span class="s2">&quot;permutation_details.txt&quot;</span>

        <span class="c1"># Prepare permutation info</span>
        <span class="n">permutation_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">perm_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_permutations</span><span class="p">):</span>
            <span class="n">permutation_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;perm_num&#39;</span><span class="p">:</span> <span class="n">perm_num</span><span class="p">,</span>
                <span class="s1">&#39;perm_idx&#39;</span><span class="p">:</span> <span class="n">permutation_indices</span><span class="p">[</span><span class="n">perm_num</span><span class="p">],</span>
                <span class="s1">&#39;max_cluster_size&#39;</span><span class="p">:</span> <span class="n">null_max_cluster_stats</span><span class="p">[</span><span class="n">perm_num</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="n">save_permutation_details</span><span class="p">(</span><span class="n">permutation_info</span><span class="p">,</span> <span class="n">permutation_log_file</span><span class="p">,</span> 
                                <span class="n">subject_ids_resp</span><span class="p">,</span> <span class="n">subject_ids_non_resp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved permutation details to: </span><span class="si">{</span><span class="n">permutation_log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Step 5: Identify significant clusters using per-cluster p-values (MNE-style)</span>
    <span class="c1"># Include observed max in null distribution for proper p-value computation</span>
    <span class="c1"># Reference: Maris &amp; Oostenveld (2007), MNE-Python implementation</span>
    <span class="n">sig_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">p_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">sig_clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_cluster_stats</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store all cluster statistics for p-value computation</span>

    <span class="c1"># First pass: collect all cluster statistics</span>
    <span class="n">max_clusters_to_check</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>  <span class="c1"># Safety limit</span>

    <span class="k">if</span> <span class="n">n_clusters</span> <span class="o">&gt;</span> <span class="n">max_clusters_to_check</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note: Checking first </span><span class="si">{</span><span class="n">max_clusters_to_check</span><span class="si">}</span><span class="s2"> clusters for significance (out of </span><span class="si">{</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2"> total)&quot;</span><span class="p">)</span>

    <span class="n">cluster_info_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_clusters_to_check</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Get cluster coordinates without creating full boolean mask</span>
        <span class="n">cluster_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labeled_array</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Only multi-voxel clusters</span>
            <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
                <span class="n">stat_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span>
                <span class="n">stat_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t_statistics</span><span class="p">[</span><span class="n">cluster_coords</span><span class="p">]))</span>

            <span class="n">cluster_info_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">cluster_id</span><span class="p">,</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="s1">&#39;stat_value&#39;</span><span class="p">:</span> <span class="n">stat_value</span><span class="p">,</span>
                <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="n">cluster_coords</span>
            <span class="p">})</span>
            <span class="n">all_cluster_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat_value</span><span class="p">)</span>

    <span class="c1"># Compute per-cluster p-values using MNE-style approach</span>
    <span class="c1"># Add observed max to null distribution for proper family-wise error control</span>
    <span class="k">if</span> <span class="n">all_cluster_stats</span><span class="p">:</span>
        <span class="n">all_cluster_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_cluster_stats</span><span class="p">)</span>

        <span class="c1"># Determine tail based on alternative hypothesis</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s1">&#39;greater&#39;</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s1">&#39;less&#39;</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Compute p-values for each cluster</span>
        <span class="n">cluster_pvalues</span> <span class="o">=</span> <span class="n">pval_from_histogram</span><span class="p">(</span><span class="n">all_cluster_stats</span><span class="p">,</span> <span class="n">null_max_cluster_stats</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="n">tail</span><span class="p">)</span>

        <span class="c1"># Log top 10 clusters with their p-values for transparency</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">))</span><span class="si">}</span><span class="s2"> observed clusters with p-values:&quot;</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">))):</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">cluster_info_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">cluster_pv</span> <span class="o">=</span> <span class="n">cluster_pvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;SIGNIFICANT&quot;</span> <span class="k">if</span> <span class="n">cluster_pv</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="s2">&quot;not significant&quot;</span>
                <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> voxels, &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;p=</span><span class="si">{</span><span class="n">cluster_pv</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: mass=</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;stat_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="n">cluster_pv</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Collect top observed clusters for visualization (top 10 by cluster statistic)</span>
        <span class="n">all_observed_clusters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">))]):</span>
            <span class="n">all_observed_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stat_value&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;stat_value&#39;</span><span class="p">],</span>
                <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">cluster_pvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="c1"># Second pass: identify significant clusters</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">):</span>
            <span class="n">cluster_pv</span> <span class="o">=</span> <span class="n">cluster_pvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Check if significant using per-cluster p-value</span>
            <span class="k">if</span> <span class="n">cluster_pv</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
                <span class="n">sig_mask</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">sig_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;stat_value&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;stat_value&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">cluster_pv</span>
                <span class="p">})</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Significant clusters (p &lt; </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_clusters</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Total significant voxels: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Prepare correlation data</span>
    <span class="n">correlation_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;sizes&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">null_max_cluster_sizes</span><span class="p">),</span>
        <span class="s1">&#39;masses&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">null_max_cluster_masses</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sig_mask</span><span class="p">,</span> <span class="n">cluster_stat_threshold</span><span class="p">,</span> <span class="n">sig_clusters</span><span class="p">,</span> <span class="n">null_max_cluster_stats</span><span class="p">,</span> <span class="n">all_observed_clusters</span><span class="p">,</span> <span class="n">correlation_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.correlation_cluster_correction" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">correlation_cluster_correction</span>


<a href="#tit.stats.correlation_cluster_correction" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">correlation_cluster_correction</span><span class="p">(</span><span class="n">subject_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">r_values</span><span class="p">,</span> <span class="n">t_statistics</span><span class="p">,</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">valid_mask</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">correlation_type</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="n">cluster_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">cluster_stat</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_permutation_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">permutation_log_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subject_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Apply cluster-based permutation correction for correlation analysis.</p>
<p>This implements the ACES approach where effect sizes are shuffled to 
break the association between E-field magnitude and outcome.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>subject_data : ndarray (x, y, z, n_subjects)
    Electric field magnitude data
effect_sizes : ndarray (n_subjects,)
    Continuous outcome measure
r_values : ndarray (x, y, z)
    Correlation coefficients from initial test
t_statistics : ndarray (x, y, z)
    T-statistics from initial test
p_values : ndarray (x, y, z)
    P-values from initial test
valid_mask : ndarray (x, y, z)
    Boolean mask of valid voxels
weights : ndarray (n_subjects,), optional
    Subject weights for weighted correlation
correlation_type : str
    'pearson' or 'spearman'
cluster_threshold : float
    P-value threshold for cluster formation
n_permutations : int
    Number of permutations
alpha : float
    Significance level for cluster-level correction
cluster_stat : str
    'size' or 'mass' (sum of t-values in cluster)
alternative : {'two-sided', 'greater', 'less'}, optional
    Defines the alternative hypothesis (default: 'two-sided'):
    * 'two-sided': test both positive and negative correlations
    * 'greater': test positive correlations only (one-tailed, uses full alpha)
    * 'less': test negative correlations only (one-tailed, uses full alpha)
n_jobs : int
    Number of parallel jobs (-1 = all cores)
verbose : bool
    Print progress information
logger : logging.Logger, optional
    Logger instance
save_permutation_log : bool
    Save permutation details
permutation_log_file : str, optional
    Path for permutation log
subject_ids : list, optional
    Subject IDs for logging</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>sig_mask : ndarray (x, y, z)
    Binary mask of significant voxels
cluster_stat_threshold : float
    Cluster statistic threshold from null distribution
sig_clusters : list of dict
    Information about significant clusters
null_distribution : ndarray
    Maximum cluster statistics from permutations
all_clusters : list
    All observed clusters
correlation_data : dict
    Cluster size and mass data for analysis</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/stats_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correlation_cluster_correction</span><span class="p">(</span><span class="n">subject_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">r_values</span><span class="p">,</span> <span class="n">t_statistics</span><span class="p">,</span>
                                   <span class="n">p_values</span><span class="p">,</span> <span class="n">valid_mask</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">correlation_type</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="n">cluster_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                   <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">cluster_stat</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span>
                                   <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">save_permutation_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">permutation_log_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">subject_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply cluster-based permutation correction for correlation analysis.</span>

<span class="sd">    This implements the ACES approach where effect sizes are shuffled to </span>
<span class="sd">    break the association between E-field magnitude and outcome.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    subject_data : ndarray (x, y, z, n_subjects)</span>
<span class="sd">        Electric field magnitude data</span>
<span class="sd">    effect_sizes : ndarray (n_subjects,)</span>
<span class="sd">        Continuous outcome measure</span>
<span class="sd">    r_values : ndarray (x, y, z)</span>
<span class="sd">        Correlation coefficients from initial test</span>
<span class="sd">    t_statistics : ndarray (x, y, z)</span>
<span class="sd">        T-statistics from initial test</span>
<span class="sd">    p_values : ndarray (x, y, z)</span>
<span class="sd">        P-values from initial test</span>
<span class="sd">    valid_mask : ndarray (x, y, z)</span>
<span class="sd">        Boolean mask of valid voxels</span>
<span class="sd">    weights : ndarray (n_subjects,), optional</span>
<span class="sd">        Subject weights for weighted correlation</span>
<span class="sd">    correlation_type : str</span>
<span class="sd">        &#39;pearson&#39; or &#39;spearman&#39;</span>
<span class="sd">    cluster_threshold : float</span>
<span class="sd">        P-value threshold for cluster formation</span>
<span class="sd">    n_permutations : int</span>
<span class="sd">        Number of permutations</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Significance level for cluster-level correction</span>
<span class="sd">    cluster_stat : str</span>
<span class="sd">        &#39;size&#39; or &#39;mass&#39; (sum of t-values in cluster)</span>
<span class="sd">    alternative : {&#39;two-sided&#39;, &#39;greater&#39;, &#39;less&#39;}, optional</span>
<span class="sd">        Defines the alternative hypothesis (default: &#39;two-sided&#39;):</span>
<span class="sd">        * &#39;two-sided&#39;: test both positive and negative correlations</span>
<span class="sd">        * &#39;greater&#39;: test positive correlations only (one-tailed, uses full alpha)</span>
<span class="sd">        * &#39;less&#39;: test negative correlations only (one-tailed, uses full alpha)</span>
<span class="sd">    n_jobs : int</span>
<span class="sd">        Number of parallel jobs (-1 = all cores)</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Print progress information</span>
<span class="sd">    logger : logging.Logger, optional</span>
<span class="sd">        Logger instance</span>
<span class="sd">    save_permutation_log : bool</span>
<span class="sd">        Save permutation details</span>
<span class="sd">    permutation_log_file : str, optional</span>
<span class="sd">        Path for permutation log</span>
<span class="sd">    subject_ids : list, optional</span>
<span class="sd">        Subject IDs for logging</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    sig_mask : ndarray (x, y, z)</span>
<span class="sd">        Binary mask of significant voxels</span>
<span class="sd">    cluster_stat_threshold : float</span>
<span class="sd">        Cluster statistic threshold from null distribution</span>
<span class="sd">    sig_clusters : list of dict</span>
<span class="sd">        Information about significant clusters</span>
<span class="sd">    null_distribution : ndarray</span>
<span class="sd">        Maximum cluster statistics from permutations</span>
<span class="sd">    all_clusters : list</span>
<span class="sd">        All observed clusters</span>
<span class="sd">    correlation_data : dict</span>
<span class="sd">        Cluster size and mass data for analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.io_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_permutation_details</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">io_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_permutation_details</span>

    <span class="n">effect_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">n_subjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="se">\n</span><span class="s2">CORRELATION CLUSTER-BASED PERMUTATION CORRECTION</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="n">stat_name</span> <span class="o">=</span> <span class="s2">&quot;Cluster Size&quot;</span> <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="k">else</span> <span class="s2">&quot;Cluster Mass&quot;</span>
        <span class="n">weight_str</span> <span class="o">=</span> <span class="s2">&quot; (weighted)&quot;</span> <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">alt_text</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;two-sided&#39;</span><span class="p">:</span> <span class="s1">&#39;two-sided (tests both positive and negative correlations)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;greater&#39;</span><span class="p">:</span> <span class="s1">&#39;one-sided (tests positive correlations only, full alpha)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;less&#39;</span><span class="p">:</span> <span class="s1">&#39;one-sided (tests negative correlations only, full alpha)&#39;</span>
        <span class="p">}</span>
        <span class="n">config_info</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation type: </span><span class="si">{</span><span class="n">correlation_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}{</span><span class="n">weight_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;Alternative hypothesis: </span><span class="si">{</span><span class="n">alt_text</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alternative</span><span class="p">,</span><span class="w"> </span><span class="n">alternative</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;Cluster statistic: </span><span class="si">{</span><span class="n">stat_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;Cluster-forming threshold: p &lt; </span><span class="si">{</span><span class="n">cluster_threshold</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;Number of permutations: </span><span class="si">{</span><span class="n">n_permutations</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;Cluster-level alpha: </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">config_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">config_info</span><span class="p">)</span>

    <span class="c1"># Form clusters based on initial threshold and alternative hypothesis</span>
    <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s1">&#39;greater&#39;</span><span class="p">:</span>
        <span class="c1"># Test positive correlations only</span>
        <span class="n">initial_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_values</span> <span class="o">&lt;</span> <span class="n">cluster_threshold</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">valid_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t_statistics</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">corr_type_str</span> <span class="o">=</span> <span class="s2">&quot;positive correlations&quot;</span>
    <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s1">&#39;less&#39;</span><span class="p">:</span>
        <span class="c1"># Test negative correlations only</span>
        <span class="n">initial_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_values</span> <span class="o">&lt;</span> <span class="n">cluster_threshold</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">valid_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t_statistics</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">corr_type_str</span> <span class="o">=</span> <span class="s2">&quot;negative correlations&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Two-sided: test all significant correlations</span>
        <span class="n">initial_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_values</span> <span class="o">&lt;</span> <span class="n">cluster_threshold</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">valid_mask</span>
        <span class="n">corr_type_str</span> <span class="o">=</span> <span class="s2">&quot;correlations (both positive and negative)&quot;</span>

    <span class="n">labeled_array</span><span class="p">,</span> <span class="n">n_clusters</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">initial_mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found </span><span class="si">{</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2"> clusters at p &lt; </span><span class="si">{</span><span class="n">cluster_threshold</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">corr_type_str</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_clusters</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No clusters found. Try increasing cluster_threshold.&quot;</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">empty_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sizes&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;masses&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])}</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">p_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="p">[],</span> <span class="n">empty_data</span>

    <span class="c1"># Pre-extract voxel data</span>
    <span class="n">valid_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span>
    <span class="n">n_valid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_coords</span><span class="p">)</span>

    <span class="n">voxel_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_valid</span><span class="p">,</span> <span class="n">n_subjects</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_coords</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">coord</span>
        <span class="n">voxel_data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">subject_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># OPTIMIZATION: For Spearman, pre-rank voxel data ONCE before permutations</span>
    <span class="c1"># This avoids re-ranking the same data in every permutation (huge speedup!)</span>
    <span class="n">voxel_data_preranked</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">correlation_type</span> <span class="o">==</span> <span class="s1">&#39;spearman&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-ranking voxel data for Spearman correlation (one-time operation)...&quot;</span><span class="p">)</span>
        <span class="n">voxel_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rankdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">voxel_data</span><span class="p">)</span>
        <span class="n">voxel_data_preranked</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Voxel data pre-ranked (</span><span class="si">{</span><span class="n">n_valid</span><span class="si">}</span><span class="s2"> voxels)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running </span><span class="si">{</span><span class="n">n_permutations</span><span class="si">}</span><span class="s2"> permutations...&quot;</span><span class="p">)</span>

    <span class="c1"># Determine number of jobs</span>
    <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

    <span class="c1"># Generate seeds for reproducibility</span>
    <span class="n">seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_permutations</span><span class="p">)</span>

    <span class="n">track_indices</span> <span class="o">=</span> <span class="n">save_permutation_log</span> <span class="ow">and</span> <span class="n">subject_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Sequential execution</span>
        <span class="n">null_max_cluster_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">null_max_cluster_sizes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">null_max_cluster_masses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">permutation_indices</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">track_indices</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_permutations</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Permutations&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_permutations</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">_run_single_correlation_permutation</span><span class="p">(</span>
                <span class="n">voxel_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">valid_coords</span><span class="p">,</span>
                <span class="n">cluster_threshold</span><span class="p">,</span> <span class="n">valid_mask</span><span class="p">,</span> <span class="n">p_values</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">correlation_type</span><span class="o">=</span><span class="n">correlation_type</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                <span class="n">cluster_stat</span><span class="o">=</span><span class="n">cluster_stat</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seeds</span><span class="p">[</span><span class="n">perm</span><span class="p">],</span>
                <span class="n">return_indices</span><span class="o">=</span><span class="n">track_indices</span><span class="p">,</span>
                <span class="n">voxel_data_preranked</span><span class="o">=</span><span class="n">voxel_data_preranked</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">track_indices</span><span class="p">:</span>
                <span class="n">max_stat</span><span class="p">,</span> <span class="n">perm_idx</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">max_mass</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">null_max_cluster_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_stat</span><span class="p">)</span>
                <span class="n">null_max_cluster_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_size</span><span class="p">)</span>
                <span class="n">null_max_cluster_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_mass</span><span class="p">)</span>
                <span class="n">permutation_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perm_idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_stat</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">max_mass</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">null_max_cluster_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_stat</span><span class="p">)</span>
                <span class="n">null_max_cluster_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_size</span><span class="p">)</span>
                <span class="n">null_max_cluster_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_mass</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Parallel execution</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">n_jobs</span><span class="si">}</span><span class="s2"> parallel processes...&quot;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">_run_single_correlation_permutation</span><span class="p">)(</span>
                <span class="n">voxel_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">valid_coords</span><span class="p">,</span>
                <span class="n">cluster_threshold</span><span class="p">,</span> <span class="n">valid_mask</span><span class="p">,</span> <span class="n">p_values</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">correlation_type</span><span class="o">=</span><span class="n">correlation_type</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                <span class="n">cluster_stat</span><span class="o">=</span><span class="n">cluster_stat</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seeds</span><span class="p">[</span><span class="n">perm</span><span class="p">],</span>
                <span class="n">return_indices</span><span class="o">=</span><span class="n">track_indices</span><span class="p">,</span>
                <span class="n">voxel_data_preranked</span><span class="o">=</span><span class="n">voxel_data_preranked</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_permutations</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Clean up parallel processing resources</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">track_indices</span><span class="p">:</span>
            <span class="n">null_max_cluster_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">permutation_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">null_max_cluster_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">null_max_cluster_masses</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">null_max_cluster_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">null_max_cluster_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">null_max_cluster_masses</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">permutation_indices</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Clean up</span>
    <span class="k">del</span> <span class="n">voxel_data</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Determine threshold using discrete approach (consistent with exact p-values)</span>
    <span class="n">null_max_cluster_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">null_max_cluster_stats</span><span class="p">)</span>

    <span class="c1"># For p &lt; alpha, we need (count &gt;= observed) &lt; alpha * n_permutations</span>
    <span class="c1"># The threshold is the value where exactly alpha * n_permutations values exceed it</span>
    <span class="n">sorted_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">null_max_cluster_stats</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Sort descending</span>
    <span class="n">threshold_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">n_permutations</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">threshold_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">threshold_index</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Need at least 1 for edge case</span>
    <span class="k">if</span> <span class="n">threshold_index</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_null</span><span class="p">):</span>
        <span class="n">threshold_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_null</span><span class="p">)</span>

    <span class="c1"># Discrete threshold: the value where exactly alpha proportion exceeds it</span>
    <span class="n">cluster_stat_threshold</span> <span class="o">=</span> <span class="n">sorted_null</span><span class="p">[</span><span class="n">threshold_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># -1 for 0-indexing</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">stat_unit</span> <span class="o">=</span> <span class="s2">&quot;voxels&quot;</span> <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="k">else</span> <span class="s2">&quot;mass units&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Discrete threshold for significance (p &lt; </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">): &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_stat_threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">stat_unit</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="sa">f</span><span class="s2">&quot;  (This is the </span><span class="si">{</span><span class="n">threshold_index</span><span class="si">}</span><span class="s2">th largest value out of </span><span class="si">{</span><span class="n">n_permutations</span><span class="si">}</span><span class="s2"> permutations)</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="sa">f</span><span class="s2">&quot;Null distribution: min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">null_max_cluster_stats</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">null_max_cluster_stats</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">null_max_cluster_stats</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Identify significant clusters using per-cluster p-values (MNE-style)</span>
    <span class="n">sig_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">p_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">sig_clusters</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Safety limit to prevent memory issues with very large number of clusters</span>
    <span class="n">max_clusters_to_check</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_clusters</span> <span class="o">&gt;</span> <span class="n">max_clusters_to_check</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note: Checking first </span><span class="si">{</span><span class="n">max_clusters_to_check</span><span class="si">}</span><span class="s2"> clusters for significance (out of </span><span class="si">{</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2"> total)&quot;</span><span class="p">)</span>

    <span class="c1"># First pass: collect cluster statistics WITHOUT storing full masks (memory efficient)</span>
    <span class="c1"># We only store the cluster_id and compute masks later for significant clusters only</span>
    <span class="n">cluster_info_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_cluster_stats</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Use scipy.ndimage for efficient cluster statistics</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="nb">sum</span> <span class="k">as</span> <span class="n">ndimage_sum</span>

    <span class="c1"># Get cluster sizes efficiently using bincount</span>
    <span class="n">cluster_labels_flat</span> <span class="o">=</span> <span class="n">labeled_array</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">cluster_sizes_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">cluster_labels_flat</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_clusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Get cluster masses using ndimage.sum (vectorized) - only if needed</span>
    <span class="n">cluster_ids_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_clusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span>
        <span class="n">cluster_masses_all</span> <span class="o">=</span> <span class="n">ndimage_sum</span><span class="p">(</span><span class="n">t_statistics</span><span class="p">,</span> <span class="n">labeled_array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">cluster_ids_all</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_clusters_to_check</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">cluster_sizes_all</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
                <span class="n">stat_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stat_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cluster_masses_all</span><span class="p">[</span><span class="n">cluster_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Don&#39;t store masks here - only store ID and stats</span>
            <span class="n">cluster_info_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">cluster_id</span><span class="p">,</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">),</span>
                <span class="s1">&#39;stat_value&#39;</span><span class="p">:</span> <span class="n">stat_value</span>
            <span class="p">})</span>
            <span class="n">all_cluster_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat_value</span><span class="p">)</span>

    <span class="c1"># Compute per-cluster p-values using MNE-style approach</span>
    <span class="k">if</span> <span class="n">all_cluster_stats</span><span class="p">:</span>
        <span class="n">all_cluster_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_cluster_stats</span><span class="p">)</span>

        <span class="c1"># Determine tail based on alternative hypothesis</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s1">&#39;greater&#39;</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Test positive correlations (upper tail)</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s1">&#39;less&#39;</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Test negative correlations (lower tail)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Two-sided test</span>

        <span class="n">cluster_pvalues</span> <span class="o">=</span> <span class="n">pval_from_histogram</span><span class="p">(</span><span class="n">all_cluster_stats</span><span class="p">,</span> <span class="n">null_max_cluster_stats</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="n">tail</span><span class="p">)</span>

        <span class="c1"># Log top 10 clusters with their p-values for transparency</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">))</span><span class="si">}</span><span class="s2"> observed clusters with p-values:&quot;</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">))):</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">cluster_info_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">cluster_pv</span> <span class="o">=</span> <span class="n">cluster_pvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;SIGNIFICANT&quot;</span> <span class="k">if</span> <span class="n">cluster_pv</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="s2">&quot;not significant&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: mass=</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;stat_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="n">cluster_pv</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Collect top observed clusters for visualization (top 10 by cluster mass)</span>
        <span class="n">all_observed_clusters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">))]):</span>
            <span class="n">all_observed_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stat_value&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;stat_value&#39;</span><span class="p">],</span>
                <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">cluster_pvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="c1"># Second pass: identify significant clusters and compute masks ONLY for those</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_info_list</span><span class="p">):</span>
            <span class="n">cluster_pv</span> <span class="o">=</span> <span class="n">cluster_pvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">cluster_pv</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
                <span class="c1"># Get cluster coordinates and set significant mask (memory efficient)</span>
                <span class="n">cluster_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labeled_array</span> <span class="o">==</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">sig_mask</span><span class="p">[</span><span class="n">cluster_coords</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># Compute additional stats only for significant clusters</span>
                <span class="n">cluster_r_values</span> <span class="o">=</span> <span class="n">r_values</span><span class="p">[</span><span class="n">cluster_coords</span><span class="p">]</span>
                <span class="n">peak_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cluster_r_values</span><span class="p">)</span>
                <span class="n">mean_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cluster_r_values</span><span class="p">)</span>

                <span class="n">sig_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;stat_value&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;stat_value&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;peak_r&#39;</span><span class="p">:</span> <span class="n">peak_r</span><span class="p">,</span>
                    <span class="s1">&#39;mean_r&#39;</span><span class="p">:</span> <span class="n">mean_r</span><span class="p">,</span>
                    <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">cluster_pv</span>
                <span class="p">})</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Significant clusters (p &lt; </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_clusters</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="sa">f</span><span class="s2">&quot;Total significant voxels: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">correlation_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;sizes&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">null_max_cluster_sizes</span><span class="p">),</span>
        <span class="s1">&#39;masses&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">null_max_cluster_masses</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sig_mask</span><span class="p">,</span> <span class="n">cluster_stat_threshold</span><span class="p">,</span> <span class="n">sig_clusters</span><span class="p">,</span> <span class="n">null_max_cluster_stats</span><span class="p">,</span> <span class="n">all_observed_clusters</span><span class="p">,</span> <span class="n">correlation_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.correlation_voxelwise" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">correlation_voxelwise</span>


<a href="#tit.stats.correlation_voxelwise" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">correlation_voxelwise</span><span class="p">(</span><span class="n">subject_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">correlation_type</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Perform vectorized correlation at each voxel between electric field
magnitude and continuous outcome measure.</p>
<p>This implements the ACES (Automated Correlation of Electric field 
strength and Stimulation effect) approach for continuous outcomes.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>subject_data : ndarray (x, y, z, n_subjects)
    Electric field magnitude data for all subjects
effect_sizes : ndarray (n_subjects,)
    Continuous outcome measure for each subject (e.g., effect size, 
    % improvement, behavioral score)
weights : ndarray (n_subjects,), optional
    Weights for each subject (e.g., sample size for meta-analysis)
correlation_type : {'pearson', 'spearman'}, optional
    Type of correlation (default: 'pearson')
verbose : bool
    Print progress information</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>r_values : ndarray (x, y, z)
    Correlation coefficient at each voxel
t_statistics : ndarray (x, y, z)
    Studentized correlation (t-statistic) at each voxel
p_values : ndarray (x, y, z)
    P-value at each voxel
valid_mask : ndarray (x, y, z)
    Boolean mask of valid voxels</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/stats_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correlation_voxelwise</span><span class="p">(</span><span class="n">subject_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                          <span class="n">correlation_type</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform vectorized correlation at each voxel between electric field</span>
<span class="sd">    magnitude and continuous outcome measure.</span>

<span class="sd">    This implements the ACES (Automated Correlation of Electric field </span>
<span class="sd">    strength and Stimulation effect) approach for continuous outcomes.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    subject_data : ndarray (x, y, z, n_subjects)</span>
<span class="sd">        Electric field magnitude data for all subjects</span>
<span class="sd">    effect_sizes : ndarray (n_subjects,)</span>
<span class="sd">        Continuous outcome measure for each subject (e.g., effect size, </span>
<span class="sd">        % improvement, behavioral score)</span>
<span class="sd">    weights : ndarray (n_subjects,), optional</span>
<span class="sd">        Weights for each subject (e.g., sample size for meta-analysis)</span>
<span class="sd">    correlation_type : {&#39;pearson&#39;, &#39;spearman&#39;}, optional</span>
<span class="sd">        Type of correlation (default: &#39;pearson&#39;)</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Print progress information</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    r_values : ndarray (x, y, z)</span>
<span class="sd">        Correlation coefficient at each voxel</span>
<span class="sd">    t_statistics : ndarray (x, y, z)</span>
<span class="sd">        Studentized correlation (t-statistic) at each voxel</span>
<span class="sd">    p_values : ndarray (x, y, z)</span>
<span class="sd">        P-value at each voxel</span>
<span class="sd">    valid_mask : ndarray (x, y, z)</span>
<span class="sd">        Boolean mask of valid voxels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">weight_str</span> <span class="o">=</span> <span class="s2">&quot; (weighted)&quot;</span> <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing voxelwise </span><span class="si">{</span><span class="n">correlation_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> correlation</span><span class="si">{</span><span class="n">weight_str</span><span class="si">}</span><span class="s2"> (vectorized)...&quot;</span><span class="p">)</span>

    <span class="c1"># Validate inputs</span>
    <span class="n">n_subjects</span> <span class="o">=</span> <span class="n">subject_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_subjects</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of effect sizes (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;number of subjects (</span><span class="si">{</span><span class="n">n_subjects</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_subjects</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of weights (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;number of subjects (</span><span class="si">{</span><span class="n">n_subjects</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_subjects</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Need at least 3 subjects for correlation, got </span><span class="si">{</span><span class="n">n_subjects</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">effect_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">subject_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">r_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">t_statistics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">p_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Create mask of valid voxels (non-zero in at least some subjects)</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">subject_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_voxels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing correlations for </span><span class="si">{</span><span class="n">total_voxels</span><span class="si">}</span><span class="s2"> valid voxels...&quot;</span><span class="p">)</span>

    <span class="c1"># Get coordinates of valid voxels</span>
    <span class="n">valid_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span>
    <span class="n">n_valid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_coords</span><span class="p">)</span>

    <span class="c1"># Pre-extract voxel data for vectorized computation</span>
    <span class="n">voxel_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_valid</span><span class="p">,</span> <span class="n">n_subjects</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_coords</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">coord</span>
        <span class="n">voxel_data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">subject_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Compute correlations for all voxels at once</span>
    <span class="n">r_1d</span><span class="p">,</span> <span class="n">t_1d</span><span class="p">,</span> <span class="n">p_1d</span> <span class="o">=</span> <span class="n">correlation</span><span class="p">(</span>
        <span class="n">voxel_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span>
        <span class="n">correlation_type</span><span class="o">=</span><span class="n">correlation_type</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span>
    <span class="p">)</span>

    <span class="c1"># Map results back to 3D volume</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_coords</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">coord</span>
        <span class="n">r_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_1d</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">t_statistics</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_1d</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">p_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_1d</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation range: [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean |r|: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]))</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sig_05</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_values</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">valid_mask</span><span class="p">)</span>
        <span class="n">sig_01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_values</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">valid_mask</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Voxels with p&lt;0.05 (uncorrected): </span><span class="si">{</span><span class="n">sig_05</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Voxels with p&lt;0.01 (uncorrected): </span><span class="si">{</span><span class="n">sig_01</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r_values</span><span class="p">,</span> <span class="n">t_statistics</span><span class="p">,</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">valid_mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.generate_correlation_summary" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">generate_correlation_summary</span>


<a href="#tit.stats.generate_correlation_summary" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">generate_correlation_summary</span><span class="p">(</span><span class="n">subject_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">r_values</span><span class="p">,</span> <span class="n">sig_mask</span><span class="p">,</span> <span class="n">cluster_threshold</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">atlas_results</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">effect_metric</span><span class="o">=</span><span class="s1">&#39;Effect Size&#39;</span><span class="p">,</span> <span class="n">subject_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generate comprehensive summary report for correlation analysis</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>subject_data : ndarray (x, y, z, n_subjects)
    Electric field magnitude data
effect_sizes : ndarray (n_subjects,)
    Continuous outcome measures
r_values : ndarray (x, y, z)
    Correlation map
sig_mask : ndarray (x, y, z)
    Binary mask of significant voxels
cluster_threshold : float
    Cluster statistic threshold from permutation
clusters : list
    List of cluster dictionaries
atlas_results : dict
    Atlas overlap results
output_file : str
    Path to output summary file
params : dict, optional
    Analysis parameters
effect_metric : str
    Name of the outcome measure
subject_ids : list, optional
    List of subject IDs
weights : ndarray, optional
    Subject weights (if used)</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/reporting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_correlation_summary</span><span class="p">(</span><span class="n">subject_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">r_values</span><span class="p">,</span> <span class="n">sig_mask</span><span class="p">,</span> 
                                 <span class="n">cluster_threshold</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">atlas_results</span><span class="p">,</span> 
                                 <span class="n">output_file</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">effect_metric</span><span class="o">=</span><span class="s2">&quot;Effect Size&quot;</span><span class="p">,</span>
                                 <span class="n">subject_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate comprehensive summary report for correlation analysis</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    subject_data : ndarray (x, y, z, n_subjects)</span>
<span class="sd">        Electric field magnitude data</span>
<span class="sd">    effect_sizes : ndarray (n_subjects,)</span>
<span class="sd">        Continuous outcome measures</span>
<span class="sd">    r_values : ndarray (x, y, z)</span>
<span class="sd">        Correlation map</span>
<span class="sd">    sig_mask : ndarray (x, y, z)</span>
<span class="sd">        Binary mask of significant voxels</span>
<span class="sd">    cluster_threshold : float</span>
<span class="sd">        Cluster statistic threshold from permutation</span>
<span class="sd">    clusters : list</span>
<span class="sd">        List of cluster dictionaries</span>
<span class="sd">    atlas_results : dict</span>
<span class="sd">        Atlas overlap results</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Path to output summary file</span>
<span class="sd">    params : dict, optional</span>
<span class="sd">        Analysis parameters</span>
<span class="sd">    effect_metric : str</span>
<span class="sd">        Name of the outcome measure</span>
<span class="sd">    subject_ids : list, optional</span>
<span class="sd">        List of subject IDs</span>
<span class="sd">    weights : ndarray, optional</span>
<span class="sd">        Subject weights (if used)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;correlation_type&#39;</span><span class="p">:</span> <span class="s1">&#39;pearson&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;cluster_stat&#39;</span><span class="p">:</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;n_permutations&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;use_weights&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>

    <span class="n">n_subjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;CORRELATION-BASED CLUSTER PERMUTATION ANALYSIS SUMMARY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(ACES-style analysis for continuous outcomes)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ANALYSIS DETAILS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">corr_type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;correlation_type&#39;</span><span class="p">,</span> <span class="s1">&#39;pearson&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="n">weighted_str</span> <span class="o">=</span> <span class="s2">&quot; (Weighted)&quot;</span> <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_weights&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation Type: </span><span class="si">{</span><span class="n">corr_type</span><span class="si">}{</span><span class="n">weighted_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Outcome Measure: </span><span class="si">{</span><span class="n">effect_metric</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">cluster_stat</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">)</span>
        <span class="n">cluster_stat_name</span> <span class="o">=</span> <span class="s2">&quot;Cluster Size&quot;</span> <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="k">else</span> <span class="s2">&quot;Cluster Mass&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster Statistic: </span><span class="si">{</span><span class="n">cluster_stat_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster-forming threshold: p &lt; </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of permutations: </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster-level alpha: </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster size threshold: </span><span class="si">{</span><span class="n">cluster_threshold</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> voxels</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster mass threshold: </span><span class="si">{</span><span class="n">cluster_threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;SAMPLE INFORMATION:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Subjects: </span><span class="si">{</span><span class="n">n_subjects</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subject_ids</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject IDs: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">subject_ids</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;EFFECT SIZE DISTRIBUTION:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Std:  </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Min:  </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max:  </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Range: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subject_ids</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Per-Subject Effect Sizes:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">):</span>
                <span class="n">weight_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
                    <span class="n">weight_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, weight=</span><span class="si">{</span><span class="n">weights</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">es</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}{</span><span class="n">weight_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;WEIGHT DISTRIBUTION:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean weight: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Min weight:  </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max weight:  </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;RESULTS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">n_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Significant Voxels: </span><span class="si">{</span><span class="n">n_sig</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Significant Clusters: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_sig</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sig_bool</span> <span class="o">=</span> <span class="n">sig_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">mean_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">sig_bool</span><span class="p">])</span>
            <span class="n">max_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">sig_bool</span><span class="p">])</span>
            <span class="n">min_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">sig_bool</span><span class="p">])</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;CORRELATION STATISTICS IN SIGNIFICANT VOXELS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean r: </span><span class="si">{</span><span class="n">mean_r</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Peak r: </span><span class="si">{</span><span class="n">max_r</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Min r:  </span><span class="si">{</span><span class="n">min_r</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># E-field statistics in significant voxels</span>
            <span class="n">mean_efield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">subject_data</span><span class="p">[</span><span class="n">sig_bool</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">max_efield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subject_data</span><span class="p">[</span><span class="n">sig_bool</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;E-FIELD STATISTICS IN SIGNIFICANT VOXELS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean E-field: </span><span class="si">{</span><span class="n">mean_efield</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max E-field:  </span><span class="si">{</span><span class="n">max_efield</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;SIGNIFICANT CLUSTERS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Cluster </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> voxels</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   MNI Center: (</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;mean_r&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Mean r: </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;mean_r&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;peak_r&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Peak r: </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;peak_r&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ATLAS OVERLAP ANALYSIS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">atlas_name</span><span class="p">,</span> <span class="n">region_counts</span> <span class="ow">in</span> <span class="n">atlas_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">atlas_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">region_counts</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of regions with significant voxels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">region_counts</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Top 20 regions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">region_counts</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;overlap_voxels&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;region_size&#39;</span><span class="p">]</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">. Region </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;region_id&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">: &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;overlap_voxels&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> voxels (</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">5.1f</span><span class="si">}</span><span class="s2">% of region)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No overlapping regions found.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;INTERPRETATION NOTES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;This analysis identifies brain regions where electric field magnitude</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;correlates with </span><span class="si">{</span><span class="n">effect_metric</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Positive correlations (r &gt; 0):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Higher E-field  Higher </span><span class="si">{</span><span class="n">effect_metric</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Note: This analysis tests positive correlations only (as per ACES).</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;To find regions with negative correlations, invert your effect sizes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(multiply by -1) and re-run the analysis.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;References:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  - Wischnewski et al. (2021) - ACES approach</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  - Maris &amp; Oostenveld (2007) - Cluster-based permutation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary written to: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.generate_summary" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">generate_summary</span>


<a href="#tit.stats.generate_summary" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">generate_summary</span><span class="p">(</span><span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">,</span> <span class="n">sig_mask</span><span class="p">,</span> <span class="n">correction_threshold</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">atlas_results</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">correction_method</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group1_name</span><span class="o">=</span><span class="s1">&#39;Responders&#39;</span><span class="p">,</span> <span class="n">group2_name</span><span class="o">=</span><span class="s1">&#39;Non-Responders&#39;</span><span class="p">,</span> <span class="n">value_metric</span><span class="o">=</span><span class="s1">&#39;Current Intensity&#39;</span><span class="p">,</span> <span class="n">test_type</span><span class="o">=</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span> <span class="n">observed_cluster_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generate comprehensive summary report</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>responders : ndarray
    Responder data (group 1)
non_responders : ndarray
    Non-responder data (group 2)
sig_mask : ndarray
    Binary mask of significant voxels
correction_threshold : float
    Threshold used for multiple comparison correction
clusters : list
    List of cluster dictionaries
atlas_results : dict
    Atlas overlap results
output_file : str
    Path to output summary file
correction_method : str
    Method used: 'cluster' or 'fdr'
params : dict, optional
    Dictionary of analysis parameters (cluster_threshold, n_permutations, alpha, etc.)
    If None, uses defaults
group1_name : str
    Name for first group (default: "Responders")
group2_name : str
    Name for second group (default: "Non-Responders")
value_metric : str
    Name of the metric being compared (default: "Current Intensity")
test_type : str
    Type of t-test used: 'paired' or 'unpaired' (default: "unpaired")
observed_cluster_sizes : list, optional
    List of observed cluster sizes (before permutation correction) sorted largest to smallest</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/reporting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_summary</span><span class="p">(</span><span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">,</span> <span class="n">sig_mask</span><span class="p">,</span> <span class="n">correction_threshold</span><span class="p">,</span> 
                    <span class="n">clusters</span><span class="p">,</span> <span class="n">atlas_results</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> 
                    <span class="n">correction_method</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">group1_name</span><span class="o">=</span><span class="s2">&quot;Responders&quot;</span><span class="p">,</span>
                    <span class="n">group2_name</span><span class="o">=</span><span class="s2">&quot;Non-Responders&quot;</span><span class="p">,</span>
                    <span class="n">value_metric</span><span class="o">=</span><span class="s2">&quot;Current Intensity&quot;</span><span class="p">,</span>
                    <span class="n">test_type</span><span class="o">=</span><span class="s2">&quot;unpaired&quot;</span><span class="p">,</span>
                    <span class="n">observed_cluster_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate comprehensive summary report</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    responders : ndarray</span>
<span class="sd">        Responder data (group 1)</span>
<span class="sd">    non_responders : ndarray</span>
<span class="sd">        Non-responder data (group 2)</span>
<span class="sd">    sig_mask : ndarray</span>
<span class="sd">        Binary mask of significant voxels</span>
<span class="sd">    correction_threshold : float</span>
<span class="sd">        Threshold used for multiple comparison correction</span>
<span class="sd">    clusters : list</span>
<span class="sd">        List of cluster dictionaries</span>
<span class="sd">    atlas_results : dict</span>
<span class="sd">        Atlas overlap results</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Path to output summary file</span>
<span class="sd">    correction_method : str</span>
<span class="sd">        Method used: &#39;cluster&#39; or &#39;fdr&#39;</span>
<span class="sd">    params : dict, optional</span>
<span class="sd">        Dictionary of analysis parameters (cluster_threshold, n_permutations, alpha, etc.)</span>
<span class="sd">        If None, uses defaults</span>
<span class="sd">    group1_name : str</span>
<span class="sd">        Name for first group (default: &quot;Responders&quot;)</span>
<span class="sd">    group2_name : str</span>
<span class="sd">        Name for second group (default: &quot;Non-Responders&quot;)</span>
<span class="sd">    value_metric : str</span>
<span class="sd">        Name of the metric being compared (default: &quot;Current Intensity&quot;)</span>
<span class="sd">    test_type : str</span>
<span class="sd">        Type of t-test used: &#39;paired&#39; or &#39;unpaired&#39; (default: &quot;unpaired&quot;)</span>
<span class="sd">    observed_cluster_sizes : list, optional</span>
<span class="sd">        List of observed cluster sizes (before permutation correction) sorted largest to smallest</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set default parameters if not provided</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s1">&#39;n_permutations&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.05</span>
        <span class="p">}</span>

    <span class="c1"># Extract parameters with defaults</span>
    <span class="n">cluster_threshold_param</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">n_permutations</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">cluster_stat</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;VOXELWISE STATISTICAL ANALYSIS SUMMARY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ANALYSIS DETAILS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">test_name</span> <span class="o">=</span> <span class="s2">&quot;Paired t-test&quot;</span> <span class="k">if</span> <span class="n">test_type</span> <span class="o">==</span> <span class="s2">&quot;paired&quot;</span> <span class="k">else</span> <span class="s2">&quot;Unpaired (Independent Samples) t-test&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Statistical Test: </span><span class="si">{</span><span class="n">test_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">correction_method</span> <span class="o">==</span> <span class="s2">&quot;cluster&quot;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple Comparison Correction: Cluster-based Permutation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cluster_stat_name</span> <span class="o">=</span> <span class="s2">&quot;Cluster Size&quot;</span> <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="k">else</span> <span class="s2">&quot;Cluster Mass&quot;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster statistic: </span><span class="si">{</span><span class="n">cluster_stat_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster-forming threshold: p &lt; </span><span class="si">{</span><span class="n">cluster_threshold_param</span><span class="si">}</span><span class="s2"> (uncorrected)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of permutations: </span><span class="si">{</span><span class="n">n_permutations</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster-level alpha: </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster size threshold: </span><span class="si">{</span><span class="n">correction_threshold</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> voxels</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster mass threshold: </span><span class="si">{</span><span class="n">correction_threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;n_jobs&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
                    <span class="n">n_jobs_actual</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parallel processing: </span><span class="si">{</span><span class="n">n_jobs_actual</span><span class="si">}</span><span class="s2"> cores</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parallel processing: Sequential (1 core)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parallel processing: </span><span class="si">{</span><span class="n">n_jobs</span><span class="si">}</span><span class="s2"> cores</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple Comparison Correction: FDR (False Discovery Rate)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significance Level: alpha = </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FDR-corrected p-value threshold: </span><span class="si">{</span><span class="n">correction_threshold</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add observed clusters information if provided</span>
        <span class="k">if</span> <span class="n">observed_cluster_sizes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed_cluster_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;OBSERVED CLUSTERS (BEFORE PERMUTATION CORRECTION):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total clusters at p &lt; </span><span class="si">{</span><span class="n">cluster_threshold_param</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">observed_cluster_sizes</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Largest observed cluster: </span><span class="si">{</span><span class="n">observed_cluster_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> voxels</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total voxels in all clusters: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">observed_cluster_sizes</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Top 10 Largest Observed Clusters:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">observed_cluster_sizes</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s2">6d</span><span class="si">}</span><span class="s2"> voxels</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;SAMPLE INFORMATION:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of </span><span class="si">{</span><span class="n">group1_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of </span><span class="si">{</span><span class="n">group2_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">non_responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Subjects: </span><span class="si">{</span><span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">non_responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;RESULTS:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">n_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Significant Voxels: </span><span class="si">{</span><span class="n">n_sig</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_sig</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Calculate mean values in significant voxels</span>
            <span class="n">sig_bool</span> <span class="o">=</span> <span class="n">sig_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">group1_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">responders</span><span class="p">[</span><span class="n">sig_bool</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">group2_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">non_responders</span><span class="p">[</span><span class="n">sig_bool</span><span class="p">,</span> <span class="p">:])</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean </span><span class="si">{</span><span class="n">value_metric</span><span class="si">}</span><span class="s2"> in Significant Voxels:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">group1_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">group1_mean</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">group2_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">group2_mean</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Difference (</span><span class="si">{</span><span class="n">group1_name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">group2_name</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">group1_mean</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">group2_mean</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Number of Clusters: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="n">sort_label</span> <span class="o">=</span> <span class="s2">&quot;by statistic&quot;</span> <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span> <span class="k">else</span> <span class="s2">&quot;by size&quot;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TOP 10 CLUSTERS (</span><span class="si">{</span><span class="n">sort_label</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Cluster </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> voxels&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span> <span class="ow">and</span> <span class="s1">&#39;stat_value&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, mass = </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;stat_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   MNI Center: (</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ATLAS OVERLAP ANALYSIS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">atlas_name</span><span class="p">,</span> <span class="n">region_counts</span> <span class="ow">in</span> <span class="n">atlas_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">atlas_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">region_counts</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of regions with significant voxels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">region_counts</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Top 20 regions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">region_counts</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;overlap_voxels&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;region_size&#39;</span><span class="p">]</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">. Region </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;region_id&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">: &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;overlap_voxels&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> voxels (</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">5.1f</span><span class="si">}</span><span class="s2">% of region)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No overlapping regions found.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary written to: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.get_path_manager" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_path_manager</span>


<a href="#tit.stats.get_path_manager" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_path_manager</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PathManager</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get the global PathManager singleton instance.</p>
<p>Returns:
    The global path manager instance</p>

            <details class="quote">
              <summary>Source code in <code>tit/core/paths.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_path_manager</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PathManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the global PathManager singleton instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The global path manager instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_path_manager_instance</span>
    <span class="k">if</span> <span class="n">_path_manager_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_path_manager_instance</span> <span class="o">=</span> <span class="n">PathManager</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_path_manager_instance</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.load_subject_data" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">load_subject_data</span>


<a href="#tit.stats.load_subject_data" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_subject_data</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Unified data loading for both group comparison and correlation analysis</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>subject_configs : list of dict
    Subject configurations (format depends on analysis_type)
nifti_file_pattern : str, optional
    Pattern for NIfTI files
analysis_type : str
    Either 'group_comparison' or 'correlation'</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>For group_comparison:
    responders, non_responders, template_img, resp_ids, non_resp_ids
For correlation:
    subject_data, effect_sizes, weights, template_img, subject_ids</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_subject_data</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unified data loading for both group comparison and correlation analysis</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    subject_configs : list of dict</span>
<span class="sd">        Subject configurations (format depends on analysis_type)</span>
<span class="sd">    nifti_file_pattern : str, optional</span>
<span class="sd">        Pattern for NIfTI files</span>
<span class="sd">    analysis_type : str</span>
<span class="sd">        Either &#39;group_comparison&#39; or &#39;correlation&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    For group_comparison:</span>
<span class="sd">        responders, non_responders, template_img, resp_ids, non_resp_ids</span>
<span class="sd">    For correlation:</span>
<span class="sd">        subject_data, effect_sizes, weights, template_img, subject_ids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_subject_data_group_comparison</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_subject_data_correlation</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown analysis_type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.load_subject_data_correlation" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">load_subject_data_correlation</span>


<a href="#tit.stats.load_subject_data_correlation" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_subject_data_correlation</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load subject data for correlation analysis (continuous outcomes)</p>

            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_subject_data_correlation</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load subject data for correlation analysis (continuous outcomes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nifti_file_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nifti_file_pattern</span> <span class="o">=</span> <span class="s2">&quot;grey_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz&quot;</span>

    <span class="c1"># Check for required fields</span>
    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation_name&#39;</span><span class="p">,</span> <span class="s1">&#39;effect_size&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">subject_configs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required field &#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#39; in subject config&quot;</span><span class="p">)</span>

    <span class="c1"># Load all subjects</span>
    <span class="n">subject_data</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">nifti</span><span class="o">.</span><span class="n">load_group_data_ti_toolbox</span><span class="p">(</span>
        <span class="n">subject_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">nifti_file_pattern</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="c1"># Build a lookup from subject_id to config for successfully loaded subjects</span>
    <span class="n">config_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">subject_configs</span><span class="p">}</span>

    <span class="c1"># Extract effect sizes and weights only for successfully loaded subjects</span>
    <span class="n">effect_sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">weights_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">has_weights</span> <span class="o">=</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">subject_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">subject_ids</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">config_lookup</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="n">effect_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;effect_size&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">has_weights</span><span class="p">:</span>
            <span class="n">weights_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

    <span class="n">effect_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_weights</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> subjects: </span><span class="si">{</span><span class="n">subject_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect sizes: mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect size range: [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weights: mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, range=[</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data shape: </span><span class="si">{</span><span class="n">subject_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">subject_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">subject_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.load_subject_data_group_comparison" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">load_subject_data_group_comparison</span>


<a href="#tit.stats.load_subject_data_group_comparison" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_subject_data_group_comparison</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load subject data for group comparison analysis (binary outcomes)</p>

            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_subject_data_group_comparison</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load subject data for group comparison analysis (binary outcomes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nifti_file_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nifti_file_pattern</span> <span class="o">=</span> <span class="s2">&quot;grey_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz&quot;</span>

    <span class="c1"># Separate configs by response</span>
    <span class="n">responder_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">subject_configs</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">non_responder_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">subject_configs</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">responder_configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_responder_configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need at least one responder and one non-responder&quot;</span><span class="p">)</span>

    <span class="c1"># Load responders</span>
    <span class="n">responders</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">responder_ids</span> <span class="o">=</span> <span class="n">nifti</span><span class="o">.</span><span class="n">load_group_data_ti_toolbox</span><span class="p">(</span>
        <span class="n">responder_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">nifti_file_pattern</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="c1"># Load non-responders</span>
    <span class="n">non_responders</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">non_responder_ids</span> <span class="o">=</span> <span class="n">nifti</span><span class="o">.</span><span class="n">load_group_data_ti_toolbox</span><span class="p">(</span>
        <span class="n">non_responder_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">nifti_file_pattern</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">responder_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> responders: </span><span class="si">{</span><span class="n">responder_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">non_responder_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> non-responders: </span><span class="si">{</span><span class="n">non_responder_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Responders shape: </span><span class="si">{</span><span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-responders shape: </span><span class="si">{</span><span class="n">non_responders</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">responder_ids</span><span class="p">,</span> <span class="n">non_responder_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.main" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">main</span>


<a href="#tit.stats.main" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">main</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Command-line interface for unified permutation analysis</p>

            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command-line interface for unified permutation analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>

    <span class="c1"># Ensure proper multiprocessing initialization</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">multiprocessing</span><span class="p">,</span> <span class="s1">&#39;set_start_method&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">multiprocessing</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="s1">&#39;fork&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Unified Cluster-Based Permutation Testing for TI-Toolbox&#39;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Examples:</span>
<span class="s2">  # Group comparison analysis</span>
<span class="s2">  python permutation_analysis.py --csv subjects.csv --name my_analysis </span><span class="se">\\</span>
<span class="s2">      --analysis-type group_comparison</span>

<span class="s2">  # Correlation analysis</span>
<span class="s2">  python permutation_analysis.py --csv subjects.csv --name my_analysis </span><span class="se">\\</span>
<span class="s2">      --analysis-type correlation</span>

<span class="s2">Group Comparison CSV Format:</span>
<span class="s2">  subject_id,simulation_name,response</span>
<span class="s2">  070,ICP_RHIPPO,1</span>
<span class="s2">  071,ICP_RHIPPO,0</span>

<span class="s2">Correlation CSV Format:</span>
<span class="s2">  subject_id,simulation_name,effect_size,weight</span>
<span class="s2">  070,ICP_RHIPPO,0.45,25</span>
<span class="s2">  071,ICP_RHIPPO,0.32,30</span>

<span class="s2">Tissue Types:</span>
<span class="s2">  --tissue-type controls which NIfTI files are loaded:</span>
<span class="s2">    grey  : grey_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz</span>
<span class="s2">    white : white_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz</span>
<span class="s2">    all   : </span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz (no prefix)</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Required arguments</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--csv&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to CSV file with subject configurations&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Analysis name (used for output directory)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--analysis-type&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of analysis to perform&#39;</span><span class="p">)</span>

    <span class="c1"># Statistical parameters (common)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cluster-threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;P-value threshold for cluster formation (default: 0.05)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cluster-stat&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cluster statistic: mass (sum of t-values) or size (voxel count) (default: mass)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n-permutations&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of permutations (default: 1000)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cluster-level significance threshold (default: 0.05)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n-jobs&#39;</span><span class="p">,</span> <span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of parallel jobs: -1=all cores, 1=sequential (default: -1)&#39;</span><span class="p">)</span>

    <span class="c1"># Group comparison specific parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--test-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span> <span class="s1">&#39;paired&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Statistical test type for group comparison (default: unpaired)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--alternative&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span> <span class="s1">&#39;greater&#39;</span><span class="p">,</span> <span class="s1">&#39;less&#39;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Alternative hypothesis for group comparison (default: two-sided)&#39;</span><span class="p">)</span>

    <span class="c1"># Correlation specific parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--correlation-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;spearman&#39;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of correlation for correlation analysis (default: pearson)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--use-weights&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use weights from CSV if available (correlation analysis)&#39;</span><span class="p">)</span>

    <span class="c1"># Optional parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tissue-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Tissue type for NIfTI files: grey (grey matter), &#39;</span>
                             <span class="s1">&#39;white (white matter), or all (all tissues, no prefix). &#39;</span>
                             <span class="s1">&#39;(default: grey)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--nifti-pattern&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Custom NIfTI filename pattern (overrides --tissue-type)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--quiet&#39;</span><span class="p">,</span> <span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Suppress progress output&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Build configuration</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;analysis_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span><span class="p">,</span>
        <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">cluster_threshold</span><span class="p">,</span>
        <span class="s1">&#39;cluster_stat&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">cluster_stat</span><span class="p">,</span>
        <span class="s1">&#39;n_permutations&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">n_permutations</span><span class="p">,</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
        <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
        <span class="s1">&#39;tissue_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tissue_type</span><span class="p">,</span>
        <span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">nifti_pattern</span><span class="p">,</span>  <span class="c1"># None triggers auto-generation</span>
    <span class="p">}</span>

    <span class="c1"># Add analysis-specific parameters</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;test_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">test_type</span><span class="p">,</span>
            <span class="s1">&#39;alternative&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">alternative</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># correlation</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;correlation_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">correlation_type</span><span class="p">,</span>
            <span class="s1">&#39;use_weights&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">use_weights</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="c1"># Print header</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UNIFIED CLUSTER-BASED PERMUTATION TESTING - TI-TOOLBOX&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis type: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV file: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis name: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tissue type: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">tissue_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permutations: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">n_permutations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parallel jobs: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">n_jobs</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">args</span><span class="o">.</span><span class="n">n_jobs</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;all cores&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster statistic: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">cluster_stat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster threshold: p &lt; </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">cluster_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Run analysis</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">run_analysis</span><span class="p">(</span>
            <span class="n">subject_configs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">csv</span><span class="p">,</span>
            <span class="n">analysis_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">output_callback</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span> <span class="k">else</span> <span class="nb">print</span>
        <span class="p">)</span>

        <span class="c1"># Print summary</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ANALYSIS COMPLETE!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;n_significant_clusters&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant clusters: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;n_significant_clusters&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;n_significant_voxels&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant voxels: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;n_significant_voxels&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis time: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;analysis_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERROR: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.plot_cluster_size_mass_correlation" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">plot_cluster_size_mass_correlation</span>


<a href="#tit.stats.plot_cluster_size_mass_correlation" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">plot_cluster_size_mass_correlation</span><span class="p">(</span><span class="n">cluster_sizes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cluster_masses</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Plot correlation between cluster size and cluster mass from permutation null distribution.</p>

            <details class="quote">
              <summary>Source code in <code>tit/plotting/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_cluster_size_mass_correlation</span><span class="p">(</span>
    <span class="n">cluster_sizes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">cluster_masses</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot correlation between cluster size and cluster mass from permutation null distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span>

    <span class="n">ensure_headless_matplotlib_backend</span><span class="p">()</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;notebook&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Remove zeros</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">cluster_sizes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cluster_masses</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">sizes_nonzero</span> <span class="o">=</span> <span class="n">cluster_sizes</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">masses_nonzero</span> <span class="o">=</span> <span class="n">cluster_masses</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes_nonzero</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">sizes_nonzero</span><span class="p">,</span> <span class="n">masses_nonzero</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">sns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">sizes_nonzero</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">masses_nonzero</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;steelblue&quot;</span><span class="p">,</span> <span class="s2">&quot;edgecolors&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidths&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
            <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sizes_nonzero</span><span class="p">,</span> <span class="n">masses_nonzero</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">sizes_nonzero</span><span class="p">,</span> <span class="n">masses_nonzero</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sizes_nonzero</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sizes_nonzero</span><span class="p">)),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">sizes_nonzero</span><span class="p">,</span> <span class="n">masses_nonzero</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Maximum Cluster Size (voxels)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Maximum Cluster Mass (sum of t-statistics)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Cluster Size vs Cluster Mass Correlation</span><span class="se">\n</span><span class="s2">Pearson r = </span><span class="si">{</span><span class="n">r_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (p = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
        <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">textstr</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;n = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sizes_nonzero</span><span class="p">)</span><span class="si">}</span><span class="s2"> permutations</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;r = </span><span class="si">{</span><span class="n">r_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;p = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Linear fit: y = </span><span class="si">{</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x + </span><span class="si">{</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;wheat&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">textstr</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">savefig_close</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">SaveFigOptions</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.plot_permutation_null_distribution" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">plot_permutation_null_distribution</span>


<a href="#tit.stats.plot_permutation_null_distribution" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">plot_permutation_null_distribution</span><span class="p">(</span><span class="n">null_distribution</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">observed_clusters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">cluster_stat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Plot permutation null distribution with threshold and observed clusters.</p>

            <details class="quote">
              <summary>Source code in <code>tit/plotting/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_permutation_null_distribution</span><span class="p">(</span>
    <span class="n">null_distribution</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">observed_clusters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">cluster_stat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot permutation null distribution with threshold and observed clusters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ensure_headless_matplotlib_backend</span><span class="p">()</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;notebook&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="c1"># Labels based on cluster statistic</span>
    <span class="k">if</span> <span class="n">cluster_stat</span> <span class="o">==</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;Maximum Cluster Size (voxels)&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Permutation Null Distribution of Maximum Cluster Sizes&quot;</span>
        <span class="n">threshold_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Discrete Threshold (p&lt;</span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> voxels&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;Maximum Cluster Mass (sum of t-statistics)&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Permutation Null Distribution of Maximum Cluster Mass&quot;</span>
        <span class="n">threshold_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Discrete Threshold (p&lt;</span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Histogram</span>
    <span class="k">if</span> <span class="n">sns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
            <span class="n">null_distribution</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Null Distribution&quot;</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">null_distribution</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Null Distribution&quot;</span><span class="p">)</span>

    <span class="c1"># Threshold line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">threshold_label</span><span class="p">)</span>

    <span class="c1"># Observed clusters</span>
    <span class="n">sig_plotted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nonsig_plotted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">observed_clusters</span><span class="p">:</span>
        <span class="n">stat_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cluster</span><span class="p">[</span><span class="s2">&quot;stat_value&quot;</span><span class="p">])</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_significant</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_significant</span> <span class="o">=</span> <span class="n">stat_value</span> <span class="o">&gt;</span> <span class="n">threshold</span>

        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span> <span class="k">if</span> <span class="n">is_significant</span> <span class="k">else</span> <span class="s2">&quot;orange&quot;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">is_significant</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sig_plotted</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Significant Clusters (p&lt;0.05)&quot;</span>
            <span class="n">sig_plotted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_significant</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">nonsig_plotted</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Non-significant Clusters (p0.05)&quot;</span>
            <span class="n">nonsig_plotted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">stat_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">savefig_close</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">SaveFigOptions</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.prepare_config_from_csv" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">prepare_config_from_csv</span>


<a href="#tit.stats.prepare_config_from_csv" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">prepare_config_from_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load subject configurations from CSV file</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>csv_file : str
    Path to CSV file
analysis_type : str
    Either 'group_comparison' or 'correlation'</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>list of dict : Subject configurations</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_config_from_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load subject configurations from CSV file</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    csv_file : str</span>
<span class="sd">        Path to CSV file</span>
<span class="sd">    analysis_type : str</span>
<span class="sd">        Either &#39;group_comparison&#39; or &#39;correlation&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    list of dict : Subject configurations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="c1"># Validate required columns for group comparison</span>
        <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation_name&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV file missing required column: &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; for group comparison&quot;</span><span class="p">)</span>

        <span class="n">configs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Handle both &#39;sub-XXX&#39; and &#39;XXX&#39; formats</span>
            <span class="n">subject_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sub-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">:</span> <span class="n">subject_id</span><span class="p">,</span>
                <span class="s1">&#39;simulation_name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;simulation_name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">])</span>
            <span class="p">})</span>

    <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span>
        <span class="c1"># Validate required columns for correlation</span>
        <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation_name&#39;</span><span class="p">,</span> <span class="s1">&#39;effect_size&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV file missing required column: &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; for correlation analysis&quot;</span><span class="p">)</span>

        <span class="n">configs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skipped_rows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Skip rows with missing required fields</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;simulation_name&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;effect_size&#39;</span><span class="p">]):</span>
                <span class="n">skipped_rows</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c1"># Handle both &#39;sub-XXX&#39; and &#39;XXX&#39; formats</span>
            <span class="c1"># Also handle float-to-string conversion (e.g., 101.0 -&gt; &quot;101&quot;)</span>
            <span class="n">raw_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_id</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="c1"># Convert float to int then to string (101.0 -&gt; &quot;101&quot;)</span>
                <span class="n">subject_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">raw_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subject_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw_id</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sub-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1"># Also handle string representations of floats like &quot;101.0&quot;</span>
                <span class="k">if</span> <span class="n">subject_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">):</span>
                    <span class="n">subject_id</span> <span class="o">=</span> <span class="n">subject_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">:</span> <span class="n">subject_id</span><span class="p">,</span>
                <span class="s1">&#39;simulation_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;simulation_name&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;effect_size&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;effect_size&#39;</span><span class="p">])</span>
            <span class="p">}</span>

            <span class="c1"># Add weight if present</span>
            <span class="k">if</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">)):</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>

            <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skipped_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Note: Skipped </span><span class="si">{</span><span class="n">skipped_rows</span><span class="si">}</span><span class="s2"> rows with missing required fields&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid subject configurations found in CSV file&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown analysis_type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">configs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.run_analysis" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_analysis</span>


<a href="#tit.stats.run_analysis" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_analysis</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">analysis_name</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run unified cluster-based permutation analysis</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>subject_configs : list of dict or str
    Either a list of subject configurations or path to CSV file
analysis_name : str
    Name for this analysis (used for output directory)
config : dict, optional
    Configuration dictionary (merged with defaults based on analysis_type)
output_callback : callable, optional
    Callback function for status updates (for GUI integration)
callback_handler : logging.Handler, optional
    Callback handler for GUI console integration
progress_callback : callable, optional
    Callback function for progress updates
stop_callback : callable, optional
    Callback function to check if analysis should be stopped</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>dict : Results dictionary (structure depends on analysis_type)</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_analysis</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">analysis_name</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">callback_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run unified cluster-based permutation analysis</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    subject_configs : list of dict or str</span>
<span class="sd">        Either a list of subject configurations or path to CSV file</span>
<span class="sd">    analysis_name : str</span>
<span class="sd">        Name for this analysis (used for output directory)</span>
<span class="sd">    config : dict, optional</span>
<span class="sd">        Configuration dictionary (merged with defaults based on analysis_type)</span>
<span class="sd">    output_callback : callable, optional</span>
<span class="sd">        Callback function for status updates (for GUI integration)</span>
<span class="sd">    callback_handler : logging.Handler, optional</span>
<span class="sd">        Callback handler for GUI console integration</span>
<span class="sd">    progress_callback : callable, optional</span>
<span class="sd">        Callback function for progress updates</span>
<span class="sd">    stop_callback : callable, optional</span>
<span class="sd">        Callback function to check if analysis should be stopped</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict : Results dictionary (structure depends on analysis_type)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine analysis type from config or default</span>
    <span class="n">analysis_type</span> <span class="o">=</span> <span class="s1">&#39;group_comparison&#39;</span>  <span class="c1"># default</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;analysis_type&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">analysis_type</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;analysis_type&#39;</span><span class="p">]</span>

    <span class="c1"># Merge config with appropriate defaults</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">DEFAULT_CONFIG_GROUP_COMPARISON</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span>
        <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">DEFAULT_CONFIG_CORRELATION</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown analysis_type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">CONFIG</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Ensure analysis_type is set in CONFIG</span>
    <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;analysis_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_type</span>

    <span class="c1"># Callback helper</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">output_callback</span><span class="p">:</span>
            <span class="n">output_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Start timing</span>
    <span class="n">analysis_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Set up output directory</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="n">get_path_manager</span><span class="p">()</span> <span class="k">if</span> <span class="n">get_path_manager</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pm</span><span class="p">:</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">project_dir</span>
        <span class="n">derivatives_dir</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">get_derivatives_dir</span><span class="p">()</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">derivatives_dir</span><span class="p">,</span>
            <span class="n">const</span><span class="o">.</span><span class="n">DIR_TI_TOOLBOX</span><span class="p">,</span>
            <span class="s1">&#39;stats&#39;</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="p">,</span>
            <span class="n">analysis_name</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROJECT_DIR&#39;</span><span class="p">,</span> <span class="s1">&#39;/mnt&#39;</span><span class="p">)</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">project_dir</span><span class="p">,</span>
            <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stats&#39;</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="p">,</span>
            <span class="n">analysis_name</span>
        <span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set up logging</span>
    <span class="k">if</span> <span class="n">callback_handler</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">,</span> <span class="n">log_file</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">,</span> <span class="n">log_file</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">)</span>

    <span class="c1"># Log header</span>
    <span class="n">analysis_title</span> <span class="o">=</span> <span class="s2">&quot;CLUSTER-BASED PERMUTATION TESTING&quot;</span> <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span> <span class="k">else</span> <span class="s2">&quot;CORRELATION-BASED CLUSTER PERMUTATION TESTING&quot;</span>
    <span class="n">subtitle</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span> <span class="k">else</span> <span class="s2">&quot;(ACES-style analysis for continuous outcomes)&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">analysis_title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subtitle</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">subtitle</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis started: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis name: </span><span class="si">{</span><span class="n">analysis_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log file: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2"> analysis: </span><span class="si">{</span><span class="n">analysis_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Construct nifti_file_pattern from tissue_type</span>
    <span class="k">if</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tissue_type</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tissue_type&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tissue_type</span> <span class="o">==</span> <span class="s1">&#39;grey&#39;</span><span class="p">:</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;grey_</span><span class="si">{simulation_name}</span><span class="s1">_TI_MNI_MNI_TI_max.nii.gz&#39;</span>
        <span class="k">elif</span> <span class="n">tissue_type</span> <span class="o">==</span> <span class="s1">&#39;white&#39;</span><span class="p">:</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;white_</span><span class="si">{simulation_name}</span><span class="s1">_TI_MNI_MNI_TI_max.nii.gz&#39;</span>
        <span class="k">elif</span> <span class="n">tissue_type</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{simulation_name}</span><span class="s1">_TI_MNI_MNI_TI_max.nii.gz&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid tissue_type: &#39;</span><span class="si">{</span><span class="n">tissue_type</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;grey&#39;, &#39;white&#39;, or &#39;all&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Log configuration</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONFIGURATION:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Statistical test: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;test_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> t-test&quot;</span><span class="p">)</span>
        <span class="n">alt_text</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;two-sided&#39;</span><span class="p">:</span> <span class="s1">&#39;two-sided ()&#39;</span><span class="p">,</span>
            <span class="s1">&#39;greater&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;one-sided (</span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group1_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group2_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="s1">&#39;less&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;one-sided (</span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group1_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group2_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Alternative hypothesis: </span><span class="si">{</span><span class="n">alt_text</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alternative&#39;</span><span class="p">],</span><span class="w"> </span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alternative&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Correlation type: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;correlation_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">cluster_stat_name</span> <span class="o">=</span> <span class="s2">&quot;Cluster Size&quot;</span> <span class="k">if</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="k">else</span> <span class="s2">&quot;Cluster Mass&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster statistic: </span><span class="si">{</span><span class="n">cluster_stat_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster threshold: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Number of permutations: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Alpha level: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Parallel jobs: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tissue type: </span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tissue_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;grey&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  NIfTI pattern: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Load subject configurations</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading subject configurations from: </span><span class="si">{</span><span class="n">subject_configs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">subject_configs</span> <span class="o">=</span> <span class="n">prepare_config_from_csv</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">)</span>

    <span class="c1"># Branch based on analysis type</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_run_group_comparison_analysis</span><span class="p">(</span>
            <span class="n">subject_configs</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">,</span>
            <span class="n">analysis_start_time</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">stop_callback</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># correlation</span>
        <span class="k">return</span> <span class="n">_run_correlation_analysis</span><span class="p">(</span>
            <span class="n">subject_configs</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">,</span>
            <span class="n">analysis_start_time</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">stop_callback</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.setup_logging" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">setup_logging</span>


<a href="#tit.stats.setup_logging" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">,</span> <span class="n">callback_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set up logging for unified analysis</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>output_dir : str
    Directory where log file will be saved
analysis_type : str
    Type of analysis for log naming
callback_handler : logging.Handler, optional
    Callback handler for GUI integration</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>logger : logging.Logger
    Configured logger instance
log_file : str
    Path to log file</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">,</span> <span class="n">callback_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up logging for unified analysis</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    output_dir : str</span>
<span class="sd">        Directory where log file will be saved</span>
<span class="sd">    analysis_type : str</span>
<span class="sd">        Type of analysis for log naming</span>
<span class="sd">    callback_handler : logging.Handler, optional</span>
<span class="sd">        Callback handler for GUI integration</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    logger : logging.Logger</span>
<span class="sd">        Configured logger instance</span>
<span class="sd">    log_file : str</span>
<span class="sd">        Path to log file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logging_util</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;logging_util module not available&quot;</span><span class="p">)</span>

    <span class="c1"># Create timestamp for log file</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">_analysis_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">)</span>

    <span class="c1"># Create logger</span>
    <span class="n">logger_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;GroupComparison&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">analysis_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;group_comparison&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Correlation&#39;</span><span class="si">}</span><span class="s2">Analysis&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging_util</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># If callback handler provided (for GUI), suppress console output and add callback</span>
    <span class="k">if</span> <span class="n">callback_handler</span><span class="p">:</span>
        <span class="n">logging_util</span><span class="o">.</span><span class="n">suppress_console_output</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">callback_handler</span><span class="p">)</span>

    <span class="c1"># Configure external loggers</span>
    <span class="n">external_loggers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;nibabel&#39;</span><span class="p">,</span> <span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">]</span>
    <span class="n">logging_util</span><span class="o">.</span><span class="n">configure_external_loggers</span><span class="p">(</span><span class="n">external_loggers</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_file</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.ttest_voxelwise" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">ttest_voxelwise</span>


<a href="#tit.stats.ttest_voxelwise" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ttest_voxelwise</span><span class="p">(</span><span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">,</span> <span class="n">test_type</span><span class="o">=</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Perform vectorized t-test (paired or unpaired) at each voxel.</p>
<p>Uses vectorized computation for optimal performance.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>responders : ndarray (x, y, z, n_subjects)
    Responder data (group 1)
non_responders : ndarray (x, y, z, n_subjects)
    Non-responder data (group 2)
test_type : str
    Either 'paired' or 'unpaired' t-test
alternative : {'two-sided', 'greater', 'less'}, optional
    Defines the alternative hypothesis (default: 'two-sided'):
    * 'two-sided': means are different (responders  non-responders)
    * 'greater': responders have higher values (responders &gt; non-responders)
    * 'less': responders have lower values (responders &lt; non-responders)
verbose : bool
    Print progress information</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>p_values : ndarray (x, y, z)
    P-value at each voxel
t_statistics : ndarray (x, y, z)
    T-statistic at each voxel
valid_mask : ndarray (x, y, z)
    Boolean mask of valid voxels</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/stats_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ttest_voxelwise</span><span class="p">(</span><span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">,</span> <span class="n">test_type</span><span class="o">=</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform vectorized t-test (paired or unpaired) at each voxel.</span>

<span class="sd">    Uses vectorized computation for optimal performance.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    responders : ndarray (x, y, z, n_subjects)</span>
<span class="sd">        Responder data (group 1)</span>
<span class="sd">    non_responders : ndarray (x, y, z, n_subjects)</span>
<span class="sd">        Non-responder data (group 2)</span>
<span class="sd">    test_type : str</span>
<span class="sd">        Either &#39;paired&#39; or &#39;unpaired&#39; t-test</span>
<span class="sd">    alternative : {&#39;two-sided&#39;, &#39;greater&#39;, &#39;less&#39;}, optional</span>
<span class="sd">        Defines the alternative hypothesis (default: &#39;two-sided&#39;):</span>
<span class="sd">        * &#39;two-sided&#39;: means are different (responders  non-responders)</span>
<span class="sd">        * &#39;greater&#39;: responders have higher values (responders &gt; non-responders)</span>
<span class="sd">        * &#39;less&#39;: responders have lower values (responders &lt; non-responders)</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Print progress information</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    p_values : ndarray (x, y, z)</span>
<span class="sd">        P-value at each voxel</span>
<span class="sd">    t_statistics : ndarray (x, y, z)</span>
<span class="sd">        T-statistic at each voxel</span>
<span class="sd">    valid_mask : ndarray (x, y, z)</span>
<span class="sd">        Boolean mask of valid voxels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">test_name</span> <span class="o">=</span> <span class="s2">&quot;Paired&quot;</span> <span class="k">if</span> <span class="n">test_type</span> <span class="o">==</span> <span class="s1">&#39;paired&#39;</span> <span class="k">else</span> <span class="s2">&quot;Unpaired (Independent Samples)&quot;</span>
        <span class="n">alt_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s1">&#39;greater&#39;</span><span class="p">:</span>
            <span class="n">alt_text</span> <span class="o">=</span> <span class="s2">&quot; (one-sided: responders &gt; non-responders)&quot;</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s1">&#39;less&#39;</span><span class="p">:</span>
            <span class="n">alt_text</span> <span class="o">=</span> <span class="s2">&quot; (one-sided: responders &lt; non-responders)&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performing voxelwise </span><span class="si">{</span><span class="n">test_name</span><span class="si">}</span><span class="s2"> t-tests</span><span class="si">{</span><span class="n">alt_text</span><span class="si">}</span><span class="s2"> (vectorized)...&quot;</span><span class="p">)</span>

    <span class="c1"># Validate test type</span>
    <span class="k">if</span> <span class="n">test_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;paired&#39;</span><span class="p">,</span> <span class="s1">&#39;unpaired&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;test_type must be &#39;paired&#39; or &#39;unpaired&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># For paired test, check that sample sizes match</span>
    <span class="k">if</span> <span class="n">test_type</span> <span class="o">==</span> <span class="s1">&#39;paired&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">non_responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Paired t-test requires equal sample sizes. &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">non_responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> subjects&quot;</span><span class="p">)</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">p_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">t_statistics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Create mask of valid voxels (non-zero in at least some subjects)</span>
    <span class="n">responder_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">responders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">non_responder_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">non_responders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">responder_mask</span> <span class="o">|</span> <span class="n">non_responder_mask</span>

    <span class="n">total_voxels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing </span><span class="si">{</span><span class="n">total_voxels</span><span class="si">}</span><span class="s2"> valid voxels using vectorized approach...&quot;</span><span class="p">)</span>

    <span class="c1"># Get coordinates of valid voxels</span>
    <span class="n">valid_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span>

    <span class="c1"># Vectorized approach: compute all tests at once</span>
    <span class="n">n_valid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_coords</span><span class="p">)</span>
    <span class="n">n_resp</span> <span class="o">=</span> <span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n_non_resp</span> <span class="o">=</span> <span class="n">non_responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Pre-extract voxel data using advanced indexing (faster than loop)</span>
    <span class="c1"># This avoids Python loop overhead by using NumPy&#39;s optimized indexing</span>
    <span class="n">idx_i</span><span class="p">,</span> <span class="n">idx_j</span><span class="p">,</span> <span class="n">idx_k</span> <span class="o">=</span> <span class="n">valid_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">valid_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">valid_coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Extract all valid voxels at once using fancy indexing</span>
    <span class="n">resp_extracted</span> <span class="o">=</span> <span class="n">responders</span><span class="p">[</span><span class="n">idx_i</span><span class="p">,</span> <span class="n">idx_j</span><span class="p">,</span> <span class="n">idx_k</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># (n_valid, n_resp)</span>
    <span class="n">non_resp_extracted</span> <span class="o">=</span> <span class="n">non_responders</span><span class="p">[</span><span class="n">idx_i</span><span class="p">,</span> <span class="n">idx_j</span><span class="p">,</span> <span class="n">idx_k</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># (n_valid, n_non_resp)</span>

    <span class="c1"># Concatenate horizontally</span>
    <span class="n">voxel_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">resp_extracted</span><span class="p">,</span> <span class="n">non_resp_extracted</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Use vectorized t-test functions</span>
    <span class="k">if</span> <span class="n">test_type</span> <span class="o">==</span> <span class="s1">&#39;paired&#39;</span><span class="p">:</span>
        <span class="n">t_stats_1d</span><span class="p">,</span> <span class="n">p_values_1d</span> <span class="o">=</span> <span class="n">ttest_rel</span><span class="p">(</span>
            <span class="n">voxel_data</span><span class="p">,</span> <span class="n">n_resp</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_stats_1d</span><span class="p">,</span> <span class="n">p_values_1d</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span>
            <span class="n">voxel_data</span><span class="p">,</span> <span class="n">n_resp</span><span class="p">,</span> <span class="n">n_non_resp</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span>
        <span class="p">)</span>

    <span class="c1"># Map results back to 3D volume coordinates using advanced indexing (faster than loop)</span>
    <span class="n">t_statistics</span><span class="p">[</span><span class="n">idx_i</span><span class="p">,</span> <span class="n">idx_j</span><span class="p">,</span> <span class="n">idx_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_stats_1d</span>
    <span class="n">p_values</span><span class="p">[</span><span class="n">idx_i</span><span class="p">,</span> <span class="n">idx_j</span><span class="p">,</span> <span class="n">idx_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_values_1d</span>

    <span class="k">return</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">t_statistics</span><span class="p">,</span> <span class="n">valid_mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="permutation-analysis-titstatspermutation_analysis">Permutation analysis (<code>tit.stats.permutation_analysis</code>)<a class="headerlink" href="#permutation-analysis-titstatspermutation_analysis" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="tit.stats.permutation_analysis"></a>
    <div class="doc doc-contents first">

        <p>Unified Cluster-Based Permutation Testing for TI-Toolbox</p>
<p>This script provides unified cluster-based permutation testing for both:
1. Group comparison analysis (binary responder/non-responder classification)
2. Correlation analysis (continuous outcome measures)</p>
<p>Supports both t-test and correlation-based statistical approaches with
cluster-based permutation correction for multiple comparisons.</p>
<p>Usage:
    from tit.stats import permutation_analysis
    # Group comparison
    results = permutation_analysis.run_analysis(
        subject_configs, analysis_name, analysis_type='group_comparison'
    )
    # Correlation analysis
    results = permutation_analysis.run_analysis(
        subject_configs, analysis_name, analysis_type='correlation'
    )</p>
<p>For GUI usage, see gui/extensions/permutation_analysis.py</p>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="tit.stats.permutation_analysis.load_subject_data" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">load_subject_data</span>


<a href="#tit.stats.permutation_analysis.load_subject_data" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_subject_data</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Unified data loading for both group comparison and correlation analysis</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>subject_configs : list of dict
    Subject configurations (format depends on analysis_type)
nifti_file_pattern : str, optional
    Pattern for NIfTI files
analysis_type : str
    Either 'group_comparison' or 'correlation'</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>For group_comparison:
    responders, non_responders, template_img, resp_ids, non_resp_ids
For correlation:
    subject_data, effect_sizes, weights, template_img, subject_ids</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_subject_data</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unified data loading for both group comparison and correlation analysis</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    subject_configs : list of dict</span>
<span class="sd">        Subject configurations (format depends on analysis_type)</span>
<span class="sd">    nifti_file_pattern : str, optional</span>
<span class="sd">        Pattern for NIfTI files</span>
<span class="sd">    analysis_type : str</span>
<span class="sd">        Either &#39;group_comparison&#39; or &#39;correlation&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    For group_comparison:</span>
<span class="sd">        responders, non_responders, template_img, resp_ids, non_resp_ids</span>
<span class="sd">    For correlation:</span>
<span class="sd">        subject_data, effect_sizes, weights, template_img, subject_ids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_subject_data_group_comparison</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_subject_data_correlation</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown analysis_type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.permutation_analysis.load_subject_data_correlation" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">load_subject_data_correlation</span>


<a href="#tit.stats.permutation_analysis.load_subject_data_correlation" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_subject_data_correlation</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load subject data for correlation analysis (continuous outcomes)</p>

            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_subject_data_correlation</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load subject data for correlation analysis (continuous outcomes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nifti_file_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nifti_file_pattern</span> <span class="o">=</span> <span class="s2">&quot;grey_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz&quot;</span>

    <span class="c1"># Check for required fields</span>
    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation_name&#39;</span><span class="p">,</span> <span class="s1">&#39;effect_size&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">subject_configs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required field &#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#39; in subject config&quot;</span><span class="p">)</span>

    <span class="c1"># Load all subjects</span>
    <span class="n">subject_data</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">nifti</span><span class="o">.</span><span class="n">load_group_data_ti_toolbox</span><span class="p">(</span>
        <span class="n">subject_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">nifti_file_pattern</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="c1"># Build a lookup from subject_id to config for successfully loaded subjects</span>
    <span class="n">config_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">subject_configs</span><span class="p">}</span>

    <span class="c1"># Extract effect sizes and weights only for successfully loaded subjects</span>
    <span class="n">effect_sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">weights_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">has_weights</span> <span class="o">=</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">subject_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">subject_ids</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">config_lookup</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="n">effect_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;effect_size&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">has_weights</span><span class="p">:</span>
            <span class="n">weights_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

    <span class="n">effect_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_weights</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> subjects: </span><span class="si">{</span><span class="n">subject_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect sizes: mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect size range: [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weights: mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, range=[</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data shape: </span><span class="si">{</span><span class="n">subject_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">subject_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">subject_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.permutation_analysis.load_subject_data_group_comparison" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">load_subject_data_group_comparison</span>


<a href="#tit.stats.permutation_analysis.load_subject_data_group_comparison" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_subject_data_group_comparison</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load subject data for group comparison analysis (binary outcomes)</p>

            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_subject_data_group_comparison</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load subject data for group comparison analysis (binary outcomes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nifti_file_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nifti_file_pattern</span> <span class="o">=</span> <span class="s2">&quot;grey_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz&quot;</span>

    <span class="c1"># Separate configs by response</span>
    <span class="n">responder_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">subject_configs</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">non_responder_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">subject_configs</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">responder_configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_responder_configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need at least one responder and one non-responder&quot;</span><span class="p">)</span>

    <span class="c1"># Load responders</span>
    <span class="n">responders</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">responder_ids</span> <span class="o">=</span> <span class="n">nifti</span><span class="o">.</span><span class="n">load_group_data_ti_toolbox</span><span class="p">(</span>
        <span class="n">responder_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">nifti_file_pattern</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="c1"># Load non-responders</span>
    <span class="n">non_responders</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">non_responder_ids</span> <span class="o">=</span> <span class="n">nifti</span><span class="o">.</span><span class="n">load_group_data_ti_toolbox</span><span class="p">(</span>
        <span class="n">non_responder_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">nifti_file_pattern</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">responder_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> responders: </span><span class="si">{</span><span class="n">responder_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">non_responder_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> non-responders: </span><span class="si">{</span><span class="n">non_responder_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Responders shape: </span><span class="si">{</span><span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-responders shape: </span><span class="si">{</span><span class="n">non_responders</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">responder_ids</span><span class="p">,</span> <span class="n">non_responder_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.permutation_analysis.main" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">main</span>


<a href="#tit.stats.permutation_analysis.main" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">main</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Command-line interface for unified permutation analysis</p>

            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command-line interface for unified permutation analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>

    <span class="c1"># Ensure proper multiprocessing initialization</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">multiprocessing</span><span class="p">,</span> <span class="s1">&#39;set_start_method&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">multiprocessing</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="s1">&#39;fork&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Unified Cluster-Based Permutation Testing for TI-Toolbox&#39;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Examples:</span>
<span class="s2">  # Group comparison analysis</span>
<span class="s2">  python permutation_analysis.py --csv subjects.csv --name my_analysis </span><span class="se">\\</span>
<span class="s2">      --analysis-type group_comparison</span>

<span class="s2">  # Correlation analysis</span>
<span class="s2">  python permutation_analysis.py --csv subjects.csv --name my_analysis </span><span class="se">\\</span>
<span class="s2">      --analysis-type correlation</span>

<span class="s2">Group Comparison CSV Format:</span>
<span class="s2">  subject_id,simulation_name,response</span>
<span class="s2">  070,ICP_RHIPPO,1</span>
<span class="s2">  071,ICP_RHIPPO,0</span>

<span class="s2">Correlation CSV Format:</span>
<span class="s2">  subject_id,simulation_name,effect_size,weight</span>
<span class="s2">  070,ICP_RHIPPO,0.45,25</span>
<span class="s2">  071,ICP_RHIPPO,0.32,30</span>

<span class="s2">Tissue Types:</span>
<span class="s2">  --tissue-type controls which NIfTI files are loaded:</span>
<span class="s2">    grey  : grey_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz</span>
<span class="s2">    white : white_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz</span>
<span class="s2">    all   : </span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz (no prefix)</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Required arguments</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--csv&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to CSV file with subject configurations&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Analysis name (used for output directory)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--analysis-type&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of analysis to perform&#39;</span><span class="p">)</span>

    <span class="c1"># Statistical parameters (common)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cluster-threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;P-value threshold for cluster formation (default: 0.05)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cluster-stat&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cluster statistic: mass (sum of t-values) or size (voxel count) (default: mass)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n-permutations&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of permutations (default: 1000)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cluster-level significance threshold (default: 0.05)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n-jobs&#39;</span><span class="p">,</span> <span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of parallel jobs: -1=all cores, 1=sequential (default: -1)&#39;</span><span class="p">)</span>

    <span class="c1"># Group comparison specific parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--test-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span> <span class="s1">&#39;paired&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Statistical test type for group comparison (default: unpaired)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--alternative&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span> <span class="s1">&#39;greater&#39;</span><span class="p">,</span> <span class="s1">&#39;less&#39;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Alternative hypothesis for group comparison (default: two-sided)&#39;</span><span class="p">)</span>

    <span class="c1"># Correlation specific parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--correlation-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;spearman&#39;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of correlation for correlation analysis (default: pearson)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--use-weights&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use weights from CSV if available (correlation analysis)&#39;</span><span class="p">)</span>

    <span class="c1"># Optional parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tissue-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Tissue type for NIfTI files: grey (grey matter), &#39;</span>
                             <span class="s1">&#39;white (white matter), or all (all tissues, no prefix). &#39;</span>
                             <span class="s1">&#39;(default: grey)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--nifti-pattern&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Custom NIfTI filename pattern (overrides --tissue-type)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--quiet&#39;</span><span class="p">,</span> <span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Suppress progress output&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Build configuration</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;analysis_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span><span class="p">,</span>
        <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">cluster_threshold</span><span class="p">,</span>
        <span class="s1">&#39;cluster_stat&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">cluster_stat</span><span class="p">,</span>
        <span class="s1">&#39;n_permutations&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">n_permutations</span><span class="p">,</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
        <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
        <span class="s1">&#39;tissue_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tissue_type</span><span class="p">,</span>
        <span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">nifti_pattern</span><span class="p">,</span>  <span class="c1"># None triggers auto-generation</span>
    <span class="p">}</span>

    <span class="c1"># Add analysis-specific parameters</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;test_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">test_type</span><span class="p">,</span>
            <span class="s1">&#39;alternative&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">alternative</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># correlation</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;correlation_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">correlation_type</span><span class="p">,</span>
            <span class="s1">&#39;use_weights&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">use_weights</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="c1"># Print header</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UNIFIED CLUSTER-BASED PERMUTATION TESTING - TI-TOOLBOX&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis type: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV file: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis name: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tissue type: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">tissue_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permutations: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">n_permutations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parallel jobs: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">n_jobs</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">args</span><span class="o">.</span><span class="n">n_jobs</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;all cores&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster statistic: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">cluster_stat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster threshold: p &lt; </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">cluster_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Run analysis</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">run_analysis</span><span class="p">(</span>
            <span class="n">subject_configs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">csv</span><span class="p">,</span>
            <span class="n">analysis_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">output_callback</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span> <span class="k">else</span> <span class="nb">print</span>
        <span class="p">)</span>

        <span class="c1"># Print summary</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ANALYSIS COMPLETE!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;n_significant_clusters&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant clusters: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;n_significant_clusters&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;n_significant_voxels&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant voxels: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;n_significant_voxels&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis time: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;analysis_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERROR: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.permutation_analysis.prepare_config_from_csv" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">prepare_config_from_csv</span>


<a href="#tit.stats.permutation_analysis.prepare_config_from_csv" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">prepare_config_from_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load subject configurations from CSV file</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>csv_file : str
    Path to CSV file
analysis_type : str
    Either 'group_comparison' or 'correlation'</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>list of dict : Subject configurations</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_config_from_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load subject configurations from CSV file</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    csv_file : str</span>
<span class="sd">        Path to CSV file</span>
<span class="sd">    analysis_type : str</span>
<span class="sd">        Either &#39;group_comparison&#39; or &#39;correlation&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    list of dict : Subject configurations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="c1"># Validate required columns for group comparison</span>
        <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation_name&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV file missing required column: &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; for group comparison&quot;</span><span class="p">)</span>

        <span class="n">configs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Handle both &#39;sub-XXX&#39; and &#39;XXX&#39; formats</span>
            <span class="n">subject_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sub-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">:</span> <span class="n">subject_id</span><span class="p">,</span>
                <span class="s1">&#39;simulation_name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;simulation_name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">])</span>
            <span class="p">})</span>

    <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span>
        <span class="c1"># Validate required columns for correlation</span>
        <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation_name&#39;</span><span class="p">,</span> <span class="s1">&#39;effect_size&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV file missing required column: &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; for correlation analysis&quot;</span><span class="p">)</span>

        <span class="n">configs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skipped_rows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Skip rows with missing required fields</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;simulation_name&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;effect_size&#39;</span><span class="p">]):</span>
                <span class="n">skipped_rows</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c1"># Handle both &#39;sub-XXX&#39; and &#39;XXX&#39; formats</span>
            <span class="c1"># Also handle float-to-string conversion (e.g., 101.0 -&gt; &quot;101&quot;)</span>
            <span class="n">raw_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_id</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="c1"># Convert float to int then to string (101.0 -&gt; &quot;101&quot;)</span>
                <span class="n">subject_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">raw_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subject_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw_id</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sub-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1"># Also handle string representations of floats like &quot;101.0&quot;</span>
                <span class="k">if</span> <span class="n">subject_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">):</span>
                    <span class="n">subject_id</span> <span class="o">=</span> <span class="n">subject_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">:</span> <span class="n">subject_id</span><span class="p">,</span>
                <span class="s1">&#39;simulation_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;simulation_name&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;effect_size&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;effect_size&#39;</span><span class="p">])</span>
            <span class="p">}</span>

            <span class="c1"># Add weight if present</span>
            <span class="k">if</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">)):</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>

            <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skipped_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Note: Skipped </span><span class="si">{</span><span class="n">skipped_rows</span><span class="si">}</span><span class="s2"> rows with missing required fields&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid subject configurations found in CSV file&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown analysis_type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">configs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.permutation_analysis.run_analysis" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_analysis</span>


<a href="#tit.stats.permutation_analysis.run_analysis" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_analysis</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">analysis_name</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run unified cluster-based permutation analysis</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>subject_configs : list of dict or str
    Either a list of subject configurations or path to CSV file
analysis_name : str
    Name for this analysis (used for output directory)
config : dict, optional
    Configuration dictionary (merged with defaults based on analysis_type)
output_callback : callable, optional
    Callback function for status updates (for GUI integration)
callback_handler : logging.Handler, optional
    Callback handler for GUI console integration
progress_callback : callable, optional
    Callback function for progress updates
stop_callback : callable, optional
    Callback function to check if analysis should be stopped</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>dict : Results dictionary (structure depends on analysis_type)</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_analysis</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">analysis_name</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">callback_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run unified cluster-based permutation analysis</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    subject_configs : list of dict or str</span>
<span class="sd">        Either a list of subject configurations or path to CSV file</span>
<span class="sd">    analysis_name : str</span>
<span class="sd">        Name for this analysis (used for output directory)</span>
<span class="sd">    config : dict, optional</span>
<span class="sd">        Configuration dictionary (merged with defaults based on analysis_type)</span>
<span class="sd">    output_callback : callable, optional</span>
<span class="sd">        Callback function for status updates (for GUI integration)</span>
<span class="sd">    callback_handler : logging.Handler, optional</span>
<span class="sd">        Callback handler for GUI console integration</span>
<span class="sd">    progress_callback : callable, optional</span>
<span class="sd">        Callback function for progress updates</span>
<span class="sd">    stop_callback : callable, optional</span>
<span class="sd">        Callback function to check if analysis should be stopped</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict : Results dictionary (structure depends on analysis_type)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine analysis type from config or default</span>
    <span class="n">analysis_type</span> <span class="o">=</span> <span class="s1">&#39;group_comparison&#39;</span>  <span class="c1"># default</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;analysis_type&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">analysis_type</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;analysis_type&#39;</span><span class="p">]</span>

    <span class="c1"># Merge config with appropriate defaults</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">DEFAULT_CONFIG_GROUP_COMPARISON</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span>
        <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">DEFAULT_CONFIG_CORRELATION</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown analysis_type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">CONFIG</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Ensure analysis_type is set in CONFIG</span>
    <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;analysis_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_type</span>

    <span class="c1"># Callback helper</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">output_callback</span><span class="p">:</span>
            <span class="n">output_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Start timing</span>
    <span class="n">analysis_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Set up output directory</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="n">get_path_manager</span><span class="p">()</span> <span class="k">if</span> <span class="n">get_path_manager</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pm</span><span class="p">:</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">project_dir</span>
        <span class="n">derivatives_dir</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">get_derivatives_dir</span><span class="p">()</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">derivatives_dir</span><span class="p">,</span>
            <span class="n">const</span><span class="o">.</span><span class="n">DIR_TI_TOOLBOX</span><span class="p">,</span>
            <span class="s1">&#39;stats&#39;</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="p">,</span>
            <span class="n">analysis_name</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROJECT_DIR&#39;</span><span class="p">,</span> <span class="s1">&#39;/mnt&#39;</span><span class="p">)</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">project_dir</span><span class="p">,</span>
            <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stats&#39;</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="p">,</span>
            <span class="n">analysis_name</span>
        <span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set up logging</span>
    <span class="k">if</span> <span class="n">callback_handler</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">,</span> <span class="n">log_file</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">,</span> <span class="n">log_file</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">)</span>

    <span class="c1"># Log header</span>
    <span class="n">analysis_title</span> <span class="o">=</span> <span class="s2">&quot;CLUSTER-BASED PERMUTATION TESTING&quot;</span> <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span> <span class="k">else</span> <span class="s2">&quot;CORRELATION-BASED CLUSTER PERMUTATION TESTING&quot;</span>
    <span class="n">subtitle</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span> <span class="k">else</span> <span class="s2">&quot;(ACES-style analysis for continuous outcomes)&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">analysis_title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subtitle</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">subtitle</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis started: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis name: </span><span class="si">{</span><span class="n">analysis_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log file: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2"> analysis: </span><span class="si">{</span><span class="n">analysis_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Construct nifti_file_pattern from tissue_type</span>
    <span class="k">if</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tissue_type</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tissue_type&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tissue_type</span> <span class="o">==</span> <span class="s1">&#39;grey&#39;</span><span class="p">:</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;grey_</span><span class="si">{simulation_name}</span><span class="s1">_TI_MNI_MNI_TI_max.nii.gz&#39;</span>
        <span class="k">elif</span> <span class="n">tissue_type</span> <span class="o">==</span> <span class="s1">&#39;white&#39;</span><span class="p">:</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;white_</span><span class="si">{simulation_name}</span><span class="s1">_TI_MNI_MNI_TI_max.nii.gz&#39;</span>
        <span class="k">elif</span> <span class="n">tissue_type</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{simulation_name}</span><span class="s1">_TI_MNI_MNI_TI_max.nii.gz&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid tissue_type: &#39;</span><span class="si">{</span><span class="n">tissue_type</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;grey&#39;, &#39;white&#39;, or &#39;all&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Log configuration</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONFIGURATION:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Statistical test: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;test_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> t-test&quot;</span><span class="p">)</span>
        <span class="n">alt_text</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;two-sided&#39;</span><span class="p">:</span> <span class="s1">&#39;two-sided ()&#39;</span><span class="p">,</span>
            <span class="s1">&#39;greater&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;one-sided (</span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group1_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group2_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="s1">&#39;less&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;one-sided (</span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group1_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group2_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Alternative hypothesis: </span><span class="si">{</span><span class="n">alt_text</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alternative&#39;</span><span class="p">],</span><span class="w"> </span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alternative&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Correlation type: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;correlation_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">cluster_stat_name</span> <span class="o">=</span> <span class="s2">&quot;Cluster Size&quot;</span> <span class="k">if</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="k">else</span> <span class="s2">&quot;Cluster Mass&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster statistic: </span><span class="si">{</span><span class="n">cluster_stat_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster threshold: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Number of permutations: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Alpha level: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Parallel jobs: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tissue type: </span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tissue_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;grey&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  NIfTI pattern: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Load subject configurations</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading subject configurations from: </span><span class="si">{</span><span class="n">subject_configs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">subject_configs</span> <span class="o">=</span> <span class="n">prepare_config_from_csv</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">)</span>

    <span class="c1"># Branch based on analysis type</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_run_group_comparison_analysis</span><span class="p">(</span>
            <span class="n">subject_configs</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">,</span>
            <span class="n">analysis_start_time</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">stop_callback</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># correlation</span>
        <span class="k">return</span> <span class="n">_run_correlation_analysis</span><span class="p">(</span>
            <span class="n">subject_configs</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">,</span>
            <span class="n">analysis_start_time</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">stop_callback</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tit.stats.permutation_analysis.setup_logging" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">setup_logging</span>


<a href="#tit.stats.permutation_analysis.setup_logging" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">,</span> <span class="n">callback_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set up logging for unified analysis</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>output_dir : str
    Directory where log file will be saved
analysis_type : str
    Type of analysis for log naming
callback_handler : logging.Handler, optional
    Callback handler for GUI integration</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>logger : logging.Logger
    Configured logger instance
log_file : str
    Path to log file</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tit/stats/permutation_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">,</span> <span class="n">callback_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up logging for unified analysis</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    output_dir : str</span>
<span class="sd">        Directory where log file will be saved</span>
<span class="sd">    analysis_type : str</span>
<span class="sd">        Type of analysis for log naming</span>
<span class="sd">    callback_handler : logging.Handler, optional</span>
<span class="sd">        Callback handler for GUI integration</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    logger : logging.Logger</span>
<span class="sd">        Configured logger instance</span>
<span class="sd">    log_file : str</span>
<span class="sd">        Path to log file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logging_util</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;logging_util module not available&quot;</span><span class="p">)</span>

    <span class="c1"># Create timestamp for log file</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">_analysis_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">)</span>

    <span class="c1"># Create logger</span>
    <span class="n">logger_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;GroupComparison&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">analysis_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;group_comparison&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Correlation&#39;</span><span class="si">}</span><span class="s2">Analysis&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging_util</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># If callback handler provided (for GUI), suppress console output and add callback</span>
    <span class="k">if</span> <span class="n">callback_handler</span><span class="p">:</span>
        <span class="n">logging_util</span><span class="o">.</span><span class="n">suppress_console_output</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">callback_handler</span><span class="p">)</span>

    <span class="c1"># Configure external loggers</span>
    <span class="n">external_loggers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;nibabel&#39;</span><span class="p">,</span> <span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">]</span>
    <span class="n">logging_util</span><span class="o">.</span><span class="n">configure_external_loggers</span><span class="p">(</span><span class="n">external_loggers</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_file</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.sections", "navigation.expand", "toc.follow"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>