

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tit.analyzer.voxel_analyzer &mdash; TI-Toolbox 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=51b770b3"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            TI-Toolbox
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Core Modules (<code class="docutils literal notranslate"><span class="pre">tit.core</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.paths">Path Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager"><code class="docutils literal notranslate"><span class="pre">PathManager</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.__init__"><code class="docutils literal notranslate"><span class="pre">PathManager.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.project_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.project_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.project_dir_name"><code class="docutils literal notranslate"><span class="pre">PathManager.project_dir_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.path"><code class="docutils literal notranslate"><span class="pre">PathManager.path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.path_optional"><code class="docutils literal notranslate"><span class="pre">PathManager.path_optional()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.list_flex_search_runs"><code class="docutils literal notranslate"><span class="pre">PathManager.list_flex_search_runs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.exists"><code class="docutils literal notranslate"><span class="pre">PathManager.exists()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.is_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.is_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.is_file"><code class="docutils literal notranslate"><span class="pre">PathManager.is_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.ensure_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.ensure_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.list_subjects"><code class="docutils literal notranslate"><span class="pre">PathManager.list_subjects()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.list_simulations"><code class="docutils literal notranslate"><span class="pre">PathManager.list_simulations()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.analysis_space_dir_name"><code class="docutils literal notranslate"><span class="pre">PathManager.analysis_space_dir_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.spherical_analysis_name"><code class="docutils literal notranslate"><span class="pre">PathManager.spherical_analysis_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.cortical_analysis_name"><code class="docutils literal notranslate"><span class="pre">PathManager.cortical_analysis_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.get_analysis_space_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.get_analysis_space_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.get_analysis_output_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.get_analysis_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.get_derivatives_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.get_derivatives_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.list_eeg_caps"><code class="docutils literal notranslate"><span class="pre">PathManager.list_eeg_caps()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.validate_subject_structure"><code class="docutils literal notranslate"><span class="pre">PathManager.validate_subject_structure()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.paths.get_path_manager"><code class="docutils literal notranslate"><span class="pre">get_path_manager()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.paths.reset_path_manager"><code class="docutils literal notranslate"><span class="pre">reset_path_manager()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.constants">Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.nifti">NIfTI Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.nifti.load_subject_nifti_ti_toolbox"><code class="docutils literal notranslate"><span class="pre">load_subject_nifti_ti_toolbox()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.nifti.load_group_data_ti_toolbox"><code class="docutils literal notranslate"><span class="pre">load_group_data_ti_toolbox()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.nifti.load_grouped_subjects_ti_toolbox"><code class="docutils literal notranslate"><span class="pre">load_grouped_subjects_ti_toolbox()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.mesh">Mesh Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.mesh.create_mesh_opt_file"><code class="docutils literal notranslate"><span class="pre">create_mesh_opt_file()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.calc">Calculations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.calc.get_TI_vectors"><code class="docutils literal notranslate"><span class="pre">get_TI_vectors()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.calc.get_mTI_vectors"><code class="docutils literal notranslate"><span class="pre">get_mTI_vectors()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.roi">ROI Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.roi.find_roi_element_indices"><code class="docutils literal notranslate"><span class="pre">find_roi_element_indices()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.roi.find_grey_matter_indices"><code class="docutils literal notranslate"><span class="pre">find_grey_matter_indices()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.roi.calculate_roi_metrics"><code class="docutils literal notranslate"><span class="pre">calculate_roi_metrics()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.roi.ROICoordinateHelper"><code class="docutils literal notranslate"><span class="pre">ROICoordinateHelper</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.roi.ROICoordinateHelper.transform_mni_to_subject"><code class="docutils literal notranslate"><span class="pre">ROICoordinateHelper.transform_mni_to_subject()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.roi.ROICoordinateHelper.find_voxels_in_sphere"><code class="docutils literal notranslate"><span class="pre">ROICoordinateHelper.find_voxels_in_sphere()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.roi.ROICoordinateHelper.load_roi_from_csv"><code class="docutils literal notranslate"><span class="pre">ROICoordinateHelper.load_roi_from_csv()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.roi.ROICoordinateHelper.save_roi_to_csv"><code class="docutils literal notranslate"><span class="pre">ROICoordinateHelper.save_roi_to_csv()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.roi.validate_ti_montage"><code class="docutils literal notranslate"><span class="pre">validate_ti_montage()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.utils">Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.utils.find_roi_element_indices"><code class="docutils literal notranslate"><span class="pre">find_roi_element_indices()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.utils.find_grey_matter_indices"><code class="docutils literal notranslate"><span class="pre">find_grey_matter_indices()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.utils.calculate_roi_metrics"><code class="docutils literal notranslate"><span class="pre">calculate_roi_metrics()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.errors">Error Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.TIToolboxError"><code class="docutils literal notranslate"><span class="pre">TIToolboxError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.TIToolboxError.__init__"><code class="docutils literal notranslate"><span class="pre">TIToolboxError.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.TIToolboxError.to_dict"><code class="docutils literal notranslate"><span class="pre">TIToolboxError.to_dict()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ProcessError"><code class="docutils literal notranslate"><span class="pre">ProcessError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ProcessError.__init__"><code class="docutils literal notranslate"><span class="pre">ProcessError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ValidationError"><code class="docutils literal notranslate"><span class="pre">ValidationError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ValidationError.__init__"><code class="docutils literal notranslate"><span class="pre">ValidationError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.FileNotFoundError"><code class="docutils literal notranslate"><span class="pre">FileNotFoundError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.FileNotFoundError.__init__"><code class="docutils literal notranslate"><span class="pre">FileNotFoundError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ConfigurationError"><code class="docutils literal notranslate"><span class="pre">ConfigurationError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ConfigurationError.__init__"><code class="docutils literal notranslate"><span class="pre">ConfigurationError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.SubjectError"><code class="docutils literal notranslate"><span class="pre">SubjectError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.SubjectError.__init__"><code class="docutils literal notranslate"><span class="pre">SubjectError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.SimulationError"><code class="docutils literal notranslate"><span class="pre">SimulationError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.SimulationError.__init__"><code class="docutils literal notranslate"><span class="pre">SimulationError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.AnalysisError"><code class="docutils literal notranslate"><span class="pre">AnalysisError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.AnalysisError.__init__"><code class="docutils literal notranslate"><span class="pre">AnalysisError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.MeshError"><code class="docutils literal notranslate"><span class="pre">MeshError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.MeshError.__init__"><code class="docutils literal notranslate"><span class="pre">MeshError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.handle_error"><code class="docutils literal notranslate"><span class="pre">handle_error()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.show_error_dialog"><code class="docutils literal notranslate"><span class="pre">show_error_dialog()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.validate_file_exists"><code class="docutils literal notranslate"><span class="pre">validate_file_exists()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.validate_subject"><code class="docutils literal notranslate"><span class="pre">validate_subject()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.validate_montage_config"><code class="docutils literal notranslate"><span class="pre">validate_montage_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.process">Process Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner"><code class="docutils literal notranslate"><span class="pre">ProcessRunner</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.output_signal"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.output_signal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.progress_signal"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.progress_signal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.finished_signal"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.finished_signal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.error_signal"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.error_signal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.__init__"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.run"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.run()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.terminate_process"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.terminate_process()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.MessageParser"><code class="docutils literal notranslate"><span class="pre">MessageParser</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.MessageParser.parse"><code class="docutils literal notranslate"><span class="pre">MessageParser.parse()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.SimulatorMessageParser"><code class="docutils literal notranslate"><span class="pre">SimulatorMessageParser</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.AnalyzerMessageParser"><code class="docutils literal notranslate"><span class="pre">AnalyzerMessageParser</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.PreprocessMessageParser"><code class="docutils literal notranslate"><span class="pre">PreprocessMessageParser</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.strip_ansi_codes"><code class="docutils literal notranslate"><span class="pre">strip_ansi_codes()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Simulation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../sim/index.html">Simulation Module (<code class="docutils literal notranslate"><span class="pre">tit.sim</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.simulator">Main Simulator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.simulator.setup_montage_directories"><code class="docutils literal notranslate"><span class="pre">setup_montage_directories()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.simulator.create_simulation_config_file"><code class="docutils literal notranslate"><span class="pre">create_simulation_config_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.simulator.run_montage_visualization"><code class="docutils literal notranslate"><span class="pre">run_montage_visualization()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.simulator.run_simulation"><code class="docutils literal notranslate"><span class="pre">run_simulation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.simulator.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.config">Configuration Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationMode"><code class="docutils literal notranslate"><span class="pre">SimulationMode</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationMode.TI"><code class="docutils literal notranslate"><span class="pre">SimulationMode.TI</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationMode.MTI"><code class="docutils literal notranslate"><span class="pre">SimulationMode.MTI</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ConductivityType"><code class="docutils literal notranslate"><span class="pre">ConductivityType</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ConductivityType.SCALAR"><code class="docutils literal notranslate"><span class="pre">ConductivityType.SCALAR</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ConductivityType.VN"><code class="docutils literal notranslate"><span class="pre">ConductivityType.VN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ConductivityType.DIR"><code class="docutils literal notranslate"><span class="pre">ConductivityType.DIR</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ConductivityType.MC"><code class="docutils literal notranslate"><span class="pre">ConductivityType.MC</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig.shape"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig.shape</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig.dimensions"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig.dimensions</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig.thickness"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig.thickness</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig.sponge_thickness"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig.sponge_thickness</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig.__init__"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig"><code class="docutils literal notranslate"><span class="pre">IntensityConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.pair1"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.pair1</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.pair2"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.pair2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.pair3"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.pair3</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.pair4"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.pair4</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.from_string"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.from_string()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.__init__"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig"><code class="docutils literal notranslate"><span class="pre">MontageConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.name"><code class="docutils literal notranslate"><span class="pre">MontageConfig.name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.electrode_pairs"><code class="docutils literal notranslate"><span class="pre">MontageConfig.electrode_pairs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.is_xyz"><code class="docutils literal notranslate"><span class="pre">MontageConfig.is_xyz</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.eeg_net"><code class="docutils literal notranslate"><span class="pre">MontageConfig.eeg_net</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.simulation_mode"><code class="docutils literal notranslate"><span class="pre">MontageConfig.simulation_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.num_pairs"><code class="docutils literal notranslate"><span class="pre">MontageConfig.num_pairs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.__init__"><code class="docutils literal notranslate"><span class="pre">MontageConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig"><code class="docutils literal notranslate"><span class="pre">ParallelConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.enabled"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.enabled</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.max_workers"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.max_workers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.__post_init__"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.__post_init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.effective_workers"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.effective_workers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.get_memory_warning"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.get_memory_warning()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.__init__"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig"><code class="docutils literal notranslate"><span class="pre">SimulationConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.subject_id"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.subject_id</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.project_dir"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.project_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.conductivity_type"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.conductivity_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.intensities"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.intensities</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.electrode"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.electrode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.eeg_net"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.eeg_net</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.map_to_surf"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.map_to_surf</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.map_to_vol"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.map_to_vol</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.map_to_mni"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.map_to_mni</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.map_to_fsavg"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.map_to_fsavg</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.tissues_in_niftis"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.tissues_in_niftis</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.open_in_gmsh"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.open_in_gmsh</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.parallel"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.parallel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.__post_init__"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.__post_init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.__init__"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.session_builder">Session Builder</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.session_builder.SessionBuilder"><code class="docutils literal notranslate"><span class="pre">SessionBuilder</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.session_builder.SessionBuilder.__init__"><code class="docutils literal notranslate"><span class="pre">SessionBuilder.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.session_builder.SessionBuilder.build_session"><code class="docutils literal notranslate"><span class="pre">SessionBuilder.build_session()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.post_processor">Post-Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.post_processor.PostProcessor"><code class="docutils literal notranslate"><span class="pre">PostProcessor</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.post_processor.PostProcessor.__init__"><code class="docutils literal notranslate"><span class="pre">PostProcessor.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.post_processor.PostProcessor.process_ti_results"><code class="docutils literal notranslate"><span class="pre">PostProcessor.process_ti_results()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.post_processor.PostProcessor.process_mti_results"><code class="docutils literal notranslate"><span class="pre">PostProcessor.process_mti_results()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.montage_loader">Montage Loading</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.load_montage_file"><code class="docutils literal notranslate"><span class="pre">load_montage_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.list_montage_names"><code class="docutils literal notranslate"><span class="pre">list_montage_names()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.add_montage"><code class="docutils literal notranslate"><span class="pre">add_montage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.load_flex_montages"><code class="docutils literal notranslate"><span class="pre">load_flex_montages()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.parse_flex_montage"><code class="docutils literal notranslate"><span class="pre">parse_flex_montage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.load_montages"><code class="docutils literal notranslate"><span class="pre">load_montages()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.utils">Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.montage_config_dir"><code class="docutils literal notranslate"><span class="pre">montage_config_dir()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.montage_list_path"><code class="docutils literal notranslate"><span class="pre">montage_list_path()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.ensure_montage_file"><code class="docutils literal notranslate"><span class="pre">ensure_montage_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.load_montage_data"><code class="docutils literal notranslate"><span class="pre">load_montage_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.save_montage_data"><code class="docutils literal notranslate"><span class="pre">save_montage_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.ensure_eeg_net_entry"><code class="docutils literal notranslate"><span class="pre">ensure_eeg_net_entry()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.upsert_montage"><code class="docutils literal notranslate"><span class="pre">upsert_montage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.list_montage_names"><code class="docutils literal notranslate"><span class="pre">list_montage_names()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../analyzer/index.html">Analysis Module (<code class="docutils literal notranslate"><span class="pre">tit.analyzer</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.mesh_analyzer">Mesh Analyzer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.__init__"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.__del__"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.__del__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_whole_head"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.analyze_whole_head()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_sphere"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.analyze_sphere()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_cortex"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.analyze_cortex()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.get_grey_matter_statistics"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.get_grey_matter_statistics()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.voxel_analyzer">Voxel Analyzer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.field_nifti"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.field_nifti</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.subject_dir"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.subject_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.output_dir"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.output_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.visualizer"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.visualizer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.__init__"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_whole_head"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.analyze_whole_head()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_sphere"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.analyze_sphere()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.resample_to_match"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.resample_to_match()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_cortex"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.analyze_cortex()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_atlas_regions"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.get_atlas_regions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.load_brain_image"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.load_brain_image()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.find_region"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.find_region()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_grey_matter_statistics"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.get_grey_matter_statistics()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.group_analyzer">Group Analyzer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.format_duration"><code class="docutils literal notranslate"><span class="pre">format_duration()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.log_group_analysis_start"><code class="docutils literal notranslate"><span class="pre">log_group_analysis_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.log_group_analysis_complete"><code class="docutils literal notranslate"><span class="pre">log_group_analysis_complete()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.log_group_subject_status"><code class="docutils literal notranslate"><span class="pre">log_group_subject_status()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.create_group_output_directory"><code class="docutils literal notranslate"><span class="pre">create_group_output_directory()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.setup_parser"><code class="docutils literal notranslate"><span class="pre">setup_parser()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.validate_args"><code class="docutils literal notranslate"><span class="pre">validate_args()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.compute_subject_output_dir"><code class="docutils literal notranslate"><span class="pre">compute_subject_output_dir()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.build_main_analyzer_command"><code class="docutils literal notranslate"><span class="pre">build_main_analyzer_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.run_subject_analysis"><code class="docutils literal notranslate"><span class="pre">run_subject_analysis()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.collect_analysis_paths"><code class="docutils literal notranslate"><span class="pre">collect_analysis_paths()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.run_comprehensive_group_analysis"><code class="docutils literal notranslate"><span class="pre">run_comprehensive_group_analysis()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.determine_group_subfolder_name"><code class="docutils literal notranslate"><span class="pre">determine_group_subfolder_name()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.visualizer">Visualizer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.output_dir"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.output_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.__init__"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.save_results_to_csv"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.save_results_to_csv()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.save_extra_info_to_csv"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.save_extra_info_to_csv()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.save_whole_head_results_to_csv"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.save_whole_head_results_to_csv()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.generate_focality_histogram"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.generate_focality_histogram()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.Visualizer"><code class="docutils literal notranslate"><span class="pre">Visualizer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.Visualizer.__init__"><code class="docutils literal notranslate"><span class="pre">Visualizer.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.MeshVisualizer"><code class="docutils literal notranslate"><span class="pre">MeshVisualizer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.MeshVisualizer.__init__"><code class="docutils literal notranslate"><span class="pre">MeshVisualizer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.MeshVisualizer.visualize_cortex_roi"><code class="docutils literal notranslate"><span class="pre">MeshVisualizer.visualize_cortex_roi()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.MeshVisualizer.visualize_spherical_roi"><code class="docutils literal notranslate"><span class="pre">MeshVisualizer.visualize_spherical_roi()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.VoxelVisualizer"><code class="docutils literal notranslate"><span class="pre">VoxelVisualizer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.VoxelVisualizer.__init__"><code class="docutils literal notranslate"><span class="pre">VoxelVisualizer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.VoxelVisualizer.create_cortex_nifti"><code class="docutils literal notranslate"><span class="pre">VoxelVisualizer.create_cortex_nifti()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.VoxelVisualizer.find_region"><code class="docutils literal notranslate"><span class="pre">VoxelVisualizer.find_region()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.main_analyzer">Main Analyzer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.stdout_reconfigure"><code class="docutils literal notranslate"><span class="pre">stdout_reconfigure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.stderr_reconfigure"><code class="docutils literal notranslate"><span class="pre">stderr_reconfigure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.flush_output"><code class="docutils literal notranslate"><span class="pre">flush_output()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.format_duration"><code class="docutils literal notranslate"><span class="pre">format_duration()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_start"><code class="docutils literal notranslate"><span class="pre">log_analysis_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_complete"><code class="docutils literal notranslate"><span class="pre">log_analysis_complete()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_failed"><code class="docutils literal notranslate"><span class="pre">log_analysis_failed()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_step_start"><code class="docutils literal notranslate"><span class="pre">log_analysis_step_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_step_complete"><code class="docutils literal notranslate"><span class="pre">log_analysis_step_complete()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_step_failed"><code class="docutils literal notranslate"><span class="pre">log_analysis_step_failed()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.create_roi_description"><code class="docutils literal notranslate"><span class="pre">create_roi_description()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.validate_file_extension"><code class="docutils literal notranslate"><span class="pre">validate_file_extension()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.validate_coordinates"><code class="docutils literal notranslate"><span class="pre">validate_coordinates()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.validate_radius"><code class="docutils literal notranslate"><span class="pre">validate_radius()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.construct_mesh_field_path"><code class="docutils literal notranslate"><span class="pre">construct_mesh_field_path()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.setup_parser"><code class="docutils literal notranslate"><span class="pre">setup_parser()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.validate_args"><code class="docutils literal notranslate"><span class="pre">validate_args()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.print_stat_if_exists"><code class="docutils literal notranslate"><span class="pre">print_stat_if_exists()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.field_selector">Field Selector</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.field_selector.select_field_file"><code class="docutils literal notranslate"><span class="pre">select_field_file()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../opt/index.html">Optimization Module (<code class="docutils literal notranslate"><span class="pre">tit.opt</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../opt/index.html#leadfield-generator">Leadfield Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../opt/index.html#flex-search">Flex-Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../opt/index.html#ex-search">Ex-Search</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../stats/index.html">Statistics Module (<code class="docutils literal notranslate"><span class="pre">tit.stats</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../stats/index.html#module-tit.stats.permutation_analysis">Permutation Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.load_subject_data"><code class="docutils literal notranslate"><span class="pre">load_subject_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.load_subject_data_group_comparison"><code class="docutils literal notranslate"><span class="pre">load_subject_data_group_comparison()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.load_subject_data_correlation"><code class="docutils literal notranslate"><span class="pre">load_subject_data_correlation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.prepare_config_from_csv"><code class="docutils literal notranslate"><span class="pre">prepare_config_from_csv()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.run_analysis"><code class="docutils literal notranslate"><span class="pre">run_analysis()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../stats/index.html#cluster-analysis">Cluster Analysis</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TI-Toolbox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tit.analyzer.voxel_analyzer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tit.analyzer.voxel_analyzer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">VoxelAnalyzer: A tool for analyzing voxel-based neuroimaging data</span>

<span class="sd">This module provides functionality for analyzing voxel-based data from medical imaging,</span>
<span class="sd">particularly focusing on field analysis in specific regions of interest (ROIs).</span>

<span class="sd">Inputs:</span>
<span class="sd">    - NIfTI files containing field data</span>
<span class="sd">    - Atlas files (NIfTI/MGZ) for cortical parcellation</span>
<span class="sd">    - ROI specifications (coordinates, regions)</span>

<span class="sd">Outputs:</span>
<span class="sd">    - Statistical measures (mean, min, max)</span>
<span class="sd">    - ROI masks</span>
<span class="sd">    - Visualization files (optional)</span>

<span class="sd">Example Usage:</span>
<span class="sd">    ```python</span>
<span class="sd">    # Initialize analyzer</span>
<span class="sd">    analyzer = VoxelAnalyzer(</span>
<span class="sd">        field_nifti=&quot;/path/to/field.nii.gz&quot;,</span>
<span class="sd">        subject_dir=&quot;/path/to/subject&quot;,</span>
<span class="sd">        output_dir=&quot;/path/to/output&quot;</span>
<span class="sd">    )</span>

<span class="sd">    # Analyze a spherical ROI</span>
<span class="sd">    sphere_results = analyzer.analyze_sphere(</span>
<span class="sd">        center_coordinates=[0, 0, 0],</span>
<span class="sd">        radius=10,</span>
<span class="sd">        visualize=True</span>
<span class="sd">    )</span>

<span class="sd">    # Analyze a cortical region</span>
<span class="sd">    cortex_results = analyzer.analyze_cortex(</span>
<span class="sd">        atlas_file=&quot;/path/to/atlas.mgz&quot;,</span>
<span class="sd">        target_region=&quot;Left-Hippocampus&quot;</span>
<span class="sd">    )</span>

<span class="sd">    # Analyze whole head</span>
<span class="sd">    whole_head_results = analyzer.analyze_whole_head(</span>
<span class="sd">        atlas_file=&quot;/path/to/atlas.mgz&quot;,</span>
<span class="sd">        visualize=True</span>
<span class="sd">    )</span>
<span class="sd">    ```</span>

<span class="sd">Dependencies:</span>
<span class="sd">    - numpy</span>
<span class="sd">    - nibabel</span>
<span class="sd">    - subprocess (for FreeSurfer operations)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>  <span class="c1"># Use non-interactive backend</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tit</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">logging_util</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tit.analyzer.visualizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">VoxelVisualizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tit.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_path_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tit.core.roi</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_roi_metrics</span>


<div class="viewcode-block" id="VoxelAnalyzer">
<a class="viewcode-back" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VoxelAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for analyzing voxel-based data from medical imaging.</span>
<span class="sd">    </span>
<span class="sd">    This class provides methods for analyzing field data in specific regions of interest,</span>
<span class="sd">    including spherical ROIs and cortical regions defined by an atlas.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        field_nifti (str): Path to the NIfTI file containing field data</span>
<span class="sd">        subject_dir (str): Directory containing subject data</span>
<span class="sd">        output_dir (str): Directory where analysis results will be saved</span>
<span class="sd">        visualizer (VoxelVisualizer): Instance of visualizer for generating plots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="VoxelAnalyzer.__init__">
<a class="viewcode-back" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_nifti</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the VoxelAnalyzer with paths to required data.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_nifti (str): Path to the NIfTI file containing field data</span>
<span class="sd">            subject_dir (str): Directory containing subject data</span>
<span class="sd">            output_dir (str): Directory where analysis results will be saved</span>
<span class="sd">            logger: Optional logger instance to use. If None, creates its own.</span>
<span class="sd">            quiet (bool): If True, suppress verbose logging messages</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If field_nifti file does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for required dependencies</span>
        <span class="k">if</span> <span class="n">nib</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;nibabel is required for voxel analysis but is not installed&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span> <span class="o">=</span> <span class="n">field_nifti</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span> <span class="o">=</span> <span class="n">subject_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>

        <span class="c1"># Validate early (before logger/file handlers) so missing input paths fail</span>
        <span class="c1"># with the intended error rather than a secondary logging error.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">field_nifti</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field file not found: </span><span class="si">{</span><span class="n">field_nifti</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Set up logger - use provided logger or create a new one</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create a child logger to distinguish voxel analyzer logs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;voxel_analyzer&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create our own logger if none provided</span>
            <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
            
            <span class="c1"># Extract subject ID from subject_dir (e.g., m2m_subject -&gt; subject)</span>
            <span class="n">subject_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_dir</span><span class="p">)</span>
            
            <span class="c1"># Create derivatives/ti-toolbox/logs/sub-* directory structure</span>
            <span class="n">pm</span> <span class="o">=</span> <span class="n">get_path_manager</span><span class="p">()</span>
            <span class="n">log_dir</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;ti_logs&quot;</span><span class="p">,</span> <span class="n">subject_id</span><span class="o">=</span><span class="n">subject_id</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Create log file in the new directory</span>
            <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;voxel_analyzer_</span><span class="si">{</span><span class="n">time_stamp</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging_util</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;voxel_analyzer&#39;</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Initialize visualizer with logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="o">=</span> <span class="n">VoxelVisualizer</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        
        <span class="c1"># Create output directory if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Voxel analyzer initialized successfully&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field NIfTI path: </span><span class="si">{</span><span class="n">field_nifti</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject directory: </span><span class="si">{</span><span class="n">subject_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_atlas_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract atlas type from filename by looking for common atlas names.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            atlas_file (str): Path to the atlas file</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Atlas type if found, otherwise &#39;custom&#39;</span>
<span class="sd">            </span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; analyzer._extract_atlas_type(&quot;/path/to/subject_dk40.mgz&quot;)</span>
<span class="sd">            &#39;DK40&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atlas_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="c1"># Check for common atlas types in filename</span>
        <span class="k">if</span> <span class="s1">&#39;dk40&#39;</span> <span class="ow">in</span> <span class="n">atlas_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;DK40&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;dkt&#39;</span> <span class="ow">in</span> <span class="n">atlas_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;DKT&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;hcp_mmp1&#39;</span> <span class="ow">in</span> <span class="n">atlas_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;HCP_MMP1&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;a2009s&#39;</span> <span class="ow">in</span> <span class="n">atlas_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;a2009s&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;custom&#39;</span>

<div class="viewcode-block" id="VoxelAnalyzer.analyze_whole_head">
<a class="viewcode-back" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_whole_head">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_whole_head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze all regions in the specified atlas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting whole head analysis of atlas: </span><span class="si">{</span><span class="n">atlas_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Extract atlas type from filename</span>
        <span class="n">atlas_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_atlas_type</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected atlas type: </span><span class="si">{</span><span class="n">atlas_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Load region information once</span>
            <span class="n">region_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atlas_regions</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
            
            <span class="c1"># Load atlas and field data once</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading atlas from </span><span class="si">{</span><span class="n">atlas_file</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">atlas_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_brain_image</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
            <span class="n">atlas_img</span><span class="p">,</span> <span class="n">atlas_arr</span> <span class="o">=</span> <span class="n">atlas_tuple</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading field from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">field_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_brain_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span>
            <span class="n">field_img</span><span class="p">,</span> <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_tuple</span>
            
            <span class="c1"># Handle 4D field data (extract first volume if multiple volumes)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected 4D field data with shape </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">field_shape_3d</span> <span class="o">=</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="c1"># If time dimension is 1, we can simply reshape to 3D</span>
                <span class="k">if</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reshaping 4D field data to 3D&quot;</span><span class="p">)</span>
                    <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;4D field has </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> volumes. Using only the first volume.&quot;</span><span class="p">)</span>
                    <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_shape_3d</span> <span class="o">=</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="c1"># Check if resampling is needed and do it once if necessary</span>
            <span class="k">if</span> <span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">field_shape_3d</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Atlas and field dimensions don&#39;t match, attempting to resample...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atlas shape: </span><span class="si">{</span><span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field shape: </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Resample the atlas to match the field data, passing atlas_file</span>
                <span class="n">atlas_img</span><span class="p">,</span> <span class="n">atlas_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample_to_match</span><span class="p">(</span>
                    <span class="n">atlas_img</span><span class="p">,</span>
                    <span class="n">field_shape_3d</span><span class="p">,</span>  <span class="c1"># Use only the spatial dimensions</span>
                    <span class="n">field_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
                    <span class="n">source_path</span><span class="o">=</span><span class="n">atlas_file</span>  <span class="c1"># Pass the atlas file path</span>
                <span class="p">)</span>
                
                <span class="c1"># Verify the resampling worked</span>
                <span class="k">if</span> <span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">field_shape_3d</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to resample atlas to match field dimensions: </span><span class="si">{</span><span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">field_shape_3d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Atlas and field dimensions already match - skipping resampling&quot;</span><span class="p">)</span>
            
            <span class="n">field_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_img</span><span class="p">,</span> <span class="n">field_arr</span><span class="p">)</span>
            
            <span class="c1"># Dictionary to store results for each region</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># Analyze each region in the atlas</span>
            <span class="k">for</span> <span class="n">region_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">region_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">region_name</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Create a directory for this region in the main output directory</span>
                    <span class="n">region_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">region_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
                    <span class="c1"># Create mask for this region</span>
                    <span class="n">region_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">atlas_arr</span> <span class="o">==</span> <span class="n">region_id</span><span class="p">)</span>
                    
                    <span class="c1"># Check if the mask contains any voxels</span>
                    <span class="n">mask_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">region_mask</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mask_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">) contains 0 voxels in the atlas&quot;</span><span class="p">)</span>
                        <span class="n">region_results</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="mi">0</span>
                        <span class="p">}</span>
                        
                        <span class="c1"># Store in the overall results</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_results</span>
                        
                        <span class="k">continue</span>
                    
                    <span class="c1"># Filter for voxels with positive values</span>
                    <span class="n">value_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">region_mask</span> <span class="o">&amp;</span> <span class="n">value_mask</span>
                    
                    <span class="c1"># Extract field values after filtering</span>
                    <span class="n">field_values</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>
                    
                    <span class="c1"># Check if any voxels remain after filtering</span>
                    <span class="n">filtered_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">filtered_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">) has no voxels with positive values&quot;</span><span class="p">)</span>
                        <span class="n">region_results</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="mi">0</span>
                        <span class="p">}</span>
                        
                        <span class="c1"># Store in the overall results</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_results</span>
                        
                        <span class="k">continue</span>
                    
                    <span class="c1"># Calculate statistics</span>
                    <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>
                    <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>

                    <span class="n">whole_brain_positive_mask</span> <span class="o">=</span> <span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">gm_values</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">]</span>
                    <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_roi_metrics</span><span class="p">(</span>
                        <span class="n">field_values</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
                        <span class="n">ti_field_gm</span><span class="o">=</span><span class="n">gm_values</span><span class="p">,</span>
                        <span class="n">gm_volumes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gm_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">mean_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImean_ROI&quot;</span><span class="p">]</span>
                    <span class="n">focality</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Focality&quot;</span><span class="p">)</span>
                    <span class="n">whole_brain_average</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TImean_GM&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Log the whole brain average for debugging</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Whole brain average (denominator for focality): </span><span class="si">{</span><span class="n">whole_brain_average</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Create result dictionary for this region</span>
                    <span class="n">region_results</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="n">mean_value</span><span class="p">,</span>
                        <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="p">,</span>
                        <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="p">,</span>
                        <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="n">focality</span><span class="p">,</span>
                        <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="n">filtered_count</span>  <span class="c1"># Store the number of voxels</span>
                    <span class="p">}</span>
                    
                    <span class="c1"># Store in the overall results</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_results</span>
                    
                    <span class="c1"># Generate visualizations if requested</span>
                    <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
                        <span class="c1"># Create visualization NIfTI file directly in the region directory</span>
                        <span class="n">viz_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">_generate_region_visualization</span><span class="p">(</span>
                            <span class="n">atlas_img</span><span class="o">=</span><span class="n">atlas_img</span><span class="p">,</span>
                            <span class="n">atlas_arr</span><span class="o">=</span><span class="n">atlas_arr</span><span class="p">,</span>
                            <span class="n">field_arr</span><span class="o">=</span><span class="n">field_arr</span><span class="p">,</span>
                            <span class="n">region_id</span><span class="o">=</span><span class="n">region_id</span><span class="p">,</span>
                            <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                            <span class="n">output_dir</span><span class="o">=</span><span class="n">region_dir</span>
                        <span class="p">)</span>
                        
                        <span class="c1"># Generate focality histogram for this region</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating focality histogram for region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="c1"># Get voxel dimensions from the field image</span>
                                <span class="n">field_img_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_brain_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span>
                                <span class="n">voxel_dims</span> <span class="o">=</span> <span class="n">field_img_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                                
                                <span class="c1"># Filter out zero values from whole head data for histogram</span>
                                <span class="n">whole_head_positive_mask</span> <span class="o">=</span> <span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                <span class="n">whole_head_filtered</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">whole_head_positive_mask</span><span class="p">]</span>
                                
                                <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">generate_focality_histogram</span><span class="p">(</span>
                                    <span class="n">whole_head_field_data</span><span class="o">=</span><span class="n">whole_head_filtered</span><span class="p">,</span>
                                    <span class="n">roi_field_data</span><span class="o">=</span><span class="n">field_values</span><span class="p">,</span>
                                    <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                                    <span class="n">roi_field_value</span><span class="o">=</span><span class="n">mean_value</span><span class="p">,</span>
                                    <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;voxel&#39;</span><span class="p">,</span>
                                    <span class="n">voxel_dims</span><span class="o">=</span><span class="n">voxel_dims</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate focality histogram for </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to analyze region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="mi">0</span>
                    <span class="p">}</span>
            
            <span class="c1"># Generate global visualization plots are disabled - only histograms are generated per region</span>
                
                <span class="c1"># Generate and save summary CSV</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_whole_head_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">atlas_type</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">results</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Clean up all temporary data</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">atlas_arr</span>
                <span class="k">del</span> <span class="n">field_arr</span>
                <span class="k">del</span> <span class="n">region_info</span>
                <span class="k">if</span> <span class="s1">&#39;atlas_tuple&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                    <span class="k">del</span> <span class="n">atlas_tuple</span>
                <span class="k">if</span> <span class="s1">&#39;field_tuple&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                    <span class="k">del</span> <span class="n">field_tuple</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="c1"># Variables may not be defined if cleanup failed earlier</span>
                <span class="k">pass</span></div>


<div class="viewcode-block" id="VoxelAnalyzer.analyze_sphere">
<a class="viewcode-back" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_sphere">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center_coordinates</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze a spherical region of interest from voxel data.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing analysis results or None if no valid voxels found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting spherical ROI analysis (radius=</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">mm) at coordinates </span><span class="si">{</span><span class="n">center_coordinates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Load the NIfTI data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading field data...&quot;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span>
        <span class="n">field_data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        
        <span class="c1"># Handle 4D field data (extract first volume if multiple volumes)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Get voxel dimensions (for proper distance calculation)</span>
        <span class="n">voxel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span>
        
        <span class="c1"># Get affine transformation matrix</span>
        <span class="n">affine</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span>
        
        <span class="c1"># Convert world coordinates to voxel coordinates if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting coordinates and creating ROI mask...&quot;</span><span class="p">)</span>
        <span class="n">inv_affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
        <span class="n">voxel_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">inv_affine</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_coordinates</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[:</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="c1"># Create coordinate grids for the entire volume</span>
        <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">z_size</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">x_size</span><span class="p">,</span> <span class="p">:</span><span class="n">y_size</span><span class="p">,</span> <span class="p">:</span><span class="n">z_size</span><span class="p">]</span>
        
        <span class="c1"># Calculate distance from center voxel (using voxel dimensions to account for anisotropy)</span>
        <span class="n">dist_from_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">voxel_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">voxel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">voxel_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">voxel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">((</span><span class="n">z</span> <span class="o">-</span> <span class="n">voxel_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">voxel_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Create the spherical mask</span>
        <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">dist_from_center</span> <span class="o">&lt;=</span> <span class="n">radius</span>
        
        <span class="c1"># Create mask for non-zero values</span>
        <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">field_data</span> <span class="o">&gt;</span> <span class="mi">0</span>
        
        <span class="c1"># Combine masks to get only non-zero values within ROI</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">roi_mask</span> <span class="o">&amp;</span> <span class="n">nonzero_mask</span>
        
        <span class="c1"># Count voxels in ROI</span>
        <span class="n">roi_voxels_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">)</span>
        <span class="n">total_roi_voxels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">)</span>
        
        <span class="c1"># Check if we have any voxels in the ROI</span>
        <span class="k">if</span> <span class="n">roi_voxels_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Determine the tissue type from the field NIfTI name</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">tissue_type</span> <span class="o">=</span> <span class="s2">&quot;grey matter&quot;</span> <span class="k">if</span> <span class="s2">&quot;grey&quot;</span> <span class="ow">in</span> <span class="n">field_name</span> <span class="k">else</span> <span class="s2">&quot;white matter&quot;</span> <span class="k">if</span> <span class="s2">&quot;white&quot;</span> <span class="ow">in</span> <span class="n">field_name</span> <span class="k">else</span> <span class="s2">&quot;brain tissue&quot;</span>
            
            <span class="n">warning_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="se">\033</span><span class="s2">[93m  WARNING: Analysis Failed </span>
<span class="s2"> No valid voxels found in ROI at [</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">], r=</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">mm</span>
<span class="s2"> </span><span class="si">{</span><span class="s2">&quot;ROI not intersecting &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tissue_type</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">total_roi_voxels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;ROI contains only zero/invalid values&quot;</span><span class="si">}</span>
<span class="s2"> </span><span class="si">{</span><span class="s2">&quot;Adjust coordinates/radius&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">total_roi_voxels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;Check field data&quot;</span><span class="si">}</span><span class="s2"> or verify using freeview</span><span class="se">\033</span><span class="s2">[0m&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating statistics...&quot;</span><span class="p">)</span>
        <span class="c1"># Get the field values within the ROI</span>
        <span class="n">roi_values</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>
        
        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">roi_values</span><span class="p">)</span>
        <span class="n">whole_brain_positive_mask</span> <span class="o">=</span> <span class="n">field_data</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">gm_values</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">]</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_roi_metrics</span><span class="p">(</span>
            <span class="n">roi_values</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roi_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
            <span class="n">ti_field_gm</span><span class="o">=</span><span class="n">gm_values</span><span class="p">,</span>
            <span class="n">gm_volumes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gm_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">mean_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImean_ROI&quot;</span><span class="p">]</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImax_ROI&quot;</span><span class="p">]</span>
        <span class="n">focality</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Focality&quot;</span><span class="p">)</span>
        <span class="n">whole_brain_average</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TImean_GM&quot;</span><span class="p">)</span>
        
        <span class="c1"># Log the whole brain average for debugging</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Whole brain average (denominator for focality): </span><span class="si">{</span><span class="n">whole_brain_average</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create results dictionary</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="n">mean_value</span><span class="p">,</span>
            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="p">,</span>
            <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="p">,</span>
            <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="n">focality</span><span class="p">,</span>
            <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="n">roi_voxels_count</span>
        <span class="p">}</span>
        
        <span class="c1"># Generate visualization if requested</span>
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">region_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sphere_x</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_z</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_r</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="c1"># Create visualization overlay (showing field values only within the sphere)</span>
            <span class="n">vis_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span>
            <span class="n">vis_arr</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>
            
            <span class="c1"># Save as NIfTI directly to the output directory</span>
            <span class="n">vis_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">affine</span><span class="p">)</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sphere_overlay_</span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">vis_img</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created visualization overlay: </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Visualization requested but only histogram generation is supported</span>
            
            <span class="c1"># Generate focality histogram if visualizer is available</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating focality histogram for spherical ROI...&quot;</span><span class="p">)</span>
                    <span class="c1"># Get voxel dimensions from the loaded image</span>
                    <span class="n">voxel_dims</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                    
                    <span class="c1"># Filter out zero values from whole head data for histogram</span>
                    <span class="n">whole_head_positive_mask</span> <span class="o">=</span> <span class="n">field_data</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">whole_head_filtered</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">whole_head_positive_mask</span><span class="p">]</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">generate_focality_histogram</span><span class="p">(</span>
                        <span class="n">whole_head_field_data</span><span class="o">=</span><span class="n">whole_head_filtered</span><span class="p">,</span>
                        <span class="n">roi_field_data</span><span class="o">=</span><span class="n">roi_values</span><span class="p">,</span>
                        <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                        <span class="n">roi_field_value</span><span class="o">=</span><span class="n">mean_value</span><span class="p">,</span>
                        <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;voxel&#39;</span><span class="p">,</span>
                        <span class="n">voxel_dims</span><span class="o">=</span><span class="n">voxel_dims</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate focality histogram for spherical ROI: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Calculate and save extra focality information for entire volume</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating focality metrics for entire volume...&quot;</span><span class="p">)</span>
        <span class="n">focality_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_focality_metrics</span><span class="p">(</span>
            <span class="n">field_data</span><span class="p">,</span>  <span class="c1"># Use entire volume data</span>
            <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">voxel_size</span><span class="p">),</span>  <span class="c1"># Voxel volume</span>
            <span class="sa">f</span><span class="s2">&quot;sphere_x</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_z</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_r</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        
        <span class="c1"># Save results to CSV if visualizer is available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">region_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sphere_x</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_z</span><span class="si">{</span><span class="n">center_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">_r</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;spherical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>
            
            <span class="c1"># Save extra info CSV with focality data</span>
            <span class="k">if</span> <span class="n">focality_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_extra_info_to_csv</span><span class="p">(</span><span class="n">focality_info</span><span class="p">,</span> <span class="s1">&#39;spherical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot save results to CSV - VoxelVisualizer not available&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_resampled_atlas_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a filename for the resampled atlas.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            atlas_file (str): Path to the original atlas file</span>
<span class="sd">            target_shape (tuple): Target shape for resampling</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Path to the resampled atlas file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract base filename and extension</span>
        <span class="n">atlas_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
        <span class="n">atlas_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
        <span class="n">atlas_name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">atlas_basename</span><span class="p">)</span>
        
        <span class="c1"># Handle double extensions like .nii.gz</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span> <span class="ow">and</span> <span class="n">atlas_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nii&#39;</span><span class="p">):</span>
            <span class="n">atlas_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">atlas_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.nii.gz&#39;</span>
        
        <span class="c1"># Generate a shape string (e.g., &quot;256x256x256&quot;)</span>
        <span class="n">shape_str</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>  <span class="c1"># Only use spatial dimensions</span>
        
        <span class="c1"># Create new filename</span>
        <span class="n">resampled_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atlas_name</span><span class="si">}</span><span class="s2">_resampled_</span><span class="si">{</span><span class="n">shape_str</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">resampled_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atlas_dir</span><span class="p">,</span> <span class="n">resampled_filename</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">resampled_path</span>

<div class="viewcode-block" id="VoxelAnalyzer.resample_to_match">
<a class="viewcode-back" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.resample_to_match">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resample_to_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_img</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">,</span> <span class="n">target_affine</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resample source image to match target dimensions and affine using FreeSurfer&#39;s mri_convert.</span>
<span class="sd">        </span>
<span class="sd">        If a resampled version already exists, it will be loaded instead of generating a new one.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source_img : nibabel.Nifti1Image</span>
<span class="sd">            Source image to resample</span>
<span class="sd">        target_shape : tuple</span>
<span class="sd">            Target shape (x, y, z) or (x, y, z, t)</span>
<span class="sd">        target_affine : numpy.ndarray</span>
<span class="sd">            Target affine transformation matrix</span>
<span class="sd">        source_path : str, optional</span>
<span class="sd">            Path to the source file. If provided, will be used to generate a resampled file name.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (resampled nibabel image, resampled data array)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resampling image from shape </span><span class="si">{</span><span class="n">source_img</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">target_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># If source_path is provided, try to find an existing resampled file</span>
        <span class="k">if</span> <span class="n">source_path</span><span class="p">:</span>
            <span class="n">resampled_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resampled_atlas_filename</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">resampled_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found existing resampled atlas: </span><span class="si">{</span><span class="n">resampled_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resampled_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resampled_path</span><span class="p">)</span>
                    <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
                    
                    <span class="c1"># Check if the resampled image has the correct shape</span>
                    <span class="k">if</span> <span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loaded previously resampled atlas&quot;</span><span class="p">)</span>
                        
                        <span class="c1"># If target is 4D but resampled is 3D, reshape it to match</span>
                        <span class="n">is_target_4d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
                        <span class="k">if</span> <span class="n">is_target_4d</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reshaping 3D data </span><span class="si">{</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to match 4D target </span><span class="si">{</span><span class="n">target_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="c1"># Add a dimension to match the 4D target shape</span>
                            <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                            
                            <span class="c1"># Create a new 4D NIfTI image</span>
                            <span class="n">new_header</span> <span class="o">=</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">new_header</span><span class="o">.</span><span class="n">set_data_shape</span><span class="p">(</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                            <span class="n">resampled_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">,</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">new_header</span><span class="p">)</span>
                        
                        <span class="k">return</span> <span class="n">resampled_img</span><span class="p">,</span> <span class="n">resampled_data</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Existing resampled atlas has wrong shape: </span><span class="si">{</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs expected </span><span class="si">{</span><span class="n">target_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading existing resampled atlas: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will generate a new one&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating new resampled atlas...&quot;</span><span class="p">)</span>
        
        <span class="c1"># If target shape is 4D but source is 3D, we need to handle this specially</span>
        <span class="n">is_target_4d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
        <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">target_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Extract just the spatial dimensions</span>
        
        <span class="c1"># Create a temporary file for the target template</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_template</span><span class="p">:</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">temp_template</span><span class="o">.</span><span class="n">name</span>
        
        <span class="c1"># Create a temporary file for the resampled output</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_output</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">temp_output</span><span class="o">.</span><span class="n">name</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Save the source image to a temporary file if not provided</span>
            <span class="k">if</span> <span class="n">source_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source_path</span><span class="p">):</span>
                <span class="c1"># Use the provided source path</span>
                <span class="n">temp_source_created</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Save the source image to a temporary file</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_source</span><span class="p">:</span>
                    <span class="n">source_path</span> <span class="o">=</span> <span class="n">temp_source</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">source_img</span><span class="p">,</span> <span class="n">source_path</span><span class="p">)</span>
                    <span class="n">temp_source_created</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># Create a template image with target dimensions (3D only)</span>
            <span class="n">template_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">),</span> <span class="n">target_affine</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">template_img</span><span class="p">,</span> <span class="n">template_path</span><span class="p">)</span>
            
            <span class="c1"># Run mri_convert to resample the image</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;mri_convert&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--reslice_like&#39;</span><span class="p">,</span> <span class="n">template_path</span><span class="p">,</span>  <span class="c1"># Use template for resampling</span>
                <span class="n">source_path</span><span class="p">,</span>                      <span class="c1"># Source image</span>
                <span class="n">output_path</span>                       <span class="c1"># Output image</span>
            <span class="p">]</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Load the resampled image</span>
            <span class="n">resampled_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            
            <span class="c1"># If target is 4D but resampled is 3D, reshape it to match</span>
            <span class="k">if</span> <span class="n">is_target_4d</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reshaping 3D data </span><span class="si">{</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to match 4D target </span><span class="si">{</span><span class="n">target_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Add a dimension to match the 4D target shape</span>
                <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                
                <span class="c1"># Create a new 4D NIfTI image</span>
                <span class="n">new_header</span> <span class="o">=</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">new_header</span><span class="o">.</span><span class="n">set_data_shape</span><span class="p">(</span><span class="n">resampled_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">resampled_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">,</span> <span class="n">resampled_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">new_header</span><span class="p">)</span>
            
            <span class="c1"># Save the resampled atlas for future use if source_path was provided and not temporary</span>
            <span class="k">if</span> <span class="n">source_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">temp_source_created</span><span class="p">:</span>
                <span class="n">resampled_save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resampled_atlas_filename</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving resampled atlas for future use: </span><span class="si">{</span><span class="n">resampled_save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">resampled_img</span><span class="p">,</span> <span class="n">resampled_save_path</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resampling complete&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resampled_img</span><span class="p">,</span> <span class="n">resampled_data</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Clean up temporary files</span>
            <span class="k">for</span> <span class="n">temp_file</span> <span class="ow">in</span> <span class="p">[</span><span class="n">template_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
                    <span class="c1"># Best-effort cleanup - file may already be deleted</span>
                    <span class="k">pass</span>

            <span class="c1"># Also remove temporary source file if we created it</span>
            <span class="k">if</span> <span class="s1">&#39;temp_source_created&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">temp_source_created</span> <span class="ow">and</span> <span class="s1">&#39;source_path&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
                    <span class="c1"># Best-effort cleanup - file may already be deleted</span>
                    <span class="k">pass</span></div>


<div class="viewcode-block" id="VoxelAnalyzer.analyze_cortex">
<a class="viewcode-back" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_cortex">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_cortex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="n">region_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atlas_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze a field scan within a specific cortical region defined in an atlas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract atlas type from filename</span>
        <span class="n">atlas_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_atlas_type</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
        
        <span class="c1"># Load the atlas and field data if not provided</span>
        <span class="k">if</span> <span class="n">atlas_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading atlas from </span><span class="si">{</span><span class="n">atlas_file</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">atlas_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_brain_image</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
            <span class="n">atlas_img</span><span class="p">,</span> <span class="n">atlas_arr</span> <span class="o">=</span> <span class="n">atlas_tuple</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unpack the tuple</span>
            <span class="n">atlas_img</span><span class="p">,</span> <span class="n">atlas_arr</span> <span class="o">=</span> <span class="n">atlas_data</span>
            
        <span class="k">if</span> <span class="n">field_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading field from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">field_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_brain_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span>
            <span class="n">field_img</span><span class="p">,</span> <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_tuple</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unpack the tuple</span>
            <span class="n">field_img</span><span class="p">,</span> <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_data</span>
        
        <span class="c1"># Handle 4D field data (extract first volume if multiple volumes)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected 4D field data with shape </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">field_shape_3d</span> <span class="o">=</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1"># If time dimension is 1, we can simply reshape to 3D</span>
            <span class="k">if</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reshaping 4D field data to 3D&quot;</span><span class="p">)</span>
                <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;4D field has </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> volumes. Using only the first volume.&quot;</span><span class="p">)</span>
                <span class="n">field_arr</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_shape_3d</span> <span class="o">=</span> <span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span>
                
        <span class="c1"># Compare spatial dimensions for atlas and field</span>
        <span class="k">if</span> <span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">field_shape_3d</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Atlas and field dimensions don&#39;t match, attempting to resample...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atlas shape: </span><span class="si">{</span><span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field shape: </span><span class="si">{</span><span class="n">field_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Resample the atlas to match the field data, passing atlas_file</span>
            <span class="n">atlas_img</span><span class="p">,</span> <span class="n">atlas_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample_to_match</span><span class="p">(</span>
                <span class="n">atlas_img</span><span class="p">,</span>
                <span class="n">field_shape_3d</span><span class="p">,</span>  <span class="c1"># Use only the spatial dimensions</span>
                <span class="n">field_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
                <span class="n">source_path</span><span class="o">=</span><span class="n">atlas_file</span>  <span class="c1"># Pass the atlas file path</span>
            <span class="p">)</span>
            
            <span class="c1"># Verify the resampling worked</span>
            <span class="k">if</span> <span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">field_shape_3d</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to resample atlas to match field dimensions: </span><span class="si">{</span><span class="n">atlas_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">field_shape_3d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Atlas and field dimensions already match - skipping resampling&quot;</span><span class="p">)</span>
        
        <span class="c1"># Load region information if not provided</span>
        <span class="k">if</span> <span class="n">region_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">region_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atlas_regions</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
        
        <span class="c1"># Determine region ID based on target_region</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finding region information for </span><span class="si">{</span><span class="n">target_region</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">region_id</span><span class="p">,</span> <span class="n">region_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_region</span><span class="p">(</span><span class="n">target_region</span><span class="p">,</span> <span class="n">region_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create mask for this region</span>
        <span class="n">region_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">atlas_arr</span> <span class="o">==</span> <span class="n">region_id</span><span class="p">)</span>
        
        <span class="c1"># Check if the mask contains any voxels</span>
        <span class="n">mask_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">region_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">) contains 0 voxels in the atlas&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>
            
            <span class="c1"># Save results to CSV even if empty</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">results</span>
        
        <span class="c1"># Filter for voxels with positive values</span>
        <span class="n">value_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">region_mask</span> <span class="o">&amp;</span> <span class="n">value_mask</span>
        
        <span class="c1"># Extract field values after filtering</span>
        <span class="n">field_values</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>
        
        <span class="c1"># Check if any voxels remain after filtering</span>
        <span class="n">filtered_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Region </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">) has no voxels with positive values&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>
            
            <span class="c1"># Save results to CSV even if empty</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">results</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating statistics...&quot;</span><span class="p">)</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>
        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>

        <span class="n">whole_brain_positive_mask</span> <span class="o">=</span> <span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">gm_values</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">whole_brain_positive_mask</span><span class="p">]</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_roi_metrics</span><span class="p">(</span>
            <span class="n">field_values</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
            <span class="n">ti_field_gm</span><span class="o">=</span><span class="n">gm_values</span><span class="p">,</span>
            <span class="n">gm_volumes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gm_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">mean_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;TImean_ROI&quot;</span><span class="p">]</span>
        <span class="n">focality</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Focality&quot;</span><span class="p">)</span>
        <span class="n">whole_brain_average</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TImean_GM&quot;</span><span class="p">)</span>
        
        <span class="c1"># Log the whole brain average for debugging</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Whole brain average (denominator for focality): </span><span class="si">{</span><span class="n">whole_brain_average</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Prepare results dictionary</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean_value&#39;</span><span class="p">:</span> <span class="n">mean_value</span><span class="p">,</span>
            <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="p">,</span>
            <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="p">,</span>
            <span class="s1">&#39;focality&#39;</span><span class="p">:</span> <span class="n">focality</span><span class="p">,</span>
            <span class="s1">&#39;voxels_in_roi&#39;</span><span class="p">:</span> <span class="n">filtered_count</span>
        <span class="p">}</span>
        
        <span class="c1"># Generate visualization if requested</span>
        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating visualizations...&quot;</span><span class="p">)</span>

            <span class="c1"># Generate focality histogram</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating focality histogram for region: </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Get voxel dimensions from the field image</span>
                <span class="n">voxel_dims</span> <span class="o">=</span> <span class="n">field_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                
                <span class="c1"># Filter out zero values from whole head data for histogram</span>
                <span class="n">whole_head_positive_mask</span> <span class="o">=</span> <span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">whole_head_filtered</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">whole_head_positive_mask</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">generate_focality_histogram</span><span class="p">(</span>
                    <span class="n">whole_head_field_data</span><span class="o">=</span><span class="n">whole_head_filtered</span><span class="p">,</span>
                    <span class="n">roi_field_data</span><span class="o">=</span><span class="n">field_values</span><span class="p">,</span>
                    <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
                    <span class="n">roi_field_value</span><span class="o">=</span><span class="n">mean_value</span><span class="p">,</span>
                    <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;voxel&#39;</span><span class="p">,</span>
                    <span class="n">voxel_dims</span><span class="o">=</span><span class="n">voxel_dims</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate focality histogram for </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Create visualization NIfTI file</span>
            <span class="n">viz_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">create_cortex_nifti</span><span class="p">(</span>
                <span class="n">atlas_img</span><span class="o">=</span><span class="n">atlas_img</span><span class="p">,</span>
                <span class="n">atlas_arr</span><span class="o">=</span><span class="n">atlas_arr</span><span class="p">,</span>
                <span class="n">field_arr</span><span class="o">=</span><span class="n">field_arr</span><span class="p">,</span>
                <span class="n">region_id</span><span class="o">=</span><span class="n">region_id</span><span class="p">,</span>
                <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span>
            <span class="p">)</span>
            
        <span class="c1"># Calculate and save extra focality information for entire field</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating focality metrics for entire field...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Get voxel dimensions for volume calculations</span>
        <span class="n">voxel_dims</span> <span class="o">=</span> <span class="n">field_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">voxel_volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">voxel_dims</span><span class="p">)</span>  <span class="c1"># Volume of one voxel in mm</span>
        
        <span class="c1"># Use entire field data (positive values only) for focality calculation</span>
        <span class="n">entire_field_positive</span> <span class="o">=</span> <span class="n">field_arr</span><span class="p">[</span><span class="n">field_arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="n">focality_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_focality_metrics</span><span class="p">(</span>
            <span class="n">entire_field_positive</span><span class="p">,</span>  <span class="c1"># Use entire field, not just ROI</span>
            <span class="n">voxel_volume</span><span class="p">,</span> 
            <span class="n">region_name</span>
        <span class="p">)</span>
        
        <span class="c1"># Save results to CSV</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_results_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>
        
        <span class="c1"># Save extra info CSV with focality data</span>
        <span class="k">if</span> <span class="n">focality_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">save_extra_info_to_csv</span><span class="p">(</span><span class="n">focality_info</span><span class="p">,</span> <span class="s1">&#39;cortical&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">)</span>
        
        <span class="c1"># Return analysis results</span>
        <span class="k">return</span> <span class="n">results</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_focality_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_data</span><span class="p">,</span> <span class="n">voxel_volume</span><span class="p">,</span> <span class="n">region_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate focality metrics similar to ex-search mesh_field_analyzer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            field_data: Field values for entire field volume (positive values only)</span>
<span class="sd">            voxel_volume: Volume of one voxel in mm</span>
<span class="sd">            region_name: Name of the region being analyzed (for labeling purposes)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing focality metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Standard parameters matching ex-search</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">95</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">]</span>
            <span class="n">focality_cutoffs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No field data available for focality calculation in </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="c1"># Remove NaN values</span>
            <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid field data after NaN removal for </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="c1"># For voxel data, each element has the same volume</span>
            <span class="n">volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">voxel_volume</span><span class="p">)</span>
            
            <span class="c1"># Sort data and corresponding volumes</span>
            <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">data_sorted</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
            <span class="n">volumes_sorted</span> <span class="o">=</span> <span class="n">volumes</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
            
            <span class="c1"># Calculate cumulative volumes</span>
            <span class="n">cumulative_volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">volumes_sorted</span><span class="p">)</span>
            <span class="n">total_volume</span> <span class="o">=</span> <span class="n">cumulative_volumes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">normalized_cumulative</span> <span class="o">=</span> <span class="n">cumulative_volumes</span> <span class="o">/</span> <span class="n">total_volume</span>
            
            <span class="c1"># Calculate percentiles and their values</span>
            <span class="n">percentile_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">percentile</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">:</span>
                <span class="c1"># Find index where cumulative volume exceeds percentile</span>
                <span class="n">threshold_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">normalized_cumulative</span><span class="p">,</span> <span class="n">percentile</span><span class="o">/</span><span class="mf">100.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">threshold_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_sorted</span><span class="p">):</span>
                    <span class="n">threshold_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_sorted</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                
                <span class="n">percentile_value</span> <span class="o">=</span> <span class="n">data_sorted</span><span class="p">[</span><span class="n">threshold_idx</span><span class="p">]</span>
                <span class="n">percentile_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">percentile_value</span><span class="p">))</span>
            
            <span class="c1"># Calculate focality (volume above thresholds)</span>
            <span class="c1"># Use 99.9 percentile as reference (index 2)</span>
            <span class="n">focality_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">percentile_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">reference_value</span> <span class="o">=</span> <span class="n">percentile_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 99.9 percentile</span>
                
                <span class="k">for</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="n">focality_cutoffs</span><span class="p">:</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">cutoff</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">reference_value</span>
                    <span class="n">above_threshold</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
                    <span class="n">volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">volumes</span><span class="p">[</span><span class="n">above_threshold</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">above_threshold</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
                    <span class="c1"># Convert from mm to cm for consistency with ex-search</span>
                    <span class="n">focality_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">volume</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">focality_values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">focality_cutoffs</span><span class="p">)</span>
            
            <span class="c1"># Prepare results</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;region_name&#39;</span><span class="p">:</span> <span class="n">region_name</span><span class="p">,</span>
                <span class="s1">&#39;field_name&#39;</span><span class="p">:</span> <span class="s1">&#39;field_value&#39;</span><span class="p">,</span>  <span class="c1"># Generic name for voxel data</span>
                <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
                <span class="s1">&#39;min_value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
                <span class="s1">&#39;percentile_95&#39;</span><span class="p">:</span> <span class="n">percentile_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">percentile_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;percentile_99&#39;</span><span class="p">:</span> <span class="n">percentile_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">percentile_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;percentile_99_9&#39;</span><span class="p">:</span> <span class="n">percentile_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">percentile_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;focality_50&#39;</span><span class="p">:</span> <span class="n">focality_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">focality_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;focality_75&#39;</span><span class="p">:</span> <span class="n">focality_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">focality_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;focality_90&#39;</span><span class="p">:</span> <span class="n">focality_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">focality_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;focality_95&#39;</span><span class="p">:</span> <span class="n">focality_values</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">focality_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;total_volume_cm3&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_volume</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">),</span>  <span class="c1"># Convert mm to cm</span>
                <span class="s1">&#39;num_voxels&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
                <span class="s1">&#39;voxel_volume_mm3&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">voxel_volume</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Focality metrics calculated for </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: 99.9%=</span><span class="si">{</span><span class="n">percentile_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, focality_95=</span><span class="si">{</span><span class="n">focality_values</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> cm&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">results</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating focality metrics for </span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="VoxelAnalyzer.get_atlas_regions">
<a class="viewcode-back" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_atlas_regions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_atlas_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract region information from atlas file using FreeSurfer&#39;s mri_segstats.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atlas_file : str</span>
<span class="sd">            Path to the atlas file (.nii or .mgz)</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary mapping region IDs to region information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">region_info</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Get the atlas name from the file path</span>
        <span class="n">atlas_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
        <span class="n">atlas_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">atlas_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Remove extension</span>
        <span class="k">if</span> <span class="n">atlas_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nii&#39;</span><span class="p">):</span>  <span class="c1"># Handle .nii.gz case</span>
            <span class="n">atlas_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">atlas_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="c1"># Get the FreeSurfer subject directory (parent of mri directory)</span>
        <span class="n">mri_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">atlas_file</span><span class="p">)</span>
        <span class="n">freesurfer_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">mri_dir</span><span class="p">)</span>
        
        <span class="c1"># Define the output file path in the mri directory</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mri_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atlas_name</span><span class="si">}</span><span class="s2">_labels.txt&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create mri directory if it doesn&#39;t exist</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mri_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Function to generate the labels file</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">generate_labels_file</span><span class="p">():</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;mri_segstats&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--seg&#39;</span><span class="p">,</span> <span class="n">atlas_file</span><span class="p">,</span>
                <span class="s1">&#39;--excludeid&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>  <span class="c1"># Exclude background</span>
                <span class="s1">&#39;--ctab-default&#39;</span><span class="p">,</span>    <span class="c1"># Use default color table</span>
                <span class="s1">&#39;--sum&#39;</span><span class="p">,</span> <span class="n">output_file</span>
            <span class="p">]</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not extract region information using mri_segstats: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command output: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">stdout</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command error: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        
        <span class="c1"># Function to parse the labels file</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">parse_labels_file</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># Skip header lines (all lines starting with #)</span>
                    <span class="n">in_header</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c1"># Check if we&#39;ve reached the end of the header</span>
                        <span class="k">if</span> <span class="n">in_header</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                            <span class="n">in_header</span> <span class="o">=</span> <span class="kc">False</span>
                            
                        <span class="c1"># Process data lines (non-header)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_header</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            
                            <span class="c1"># The format is:</span>
                            <span class="c1"># Index SegId NVoxels Volume_mm3 StructName</span>
                            <span class="c1"># We need at least 5 columns</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">region_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># SegId is the second column</span>
                                    <span class="n">n_voxels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>   <span class="c1"># NVoxels is the third column</span>
                                    
                                    <span class="c1"># Structure name can contain spaces, so join the remaining parts</span>
                                    <span class="n">region_name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
                                    
                                    <span class="c1"># Generate a random color based on region_id for visualization</span>
                                    <span class="c1"># This creates a consistent color for each region</span>
                                    <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
                                    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">region_id</span><span class="p">)</span>
                                    <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
                                    <span class="n">g</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
                                    <span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
                                    
                                    <span class="n">region_info</span><span class="p">[</span><span class="n">region_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">region_name</span><span class="p">,</span>
                                        <span class="s1">&#39;voxel_count&#39;</span><span class="p">:</span> <span class="n">n_voxels</span><span class="p">,</span>
                                        <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                                    <span class="p">}</span>
                                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not parse line: </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">region_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading labels file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        
        <span class="c1"># Try to use existing file first</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found existing labels file: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parse_labels_file</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully parsed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">region_info</span><span class="p">)</span><span class="si">}</span><span class="s2"> regions from existing file&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">region_info</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Existing file is invalid or empty, regenerating...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Generate new file if needed</span>
        <span class="k">if</span> <span class="n">generate_labels_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">parse_labels_file</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully generated and parsed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">region_info</span><span class="p">)</span><span class="si">}</span><span class="s2"> regions&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">region_info</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning: Could not get region information from atlas file&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">region_info</span></div>


<div class="viewcode-block" id="VoxelAnalyzer.load_brain_image">
<a class="viewcode-back" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.load_brain_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_brain_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load brain image data from file, handling different formats.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : str</span>
<span class="sd">            Path to the image file</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (nibabel image object, numpy array of data)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_ext</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">file_ext</span> <span class="o">==</span> <span class="s1">&#39;.mgz&#39;</span><span class="p">:</span>
            <span class="c1"># Try to use nibabel directly first</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">data</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load MGZ file directly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Try to convert MGZ to NIfTI using mri_convert</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create a temporary file for the converted image</span>
                    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp</span><span class="p">:</span>
                        <span class="n">temp_path</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">name</span>
                    
                    <span class="c1"># Run mri_convert to convert MGZ to NIfTI</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mri_convert&#39;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">temp_path</span><span class="p">]</span>
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
                    <span class="c1"># Load the converted file</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
                    
                    <span class="c1"># Clean up</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
                    
                    <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">data</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to convert MGZ file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For NIfTI and other formats, use nibabel directly</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">data</span></div>

        
<div class="viewcode-block" id="VoxelAnalyzer.find_region">
<a class="viewcode-back" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.find_region">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="n">region_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find region ID and name based on input.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_region : str or int</span>
<span class="sd">            Target region name or ID</span>
<span class="sd">        region_info : dict</span>
<span class="sd">            Dictionary with region information</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (region_id, region_name)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if target_region is an ID (int) or can be converted to one</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">region_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_region</span><span class="p">)</span>
            <span class="c1"># If it&#39;s an ID, get the name from region_info if available</span>
            <span class="k">if</span> <span class="n">region_info</span> <span class="ow">and</span> <span class="n">region_id</span> <span class="ow">in</span> <span class="n">region_info</span><span class="p">:</span>
                <span class="n">region_name</span> <span class="o">=</span> <span class="n">region_info</span><span class="p">[</span><span class="n">region_id</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">region_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">region_id</span><span class="p">,</span> <span class="n">region_name</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># target_region is a string name, need to find the corresponding ID</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">region_info</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Region labels are required to look up regions by name&quot;</span><span class="p">)</span>
            
            <span class="c1"># Search for the region name (case-insensitive)</span>
            <span class="n">target_lower</span> <span class="o">=</span> <span class="n">target_region</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">region_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">region_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">target_lower</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">region_id</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            
            <span class="c1"># If we get here, region name was not found</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region name &#39;</span><span class="si">{</span><span class="n">target_region</span><span class="si">}</span><span class="s2">&#39; not found in region labels&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="VoxelAnalyzer.get_grey_matter_statistics">
<a class="viewcode-back" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_grey_matter_statistics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_grey_matter_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate grey matter field statistics from the NIfTI data.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing grey matter statistics (mean, max, min)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating grey matter field statistics...&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Load the field data</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span>
            <span class="n">field_data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            
            <span class="c1"># Handle 4D field data (extract first volume if multiple volumes)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># For voxel analysis, we assume the entire field is grey matter</span>
            <span class="c1"># (since we&#39;re typically working with grey matter NIfTI files)</span>
            <span class="c1"># Filter for positive values only (matching ROI analysis behavior)</span>
            <span class="n">positive_mask</span> <span class="o">=</span> <span class="n">field_data</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">field_data_positive</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>
            
            <span class="c1"># Check if we have any positive values</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_data_positive</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No positive values found in grey matter data&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
            
            <span class="c1"># Calculate statistics on positive values only</span>
            <span class="n">grey_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">field_data_positive</span><span class="p">)</span>
            <span class="n">grey_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field_data_positive</span><span class="p">)</span>
            <span class="n">grey_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field_data_positive</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grey matter statistics for field &#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_nifti</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; (positive values only): &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;mean=</span><span class="si">{</span><span class="n">grey_mean</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">grey_max</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">grey_min</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_mean</span><span class="p">),</span>
                <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_max</span><span class="p">),</span>
                <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_min</span><span class="p">)</span>
            <span class="p">}</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating grey matter statistics: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;grey_mean&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_max&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;grey_min&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Ido Haber.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>