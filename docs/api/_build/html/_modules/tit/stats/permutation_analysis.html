

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tit.stats.permutation_analysis &mdash; TI-Toolbox 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=51b770b3"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            TI-Toolbox
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Core Modules (<code class="docutils literal notranslate"><span class="pre">tit.core</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.paths">Path Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager"><code class="docutils literal notranslate"><span class="pre">PathManager</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.__init__"><code class="docutils literal notranslate"><span class="pre">PathManager.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.project_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.project_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.project_dir_name"><code class="docutils literal notranslate"><span class="pre">PathManager.project_dir_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.path"><code class="docutils literal notranslate"><span class="pre">PathManager.path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.path_optional"><code class="docutils literal notranslate"><span class="pre">PathManager.path_optional()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.list_flex_search_runs"><code class="docutils literal notranslate"><span class="pre">PathManager.list_flex_search_runs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.exists"><code class="docutils literal notranslate"><span class="pre">PathManager.exists()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.is_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.is_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.is_file"><code class="docutils literal notranslate"><span class="pre">PathManager.is_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.ensure_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.ensure_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.list_subjects"><code class="docutils literal notranslate"><span class="pre">PathManager.list_subjects()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.list_simulations"><code class="docutils literal notranslate"><span class="pre">PathManager.list_simulations()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.analysis_space_dir_name"><code class="docutils literal notranslate"><span class="pre">PathManager.analysis_space_dir_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.spherical_analysis_name"><code class="docutils literal notranslate"><span class="pre">PathManager.spherical_analysis_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.cortical_analysis_name"><code class="docutils literal notranslate"><span class="pre">PathManager.cortical_analysis_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.get_analysis_space_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.get_analysis_space_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.get_analysis_output_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.get_analysis_output_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.get_derivatives_dir"><code class="docutils literal notranslate"><span class="pre">PathManager.get_derivatives_dir()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.list_eeg_caps"><code class="docutils literal notranslate"><span class="pre">PathManager.list_eeg_caps()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.paths.PathManager.validate_subject_structure"><code class="docutils literal notranslate"><span class="pre">PathManager.validate_subject_structure()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.paths.get_path_manager"><code class="docutils literal notranslate"><span class="pre">get_path_manager()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.paths.reset_path_manager"><code class="docutils literal notranslate"><span class="pre">reset_path_manager()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.constants">Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.nifti">NIfTI Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.nifti.load_subject_nifti_ti_toolbox"><code class="docutils literal notranslate"><span class="pre">load_subject_nifti_ti_toolbox()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.nifti.load_group_data_ti_toolbox"><code class="docutils literal notranslate"><span class="pre">load_group_data_ti_toolbox()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.nifti.load_grouped_subjects_ti_toolbox"><code class="docutils literal notranslate"><span class="pre">load_grouped_subjects_ti_toolbox()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.mesh">Mesh Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.mesh.create_mesh_opt_file"><code class="docutils literal notranslate"><span class="pre">create_mesh_opt_file()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.calc">Calculations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.calc.get_TI_vectors"><code class="docutils literal notranslate"><span class="pre">get_TI_vectors()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.calc.get_mTI_vectors"><code class="docutils literal notranslate"><span class="pre">get_mTI_vectors()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.roi">ROI Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.roi.find_roi_element_indices"><code class="docutils literal notranslate"><span class="pre">find_roi_element_indices()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.roi.find_grey_matter_indices"><code class="docutils literal notranslate"><span class="pre">find_grey_matter_indices()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.roi.calculate_roi_metrics"><code class="docutils literal notranslate"><span class="pre">calculate_roi_metrics()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.roi.ROICoordinateHelper"><code class="docutils literal notranslate"><span class="pre">ROICoordinateHelper</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.roi.ROICoordinateHelper.transform_mni_to_subject"><code class="docutils literal notranslate"><span class="pre">ROICoordinateHelper.transform_mni_to_subject()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.roi.ROICoordinateHelper.find_voxels_in_sphere"><code class="docutils literal notranslate"><span class="pre">ROICoordinateHelper.find_voxels_in_sphere()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.roi.ROICoordinateHelper.load_roi_from_csv"><code class="docutils literal notranslate"><span class="pre">ROICoordinateHelper.load_roi_from_csv()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.roi.ROICoordinateHelper.save_roi_to_csv"><code class="docutils literal notranslate"><span class="pre">ROICoordinateHelper.save_roi_to_csv()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.roi.validate_ti_montage"><code class="docutils literal notranslate"><span class="pre">validate_ti_montage()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.utils">Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.utils.find_roi_element_indices"><code class="docutils literal notranslate"><span class="pre">find_roi_element_indices()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.utils.find_grey_matter_indices"><code class="docutils literal notranslate"><span class="pre">find_grey_matter_indices()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.utils.calculate_roi_metrics"><code class="docutils literal notranslate"><span class="pre">calculate_roi_metrics()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.errors">Error Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.TIToolboxError"><code class="docutils literal notranslate"><span class="pre">TIToolboxError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.TIToolboxError.__init__"><code class="docutils literal notranslate"><span class="pre">TIToolboxError.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.TIToolboxError.to_dict"><code class="docutils literal notranslate"><span class="pre">TIToolboxError.to_dict()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ProcessError"><code class="docutils literal notranslate"><span class="pre">ProcessError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ProcessError.__init__"><code class="docutils literal notranslate"><span class="pre">ProcessError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ValidationError"><code class="docutils literal notranslate"><span class="pre">ValidationError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ValidationError.__init__"><code class="docutils literal notranslate"><span class="pre">ValidationError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.FileNotFoundError"><code class="docutils literal notranslate"><span class="pre">FileNotFoundError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.FileNotFoundError.__init__"><code class="docutils literal notranslate"><span class="pre">FileNotFoundError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ConfigurationError"><code class="docutils literal notranslate"><span class="pre">ConfigurationError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.ConfigurationError.__init__"><code class="docutils literal notranslate"><span class="pre">ConfigurationError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.SubjectError"><code class="docutils literal notranslate"><span class="pre">SubjectError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.SubjectError.__init__"><code class="docutils literal notranslate"><span class="pre">SubjectError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.SimulationError"><code class="docutils literal notranslate"><span class="pre">SimulationError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.SimulationError.__init__"><code class="docutils literal notranslate"><span class="pre">SimulationError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.AnalysisError"><code class="docutils literal notranslate"><span class="pre">AnalysisError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.AnalysisError.__init__"><code class="docutils literal notranslate"><span class="pre">AnalysisError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.MeshError"><code class="docutils literal notranslate"><span class="pre">MeshError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.errors.MeshError.__init__"><code class="docutils literal notranslate"><span class="pre">MeshError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.handle_error"><code class="docutils literal notranslate"><span class="pre">handle_error()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.show_error_dialog"><code class="docutils literal notranslate"><span class="pre">show_error_dialog()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.validate_file_exists"><code class="docutils literal notranslate"><span class="pre">validate_file_exists()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.validate_subject"><code class="docutils literal notranslate"><span class="pre">validate_subject()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.errors.validate_montage_config"><code class="docutils literal notranslate"><span class="pre">validate_montage_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../core/index.html#module-tit.core.process">Process Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner"><code class="docutils literal notranslate"><span class="pre">ProcessRunner</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.output_signal"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.output_signal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.progress_signal"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.progress_signal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.finished_signal"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.finished_signal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.error_signal"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.error_signal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.__init__"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.run"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.run()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.ProcessRunner.terminate_process"><code class="docutils literal notranslate"><span class="pre">ProcessRunner.terminate_process()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.MessageParser"><code class="docutils literal notranslate"><span class="pre">MessageParser</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../core/index.html#tit.core.process.MessageParser.parse"><code class="docutils literal notranslate"><span class="pre">MessageParser.parse()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.SimulatorMessageParser"><code class="docutils literal notranslate"><span class="pre">SimulatorMessageParser</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.AnalyzerMessageParser"><code class="docutils literal notranslate"><span class="pre">AnalyzerMessageParser</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.PreprocessMessageParser"><code class="docutils literal notranslate"><span class="pre">PreprocessMessageParser</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../core/index.html#tit.core.process.strip_ansi_codes"><code class="docutils literal notranslate"><span class="pre">strip_ansi_codes()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Simulation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../sim/index.html">Simulation Module (<code class="docutils literal notranslate"><span class="pre">tit.sim</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.simulator">Main Simulator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.simulator.setup_montage_directories"><code class="docutils literal notranslate"><span class="pre">setup_montage_directories()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.simulator.create_simulation_config_file"><code class="docutils literal notranslate"><span class="pre">create_simulation_config_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.simulator.run_montage_visualization"><code class="docutils literal notranslate"><span class="pre">run_montage_visualization()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.simulator.run_simulation"><code class="docutils literal notranslate"><span class="pre">run_simulation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.simulator.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.config">Configuration Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationMode"><code class="docutils literal notranslate"><span class="pre">SimulationMode</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationMode.TI"><code class="docutils literal notranslate"><span class="pre">SimulationMode.TI</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationMode.MTI"><code class="docutils literal notranslate"><span class="pre">SimulationMode.MTI</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ConductivityType"><code class="docutils literal notranslate"><span class="pre">ConductivityType</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ConductivityType.SCALAR"><code class="docutils literal notranslate"><span class="pre">ConductivityType.SCALAR</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ConductivityType.VN"><code class="docutils literal notranslate"><span class="pre">ConductivityType.VN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ConductivityType.DIR"><code class="docutils literal notranslate"><span class="pre">ConductivityType.DIR</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ConductivityType.MC"><code class="docutils literal notranslate"><span class="pre">ConductivityType.MC</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig.shape"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig.shape</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig.dimensions"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig.dimensions</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig.thickness"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig.thickness</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig.sponge_thickness"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig.sponge_thickness</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ElectrodeConfig.__init__"><code class="docutils literal notranslate"><span class="pre">ElectrodeConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig"><code class="docutils literal notranslate"><span class="pre">IntensityConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.pair1"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.pair1</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.pair2"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.pair2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.pair3"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.pair3</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.pair4"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.pair4</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.from_string"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.from_string()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.IntensityConfig.__init__"><code class="docutils literal notranslate"><span class="pre">IntensityConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig"><code class="docutils literal notranslate"><span class="pre">MontageConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.name"><code class="docutils literal notranslate"><span class="pre">MontageConfig.name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.electrode_pairs"><code class="docutils literal notranslate"><span class="pre">MontageConfig.electrode_pairs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.is_xyz"><code class="docutils literal notranslate"><span class="pre">MontageConfig.is_xyz</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.eeg_net"><code class="docutils literal notranslate"><span class="pre">MontageConfig.eeg_net</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.simulation_mode"><code class="docutils literal notranslate"><span class="pre">MontageConfig.simulation_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.num_pairs"><code class="docutils literal notranslate"><span class="pre">MontageConfig.num_pairs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.MontageConfig.__init__"><code class="docutils literal notranslate"><span class="pre">MontageConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig"><code class="docutils literal notranslate"><span class="pre">ParallelConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.enabled"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.enabled</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.max_workers"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.max_workers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.__post_init__"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.__post_init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.effective_workers"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.effective_workers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.get_memory_warning"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.get_memory_warning()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.ParallelConfig.__init__"><code class="docutils literal notranslate"><span class="pre">ParallelConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig"><code class="docutils literal notranslate"><span class="pre">SimulationConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.subject_id"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.subject_id</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.project_dir"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.project_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.conductivity_type"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.conductivity_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.intensities"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.intensities</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.electrode"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.electrode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.eeg_net"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.eeg_net</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.map_to_surf"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.map_to_surf</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.map_to_vol"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.map_to_vol</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.map_to_mni"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.map_to_mni</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.map_to_fsavg"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.map_to_fsavg</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.tissues_in_niftis"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.tissues_in_niftis</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.open_in_gmsh"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.open_in_gmsh</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.parallel"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.parallel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.__post_init__"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.__post_init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.config.SimulationConfig.__init__"><code class="docutils literal notranslate"><span class="pre">SimulationConfig.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.session_builder">Session Builder</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.session_builder.SessionBuilder"><code class="docutils literal notranslate"><span class="pre">SessionBuilder</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.session_builder.SessionBuilder.__init__"><code class="docutils literal notranslate"><span class="pre">SessionBuilder.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.session_builder.SessionBuilder.build_session"><code class="docutils literal notranslate"><span class="pre">SessionBuilder.build_session()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.post_processor">Post-Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.post_processor.PostProcessor"><code class="docutils literal notranslate"><span class="pre">PostProcessor</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.post_processor.PostProcessor.__init__"><code class="docutils literal notranslate"><span class="pre">PostProcessor.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.post_processor.PostProcessor.process_ti_results"><code class="docutils literal notranslate"><span class="pre">PostProcessor.process_ti_results()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../sim/index.html#tit.sim.post_processor.PostProcessor.process_mti_results"><code class="docutils literal notranslate"><span class="pre">PostProcessor.process_mti_results()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.montage_loader">Montage Loading</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.load_montage_file"><code class="docutils literal notranslate"><span class="pre">load_montage_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.list_montage_names"><code class="docutils literal notranslate"><span class="pre">list_montage_names()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.add_montage"><code class="docutils literal notranslate"><span class="pre">add_montage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.load_flex_montages"><code class="docutils literal notranslate"><span class="pre">load_flex_montages()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.parse_flex_montage"><code class="docutils literal notranslate"><span class="pre">parse_flex_montage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.montage_loader.load_montages"><code class="docutils literal notranslate"><span class="pre">load_montages()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../sim/index.html#module-tit.sim.utils">Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.montage_config_dir"><code class="docutils literal notranslate"><span class="pre">montage_config_dir()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.montage_list_path"><code class="docutils literal notranslate"><span class="pre">montage_list_path()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.ensure_montage_file"><code class="docutils literal notranslate"><span class="pre">ensure_montage_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.load_montage_data"><code class="docutils literal notranslate"><span class="pre">load_montage_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.save_montage_data"><code class="docutils literal notranslate"><span class="pre">save_montage_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.ensure_eeg_net_entry"><code class="docutils literal notranslate"><span class="pre">ensure_eeg_net_entry()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.upsert_montage"><code class="docutils literal notranslate"><span class="pre">upsert_montage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sim/index.html#tit.sim.utils.list_montage_names"><code class="docutils literal notranslate"><span class="pre">list_montage_names()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../analyzer/index.html">Analysis Module (<code class="docutils literal notranslate"><span class="pre">tit.analyzer</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.mesh_analyzer">Mesh Analyzer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.__init__"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.__del__"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.__del__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_whole_head"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.analyze_whole_head()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_sphere"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.analyze_sphere()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.analyze_cortex"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.analyze_cortex()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.mesh_analyzer.MeshAnalyzer.get_grey_matter_statistics"><code class="docutils literal notranslate"><span class="pre">MeshAnalyzer.get_grey_matter_statistics()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.voxel_analyzer">Voxel Analyzer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.field_nifti"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.field_nifti</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.subject_dir"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.subject_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.output_dir"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.output_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.visualizer"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.visualizer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.__init__"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_whole_head"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.analyze_whole_head()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_sphere"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.analyze_sphere()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.resample_to_match"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.resample_to_match()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.analyze_cortex"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.analyze_cortex()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_atlas_regions"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.get_atlas_regions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.load_brain_image"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.load_brain_image()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.find_region"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.find_region()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.voxel_analyzer.VoxelAnalyzer.get_grey_matter_statistics"><code class="docutils literal notranslate"><span class="pre">VoxelAnalyzer.get_grey_matter_statistics()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.group_analyzer">Group Analyzer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.format_duration"><code class="docutils literal notranslate"><span class="pre">format_duration()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.log_group_analysis_start"><code class="docutils literal notranslate"><span class="pre">log_group_analysis_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.log_group_analysis_complete"><code class="docutils literal notranslate"><span class="pre">log_group_analysis_complete()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.log_group_subject_status"><code class="docutils literal notranslate"><span class="pre">log_group_subject_status()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.create_group_output_directory"><code class="docutils literal notranslate"><span class="pre">create_group_output_directory()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.setup_parser"><code class="docutils literal notranslate"><span class="pre">setup_parser()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.validate_args"><code class="docutils literal notranslate"><span class="pre">validate_args()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.compute_subject_output_dir"><code class="docutils literal notranslate"><span class="pre">compute_subject_output_dir()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.build_main_analyzer_command"><code class="docutils literal notranslate"><span class="pre">build_main_analyzer_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.run_subject_analysis"><code class="docutils literal notranslate"><span class="pre">run_subject_analysis()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.collect_analysis_paths"><code class="docutils literal notranslate"><span class="pre">collect_analysis_paths()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.run_comprehensive_group_analysis"><code class="docutils literal notranslate"><span class="pre">run_comprehensive_group_analysis()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.determine_group_subfolder_name"><code class="docutils literal notranslate"><span class="pre">determine_group_subfolder_name()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.group_analyzer.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.visualizer">Visualizer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.output_dir"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.output_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.__init__"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.save_results_to_csv"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.save_results_to_csv()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.save_extra_info_to_csv"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.save_extra_info_to_csv()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.save_whole_head_results_to_csv"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.save_whole_head_results_to_csv()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.BaseVisualizer.generate_focality_histogram"><code class="docutils literal notranslate"><span class="pre">BaseVisualizer.generate_focality_histogram()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.Visualizer"><code class="docutils literal notranslate"><span class="pre">Visualizer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.Visualizer.__init__"><code class="docutils literal notranslate"><span class="pre">Visualizer.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.MeshVisualizer"><code class="docutils literal notranslate"><span class="pre">MeshVisualizer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.MeshVisualizer.__init__"><code class="docutils literal notranslate"><span class="pre">MeshVisualizer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.MeshVisualizer.visualize_cortex_roi"><code class="docutils literal notranslate"><span class="pre">MeshVisualizer.visualize_cortex_roi()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.MeshVisualizer.visualize_spherical_roi"><code class="docutils literal notranslate"><span class="pre">MeshVisualizer.visualize_spherical_roi()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.VoxelVisualizer"><code class="docutils literal notranslate"><span class="pre">VoxelVisualizer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.VoxelVisualizer.__init__"><code class="docutils literal notranslate"><span class="pre">VoxelVisualizer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.VoxelVisualizer.create_cortex_nifti"><code class="docutils literal notranslate"><span class="pre">VoxelVisualizer.create_cortex_nifti()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.visualizer.VoxelVisualizer.find_region"><code class="docutils literal notranslate"><span class="pre">VoxelVisualizer.find_region()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.main_analyzer">Main Analyzer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.stdout_reconfigure"><code class="docutils literal notranslate"><span class="pre">stdout_reconfigure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.stderr_reconfigure"><code class="docutils literal notranslate"><span class="pre">stderr_reconfigure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.flush_output"><code class="docutils literal notranslate"><span class="pre">flush_output()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.format_duration"><code class="docutils literal notranslate"><span class="pre">format_duration()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_start"><code class="docutils literal notranslate"><span class="pre">log_analysis_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_complete"><code class="docutils literal notranslate"><span class="pre">log_analysis_complete()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_failed"><code class="docutils literal notranslate"><span class="pre">log_analysis_failed()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_step_start"><code class="docutils literal notranslate"><span class="pre">log_analysis_step_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_step_complete"><code class="docutils literal notranslate"><span class="pre">log_analysis_step_complete()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.log_analysis_step_failed"><code class="docutils literal notranslate"><span class="pre">log_analysis_step_failed()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.create_roi_description"><code class="docutils literal notranslate"><span class="pre">create_roi_description()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.validate_file_extension"><code class="docutils literal notranslate"><span class="pre">validate_file_extension()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.validate_coordinates"><code class="docutils literal notranslate"><span class="pre">validate_coordinates()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.validate_radius"><code class="docutils literal notranslate"><span class="pre">validate_radius()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.construct_mesh_field_path"><code class="docutils literal notranslate"><span class="pre">construct_mesh_field_path()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.setup_parser"><code class="docutils literal notranslate"><span class="pre">setup_parser()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.validate_args"><code class="docutils literal notranslate"><span class="pre">validate_args()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.main_analyzer.print_stat_if_exists"><code class="docutils literal notranslate"><span class="pre">print_stat_if_exists()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../analyzer/index.html#module-tit.analyzer.field_selector">Field Selector</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analyzer/index.html#tit.analyzer.field_selector.select_field_file"><code class="docutils literal notranslate"><span class="pre">select_field_file()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../opt/index.html">Optimization Module (<code class="docutils literal notranslate"><span class="pre">tit.opt</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../opt/index.html#leadfield-generator">Leadfield Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../opt/index.html#flex-search">Flex-Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../opt/index.html#ex-search">Ex-Search</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../stats/index.html">Statistics Module (<code class="docutils literal notranslate"><span class="pre">tit.stats</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../stats/index.html#module-tit.stats.permutation_analysis">Permutation Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.load_subject_data"><code class="docutils literal notranslate"><span class="pre">load_subject_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.load_subject_data_group_comparison"><code class="docutils literal notranslate"><span class="pre">load_subject_data_group_comparison()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.load_subject_data_correlation"><code class="docutils literal notranslate"><span class="pre">load_subject_data_correlation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.prepare_config_from_csv"><code class="docutils literal notranslate"><span class="pre">prepare_config_from_csv()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.run_analysis"><code class="docutils literal notranslate"><span class="pre">run_analysis()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../stats/index.html#tit.stats.permutation_analysis.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../stats/index.html#cluster-analysis">Cluster Analysis</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TI-Toolbox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tit.stats.permutation_analysis</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tit.stats.permutation_analysis</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env simnibs_python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Unified Cluster-Based Permutation Testing for TI-Toolbox</span>

<span class="sd">This script provides unified cluster-based permutation testing for both:</span>
<span class="sd">1. Group comparison analysis (binary responder/non-responder classification)</span>
<span class="sd">2. Correlation analysis (continuous outcome measures)</span>

<span class="sd">Supports both t-test and correlation-based statistical approaches with</span>
<span class="sd">cluster-based permutation correction for multiple comparisons.</span>

<span class="sd">Usage:</span>
<span class="sd">    from tit.stats import permutation_analysis</span>
<span class="sd">    # Group comparison</span>
<span class="sd">    results = permutation_analysis.run_analysis(</span>
<span class="sd">        subject_configs, analysis_name, analysis_type=&#39;group_comparison&#39;</span>
<span class="sd">    )</span>
<span class="sd">    # Correlation analysis</span>
<span class="sd">    results = permutation_analysis.run_analysis(</span>
<span class="sd">        subject_configs, analysis_name, analysis_type=&#39;correlation&#39;</span>
<span class="sd">    )</span>

<span class="sd">For GUI usage, see gui/extensions/permutation_analysis.py</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.stats_utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ttest_voxelwise</span><span class="p">,</span> <span class="n">cluster_based_correction</span><span class="p">,</span>
    <span class="n">correlation_voxelwise</span><span class="p">,</span> <span class="n">correlation_cluster_correction</span><span class="p">,</span>
    <span class="n">cluster_analysis</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.atlas_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">atlas_overlap_analysis</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_permutation_null_distribution</span><span class="p">,</span> <span class="n">plot_cluster_size_mass_correlation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.reporting</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_summary</span><span class="p">,</span> <span class="n">generate_correlation_summary</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tit.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_path_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tit.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tit.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">nifti</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tit</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">logging_util</span>


<span class="c1"># ==============================================================================</span>
<span class="c1"># UNIFIED DATA LOADING</span>
<span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="load_subject_data">
<a class="viewcode-back" href="../../../stats/index.html#tit.stats.permutation_analysis.load_subject_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_subject_data</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unified data loading for both group comparison and correlation analysis</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    subject_configs : list of dict</span>
<span class="sd">        Subject configurations (format depends on analysis_type)</span>
<span class="sd">    nifti_file_pattern : str, optional</span>
<span class="sd">        Pattern for NIfTI files</span>
<span class="sd">    analysis_type : str</span>
<span class="sd">        Either &#39;group_comparison&#39; or &#39;correlation&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    For group_comparison:</span>
<span class="sd">        responders, non_responders, template_img, resp_ids, non_resp_ids</span>
<span class="sd">    For correlation:</span>
<span class="sd">        subject_data, effect_sizes, weights, template_img, subject_ids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_subject_data_group_comparison</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_subject_data_correlation</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown analysis_type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_subject_data_group_comparison">
<a class="viewcode-back" href="../../../stats/index.html#tit.stats.permutation_analysis.load_subject_data_group_comparison">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_subject_data_group_comparison</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load subject data for group comparison analysis (binary outcomes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nifti_file_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nifti_file_pattern</span> <span class="o">=</span> <span class="s2">&quot;grey_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz&quot;</span>

    <span class="c1"># Separate configs by response</span>
    <span class="n">responder_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">subject_configs</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">non_responder_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">subject_configs</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">responder_configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_responder_configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need at least one responder and one non-responder&quot;</span><span class="p">)</span>

    <span class="c1"># Load responders</span>
    <span class="n">responders</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">responder_ids</span> <span class="o">=</span> <span class="n">nifti</span><span class="o">.</span><span class="n">load_group_data_ti_toolbox</span><span class="p">(</span>
        <span class="n">responder_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">nifti_file_pattern</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="c1"># Load non-responders</span>
    <span class="n">non_responders</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">non_responder_ids</span> <span class="o">=</span> <span class="n">nifti</span><span class="o">.</span><span class="n">load_group_data_ti_toolbox</span><span class="p">(</span>
        <span class="n">non_responder_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">nifti_file_pattern</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">responder_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> responders: </span><span class="si">{</span><span class="n">responder_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">non_responder_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> non-responders: </span><span class="si">{</span><span class="n">non_responder_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Responders shape: </span><span class="si">{</span><span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-responders shape: </span><span class="si">{</span><span class="n">non_responders</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">responder_ids</span><span class="p">,</span> <span class="n">non_responder_ids</span></div>



<div class="viewcode-block" id="load_subject_data_correlation">
<a class="viewcode-back" href="../../../stats/index.html#tit.stats.permutation_analysis.load_subject_data_correlation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_subject_data_correlation</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load subject data for correlation analysis (continuous outcomes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nifti_file_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nifti_file_pattern</span> <span class="o">=</span> <span class="s2">&quot;grey_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz&quot;</span>

    <span class="c1"># Check for required fields</span>
    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation_name&#39;</span><span class="p">,</span> <span class="s1">&#39;effect_size&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">subject_configs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required field &#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#39; in subject config&quot;</span><span class="p">)</span>

    <span class="c1"># Load all subjects</span>
    <span class="n">subject_data</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">nifti</span><span class="o">.</span><span class="n">load_group_data_ti_toolbox</span><span class="p">(</span>
        <span class="n">subject_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">nifti_file_pattern</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="c1"># Build a lookup from subject_id to config for successfully loaded subjects</span>
    <span class="n">config_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">subject_configs</span><span class="p">}</span>

    <span class="c1"># Extract effect sizes and weights only for successfully loaded subjects</span>
    <span class="n">effect_sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">weights_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">has_weights</span> <span class="o">=</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">subject_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">subject_ids</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">config_lookup</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="n">effect_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;effect_size&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">has_weights</span><span class="p">:</span>
            <span class="n">weights_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

    <span class="n">effect_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_weights</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> subjects: </span><span class="si">{</span><span class="n">subject_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect sizes: mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect size range: [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weights: mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, range=[</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data shape: </span><span class="si">{</span><span class="n">subject_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">subject_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">subject_ids</span></div>



<div class="viewcode-block" id="prepare_config_from_csv">
<a class="viewcode-back" href="../../../stats/index.html#tit.stats.permutation_analysis.prepare_config_from_csv">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_config_from_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load subject configurations from CSV file</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    csv_file : str</span>
<span class="sd">        Path to CSV file</span>
<span class="sd">    analysis_type : str</span>
<span class="sd">        Either &#39;group_comparison&#39; or &#39;correlation&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    list of dict : Subject configurations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="c1"># Validate required columns for group comparison</span>
        <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation_name&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV file missing required column: &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; for group comparison&quot;</span><span class="p">)</span>

        <span class="n">configs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Handle both &#39;sub-XXX&#39; and &#39;XXX&#39; formats</span>
            <span class="n">subject_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sub-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">:</span> <span class="n">subject_id</span><span class="p">,</span>
                <span class="s1">&#39;simulation_name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;simulation_name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">])</span>
            <span class="p">})</span>

    <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span>
        <span class="c1"># Validate required columns for correlation</span>
        <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation_name&#39;</span><span class="p">,</span> <span class="s1">&#39;effect_size&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV file missing required column: &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; for correlation analysis&quot;</span><span class="p">)</span>

        <span class="n">configs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skipped_rows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Skip rows with missing required fields</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;simulation_name&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;effect_size&#39;</span><span class="p">]):</span>
                <span class="n">skipped_rows</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c1"># Handle both &#39;sub-XXX&#39; and &#39;XXX&#39; formats</span>
            <span class="c1"># Also handle float-to-string conversion (e.g., 101.0 -&gt; &quot;101&quot;)</span>
            <span class="n">raw_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_id</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="c1"># Convert float to int then to string (101.0 -&gt; &quot;101&quot;)</span>
                <span class="n">subject_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">raw_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subject_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw_id</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sub-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1"># Also handle string representations of floats like &quot;101.0&quot;</span>
                <span class="k">if</span> <span class="n">subject_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">):</span>
                    <span class="n">subject_id</span> <span class="o">=</span> <span class="n">subject_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;subject_id&#39;</span><span class="p">:</span> <span class="n">subject_id</span><span class="p">,</span>
                <span class="s1">&#39;simulation_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;simulation_name&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;effect_size&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;effect_size&#39;</span><span class="p">])</span>
            <span class="p">}</span>

            <span class="c1"># Add weight if present</span>
            <span class="k">if</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">)):</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>

            <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skipped_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Note: Skipped </span><span class="si">{</span><span class="n">skipped_rows</span><span class="si">}</span><span class="s2"> rows with missing required fields&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid subject configurations found in CSV file&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown analysis_type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">configs</span></div>



<span class="c1"># ==============================================================================</span>
<span class="c1"># CONFIGURATION</span>
<span class="c1"># ==============================================================================</span>

<span class="n">DEFAULT_CONFIG_GROUP_COMPARISON</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Analysis type</span>
    <span class="s1">&#39;analysis_type&#39;</span><span class="p">:</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">,</span>

    <span class="c1"># Statistical parameters</span>
    <span class="s1">&#39;test_type&#39;</span><span class="p">:</span> <span class="s1">&#39;unpaired&#39;</span><span class="p">,</span>        <span class="c1"># &#39;paired&#39; or &#39;unpaired&#39; t-test</span>
    <span class="s1">&#39;alternative&#39;</span><span class="p">:</span> <span class="s1">&#39;two-sided&#39;</span><span class="p">,</span>       <span class="c1"># &#39;two-sided&#39;, &#39;greater&#39; (resp &gt; non-resp), or &#39;less&#39;</span>
    <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>      <span class="c1"># p &lt; 0.05 for cluster formation</span>
    <span class="s1">&#39;cluster_stat&#39;</span><span class="p">:</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span>         <span class="c1"># &#39;size&#39; (voxel count) or &#39;mass&#39; (sum of t-values)</span>
    <span class="s1">&#39;n_permutations&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>         <span class="c1"># Number of permutations</span>
    <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>                  <span class="c1"># Cluster-level significance</span>
    <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>                   <span class="c1"># Number of parallel jobs (-1 = all cores)</span>

    <span class="c1"># Group and metric labels (customize for your study)</span>
    <span class="s1">&#39;group1_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Responders&#39;</span><span class="p">,</span>
    <span class="s1">&#39;group2_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Non-Responders&#39;</span><span class="p">,</span>
    <span class="s1">&#39;value_metric&#39;</span><span class="p">:</span> <span class="s1">&#39;Current Intensity&#39;</span><span class="p">,</span>

    <span class="c1"># Tissue type selection: &#39;grey&#39;, &#39;white&#39;, or &#39;all&#39;</span>
    <span class="s1">&#39;tissue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span>

    <span class="c1"># File pattern for NIfTI files (auto-generated from tissue_type if not provided)</span>
    <span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>

    <span class="c1"># Atlas files (optional)</span>
    <span class="s1">&#39;atlas_files&#39;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>

<span class="n">DEFAULT_CONFIG_CORRELATION</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Analysis type</span>
    <span class="s1">&#39;analysis_type&#39;</span><span class="p">:</span> <span class="s1">&#39;correlation&#39;</span><span class="p">,</span>

    <span class="c1"># Statistical parameters</span>
    <span class="s1">&#39;correlation_type&#39;</span><span class="p">:</span> <span class="s1">&#39;pearson&#39;</span><span class="p">,</span>   <span class="c1"># &#39;pearson&#39; or &#39;spearman&#39;</span>
    <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>       <span class="c1"># p &lt; 0.05 for cluster formation</span>
    <span class="s1">&#39;cluster_stat&#39;</span><span class="p">:</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span>          <span class="c1"># &#39;size&#39; (voxel count) or &#39;mass&#39; (sum of t-values)</span>
    <span class="s1">&#39;n_permutations&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>          <span class="c1"># Number of permutations</span>
    <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>                   <span class="c1"># Cluster-level significance</span>
    <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>                    <span class="c1"># Number of parallel jobs (-1 = all cores)</span>
    <span class="s1">&#39;use_weights&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>             <span class="c1"># Use weights if available in CSV</span>

    <span class="c1"># Labels for reports</span>
    <span class="s1">&#39;effect_metric&#39;</span><span class="p">:</span> <span class="s1">&#39;Effect Size&#39;</span><span class="p">,</span>  <span class="c1"># Name of the outcome measure</span>
    <span class="s1">&#39;field_metric&#39;</span><span class="p">:</span> <span class="s1">&#39;Electric Field Magnitude&#39;</span><span class="p">,</span>

    <span class="c1"># Tissue type selection: &#39;grey&#39;, &#39;white&#39;, or &#39;all&#39;</span>
    <span class="s1">&#39;tissue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span>

    <span class="c1"># File pattern for NIfTI files (auto-generated from tissue_type if not provided)</span>
    <span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>

    <span class="c1"># Atlas files (optional)</span>
    <span class="s1">&#39;atlas_files&#39;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>


<span class="c1"># ==============================================================================</span>
<span class="c1"># LOGGING SETUP</span>
<span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="setup_logging">
<a class="viewcode-back" href="../../../stats/index.html#tit.stats.permutation_analysis.setup_logging">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">,</span> <span class="n">callback_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up logging for unified analysis</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    output_dir : str</span>
<span class="sd">        Directory where log file will be saved</span>
<span class="sd">    analysis_type : str</span>
<span class="sd">        Type of analysis for log naming</span>
<span class="sd">    callback_handler : logging.Handler, optional</span>
<span class="sd">        Callback handler for GUI integration</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    logger : logging.Logger</span>
<span class="sd">        Configured logger instance</span>
<span class="sd">    log_file : str</span>
<span class="sd">        Path to log file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logging_util</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;logging_util module not available&quot;</span><span class="p">)</span>

    <span class="c1"># Create timestamp for log file</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">_analysis_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">)</span>

    <span class="c1"># Create logger</span>
    <span class="n">logger_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;GroupComparison&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">analysis_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;group_comparison&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Correlation&#39;</span><span class="si">}</span><span class="s2">Analysis&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging_util</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># If callback handler provided (for GUI), suppress console output and add callback</span>
    <span class="k">if</span> <span class="n">callback_handler</span><span class="p">:</span>
        <span class="n">logging_util</span><span class="o">.</span><span class="n">suppress_console_output</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">callback_handler</span><span class="p">)</span>

    <span class="c1"># Configure external loggers</span>
    <span class="n">external_loggers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;nibabel&#39;</span><span class="p">,</span> <span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">]</span>
    <span class="n">logging_util</span><span class="o">.</span><span class="n">configure_external_loggers</span><span class="p">(</span><span class="n">external_loggers</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_file</span></div>



<span class="c1"># ==============================================================================</span>
<span class="c1"># MAIN WORKFLOW</span>
<span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="run_analysis">
<a class="viewcode-back" href="../../../stats/index.html#tit.stats.permutation_analysis.run_analysis">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_analysis</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">analysis_name</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">callback_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run unified cluster-based permutation analysis</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    subject_configs : list of dict or str</span>
<span class="sd">        Either a list of subject configurations or path to CSV file</span>
<span class="sd">    analysis_name : str</span>
<span class="sd">        Name for this analysis (used for output directory)</span>
<span class="sd">    config : dict, optional</span>
<span class="sd">        Configuration dictionary (merged with defaults based on analysis_type)</span>
<span class="sd">    output_callback : callable, optional</span>
<span class="sd">        Callback function for status updates (for GUI integration)</span>
<span class="sd">    callback_handler : logging.Handler, optional</span>
<span class="sd">        Callback handler for GUI console integration</span>
<span class="sd">    progress_callback : callable, optional</span>
<span class="sd">        Callback function for progress updates</span>
<span class="sd">    stop_callback : callable, optional</span>
<span class="sd">        Callback function to check if analysis should be stopped</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict : Results dictionary (structure depends on analysis_type)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine analysis type from config or default</span>
    <span class="n">analysis_type</span> <span class="o">=</span> <span class="s1">&#39;group_comparison&#39;</span>  <span class="c1"># default</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="s1">&#39;analysis_type&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">analysis_type</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;analysis_type&#39;</span><span class="p">]</span>

    <span class="c1"># Merge config with appropriate defaults</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">DEFAULT_CONFIG_GROUP_COMPARISON</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span>
        <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">DEFAULT_CONFIG_CORRELATION</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown analysis_type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">CONFIG</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Ensure analysis_type is set in CONFIG</span>
    <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;analysis_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_type</span>

    <span class="c1"># Callback helper</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">output_callback</span><span class="p">:</span>
            <span class="n">output_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Start timing</span>
    <span class="n">analysis_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Set up output directory</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="n">get_path_manager</span><span class="p">()</span> <span class="k">if</span> <span class="n">get_path_manager</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pm</span><span class="p">:</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">project_dir</span>
        <span class="n">derivatives_dir</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">get_derivatives_dir</span><span class="p">()</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">derivatives_dir</span><span class="p">,</span>
            <span class="n">const</span><span class="o">.</span><span class="n">DIR_TI_TOOLBOX</span><span class="p">,</span>
            <span class="s1">&#39;stats&#39;</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="p">,</span>
            <span class="n">analysis_name</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROJECT_DIR&#39;</span><span class="p">,</span> <span class="s1">&#39;/mnt&#39;</span><span class="p">)</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">project_dir</span><span class="p">,</span>
            <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stats&#39;</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="p">,</span>
            <span class="n">analysis_name</span>
        <span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set up logging</span>
    <span class="k">if</span> <span class="n">callback_handler</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">,</span> <span class="n">log_file</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">,</span> <span class="n">log_file</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">)</span>

    <span class="c1"># Log header</span>
    <span class="n">analysis_title</span> <span class="o">=</span> <span class="s2">&quot;CLUSTER-BASED PERMUTATION TESTING&quot;</span> <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span> <span class="k">else</span> <span class="s2">&quot;CORRELATION-BASED CLUSTER PERMUTATION TESTING&quot;</span>
    <span class="n">subtitle</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span> <span class="k">else</span> <span class="s2">&quot;(ACES-style analysis for continuous outcomes)&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">analysis_title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subtitle</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">subtitle</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis started: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis name: </span><span class="si">{</span><span class="n">analysis_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis type: </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log file: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2"> analysis: </span><span class="si">{</span><span class="n">analysis_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Construct nifti_file_pattern from tissue_type</span>
    <span class="k">if</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tissue_type</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tissue_type&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tissue_type</span> <span class="o">==</span> <span class="s1">&#39;grey&#39;</span><span class="p">:</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;grey_</span><span class="si">{simulation_name}</span><span class="s1">_TI_MNI_MNI_TI_max.nii.gz&#39;</span>
        <span class="k">elif</span> <span class="n">tissue_type</span> <span class="o">==</span> <span class="s1">&#39;white&#39;</span><span class="p">:</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;white_</span><span class="si">{simulation_name}</span><span class="s1">_TI_MNI_MNI_TI_max.nii.gz&#39;</span>
        <span class="k">elif</span> <span class="n">tissue_type</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{simulation_name}</span><span class="s1">_TI_MNI_MNI_TI_max.nii.gz&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid tissue_type: &#39;</span><span class="si">{</span><span class="n">tissue_type</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;grey&#39;, &#39;white&#39;, or &#39;all&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Log configuration</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONFIGURATION:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Statistical test: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;test_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> t-test&quot;</span><span class="p">)</span>
        <span class="n">alt_text</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;two-sided&#39;</span><span class="p">:</span> <span class="s1">&#39;two-sided ()&#39;</span><span class="p">,</span>
            <span class="s1">&#39;greater&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;one-sided (</span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group1_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group2_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="s1">&#39;less&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;one-sided (</span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group1_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group2_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Alternative hypothesis: </span><span class="si">{</span><span class="n">alt_text</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alternative&#39;</span><span class="p">],</span><span class="w"> </span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alternative&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Correlation type: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;correlation_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">cluster_stat_name</span> <span class="o">=</span> <span class="s2">&quot;Cluster Size&quot;</span> <span class="k">if</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="k">else</span> <span class="s2">&quot;Cluster Mass&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster statistic: </span><span class="si">{</span><span class="n">cluster_stat_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster threshold: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Number of permutations: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Alpha level: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Parallel jobs: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tissue type: </span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tissue_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;grey&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  NIfTI pattern: </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Load subject configurations</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading subject configurations from: </span><span class="si">{</span><span class="n">subject_configs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">subject_configs</span> <span class="o">=</span> <span class="n">prepare_config_from_csv</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">)</span>

    <span class="c1"># Branch based on analysis type</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_run_group_comparison_analysis</span><span class="p">(</span>
            <span class="n">subject_configs</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">,</span>
            <span class="n">analysis_start_time</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">stop_callback</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># correlation</span>
        <span class="k">return</span> <span class="n">_run_correlation_analysis</span><span class="p">(</span>
            <span class="n">subject_configs</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">,</span>
            <span class="n">analysis_start_time</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">stop_callback</span>
        <span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_run_group_comparison_analysis</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">,</span>
                                   <span class="n">analysis_start_time</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">stop_callback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run group comparison analysis workflow&quot;&quot;&quot;</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 1. LOAD DATA</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[1/8] LOADING SUBJECT DATA&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Loading subject data...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">responders</span><span class="p">,</span> <span class="n">non_responders</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">resp_ids</span><span class="p">,</span> <span class="n">non_resp_ids</span> <span class="o">=</span> <span class="n">load_subject_data</span><span class="p">(</span>
        <span class="n">subject_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">],</span>
        <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;group_comparison&#39;</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group1_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">resp_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">non_responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group2_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">non_resp_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image shape: </span><span class="si">{</span><span class="n">responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Data diagnostics</span>
    <span class="n">resp_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">responders</span><span class="p">[</span><span class="n">responders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">responders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">non_resp_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">non_responders</span><span class="p">[</span><span class="n">non_responders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">non_responders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">resp_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">responders</span><span class="p">)</span>
    <span class="n">non_resp_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">non_responders</span><span class="p">)</span>
    <span class="n">resp_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">responders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">non_resp_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">non_responders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DATA DIAGNOSTICS:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Responders - Mean (non-zero): </span><span class="si">{</span><span class="n">resp_mean</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, Max: </span><span class="si">{</span><span class="n">resp_max</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, Non-zero voxels: </span><span class="si">{</span><span class="n">resp_nonzero</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Non-Responders - Mean (non-zero): </span><span class="si">{</span><span class="n">non_resp_mean</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, Max: </span><span class="si">{</span><span class="n">non_resp_max</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, Non-zero voxels: </span><span class="si">{</span><span class="n">non_resp_nonzero</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Data appears valid: </span><span class="si">{</span><span class="n">resp_max</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">non_resp_max</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">()</span>
        <span class="n">mem_info</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Memory usage: </span><span class="si">{</span><span class="n">mem_info</span><span class="o">.</span><span class="n">rss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Memory usage logging may fail on some systems - continue without it</span>
        <span class="k">pass</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stop_callback</span> <span class="ow">and</span> <span class="n">stop_callback</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Analysis stopped by user during data loading&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span><span class="p">(</span><span class="s2">&quot;Analysis stopped by user&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 2. VOXELWISE STATISTICAL TEST</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[2/8] RUNNING VOXELWISE STATISTICAL TESTS&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Running voxelwise statistical tests...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">p_values</span><span class="p">,</span> <span class="n">t_statistics</span><span class="p">,</span> <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">ttest_voxelwise</span><span class="p">(</span>
        <span class="n">responders</span><span class="p">,</span>
        <span class="n">non_responders</span><span class="p">,</span>
        <span class="n">test_type</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;test_type&#39;</span><span class="p">],</span>
        <span class="n">alternative</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alternative&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">n_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tested </span><span class="si">{</span><span class="n">n_valid</span><span class="si">}</span><span class="s2"> valid voxels&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minimum p-value: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">p_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum p-value: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">p_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Voxels with p&lt;0.01: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_values</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.01</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">valid_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Voxels with p&lt;0.05: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_values</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">valid_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Voxels with p&lt;0.10: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_values</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.10</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">valid_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># T-statistic diagnostics</span>
    <span class="n">t_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t_statistics</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t_nonzero</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">T-STATISTIC DIAGNOSTICS:&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Non-zero t-statistics: </span><span class="si">{</span><span class="n">t_nonzero</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Min t-stat: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">t_statistics</span><span class="p">[</span><span class="n">t_statistics</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max t-stat: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t_statistics</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean |t-stat|: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t_statistics</span><span class="p">[</span><span class="n">t_statistics</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">]))</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WARNING: All t-statistics are zero!&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># Log observed clusters before permutation correction (vectorized for speed)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">label</span> <span class="k">as</span> <span class="n">scipy_label</span>
    <span class="n">observed_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_values</span> <span class="o">&lt;</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">valid_mask</span>
    <span class="n">observed_labeled</span><span class="p">,</span> <span class="n">n_observed_clusters</span> <span class="o">=</span> <span class="n">scipy_label</span><span class="p">(</span><span class="n">observed_mask</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Observed clusters at p &lt; </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (before permutation correction):&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total clusters found: </span><span class="si">{</span><span class="n">n_observed_clusters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_observed_clusters</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Vectorized cluster size computation using bincount</span>
        <span class="n">cluster_labels_flat</span> <span class="o">=</span> <span class="n">observed_labeled</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">observed_cluster_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">cluster_labels_flat</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_observed_clusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">observed_cluster_sizes_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">observed_cluster_sizes</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 largest observed clusters (before permutation correction):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">observed_cluster_sizes_sorted</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s2">6d</span><span class="si">}</span><span class="s2"> voxels&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Largest observed cluster: </span><span class="si">{</span><span class="n">observed_cluster_sizes_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> voxels&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total voxels in all clusters: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">observed_cluster_sizes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stop_callback</span> <span class="ow">and</span> <span class="n">stop_callback</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Analysis stopped by user before permutation testing&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span><span class="p">(</span><span class="s2">&quot;Analysis stopped by user&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 3. CLUSTER-BASED PERMUTATION CORRECTION</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[3/8] APPLYING CLUSTER-BASED PERMUTATION CORRECTION&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running permutation testing (</span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> permutations)...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">permutation_log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;permutation_details.txt&#39;</span><span class="p">)</span>

    <span class="n">sig_mask</span><span class="p">,</span> <span class="n">cluster_threshold</span><span class="p">,</span> <span class="n">sig_clusters</span><span class="p">,</span> <span class="n">null_distribution</span><span class="p">,</span> <span class="n">all_clusters</span><span class="p">,</span> <span class="n">correlation_data</span> <span class="o">=</span> <span class="n">cluster_based_correction</span><span class="p">(</span>
        <span class="n">responders</span><span class="p">,</span>
        <span class="n">non_responders</span><span class="p">,</span>
        <span class="n">p_values</span><span class="p">,</span>
        <span class="n">valid_mask</span><span class="p">,</span>
        <span class="n">cluster_threshold</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">],</span>
        <span class="n">n_permutations</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">],</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
        <span class="n">test_type</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;test_type&#39;</span><span class="p">],</span>
        <span class="n">alternative</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alternative&#39;</span><span class="p">],</span>
        <span class="n">cluster_stat</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">],</span>
        <span class="n">t_statistics</span><span class="o">=</span><span class="n">t_statistics</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">],</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="n">save_permutation_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">permutation_log_file</span><span class="o">=</span><span class="n">permutation_log_file</span><span class="p">,</span>
        <span class="n">subject_ids_resp</span><span class="o">=</span><span class="n">resp_ids</span><span class="p">,</span>
        <span class="n">subject_ids_non_resp</span><span class="o">=</span><span class="n">non_resp_ids</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster size threshold: </span><span class="si">{</span><span class="n">cluster_threshold</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> voxels&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster mass threshold: </span><span class="si">{</span><span class="n">cluster_threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant clusters found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_clusters</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total significant voxels: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 4. CLUSTER ANALYSIS</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[4/8] ANALYZING SIGNIFICANT CLUSTERS&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_clusters</span><span class="p">)</span><span class="si">}</span><span class="s2"> significant clusters...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="n">cluster_analysis</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Largest cluster: </span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> voxels&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MNI center: (</span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 5. PLOT PERMUTATION NULL DISTRIBUTION</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[5/8] PLOTTING PERMUTATION NULL DISTRIBUTION&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Generating visualization plots...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">perm_plot_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;permutation_null_distribution.pdf&#39;</span><span class="p">)</span>
    <span class="n">plot_permutation_null_distribution</span><span class="p">(</span>
        <span class="n">null_distribution</span><span class="p">,</span>
        <span class="n">cluster_threshold</span><span class="p">,</span>
        <span class="n">all_clusters</span><span class="p">,</span>
        <span class="n">perm_plot_file</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
        <span class="n">cluster_stat</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Plot cluster size vs mass correlation</span>
    <span class="n">correlation_plot_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;cluster_size_mass_correlation.pdf&#39;</span><span class="p">)</span>
    <span class="n">plot_cluster_size_mass_correlation</span><span class="p">(</span>
        <span class="n">correlation_data</span><span class="p">[</span><span class="s1">&#39;sizes&#39;</span><span class="p">],</span>
        <span class="n">correlation_data</span><span class="p">[</span><span class="s1">&#39;masses&#39;</span><span class="p">],</span>
        <span class="n">correlation_plot_file</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 6. GENERATE AVERAGE MAPS</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[6/8] GENERATING AVERAGE INTENSITY MAPS&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Generating average intensity maps...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Average responders (compute in float32 to save memory)</span>
    <span class="n">avg_responders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">responders</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">avg_resp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;average_responders.nii.gz&#39;</span><span class="p">)</span>
    <span class="c1"># Save NIfTI file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">avg_resp_file</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">avg_responders</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">avg_resp_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: average_responders.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># Average non-responders (compute in float32 to save memory)</span>
    <span class="n">avg_non_responders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">non_responders</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">avg_non_resp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;average_non_responders.nii.gz&#39;</span><span class="p">)</span>
    <span class="c1"># Save NIfTI file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">avg_non_resp_file</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">avg_non_responders</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">avg_non_resp_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: average_non_responders.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># Difference map</span>
    <span class="n">diff_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">avg_responders</span> <span class="o">-</span> <span class="n">avg_non_responders</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">diff_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;difference_map.nii.gz&#39;</span><span class="p">)</span>
    <span class="c1"># Save NIfTI file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">diff_file</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">diff_map</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">diff_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: difference_map.nii.gz&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean difference in brain: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_map</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max absolute difference: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff_map</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]))</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 7. ATLAS OVERLAP ANALYSIS</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[7/8] PERFORMING ATLAS OVERLAP ANALYSIS&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Performing atlas overlap analysis...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Only run atlas analysis if atlas files are configured</span>
    <span class="n">atlas_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atlas_files&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;atlas_files&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Get TI-Toolbox resources directory for atlases</span>
        <span class="n">ti_toolbox_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">atlas_dir</span> <span class="o">=</span> <span class="n">ti_toolbox_root</span> <span class="o">/</span> <span class="s1">&#39;resources&#39;</span> <span class="o">/</span> <span class="s1">&#39;atlas&#39;</span>

        <span class="k">if</span> <span class="n">atlas_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">atlas_results</span> <span class="o">=</span> <span class="n">atlas_overlap_analysis</span><span class="p">(</span>
                <span class="n">sig_mask</span><span class="p">,</span>
                <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;atlas_files&#39;</span><span class="p">],</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">atlas_dir</span><span class="p">),</span>
                <span class="n">reference_img</span><span class="o">=</span><span class="n">template_img</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Atlas directory not found, skipping atlas analysis&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No atlas files configured, skipping atlas analysis&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">atlas_name</span><span class="p">,</span> <span class="n">regions</span> <span class="ow">in</span> <span class="n">atlas_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">regions</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atlas_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> regions with overlap&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 8. SAVE OUTPUTS</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[8/8] SAVING RESULTS&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Saving final results...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Binary mask</span>
    <span class="n">output_mask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;significant_voxels_mask.nii.gz&#39;</span><span class="p">)</span>
    <span class="c1"># Save NIfTI file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_mask</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">sig_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">output_mask</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: significant_voxels_mask.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># P-values map (as -log10 for visualization)</span>
    <span class="n">log_p</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">p_values</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
    <span class="n">log_p</span><span class="p">[</span><span class="o">~</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output_pvalues</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;pvalues_map.nii.gz&#39;</span><span class="p">)</span>
    <span class="c1"># Save NIfTI file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_pvalues</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">log_p</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">output_pvalues</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: pvalues_map.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># Summary report</span>
    <span class="n">output_summary</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;analysis_summary.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Prepare parameters dictionary for summary</span>
    <span class="n">summary_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">],</span>
        <span class="s1">&#39;cluster_stat&#39;</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">],</span>
        <span class="s1">&#39;n_permutations&#39;</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">],</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
        <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="n">generate_summary</span><span class="p">(</span>
        <span class="n">responders</span><span class="p">,</span>
        <span class="n">non_responders</span><span class="p">,</span>
        <span class="n">sig_mask</span><span class="p">,</span>
        <span class="n">cluster_threshold</span><span class="p">,</span>
        <span class="n">clusters</span><span class="p">,</span>
        <span class="n">atlas_results</span><span class="p">,</span>
        <span class="n">output_summary</span><span class="p">,</span>
        <span class="n">correction_method</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">summary_params</span><span class="p">,</span>
        <span class="n">group1_name</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group1_name&#39;</span><span class="p">],</span>
        <span class="n">group2_name</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group2_name&#39;</span><span class="p">],</span>
        <span class="n">value_metric</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;value_metric&#39;</span><span class="p">],</span>
        <span class="n">test_type</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;test_type&#39;</span><span class="p">],</span>
        <span class="n">observed_cluster_sizes</span><span class="o">=</span><span class="n">observed_cluster_sizes</span> <span class="k">if</span> <span class="n">n_observed_clusters</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: analysis_summary.txt&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># COMPLETE</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">analysis_start_time</span>
    <span class="n">hours</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">total_time</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ANALYSIS COMPLETE!&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total analysis time: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span><span class="si">}</span><span class="s2">h </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span><span class="si">}</span><span class="s2">m </span><span class="si">{</span><span class="n">seconds</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OUTPUT FILES:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  1. Binary mask: </span><span class="si">{</span><span class="n">output_mask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  2. P-values map (-log10): </span><span class="si">{</span><span class="n">output_pvalues</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  3. Summary report: </span><span class="si">{</span><span class="n">output_summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  4. Average </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group1_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">avg_resp_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  5. Average </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;group2_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">avg_non_resp_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  6. Difference map: </span><span class="si">{</span><span class="n">diff_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  7. Permutation null distribution plot: </span><span class="si">{</span><span class="n">perm_plot_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  8. Cluster size-mass correlation plot: </span><span class="si">{</span><span class="n">correlation_plot_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  9. Permutation details log: </span><span class="si">{</span><span class="n">permutation_log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  10. Log file: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Analysis complete!&quot;</span><span class="p">)</span>

    <span class="c1"># Clean up large arrays to free memory</span>
    <span class="k">del</span> <span class="n">responders</span>
    <span class="k">del</span> <span class="n">non_responders</span>
    <span class="k">del</span> <span class="n">p_values</span>
    <span class="k">del</span> <span class="n">t_statistics</span>
    <span class="k">del</span> <span class="n">avg_responders</span>
    <span class="k">del</span> <span class="n">avg_non_responders</span>
    <span class="k">del</span> <span class="n">diff_map</span>
    <span class="k">del</span> <span class="n">null_distribution</span>
    <span class="k">del</span> <span class="n">correlation_data</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Close log handlers</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="c1"># Return results</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;output_dir&#39;</span><span class="p">:</span> <span class="n">output_dir</span><span class="p">,</span>
        <span class="s1">&#39;sig_mask&#39;</span><span class="p">:</span> <span class="n">sig_mask</span><span class="p">,</span>
        <span class="s1">&#39;clusters&#39;</span><span class="p">:</span> <span class="n">clusters</span><span class="p">,</span>
        <span class="s1">&#39;log_file&#39;</span><span class="p">:</span> <span class="n">log_file</span><span class="p">,</span>
        <span class="s1">&#39;n_responders&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp_ids</span><span class="p">),</span>
        <span class="s1">&#39;n_non_responders&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_resp_ids</span><span class="p">),</span>
        <span class="s1">&#39;n_significant_voxels&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">),</span>
        <span class="s1">&#39;n_significant_clusters&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_clusters</span><span class="p">),</span>
        <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="n">cluster_threshold</span><span class="p">,</span>
        <span class="s1">&#39;analysis_time&#39;</span><span class="p">:</span> <span class="n">total_time</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_run_correlation_analysis</span><span class="p">(</span><span class="n">subject_configs</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">,</span>
                              <span class="n">analysis_start_time</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">stop_callback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run correlation analysis workflow&quot;&quot;&quot;</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 1. LOAD DATA</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[1/7] LOADING SUBJECT DATA&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Loading subject data...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">subject_data</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">template_img</span><span class="p">,</span> <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">load_subject_data</span><span class="p">(</span>
        <span class="n">subject_configs</span><span class="p">,</span>
        <span class="n">nifti_file_pattern</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">],</span>
        <span class="n">analysis_type</span><span class="o">=</span><span class="s1">&#39;correlation&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Handle weights based on config</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;use_weights&#39;</span><span class="p">]:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">n_subjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">n_subjects</span><span class="si">}</span><span class="s2"> subjects&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject IDs: </span><span class="si">{</span><span class="n">subject_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect sizes: </span><span class="si">{</span><span class="n">effect_sizes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weights: </span><span class="si">{</span><span class="n">weights</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image shape: </span><span class="si">{</span><span class="n">subject_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Data diagnostics</span>
    <span class="n">data_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">subject_data</span><span class="p">[</span><span class="n">subject_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">subject_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">data_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subject_data</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DATA DIAGNOSTICS:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  E-field mean (non-zero): </span><span class="si">{</span><span class="n">data_mean</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  E-field max: </span><span class="si">{</span><span class="n">data_max</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Effect size mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Effect size std: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stop_callback</span> <span class="ow">and</span> <span class="n">stop_callback</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span><span class="p">(</span><span class="s2">&quot;Analysis stopped by user&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 2. VOXELWISE CORRELATION</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[2/7] COMPUTING VOXELWISE CORRELATIONS&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Computing voxelwise correlations...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">r_values</span><span class="p">,</span> <span class="n">t_statistics</span><span class="p">,</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">correlation_voxelwise</span><span class="p">(</span>
        <span class="n">subject_data</span><span class="p">,</span>
        <span class="n">effect_sizes</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">correlation_type</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;correlation_type&#39;</span><span class="p">],</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">n_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computed correlations for </span><span class="si">{</span><span class="n">n_valid</span><span class="si">}</span><span class="s2"> valid voxels&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation range: [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean |r|: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]))</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max positive r: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max negative r: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Count significant voxels at different thresholds</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Uncorrected significant voxels:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  p &lt; 0.01: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_values</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.01</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">valid_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  p &lt; 0.05: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_values</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">valid_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  p &lt; 0.10: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_values</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.10</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">valid_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># Log observed clusters before permutation correction (vectorized for speed)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">label</span> <span class="k">as</span> <span class="n">scipy_label</span><span class="p">,</span> <span class="nb">sum</span> <span class="k">as</span> <span class="n">ndimage_sum</span>
    <span class="n">observed_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_values</span> <span class="o">&lt;</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">valid_mask</span>
    <span class="n">observed_labeled</span><span class="p">,</span> <span class="n">n_observed_clusters</span> <span class="o">=</span> <span class="n">scipy_label</span><span class="p">(</span><span class="n">observed_mask</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Observed clusters at p &lt; </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (before permutation correction):&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total clusters found: </span><span class="si">{</span><span class="n">n_observed_clusters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_observed_clusters</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Vectorized cluster size computation using bincount</span>
        <span class="n">cluster_labels_flat</span> <span class="o">=</span> <span class="n">observed_labeled</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">observed_cluster_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">cluster_labels_flat</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_observed_clusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Vectorized cluster mass computation using ndimage.sum</span>
        <span class="n">cluster_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_observed_clusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">observed_cluster_masses</span> <span class="o">=</span> <span class="n">ndimage_sum</span><span class="p">(</span><span class="n">t_statistics</span><span class="p">,</span> <span class="n">observed_labeled</span><span class="p">,</span> <span class="n">cluster_indices</span><span class="p">)</span>
        <span class="n">observed_cluster_masses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">observed_cluster_masses</span><span class="p">)</span>

        <span class="c1"># Sort by cluster statistic</span>
        <span class="k">if</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
            <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">observed_cluster_sizes</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">observed_cluster_masses</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">observed_cluster_sizes_sorted</span> <span class="o">=</span> <span class="n">observed_cluster_sizes</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
        <span class="n">observed_cluster_masses_sorted</span> <span class="o">=</span> <span class="n">observed_cluster_masses</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 largest observed clusters (before permutation correction):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed_cluster_sizes_sorted</span><span class="p">))):</span>
            <span class="k">if</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">observed_cluster_sizes_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">6d</span><span class="si">}</span><span class="s2"> voxels, mass=</span><span class="si">{</span><span class="n">observed_cluster_masses_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cluster </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">: mass=</span><span class="si">{</span><span class="n">observed_cluster_masses_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">observed_cluster_sizes_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">6d</span><span class="si">}</span><span class="s2"> voxels&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Largest observed cluster: </span><span class="si">{</span><span class="n">observed_cluster_sizes_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> voxels&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Largest observed cluster mass: </span><span class="si">{</span><span class="n">observed_cluster_masses_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total voxels in all clusters: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">observed_cluster_sizes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stop_callback</span> <span class="ow">and</span> <span class="n">stop_callback</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span><span class="p">(</span><span class="s2">&quot;Analysis stopped by user&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 3. CLUSTER-BASED PERMUTATION CORRECTION</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[3/7] APPLYING CLUSTER-BASED PERMUTATION CORRECTION&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running permutation testing (</span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> permutations)...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">permutation_log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;permutation_details.txt&#39;</span><span class="p">)</span>

    <span class="n">sig_mask</span><span class="p">,</span> <span class="n">cluster_threshold</span><span class="p">,</span> <span class="n">sig_clusters</span><span class="p">,</span> <span class="n">null_distribution</span><span class="p">,</span> <span class="n">all_clusters</span><span class="p">,</span> <span class="n">correlation_data</span> <span class="o">=</span> \
        <span class="n">correlation_cluster_correction</span><span class="p">(</span>
            <span class="n">subject_data</span><span class="p">,</span>
            <span class="n">effect_sizes</span><span class="p">,</span>
            <span class="n">r_values</span><span class="p">,</span>
            <span class="n">t_statistics</span><span class="p">,</span>
            <span class="n">p_values</span><span class="p">,</span>
            <span class="n">valid_mask</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
            <span class="n">correlation_type</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;correlation_type&#39;</span><span class="p">],</span>
            <span class="n">cluster_threshold</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">],</span>
            <span class="n">n_permutations</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
            <span class="n">cluster_stat</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">],</span>
            <span class="n">alternative</span><span class="o">=</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alternative&#39;</span><span class="p">,</span> <span class="s1">&#39;two-sided&#39;</span><span class="p">),</span>  <span class="c1"># Default to two-sided if not specified</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">],</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">save_permutation_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">permutation_log_file</span><span class="o">=</span><span class="n">permutation_log_file</span><span class="p">,</span>
            <span class="n">subject_ids</span><span class="o">=</span><span class="n">subject_ids</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster size threshold: </span><span class="si">{</span><span class="n">cluster_threshold</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> voxels&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster mass threshold: </span><span class="si">{</span><span class="n">cluster_threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant clusters found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_clusters</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total significant voxels: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 4. CLUSTER ANALYSIS</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[4/7] ANALYZING SIGNIFICANT CLUSTERS&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_clusters</span><span class="p">)</span><span class="si">}</span><span class="s2"> significant clusters...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="n">cluster_analysis</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>

    <span class="c1"># Add correlation info to clusters</span>
    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="n">cluster_mask</span> <span class="o">=</span> <span class="n">sig_mask</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># Binary mask</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">label</span> <span class="k">as</span> <span class="n">scipy_label</span>
        <span class="n">labeled</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">scipy_label</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
            <span class="n">c_mask</span> <span class="o">=</span> <span class="n">labeled</span> <span class="o">==</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">]</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;mean_r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">c_mask</span><span class="p">])</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;peak_r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">c_mask</span><span class="p">])</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;mean_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_statistics</span><span class="p">[</span><span class="n">c_mask</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Largest cluster: </span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> voxels&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean r: </span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean_r&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Peak r: </span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;peak_r&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MNI center: (</span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;center_mni&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 5. GENERATE PLOTS</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[5/7] GENERATING VISUALIZATION PLOTS&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Generating visualization plots...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Permutation null distribution</span>
    <span class="n">perm_plot_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;permutation_null_distribution.pdf&#39;</span><span class="p">)</span>
    <span class="n">plot_permutation_null_distribution</span><span class="p">(</span>
        <span class="n">null_distribution</span><span class="p">,</span>
        <span class="n">cluster_threshold</span><span class="p">,</span>
        <span class="n">all_clusters</span><span class="p">,</span>
        <span class="n">perm_plot_file</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
        <span class="n">cluster_stat</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Cluster size vs mass correlation</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">correlation_data</span><span class="p">[</span><span class="s1">&#39;sizes&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">correlation_plot_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;cluster_size_mass_correlation.pdf&#39;</span><span class="p">)</span>
        <span class="n">plot_cluster_size_mass_correlation</span><span class="p">(</span>
            <span class="n">correlation_data</span><span class="p">[</span><span class="s1">&#39;sizes&#39;</span><span class="p">],</span>
            <span class="n">correlation_data</span><span class="p">[</span><span class="s1">&#39;masses&#39;</span><span class="p">],</span>
            <span class="n">correlation_plot_file</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 6. ATLAS OVERLAP ANALYSIS</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[6/7] PERFORMING ATLAS OVERLAP ANALYSIS&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Performing atlas overlap analysis...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">atlas_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atlas_files&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;atlas_files&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ti_toolbox_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">atlas_dir</span> <span class="o">=</span> <span class="n">ti_toolbox_root</span> <span class="o">/</span> <span class="s1">&#39;resources&#39;</span> <span class="o">/</span> <span class="s1">&#39;atlas&#39;</span>

        <span class="k">if</span> <span class="n">atlas_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">atlas_results</span> <span class="o">=</span> <span class="n">atlas_overlap_analysis</span><span class="p">(</span>
                <span class="n">sig_mask</span><span class="p">,</span>
                <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;atlas_files&#39;</span><span class="p">],</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">atlas_dir</span><span class="p">),</span>
                <span class="n">reference_img</span><span class="o">=</span><span class="n">template_img</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Atlas directory not found, skipping atlas analysis&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No atlas files configured, skipping atlas analysis&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">atlas_name</span><span class="p">,</span> <span class="n">regions</span> <span class="ow">in</span> <span class="n">atlas_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">regions</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atlas_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> regions with overlap&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># 7. SAVE OUTPUTS</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[7/7] SAVING RESULTS&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Saving final results...&quot;</span><span class="p">)</span>
    <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Significant voxels mask</span>
    <span class="n">output_mask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;significant_voxels_mask.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">sig_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">output_mask</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: significant_voxels_mask.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># Correlation map</span>
    <span class="n">output_r</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;correlation_map.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">r_values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">output_r</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: correlation_map.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># T-statistics map</span>
    <span class="n">output_t</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;t_statistics_map.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">t_statistics</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">output_t</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: t_statistics_map.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># P-values map (as -log10 for visualization)</span>
    <span class="n">log_p</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">p_values</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
    <span class="n">log_p</span><span class="p">[</span><span class="o">~</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output_pvalues</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;pvalues_map.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">log_p</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">output_pvalues</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: pvalues_map.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># Thresholded correlation map (only significant voxels)</span>
    <span class="n">r_thresholded</span> <span class="o">=</span> <span class="n">r_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">r_thresholded</span><span class="p">[</span><span class="n">sig_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output_r_thresh</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;correlation_map_thresholded.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">r_thresholded</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">output_r_thresh</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: correlation_map_thresholded.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># Average E-field map</span>
    <span class="n">avg_efield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">subject_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">avg_efield_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;average_efield.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">avg_efield</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">avg_efield_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: average_efield.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># Summary report</span>
    <span class="n">output_summary</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;analysis_summary.txt&#39;</span><span class="p">)</span>
    <span class="n">summary_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;correlation_type&#39;</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;correlation_type&#39;</span><span class="p">],</span>
        <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_threshold&#39;</span><span class="p">],</span>
        <span class="s1">&#39;cluster_stat&#39;</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;cluster_stat&#39;</span><span class="p">],</span>
        <span class="s1">&#39;n_permutations&#39;</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;n_permutations&#39;</span><span class="p">],</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
        <span class="s1">&#39;use_weights&#39;</span><span class="p">:</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">}</span>

    <span class="n">generate_correlation_summary</span><span class="p">(</span>
        <span class="n">subject_data</span><span class="p">,</span>
        <span class="n">effect_sizes</span><span class="p">,</span>
        <span class="n">r_values</span><span class="p">,</span>
        <span class="n">sig_mask</span><span class="p">,</span>
        <span class="n">cluster_threshold</span><span class="p">,</span>
        <span class="n">clusters</span><span class="p">,</span>
        <span class="n">atlas_results</span><span class="p">,</span>
        <span class="n">output_summary</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">summary_params</span><span class="p">,</span>
        <span class="n">effect_metric</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;effect_metric&#39;</span><span class="p">],</span>
        <span class="n">subject_ids</span><span class="o">=</span><span class="n">subject_ids</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: analysis_summary.txt&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">step_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># COMPLETE</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">analysis_start_time</span>
    <span class="n">hours</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">total_time</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ANALYSIS COMPLETE!&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total analysis time: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span><span class="si">}</span><span class="s2">h </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span><span class="si">}</span><span class="s2">m </span><span class="si">{</span><span class="n">seconds</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OUTPUT FILES:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  1. Significant voxels mask: </span><span class="si">{</span><span class="n">output_mask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  2. Correlation map (r values): </span><span class="si">{</span><span class="n">output_r</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  3. Thresholded correlation map: </span><span class="si">{</span><span class="n">output_r_thresh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  4. T-statistics map: </span><span class="si">{</span><span class="n">output_t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  5. P-values map (-log10): </span><span class="si">{</span><span class="n">output_pvalues</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  6. Average E-field: </span><span class="si">{</span><span class="n">avg_efield_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  7. Analysis summary: </span><span class="si">{</span><span class="n">output_summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  8. Permutation plot: </span><span class="si">{</span><span class="n">perm_plot_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  9. Log file: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;INTERPRETATION:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - Positive correlations indicate regions where higher E-field&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    magnitude is associated with higher </span><span class="si">{</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;effect_metric&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - To find negative correlations, invert your effect size values&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    and re-run the analysis&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">log_callback</span><span class="p">(</span><span class="s2">&quot;Analysis complete!&quot;</span><span class="p">)</span>

    <span class="c1"># Clean up large arrays to free memory (keep returned variables)</span>
    <span class="k">del</span> <span class="n">subject_data</span>
    <span class="k">del</span> <span class="n">effect_sizes</span>
    <span class="k">del</span> <span class="n">weights</span>
    <span class="k">del</span> <span class="n">t_statistics</span>
    <span class="k">del</span> <span class="n">p_values</span>
    <span class="k">del</span> <span class="n">valid_mask</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;output_dir&#39;</span><span class="p">:</span> <span class="n">output_dir</span><span class="p">,</span>
        <span class="s1">&#39;sig_mask&#39;</span><span class="p">:</span> <span class="n">sig_mask</span><span class="p">,</span>
        <span class="s1">&#39;r_values&#39;</span><span class="p">:</span> <span class="n">r_values</span><span class="p">,</span>
        <span class="s1">&#39;clusters&#39;</span><span class="p">:</span> <span class="n">clusters</span><span class="p">,</span>
        <span class="s1">&#39;log_file&#39;</span><span class="p">:</span> <span class="n">log_file</span><span class="p">,</span>
        <span class="s1">&#39;n_subjects&#39;</span><span class="p">:</span> <span class="n">n_subjects</span><span class="p">,</span>
        <span class="s1">&#39;n_significant_voxels&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_mask</span><span class="p">),</span>
        <span class="s1">&#39;n_significant_clusters&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_clusters</span><span class="p">),</span>
        <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="n">cluster_threshold</span><span class="p">,</span>
        <span class="s1">&#39;analysis_time&#39;</span><span class="p">:</span> <span class="n">total_time</span>
    <span class="p">}</span>


<span class="c1"># Placeholder for the rest of the implementation</span>
<span class="c1"># The full implementation would continue with the remaining steps for both analysis types</span>

<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../stats/index.html#tit.stats.permutation_analysis.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command-line interface for unified permutation analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>

    <span class="c1"># Ensure proper multiprocessing initialization</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">multiprocessing</span><span class="p">,</span> <span class="s1">&#39;set_start_method&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">multiprocessing</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="s1">&#39;fork&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Unified Cluster-Based Permutation Testing for TI-Toolbox&#39;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Examples:</span>
<span class="s2">  # Group comparison analysis</span>
<span class="s2">  python permutation_analysis.py --csv subjects.csv --name my_analysis </span><span class="se">\\</span>
<span class="s2">      --analysis-type group_comparison</span>

<span class="s2">  # Correlation analysis</span>
<span class="s2">  python permutation_analysis.py --csv subjects.csv --name my_analysis </span><span class="se">\\</span>
<span class="s2">      --analysis-type correlation</span>

<span class="s2">Group Comparison CSV Format:</span>
<span class="s2">  subject_id,simulation_name,response</span>
<span class="s2">  070,ICP_RHIPPO,1</span>
<span class="s2">  071,ICP_RHIPPO,0</span>

<span class="s2">Correlation CSV Format:</span>
<span class="s2">  subject_id,simulation_name,effect_size,weight</span>
<span class="s2">  070,ICP_RHIPPO,0.45,25</span>
<span class="s2">  071,ICP_RHIPPO,0.32,30</span>

<span class="s2">Tissue Types:</span>
<span class="s2">  --tissue-type controls which NIfTI files are loaded:</span>
<span class="s2">    grey  : grey_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz</span>
<span class="s2">    white : white_</span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz</span>
<span class="s2">    all   : </span><span class="si">{simulation_name}</span><span class="s2">_TI_MNI_MNI_TI_max.nii.gz (no prefix)</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Required arguments</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--csv&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to CSV file with subject configurations&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Analysis name (used for output directory)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--analysis-type&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group_comparison&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of analysis to perform&#39;</span><span class="p">)</span>

    <span class="c1"># Statistical parameters (common)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cluster-threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;P-value threshold for cluster formation (default: 0.05)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cluster-stat&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cluster statistic: mass (sum of t-values) or size (voxel count) (default: mass)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n-permutations&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of permutations (default: 1000)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cluster-level significance threshold (default: 0.05)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n-jobs&#39;</span><span class="p">,</span> <span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of parallel jobs: -1=all cores, 1=sequential (default: -1)&#39;</span><span class="p">)</span>

    <span class="c1"># Group comparison specific parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--test-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span> <span class="s1">&#39;paired&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;unpaired&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Statistical test type for group comparison (default: unpaired)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--alternative&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span> <span class="s1">&#39;greater&#39;</span><span class="p">,</span> <span class="s1">&#39;less&#39;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Alternative hypothesis for group comparison (default: two-sided)&#39;</span><span class="p">)</span>

    <span class="c1"># Correlation specific parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--correlation-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;spearman&#39;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of correlation for correlation analysis (default: pearson)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--use-weights&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use weights from CSV if available (correlation analysis)&#39;</span><span class="p">)</span>

    <span class="c1"># Optional parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tissue-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Tissue type for NIfTI files: grey (grey matter), &#39;</span>
                             <span class="s1">&#39;white (white matter), or all (all tissues, no prefix). &#39;</span>
                             <span class="s1">&#39;(default: grey)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--nifti-pattern&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Custom NIfTI filename pattern (overrides --tissue-type)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--quiet&#39;</span><span class="p">,</span> <span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Suppress progress output&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Build configuration</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;analysis_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span><span class="p">,</span>
        <span class="s1">&#39;cluster_threshold&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">cluster_threshold</span><span class="p">,</span>
        <span class="s1">&#39;cluster_stat&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">cluster_stat</span><span class="p">,</span>
        <span class="s1">&#39;n_permutations&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">n_permutations</span><span class="p">,</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
        <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
        <span class="s1">&#39;tissue_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tissue_type</span><span class="p">,</span>
        <span class="s1">&#39;nifti_file_pattern&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">nifti_pattern</span><span class="p">,</span>  <span class="c1"># None triggers auto-generation</span>
    <span class="p">}</span>

    <span class="c1"># Add analysis-specific parameters</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;group_comparison&#39;</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;test_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">test_type</span><span class="p">,</span>
            <span class="s1">&#39;alternative&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">alternative</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># correlation</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;correlation_type&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">correlation_type</span><span class="p">,</span>
            <span class="s1">&#39;use_weights&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">use_weights</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="c1"># Print header</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UNIFIED CLUSTER-BASED PERMUTATION TESTING - TI-TOOLBOX&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis type: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV file: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis name: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tissue type: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">tissue_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permutations: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">n_permutations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parallel jobs: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">n_jobs</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">args</span><span class="o">.</span><span class="n">n_jobs</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;all cores&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster statistic: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">cluster_stat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster threshold: p &lt; </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">cluster_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Run analysis</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">run_analysis</span><span class="p">(</span>
            <span class="n">subject_configs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">csv</span><span class="p">,</span>
            <span class="n">analysis_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">output_callback</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span> <span class="k">else</span> <span class="nb">print</span>
        <span class="p">)</span>

        <span class="c1"># Print summary</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ANALYSIS COMPLETE!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;n_significant_clusters&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant clusters: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;n_significant_clusters&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;n_significant_voxels&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant voxels: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;n_significant_voxels&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis time: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;analysis_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERROR: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Ido Haber.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>