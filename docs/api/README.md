# TI-Toolbox API Documentation

Sphinx-based API reference for the TI-Toolbox Python interface, with **automated builds** integrated into your GitHub workflow.

---

## üöÄ Quick Start

### View Live Documentation

**Production**: https://idossha.github.io/TI-Toolbox/api/_build/html/index.html

**Access from Wiki**:
- Main wiki page ‚Üí "Development & Testing" ‚Üí "API Reference"
- Any wiki page ‚Üí Left sidebar ‚Üí "API Reference ‚Üó"

### Local Build

```bash
# One-time setup
pip install -r requirements.txt

# Build documentation
make html

# View
open _build/html/index.html  # macOS
# or: xdg-open _build/html/index.html  # Linux
```

---

## ‚öôÔ∏è How Auto-Build Works

### Automatic Deployment

Documentation **automatically rebuilds and deploys** when you push changes to:
- Python source files (`tit/**/*.py`)
- Sphinx configuration (`docs/api/**`)
- Wiki pages (`docs/wiki/**`)

### The Workflow

```
Edit docstrings ‚Üí git push ‚Üí GitHub Actions ‚Üí Build Sphinx ‚Üí Deploy to Pages ‚Üí Live in ~2 min
```

**GitHub Actions**: `.github/workflows/build-docs.yml`

**Features**:
- ‚úÖ Builds on every push to main
- ‚úÖ Checks for documentation warnings
- ‚úÖ Auto-deploys to GitHub Pages
- ‚úÖ Comments on PRs with docs link
- ‚úÖ Uploads build artifacts (30-day retention)

### Manual Trigger

```bash
# From project root
cd docs
./build-docs.sh
```

Or via GitHub Actions UI: https://github.com/idossha/TI-Toolbox/actions

---

## üìÅ Structure

```
docs/api/
‚îú‚îÄ‚îÄ _build/html/          # Generated HTML (auto-built, git-ignored)
‚îú‚îÄ‚îÄ conf.py               # Sphinx configuration
‚îú‚îÄ‚îÄ index.rst             # Main API page
‚îú‚îÄ‚îÄ requirements.txt      # Sphinx dependencies
‚îú‚îÄ‚îÄ Makefile              # Build automation
‚îú‚îÄ‚îÄ core/index.rst        # Core modules (paths, constants, nifti, mesh, calc, etc.)
‚îú‚îÄ‚îÄ sim/index.rst         # Simulation modules (simulator, config, session_builder, etc.)
‚îú‚îÄ‚îÄ analyzer/index.rst    # Analysis modules (mesh_analyzer, voxel_analyzer, etc.)
‚îú‚îÄ‚îÄ opt/index.rst         # Optimization modules (leadfield, flex-search, ex-search)
‚îî‚îÄ‚îÄ stats/index.rst       # Statistics modules (permutation_analysis, etc.)
```

---

## üìù Docstring Style Guide

All docstrings use **NumPy style** (as specified in CLAUDE.md):

### Function Example

```python
def analyze_sphere(center_coordinates, radius, visualize=False):
    """
    Analyze a spherical region of interest from a mesh.

    Parameters
    ----------
    center_coordinates : list of float
        List of [x, y, z] coordinates for the sphere center
    radius : float
        Radius of the sphere in mm
    visualize : bool, optional
        Whether to generate visualization files (default: False)

    Returns
    -------
    dict
        Analysis results with keys:
        - 'mean_value' : float - Mean field value in ROI
        - 'max_value' : float - Maximum field value
        - 'focality' : float - Focality metric

    Raises
    ------
    ValueError
        If coordinates are invalid
    FileNotFoundError
        If mesh file is missing

    Examples
    --------
    >>> analyzer = MeshAnalyzer(...)
    >>> results = analyzer.analyze_sphere([0, 0, 0], radius=10)
    >>> print(results['mean_value'])
    0.42

    See Also
    --------
    analyze_cortex : Analyze cortical regions by atlas
    """
```

### Class Example

```python
class MeshAnalyzer:
    """
    Analyzer for mesh-based field data.

    This class provides methods for analyzing electromagnetic field
    distributions in brain tissue using 3D tetrahedral meshes.

    Parameters
    ----------
    field_mesh_path : str
        Path to the mesh file containing field data
    field_name : str
        Name of the field to analyze (e.g., 'TI_max', 'normE')
    subject_dir : str
        Path to subject's m2m directory
    output_dir : str
        Directory for saving analysis results

    Attributes
    ----------
    mesh : simnibs.msh.mesh_io.Msh
        Loaded mesh object
    field_data : numpy.ndarray
        Extracted field values

    Examples
    --------
    >>> analyzer = MeshAnalyzer(
    ...     field_mesh_path='sub-001_TI.msh',
    ...     field_name='TI_max',
    ...     subject_dir='/path/to/m2m_001',
    ...     output_dir='/path/to/output'
    ... )
    >>> results = analyzer.analyze_sphere([0, 0, 0], radius=10)
    """
```

### Module Example

```python
"""
Mesh analysis utilities for TI field data.

This module provides tools for analyzing electromagnetic field distributions
on 3D tetrahedral meshes generated by SimNIBS.

Key Classes
-----------
MeshAnalyzer : Main analyzer class for mesh-based ROI analysis

Key Functions
-------------
extract_field_values : Extract field values from mesh
calculate_focality : Compute focality metrics

Examples
--------
>>> from tit.analyzer import mesh_analyzer
>>> analyzer = mesh_analyzer.MeshAnalyzer(...)
>>> results = analyzer.analyze_sphere([0, 0, 0], radius=10)
"""
```

---

## üîß Configuration

### Sphinx Settings (`conf.py`)

**Extensions Enabled**:
- `sphinx.ext.autodoc` - Auto-generate docs from docstrings
- `sphinx.ext.napoleon` - NumPy/Google docstring support
- `sphinx.ext.viewcode` - Source code links
- `sphinx.ext.intersphinx` - Links to external docs (numpy, scipy, matplotlib)
- `sphinx.ext.autosummary` - Generate summary tables
- `sphinx.ext.coverage` - Documentation coverage checking

**Mocked Imports** (for build environment):
- `simnibs` - SimNIBS package
- `PyQt5` - GUI framework
- `vtk` - 3D visualization

**Theme**: ReadTheDocs (`sphinx_rtd_theme`)

### Adding New Modules

1. Create RST file in appropriate subdirectory:
   ```rst
   # docs/api/newmodule/index.rst
   New Module (``tit.newmodule``)
   ===============================

   .. automodule:: tit.newmodule
      :members:
      :undoc-members:
      :show-inheritance:
   ```

2. Add to main index (`index.rst`):
   ```rst
   .. toctree::
      :maxdepth: 2

      newmodule/index
   ```

3. Rebuild: `make clean html`

---

## üîÑ Update Workflow

### When You Update Code

1. **Edit docstrings** in `tit/` modules
2. **Commit and push** to GitHub
3. **GitHub Actions automatically**:
   - Builds Sphinx documentation
   - Deploys to GitHub Pages
   - Updates live site

**No manual steps required!**

### When You Update Sphinx Config

1. Edit `docs/api/conf.py` or RST files
2. Test locally: `make clean html`
3. Commit and push
4. GitHub Actions rebuilds automatically

### Check Build Status

https://github.com/idossha/TI-Toolbox/actions

---

## üé® Customization

### Change Theme

Edit `conf.py`:
```python
html_theme = 'sphinx_rtd_theme'  # Current
# html_theme = 'alabaster'       # Alternative
# html_theme = 'pydata_sphinx_theme'  # Alternative
```

### Theme Options

```python
html_theme_options = {
    'navigation_depth': 4,         # Sidebar depth
    'collapse_navigation': False,  # Keep sidebar expanded
    'sticky_navigation': True,     # Sticky sidebar
    'includehidden': True,         # Show hidden toctrees
}
```

### Add Custom CSS

1. Create `_static/custom.css`
2. In `conf.py`:
   ```python
   html_static_path = ['_static']
   html_css_files = ['custom.css']
   ```

---

## üêõ Troubleshooting

### Build Warnings

**Check warnings file**:
```bash
cat _build/warnings.txt
```

**Common issues**:
- Missing docstrings ‚Üí Add NumPy-style docstrings
- Malformed docstrings ‚Üí Check indentation (4 spaces)
- Unknown cross-reference ‚Üí Check module/class/function names

### Import Errors

If you get `ImportError` for a package during build:

Add to `conf.py`:
```python
autodoc_mock_imports = ['simnibs', 'PyQt5', 'vtk', 'your_package']
```

### Module Not Found

If a module doesn't appear in the docs:
1. Verify it's imported in `__init__.py`
2. Check RST file includes the module
3. Rebuild with `make clean html`

### Docstrings Not Rendering

**Check**:
- Docstring format (NumPy or Google style)
- Indentation (must be consistent, 4 spaces)
- Parameters section has correct format
- No syntax errors in docstring

**Debug**:
```bash
# Verbose build
make clean
sphinx-build -v -b html . _build/html
```

### GitHub Actions Failures

**View logs**: https://github.com/idossha/TI-Toolbox/actions

**Common causes**:
- Python syntax error in source files
- Invalid RST syntax
- Missing dependencies
- Broken cross-references

**Fix and re-run**:
```bash
git commit --allow-empty -m "docs: retrigger build"
git push
```

---

## üìä Documentation Coverage

### Check Coverage

```bash
make coverage
```

Output: `_build/coverage/python.txt`

### Current Status

- **Overall**: ~60% (improved from 49%)
- **tit.stats**: 96.7% ‚úÖ
- **tit.gui**: 95.1% ‚úÖ
- **tit.sim**: ~45% (improved from 30%)
- **tit.core.paths**: ~75% (improved from 56%)
- **tit.analyzer**: 43.7% (needs improvement)

### Priority Areas for Improvement

1. **tit.analyzer.voxel_analyzer** - Model after mesh_analyzer.py
2. **tit.analyzer.group_analyzer** - Group-level analysis
3. **tit.core.mesh** - Mesh utility functions
4. **tit.core.calc** - Calculation functions

---

## üîó Integration with Jekyll

### Navigation Links

**Wiki main page** (`docs/wiki/wiki.md`):
```markdown
### Development & Testing
- **[API Reference](../api/_build/html/index.html)** - Complete Python API documentation
```

**Sidebar** (`docs/_layouts/wiki.html`):
```html
<li><a href="{{ site.baseurl }}/api/_build/html/index.html" target="_blank">API Reference ‚Üó</a></li>
```

### Jekyll Configuration

**Excluded from Jekyll build** (`docs/_config.yml`):
```yaml
exclude:
  - api/_build/
  - api/conf.py
  - api/Makefile
  - api/requirements.txt
  - build-docs.sh
```

**Git-ignored** (`docs/.gitignore`):
```
api/_build/
api/_static/
api/_templates/
```

---

## üìö External Resources

- **Sphinx Documentation**: https://www.sphinx-doc.org/
- **NumPy Docstring Guide**: https://numpydoc.readthedocs.io/
- **ReadTheDocs Theme**: https://sphinx-rtd-theme.readthedocs.io/
- **Intersphinx**: https://www.sphinx-doc.org/en/master/usage/extensions/intersphinx.html

---

## üéØ Quick Reference

### Build Commands

```bash
make html          # Build HTML documentation
make clean         # Remove build artifacts
make coverage      # Check documentation coverage
make linkcheck     # Check external links
make html SPHINXOPTS="-v"  # Verbose build
```

### File Locations

- **Live docs**: https://idossha.github.io/TI-Toolbox/api/_build/html/
- **Source**: `docs/api/*.rst`
- **Config**: `docs/api/conf.py`
- **Output**: `docs/api/_build/html/`
- **Build script**: `docs/build-docs.sh`
- **CI/CD**: `.github/workflows/build-docs.yml`

### Common Tasks

**Add docstring to function**:
```python
def my_function(param):
    """Brief description.

    Parameters
    ----------
    param : type
        Description
    """
```

**Rebuild after changes**:
```bash
cd docs/api
make clean html
```

**Deploy changes**:
```bash
git add .
git commit -m "docs: improve docstrings"
git push  # Auto-builds and deploys
```

---

## ‚ú® Summary

**What You Have**:
- ‚úÖ Professional API documentation (Sphinx)
- ‚úÖ Automated builds (GitHub Actions)
- ‚úÖ Seamless Jekyll integration
- ‚úÖ Auto-deployment to GitHub Pages
- ‚úÖ Zero maintenance required

**Workflow**:
```
Edit docstrings ‚Üí git push ‚Üí Auto-build ‚Üí Live in ~2 minutes
```

**Access**:
- Production: https://idossha.github.io/TI-Toolbox/api/_build/html/
- From wiki navigation (main page + sidebar)
- Direct link from anywhere

**For Help**: Open issue at https://github.com/idossha/TI-Toolbox/issues

---

**Last Updated**: 2026-01-12
**Maintainer**: Ido Haber (ihaber@wisc.edu)
