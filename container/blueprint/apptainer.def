Bootstrap: docker
From: ubuntu:22.04

%labels
    Author Ido Haber
    Version 2.2.4
    Description TI-Toolbox combined image (SimNIBS 4.5 + FreeSurfer 7.4.1) for HPC deployment
    URL https://github.com/idossha/TI-toolbox

%environment
    export DEBIAN_FRONTEND=noninteractive
    
    # FreeSurfer base paths (SetUpFreeSurfer.sh will set the rest)
    export FREESURFER_HOME=/usr/local/freesurfer
    export FS_LICENSE=/usr/local/freesurfer/license.txt
    export SUBJECTS_DIR=/usr/local/freesurfer/subjects
    
    # SimNIBS
    export SIMNIBSDIR=/opt/SimNIBS-4.5
    
    # Initial PATH (will be extended by SetUpFreeSurfer.sh)
    export PATH="/opt/SimNIBS-4.5/bin:$PATH"
    export PATH="/ti-toolbox/tit/cli:$PATH"
    
    # Runtime directories
    export XDG_RUNTIME_DIR=/tmp/runtime-$(id -u)
    export OMP_NUM_THREADS=${SLURM_CPUS_PER_TASK:-1}
    export KMP_AFFINITY=disabled
    
    # Ensure bash is default shell
    export SHELL=/bin/bash

%post
    export DEBIAN_FRONTEND=noninteractive

    # ================================================================
    # System packages (combined FreeSurfer + SimNIBS deps)
    # NOTE: kept on a single logical line to avoid shell parsing issues
    #       in Apptainer's /bin/sh during %post.
    # ================================================================
    apt-get update && apt-get install -y \
        wget \
        git \
        unzip \
        tar \
        bzip2 \
        curl \
        gettext \
        locales \
        fontconfig \
        tzdata \
        build-essential \
        gcc \
        g++ \
        gcc-10 \
        g++-10 \
        cmake \
        ninja-build \
        libtool \
        libtool-bin \
        autoconf \
        automake \
        pkg-config \
        libglib2.0-0 \
        libopenblas-dev \
        libgl1-mesa-glx \
        libglu1-mesa \
        mesa-utils \
        libgl1-mesa-dri \
        libglapi-mesa \
        libosmesa6 \
        mesa-va-drivers \
        libegl1-mesa \
        libgbm1 \
        libxt6 \
        libxext6 \
        libxrender1 \
        libxrandr2 \
        libxfixes3 \
        libxcursor1 \
        libxcomposite1 \
        libxdamage1 \
        libxi6 \
        libxmu6 \
        libxft2 \
        libice6 \
        libsm6 \
        libqt5widgets5 \
        libqt5gui5 \
        libqt5core5a \
        libqt5svg5 \
        libqt5opengl5 \
        libqt5network5 \
        libqt5xml5 \
        qtbase5-dev \
        qtbase5-dev-tools \
        qtchooser \
        qttools5-dev-tools \
        libgtk2.0-0 \
        bc \
        jq \
        vim \
        tmux \
        tree \
        execstack \
        parallel \
        dos2unix \
        bats \
        imagemagick \
        dcm2niix \
        tcsh \
        libgomp1 \
        libx11-6 \
        libjpeg62 \
        libtiff5 \
        perl-modules \
        ca-certificates \
        \
        && locale-gen en_US.UTF-8 \
        && apt-get clean && rm -rf /var/lib/apt/lists/* || true

    # ================================================================
    # Docker CLI (optional, for Docker-out-of-Docker workflows)
    # ================================================================
    install -m 0755 -d /etc/apt/keyrings \
        && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
        && chmod a+r /etc/apt/keyrings/docker.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu jammy stable" > /etc/apt/sources.list.d/docker.list \
        && apt-get update \
        && apt-get install -y docker-ce-cli \
        && apt-get clean && rm -rf /var/lib/apt/lists/* || true

    # ================================================================
    # FreeSurfer 7.4.1
    # ================================================================
    export FREESURFER_HOME=/usr/local/freesurfer
    mkdir -p $FREESURFER_HOME

    wget --progress=bar:force:noscroll \
        https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/7.4.1/freesurfer-linux-centos8_x86_64-7.4.1.tar.gz \
        -P /tmp \
        && tar -xzf /tmp/freesurfer-linux-centos8_x86_64-7.4.1.tar.gz -C /tmp \
        && mv /tmp/freesurfer/* $FREESURFER_HOME/ \
        && rm -rf /tmp/freesurfer /tmp/freesurfer-linux-centos8_x86_64-7.4.1.tar.gz

    # Fix permissions for SetUpFreeSurfer.sh
    chmod +x $FREESURFER_HOME/SetUpFreeSurfer.sh 2>/dev/null || true
    
    # Create subjects directory if not exists
    mkdir -p $FREESURFER_HOME/subjects
    
    # Create a placeholder license file (will be bind-mounted at runtime)
    touch $FREESURFER_HOME/license.txt

    # ================================================================
    # SimNIBS 4.5
    # ================================================================
    export OMP_NUM_THREADS=1
    export KMP_AFFINITY=disabled

    mkdir -p /simnibs && chmod -R 755 /simnibs
    wget https://github.com/simnibs/simnibs/releases/download/v4.5.0/simnibs_installer_linux.tar.gz -P /simnibs \
        && tar -xzf /simnibs/simnibs_installer_linux.tar.gz -C /simnibs \
        && /simnibs/simnibs_installer/install -s

    # Move SimNIBS to /opt for multi-user access and symlink back
    mv /root/SimNIBS-4.5 /opt/SimNIBS-4.5
    ln -s /opt/SimNIBS-4.5 /root/SimNIBS-4.5

    export PATH="/opt/SimNIBS-4.5/bin:$PATH"
    export SIMNIBSDIR=/opt/SimNIBS-4.5

    # Clean up installer
    rm -rf /simnibs

    # Additional Python packages
    simnibs_python -m pip install --no-cache-dir \
        meshio nilearn PyOpenGL-accelerate trimesh seaborn \
        scikit-image numpy-stl click bpy

    # ================================================================
    # TI-Toolbox
    # ================================================================
    git clone https://github.com/idossha/TI-Toolbox.git /ti-toolbox

    # Convert shell scripts to Unix line endings
    find /ti-toolbox -name "*.sh" -exec dos2unix {} \;

    # Extra EEG electrode caps
    mkdir -p $SIMNIBSDIR/resources/ElectrodeCaps_MNI/
    cp /ti-toolbox/resources/ElectrodeCaps_MNI/* $SIMNIBSDIR/resources/ElectrodeCaps_MNI/

    # Flex extension
    rm -f $SIMNIBSDIR/simnibs/optimization/tes_flex_optimization/tes_flex_optimization.py
    cp /ti-toolbox/resources/map-electrodes/tes_flex_optimization.py \
        $SIMNIBSDIR/simnibs/optimization/tes_flex_optimization/tes_flex_optimization.py

    # Install TIT package
    cd /ti-toolbox && simnibs_python -m pip install --no-cache-dir .

    # ================================================================
    # System-wide profile so every user gets FreeSurfer + TI-Toolbox
    # (Apptainer runs as host user e.g. ihaber, not root; .bashrc is per-user)
    # ================================================================
    cat > /etc/profile.d/ti-toolbox-freesurfer.sh <<'PROFILE_EOF'
#!/bin/bash
# TI-Toolbox + FreeSurfer environment setup

# FreeSurfer setup - source the official setup script
if [ -n "$FREESURFER_HOME" ] && [ -f "$FREESURFER_HOME/SetUpFreeSurfer.sh" ]; then
    # Source FreeSurfer setup silently
    . "$FREESURFER_HOME/SetUpFreeSurfer.sh" >/dev/null 2>&1
fi

# Ensure critical FreeSurfer paths are set (fallback if SetUpFreeSurfer.sh fails)
if [ -n "$FREESURFER_HOME" ]; then
    export PATH="$FREESURFER_HOME/bin:$FREESURFER_HOME/fsfast/bin:$FREESURFER_HOME/tktools:$PATH"
    export SUBJECTS_DIR="${SUBJECTS_DIR:-$FREESURFER_HOME/subjects}"
    export FS_LICENSE="${FS_LICENSE:-$FREESURFER_HOME/license.txt}"
    export FSFAST_HOME="${FSFAST_HOME:-$FREESURFER_HOME/fsfast}"
    export FMRI_ANALYSIS_DIR="${FMRI_ANALYSIS_DIR:-$FREESURFER_HOME/fsfast}"
    export FUNCTIONALS_DIR="${FUNCTIONALS_DIR:-$FREESURFER_HOME/sessions}"
fi

# TI-Toolbox CLI aliases (any user)
alias GUI='simnibs_python -m tit.cli.gui'
alias analyzer='simnibs_python -m tit.cli.analyzer'
alias ex_search='simnibs_python -m tit.cli.ex_search'
alias flex_search='simnibs_python -m tit.cli.flex_search'
alias group_analyzer='simnibs_python -m tit.cli.group_analyzer'
alias pre_process='simnibs_python -m tit.cli.pre_process'
alias simulator='simnibs_python -m tit.cli.simulator'
alias blender='simnibs_python -m tit.cli.vis_blender'
alias create_leadfield='simnibs_python -m tit.cli.create_leadfield'
alias cluster_permutation='simnibs_python -m tit.cli.cluster_permuatation'
PROFILE_EOF
    chmod 644 /etc/profile.d/ti-toolbox-freesurfer.sh

    # Also ensure /etc/bash.bashrc sources profile.d (Debian/Ubuntu interactive non-login)
    if ! grep -q 'ti-toolbox-freesurfer' /etc/bash.bashrc 2>/dev/null; then
        echo '[ -f /etc/profile.d/ti-toolbox-freesurfer.sh ] && . /etc/profile.d/ti-toolbox-freesurfer.sh' >> /etc/bash.bashrc
    fi
    
    # Ensure /etc/profile also sources it for login shells
    if ! grep -q 'profile.d' /etc/profile 2>/dev/null; then
        echo 'for i in /etc/profile.d/*.sh; do [ -r "$i" ] && . "$i"; done' >> /etc/profile
    fi

%runscript
    #!/bin/bash
    
    # Setup XDG runtime dir
    export XDG_RUNTIME_DIR=/tmp/runtime-$(id -u)
    mkdir -p "$XDG_RUNTIME_DIR"
    chmod 700 "$XDG_RUNTIME_DIR"
    
    # Source system-wide profile for FreeSurfer and TI-Toolbox
    if [ -f /etc/profile.d/ti-toolbox-freesurfer.sh ]; then
        . /etc/profile.d/ti-toolbox-freesurfer.sh
    fi
    
    # Also source /etc/profile to ensure all system settings are loaded
    if [ -f /etc/profile ]; then
        . /etc/profile >/dev/null 2>&1 || true
    fi

    # Auto-detect project directory from /mnt
    if [ -z "$PROJECT_DIR" ] && [ -d /mnt ]; then
        for d in /mnt/*/; do
            if [ -d "$d" ]; then
                export PROJECT_DIR="$d"
                break
            fi
        done
    fi

    if [ $# -eq 0 ]; then
        echo ""
        echo "================================================================"
        echo "  TI-Toolbox (Apptainer) - Interactive Session"
        echo "================================================================"
        echo ""
        echo "  SimNIBS:    $SIMNIBSDIR"
        echo "  FreeSurfer: $FREESURFER_HOME"
        echo "  TI-Toolbox: /ti-toolbox"
        if [ -n "$PROJECT_DIR" ]; then
            echo "  Project:    $PROJECT_DIR"
        fi
        echo ""
        echo "  FreeSurfer tools available: recon-all, freeview, etc."
        echo ""
        # Use --login to ensure /etc/profile is sourced, but --noprofile/--norc
        # to avoid host user dotfiles that might override container settings
        exec /bin/bash --login --noprofile --norc
    else
        exec "$@"
    fi

%test
    # Verify SimNIBS
    export PATH="/opt/SimNIBS-4.5/bin:$PATH"
    simnibs_python -c "import simnibs; print('SimNIBS', simnibs.__version__)" || exit 1

    # Verify TI-Toolbox
    simnibs_python -c "import tit; print('TI-Toolbox', tit.__version__)" || exit 1

    # Verify FreeSurfer installation
    export FREESURFER_HOME=/usr/local/freesurfer
    if [ -d "$FREESURFER_HOME/bin" ]; then
        echo "FreeSurfer directory OK"
        # Check if critical binaries exist
        if [ -x "$FREESURFER_HOME/bin/recon-all" ]; then
            echo "  - recon-all: OK"
        else
            echo "  - recon-all: NOT FOUND"
        fi
        if [ -x "$FREESURFER_HOME/bin/freeview" ]; then
            echo "  - freeview: OK"
        else
            echo "  - freeview: NOT FOUND"
        fi
        # Source FreeSurfer setup and verify mri_info works
        if [ -f "$FREESURFER_HOME/SetUpFreeSurfer.sh" ]; then
            . "$FREESURFER_HOME/SetUpFreeSurfer.sh" >/dev/null 2>&1
            if command -v mri_info >/dev/null 2>&1; then
                echo "  - FreeSurfer environment: OK"
            else
                echo "  - FreeSurfer environment: WARNING (PATH may not be set correctly)"
            fi
        fi
    else
        echo "WARNING: /usr/local/freesurfer/bin not found during %test. Image build will continue." >&2
    fi

    echo "All smoke tests passed."

%help
    TI-Toolbox: Temporal Interference Stimulation Toolbox for HPC

    This image contains SimNIBS 4.5, FreeSurfer 7.4.1, and TI-Toolbox
    pre-installed for high-performance computing environments.

    Usage:
      # Interactive session
      apptainer run --bind /path/to/project:/mnt/project ti-toolbox.sif

      # Run a specific command
      apptainer exec --bind /path/to/project:/mnt/project ti-toolbox.sif \
          simnibs_python -m tit.cli.simulator --help

      # With FreeSurfer license (required for FreeSurfer tools)
      apptainer run \
          --bind /path/to/project:/mnt/project \
          --bind /path/to/license.txt:/usr/local/freesurfer/license.txt:ro \
          ti-toolbox.sif

    FreeSurfer License:
      The FreeSurfer license is NOT included in the image.
      Bind-mount your license.txt at runtime:
        --bind /path/to/license.txt:/usr/local/freesurfer/license.txt:ro
      
      You can request a free license at:
        https://surfer.nmr.mgh.harvard.edu/registration.html

    Environment Variables:
      FREESURFER_HOME=/usr/local/freesurfer
      SIMNIBSDIR=/opt/SimNIBS-4.5
      OMP_NUM_THREADS=${SLURM_CPUS_PER_TASK:-1}

    For full documentation, see:
      https://github.com/idossha/TI-toolbox
