# Dockerfile.simnibs
## 22.04 LTS is a new test to check for simnibs solution.

FROM ubuntu:22.04

# Set noninteractive mode for apt-get
ENV DEBIAN_FRONTEND=noninteractive

# Install packages grouped by context and purpose
##########################################################
RUN apt-get update && apt-get install -y \
    # Core system utilities
    wget \
    git \
    unzip \
    tar \
    bzip2 \
    curl \
    gettext \
    locales \
    fontconfig \
    \
    # Python environment
    python3.11 \
    python3-pip \
    python3.11-venv \
    python3.11-dev \
    \
    # Build tools and compilers
    build-essential \
    gcc \
    g++ \
    gcc-10 \
    g++-10 \
    cmake \
    ninja-build \
    libtool \
    libtool-bin \
    autoconf \
    automake \
    pkg-config \
    \
    # System libraries
    libglib2.0-0 \
    libopenblas-dev \
    \
    # OpenGL and Mesa libraries (for 3D graphics)
    libgl1-mesa-glx \
    libglu1-mesa \
    mesa-utils \
    libgl1-mesa-dri \
    libglapi-mesa \
    libosmesa6 \
        \
    # X11 libraries (for GUI applications)
    libxt6 \
    libxext6 \
    libxrender1 \
    libxrandr2 \
    libxfixes3 \
    libxcursor1 \
    libxcomposite1 \
    libxdamage1 \
    libxi6 \
    libxmu6 \
    libxft2 \ 
    \
    # Qt5 libraries (for PyQt5 GUI)
    libqt5widgets5 \
    libqt5gui5 \
    libqt5core5a \
    libqt5svg5 \
    libqt5opengl5 \
    \
    # GTK libraries (for legacy GUI applications)
    libgtk2.0-0 \
    \
    # Command-line tools and utilities
    bc \
    jq \
    vim \
    tmux \
    tree \
    execstack \
    parallel \
    dos2unix \
    \
    # Testing tools
    bats \
    \
    # Image processing tools
    imagemagick \
    \
    # Neuroimaging specific tools
    dcm2niix \
    # for recon-all function specifically
    tcsh \
    \
    && apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

######## Install SimNIBS ################
RUN mkdir -p /simnibs && chmod -R 755 /simnibs

RUN wget https://github.com/simnibs/simnibs/releases/download/v4.5.0/simnibs_installer_linux.tar.gz -P /simnibs \
    && tar -xzf /simnibs/simnibs_installer_linux.tar.gz -C /simnibs \
    && /simnibs/simnibs_installer/install -s

ENV PATH="/root/SimNIBS-4.5/bin:$PATH"
ENV SIMNIBSDIR="/root/SimNIBS-4.5"

# Install additional Python packages to simnibs_python
# Base packages for TI-Toolbox functionality
RUN simnibs_python -m pip install meshio nilearn PyOpenGL-accelerate trimesh seaborn pytest-cov seaborn scikit-image numpy-stl click bpy

# Note: Electrode caps will be copied from mounted ti-toolbox/resources/ElectrodeCaps_MNI/
# at runtime by entrypoint_test.sh (no need to download during build)

# Set environment variables for test project
ENV PROJECT_DIR_NAME=test_projectdir
ENV LOCAL_PROJECT_DIR=/mnt/test_projectdir

# Copy the entrypoint script
COPY entrypoint_test.sh /entrypoint_test.sh
RUN chmod +x /entrypoint_test.sh

######## Create Directories for Downloads ################
# Create minimal directories needed for downloads during build
RUN mkdir -p /opt/test_projectdir/derivatives/SimNIBS/sub-ernie_extended/m2m_ernie_extended \
    && mkdir -p /opt/test_projectdir/derivatives/SimNIBS/sub-ernie_extended/Simulations

######## Download Test Data During Build ################

# Download and setup ErnieExtended data (long download - baked into image)
RUN echo "Downloading ErnieExtended data from OSF..." \
    && (curl -L -f -o /tmp/ErnieExtended.zip "https://osf.io/download/6qv2z/" || \
        curl -L -f -o /tmp/ErnieExtended.zip "https://files.osf.io/v1/resources/6qv2z/providers/osfstorage/?zip=") \
    && echo "Extracting ErnieExtended data..." \
    && unzip -q /tmp/ErnieExtended.zip -d /tmp/ernie \
    && if [ -d "/tmp/ernie/ErnieExtended/m2m_ernie_extended" ]; then \
        cp -r /tmp/ernie/ErnieExtended/m2m_ernie_extended/* /opt/test_projectdir/derivatives/SimNIBS/sub-ernie_extended/m2m_ernie_extended/; \
    fi \
    && rm -rf /tmp/ernie /tmp/ErnieExtended.zip

# Download and setup test_montage simulation data (long download - baked into image)
RUN echo "Downloading test_montage simulation data..." \
    && curl -L -f -o /tmp/test_montage.zip "https://archive.org/download/test_montage/test_montage.zip" \
    && echo "Extracting test_montage simulation data..." \
    && unzip -q /tmp/test_montage.zip -d /tmp/ernie_simulation \
    && if [ -d "/tmp/ernie_simulation/test_montage" ]; then \
        cp -r /tmp/ernie_simulation/test_montage* /opt/test_projectdir/derivatives/SimNIBS/sub-ernie_extended/Simulations/; \
    fi \
    && rm -rf /tmp/ernie_simulation /tmp/test_montage.zip

# Set working directory where code will be mounted
# Using /ti-toolbox to match production SimNIBS image
WORKDIR /ti-toolbox

# Set entrypoint to run the setup script
ENTRYPOINT ["/entrypoint_test.sh"]
