# TI-Toolbox Analyzer

## Input Files

### Mesh Analysis
- **Field mesh**: `*_TI.msh` (SimNIBS mesh with TI_max field)
- **Normal mesh**: `*_normal.msh` (optional, for TI_normal statistics)
- **Subject data**: `m2m_*/` directory with atlas mappings

### Voxel Analysis
- **Field data**: `*.nii`, `*.nii.gz` (3D/4D NIfTI volumes)
- **Atlas**: `*.nii`, `*.nii.gz` (segmentation labels)
- **Subject data**: `m2m_*/` directory

## Output Files

- **`analysis_results.csv`**: Statistical summary
- **`*_histogram.png`**: Whole-head field distribution with ROI contribution (shows histogram with ROI color coding)
- **`*.msh`**: 3D mesh visualization files with ROI highlighted (for mesh analysis)

## Values and Source Files

### TI_max Values (Primary Analysis)

**Source File**: `*_TI.msh` → **GM Surface** (generated by `msh2cortex`)
- **Field extracted**: `TI_max` 
- **Processing**: GM surface contains area-weighted nodes for precise cortical analysis

**Used for**:
- ROI statistics (spherical, cortical, whole head)
- Grey matter statistics  
- TI_max focality calculations

### TI_normal Values (Secondary Analysis)

**Source File**: `*_normal.msh` (used directly)
- **Field extracted**: `TI_normal`
- **Processing**: Volume mesh nodes, area-weighted calculations

**Used for**:
- TI_normal ROI statistics
- TI_normal focality calculations

## Metrics

### Basic ROI Statistics
```
Mean = Area-weighted average of positive TI_max values in ROI
Max = Maximum positive TI_max value in ROI  
Min = Minimum positive TI_max value in ROI

Source: GM surface generated from *_TI.msh
```

### TI_max Focality
```
TImax_Focality = TImax_ROI_average / TImax_GM_average

TImax_ROI_average = Area-weighted mean of positive TI_max in ROI
TImax_GM_average = Area-weighted mean of ALL positive TI_max

Source: Same GM surface for both numerator and denominator (consistency)
```

### Grey Matter Statistics
```
Grey_mean = Area-weighted average of ALL positive TI_max values
Grey_max = Maximum TI_max value across entire GM surface
Grey_min = Minimum TI_max value across entire GM surface

Source: GM surface generated from *_TI.msh
Fallback: Original *_TI.msh if surface generation fails
```

### TI_normal Focality (mesh only)
```
TInormal_Focality = TInormal_ROI_average / TInormal_GM_average

TInormal_ROI_average = Area-weighted mean of positive TI_normal in ROI
TInormal_GM_average = Area-weighted mean of ALL positive TI_normal
Normal_mean = TInormal_ROI_average

Source: *_normal.msh (same file for both numerator and denominator)
```

## File Processing Pipeline

### Mesh Analysis Flow
1. **Load** `*_TI.msh` → **Generate** GM surface → **Extract** `TI_max` field
2. **Load** `*_normal.msh` → **Extract** `TI_normal` field directly
3. **Consistency**: Same surface/mesh used for ROI and whole brain calculations

### Voxel Analysis Flow  
1. **Load** field NIfTI → **Extract** values directly (no surface generation)
2. **Load** atlas NIfTI → **Map** ROI regions

## Analysis Types

- **Spherical**: Analyze sphere at coordinates (x,y,z) with radius r
- **Cortical**: Analyze specific brain region from atlas
- **Whole Head**: Analyze all regions in atlas simultaneously