services:

  freesurfer:
    image: idossha/ti-toolbox_freesurfer:v7.4.1
    platform: linux/amd64
    container_name: freesurfer_container
    volumes:
      - ti-toolbox_freesurfer_data:/usr/local/freesurfer/
    networks:
      - ti_network
    restart: unless-stopped

  simnibs:
    platform: linux/amd64
    image: idossha/simnibs:v2.2.3
    container_name: simnibs_container
    volumes:
      - ti-toolbox_freesurfer_data:/usr/local/freesurfer/
      - /tmp/.X11-unix:/tmp/.X11-unix:rw      # X11 socket mount for Linux/macOS
      - ${LOCAL_PROJECT_DIR}:/mnt/${PROJECT_DIR_NAME}
      - ${HOME}/.Xauthority:/root/.Xauthority:rw       # Additional mount for macOS XQuartz compatibility
    environment:
      USER: root
      DISPLAY: ${DISPLAY}
      MPLBACKEND: "Agg"
      FREESURFER_HOME: /usr/local/freesurfer
      SUBJECTS_DIR: /usr/local/freesurfer/subjects
      FS_LICENSE: /usr/local/freesurfer/license.txt
      LOCAL_PROJECT_DIR: ${LOCAL_PROJECT_DIR}
      PROJECT_DIR_NAME: ${PROJECT_DIR_NAME}
      TZ: ${TZ}
      KMP_AFFINITY: "disabled"
      TI_TOOLBOX_VERSION: "v2.2.3"
      USE_GPU: ${USE_GPU:-0}  # Set to 1 to enable GPU acceleration (requires nvidia-docker2)
    networks:
      - ti_network
    depends_on:
      - freesurfer
    tty: true
    stdin_open: true
    working_dir: /ti-toolbox
    restart: unless-stopped
    command: ["tail", "-f", "/dev/null"]
    # GPU Support (NVIDIA CUDA only) - Uncomment the 6 lines below if you have NVIDIA GPU
    # Requirements: nvidia-docker2 installed (apt-get install nvidia-docker2)
    # Then set: export USE_GPU=1
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

networks:
  ti_network:
    driver: bridge

volumes:
  ti-toolbox_freesurfer_data:
    external: true
    name: ti-toolbox_freesurfer_data

